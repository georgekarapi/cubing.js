import{a as A,d as k,i as F,j as O,k as H}from"./chunk-WKWCM3NN.js";import{b as L}from"./chunk-QIOL4UIE.js";var d={shareAllNewRenderers:"auto",showRenderStats:!1};function re(i){for(let[n,e]of Object.entries(i))n in d&&(d[n]=e)}var se={floating:!0,none:!0},X=class extends k{getDefaultValue(){return"auto"}};var Y=null;function me(i){Y=i}function y(){return Y??(devicePixelRatio||1)}var p=class{constructor(n){this.callback=n;this.animFrameID=null;this.animFrame=this.animFrameWrapper.bind(this)}requestIsPending(){return!!this.animFrameID}requestAnimFrame(){this.animFrameID||(this.animFrameID=requestAnimationFrame(this.animFrame))}cancelAnimFrame(){this.animFrameID&&(cancelAnimationFrame(this.animFrameID),this.animFrameID=0)}animFrameWrapper(n){this.animFrameID=0,this.callback(n)}};var B=Math.PI*2,u=360/B;var g=globalThis.performance,I=class{constructor(){this.mode=0;this.dom=document.createElement("div");this.beginTime=(g||Date).now();this.prevTime=this.beginTime;this.frames=0;this.fpsPanel=this.addPanel(new w("FPS","#0ff","#002"));this.msPanel=this.addPanel(new w("MS","#0f0","#020"));this.memPanel=g?.memory?this.addPanel(new w("MB","#f08","#201")):null;this.REVISION=16;this.dom.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",this.dom.addEventListener("click",n=>{n.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},!1),this.showPanel(0)}addPanel(n){return this.dom.appendChild(n.dom),n}showPanel(n){for(let e=0;e<this.dom.children.length;e++)this.dom.children[e].style.display=e===n?"block":"none";this.mode=n}begin(){this.beginTime=(g||Date).now()}end(){this.frames++;let n=(g||Date).now();if(this.msPanel.update(n-this.beginTime,200),n>=this.prevTime+1e3&&(this.fpsPanel.update(this.frames*1e3/(n-this.prevTime),100),this.prevTime=n,this.frames=0,this.memPanel)){let e=g.memory;this.memPanel.update(e.usedJSHeapSize/1048576,e.jsHeapSizeLimit/1048576)}return n}update(){this.beginTime=this.end()}},a=Math.round(globalThis?.window?.devicePixelRatio??1),S=80*a,_=48*a,W=3*a,N=2*a,f=3*a,c=15*a,v=74*a,b=30*a,w=class{constructor(n,e,t){this.name=n;this.fg=e;this.bg=t;this.min=1/0;this.max=0;this.dom=document.createElement("canvas");this.context=this.dom.getContext("2d");this.dom.width=S,this.dom.height=_,this.dom.style.cssText="width:80px;height:48px",this.context.font=`bold ${9*a}px Helvetica,Arial,sans-serif`,this.context.textBaseline="top",this.context.fillStyle=t,this.context.fillRect(0,0,S,_),this.context.fillStyle=e,this.context.fillText(n,W,N),this.context.fillRect(f,c,v,b),this.context.fillStyle=t,this.context.globalAlpha=.9,this.context.fillRect(f,c,v,b)}update(n,e){this.min=Math.min(this.min,n),this.max=Math.max(this.max,n),this.context.fillStyle=this.bg,this.context.globalAlpha=1,this.context.fillRect(0,0,S,c),this.context.fillStyle=this.fg,this.context.fillText(`${Math.round(n)} ${this.name} (${Math.round(this.min)}-${Math.round(this.max)})`,W,N),this.context.drawImage(this.dom,f+a,c,v-a,b,f,c,v-a,b),this.context.fillRect(f+v-a,c,a,b),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(f+v-a,c,a,Math.round((1-n/e)*b))}};var K=null;async function $(){return K??(K=import("./twisty-dynamic-3d-I57WC6XA.js"))}var h=L(async()=>(await $()).T3I);var G=new O(`
:host {
  width: 384px;
  height: 256px;
  display: grid;
}

.wrapper {
  width: 100%;
  height: 100%;
  display: grid;
  overflow: hidden;
  place-content: center;
  contain: strict;
}

.loading {
  width: 4em;
  height: 4em;
  border-radius: 2.5em;
  border: 0.5em solid rgba(0, 0, 0, 0);
  border-top: 0.5em solid rgba(0, 0, 0, 0.7);
  border-right: 0.5em solid rgba(0, 0, 0, 0.7);
  animation: fade-in-delayed 4s, rotate 1s linear infinite;
}

@keyframes fade-in-delayed {
  0% { opacity: 0; }
  25% {opacity: 0; }
  100% { opacity: 1; }
}

@keyframes rotate {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* TODO: This is due to stats hack. Replace with \`canvas\`. */
.wrapper > canvas {
  max-width: 100%;
  max-height: 100%;
  animation: fade-in 0.25s ease-in;
}

@keyframes fade-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

.wrapper.invisible {
  opacity: 0;
}

.wrapper.drag-input-enabled > canvas {
  cursor: grab;
}

.wrapper.drag-input-enabled > canvas:active {
  cursor: grabbing;
}
`);var P=class extends EventTarget{constructor(e){super();this.target=e}#e=new Map;start(){this.addTargetListener("pointerdown",this.onPointerDown.bind(this)),this.addTargetListener("contextmenu",e=>{e.preventDefault()}),this.addTargetListener("touchmove",e=>e.preventDefault()),this.addTargetListener("dblclick",e=>e.preventDefault())}stop(){for(let[e,t]of this.#t.entries())this.target.removeEventListener(e,t);this.#t.clear(),this.#n=!1}#t=new Map;addTargetListener(e,t){this.#t.has(e)||(this.target.addEventListener(e,t),this.#t.set(e,t))}#n=!1;#r(){this.#n||(this.addTargetListener("pointermove",this.onPointerMove.bind(this)),this.addTargetListener("pointerup",this.onPointerUp.bind(this)),this.#n=!0)}#i(e){this.#e.delete(e.pointerId)}#a(e){let t=this.#e.get(e.pointerId);if(!t)return{movementInfo:null,hasMoved:!1};let r;return(e.movementX??0)!==0||(e.movementY??0)!==0?r={attachedInfo:t.attachedInfo,movementX:e.movementX,movementY:e.movementY,elapsedMs:e.timeStamp-t.lastTimeStamp}:r={attachedInfo:t.attachedInfo,movementX:e.clientX-t.lastClientX,movementY:e.clientY-t.lastClientY,elapsedMs:e.timeStamp-t.lastTimeStamp},t.lastClientX=e.clientX,t.lastClientY=e.clientY,t.lastTimeStamp=e.timeStamp,Math.abs(r.movementX)<.1&&Math.abs(r.movementY)<.1?{movementInfo:null,hasMoved:t.hasMoved}:(t.hasMoved=!0,{movementInfo:r,hasMoved:t.hasMoved})}onPointerDown(e){this.#r();let t={attachedInfo:{},hasMoved:!1,lastClientX:e.clientX,lastClientY:e.clientY,lastTimeStamp:e.timeStamp};this.#e.set(e.pointerId,t),this.target.setPointerCapture(e.pointerId)}onPointerMove(e){let t=this.#a(e).movementInfo;t&&(e.preventDefault(),this.dispatchEvent(new CustomEvent("move",{detail:t})))}onPointerUp(e){let t=this.#a(e),r=this.#e.get(e.pointerId);this.#i(e),this.target.releasePointerCapture(e.pointerId);let s;if(t.hasMoved)s=new CustomEvent("up",{detail:{attachedInfo:r.attachedInfo}});else{let{altKey:o,ctrlKey:m,metaKey:l,shiftKey:q}=e;s=new CustomEvent("press",{detail:{normalizedX:e.offsetX/this.target.offsetWidth*2-1,normalizedY:1-e.offsetY/this.target.offsetHeight*2,rightClick:!!(e.button&2),keys:{altKey:o,ctrlOrMetaKey:m||l,shiftKey:q}}})}this.dispatchEvent(s)}};var T=[];async function J(i,n,e,t){T.length===0&&T.push(x());let r=await T[0];return r.setSize(i,n),r.render(e,t),r.domElement}async function z(i,n,e,t,r){if(i===0||n===0)return;T.length===0&&T.push(x());let s=await J(i,n,t,r),o=e.getContext("2d");o.clearRect(0,0,e.width,e.height),o.drawImage(s,0,0)}async function x(){let i=(await h).WebGLRenderer,n=new i({antialias:!0,alpha:!0});return n.setPixelRatio(y()),n}var j=!0,M=500,Q=50,Z=.75;function V(i){return(Math.exp(1-i)-(1-i))/(1-Math.E)+1}var R=class{constructor(n,e,t,r){this.startTimestamp=n;this.momentumX=e;this.momentumY=t;this.callback=r;this.scheduler=new p(this.render.bind(this));this.scheduler.requestAnimFrame(),this.lastTimestamp=n}render(n){let e=(this.lastTimestamp-this.startTimestamp)/M,t=Math.min(1,(n-this.startTimestamp)/M);if(e===0&&t>Q/M)return;let r=V(t)-V(e);this.callback(this.momentumX*r*1e3,this.momentumY*r*1e3),t<1&&this.scheduler.requestAnimFrame(),this.lastTimestamp=n}};var E=class{constructor(n,e,t,r){this.model=n;this.mirror=e;this.canvas=t;this.dragTracker=r;this.experimentalInertia=j;this.onMovementBound=this.onMovement.bind(this);this.experimentalHasBeenMoved=!1;this.dragTracker.addEventListener("move",this.onMove.bind(this)),this.dragTracker.addEventListener("up",this.onUp.bind(this))}temperMovement(n){return Math.sign(n)*Math.log(Math.abs(n*10)+1)/6}onMove(n){var s;(s=n.detail).attachedInfo??(s.attachedInfo={});let{temperedX:e,temperedY:t}=this.onMovement(n.detail.movementX,n.detail.movementY),r=n.detail.attachedInfo;r.lastTemperedX=e*10,r.lastTemperedY=t*10,r.timestamp=n.timeStamp}onMovement(n,e){let t=this.mirror?-1:1,r=Math.min(this.canvas.offsetWidth,this.canvas.offsetHeight),s=this.temperMovement(n/r),o=this.temperMovement(e/r*Z);return this.model.twistySceneModel.orbitCoordinatesRequest.set((async()=>{let m=await this.model.twistySceneModel.orbitCoordinates.get();return{latitude:m.latitude+2*o*u*t,longitude:m.longitude-2*s*u}})()),{temperedX:s,temperedY:o}}onUp(n){n.preventDefault(),"lastTemperedX"in n.detail.attachedInfo&&"lastTemperedY"in n.detail.attachedInfo&&"timestamp"in n.detail.attachedInfo&&n.timeStamp-n.detail.attachedInfo.timestamp<60&&new R(n.timeStamp,n.detail.attachedInfo.lastTemperedX,n.detail.attachedInfo.lastTemperedY,this.onMovementBound)}};async function ee(i,n,e=!1){let t=new(await h).Spherical(n.distance,(90-(e?-1:1)*n.latitude)/u,((e?180:0)+n.longitude)/u);t.makeSafe(),i.position.setFromSpherical(t),i.lookAt(0,0,0)}var C=0,te=2,U=!1;function ne(){return d.shareAllNewRenderers!=="auto"?(d.shareAllNewRenderers||C++,d.shareAllNewRenderers!=="never"):C<te?(C++,!1):(U=!0,!0)}function _e(){return U}var D=class extends H{constructor(e,t,r){super();this.model=e;this.options=r;this.scene=null;this.stats=null;this.rendererIsShared=ne();this.loadingElement=null;this.#t=new A;this.#n=0;this.#r=0;this.#a=null;this.#l=null;this.#d=null;this.#c=null;this.#h=null;this.#s=[];this.#o=null;this.#p=new p(this.render.bind(this));this.scene=t??null,this.loadingElement=this.addElement(document.createElement("div")),this.loadingElement.classList.add("loading"),d.showRenderStats&&(this.stats=new I,this.stats.dom.style.position="absolute",this.contentWrapper.appendChild(this.stats.dom))}async connectedCallback(){this.addCSS(G),this.addElement((await this.canvasInfo()).canvas),this.#i(),new ResizeObserver(this.#i.bind(this)).observe(this.contentWrapper),this.orbitControls(),this.#e(),this.scheduleRender()}async#e(){(await this.#m()).addEventListener("press",async t=>{await this.model.twistySceneModel.movePressInput.get()==="basic"&&this.dispatchEvent(new CustomEvent("press",{detail:{pressInfo:t.detail,cameraPromise:this.camera()}}))})}#t;async clearCanvas(){if(this.rendererIsShared){let e=await this.canvasInfo();e.context.clearRect(0,0,e.canvas.width,e.canvas.height)}else{let t=(await this.renderer()).getContext();t.clear(t.COLOR_BUFFER_BIT)}}#n;#r;async#i(){let e=await this.#t.queue(this.camera()),t=this.contentWrapper.clientWidth,r=this.contentWrapper.clientHeight;this.#n=t,this.#r=r;let s=0,o=0,m=0;if(r>t&&(m=r-t,o=-Math.floor(.5*m)),e.aspect=t/r,e.setViewOffset(t,r-m,s,o,t,r),e.updateProjectionMatrix(),this.clearCanvas(),this.rendererIsShared){let l=await this.canvasInfo();l.canvas.width=t*y(),l.canvas.height=r*y(),l.canvas.style.width=`${t.toString()}px`,l.canvas.style.height=`${r.toString()}px`}else(await this.renderer()).setSize(t,r,!0);this.scheduleRender()}#a;async renderer(){if(this.rendererIsShared)throw new Error("renderer expected to be shared.");return this.#a??(this.#a=x())}#l;async canvasInfo(){return this.#l??(this.#l=(async()=>{let e;if(this.rendererIsShared)e=this.addElement(document.createElement("canvas"));else{let r=await this.renderer();e=this.addElement(r.domElement)}this.loadingElement?.remove();let t=e.getContext("2d");return{canvas:e,context:t}})())}#d;async#m(){return this.#d??(this.#d=(async()=>{let e=new P((await this.canvasInfo()).canvas);return this.model?.twistySceneModel.dragInput.addFreshListener(t=>{let r=!1;switch(t){case"auto":{e.start(),r=!0;break}case"none":{e.stop();break}}this.contentWrapper.classList.toggle("drag-input-enabled",r)}),e})())}#c;async camera(){return this.#c??(this.#c=(async()=>{let e=new(await h).PerspectiveCamera(20,1,.1,20);return e.position.copy(new(await h).Vector3(2,4,4).multiplyScalar(this.options?.backView?-1:1)),e.lookAt(0,0,0),e})())}#h;async orbitControls(){return this.#h??(this.#h=(async()=>{let e=new E(this.model,!!this.options?.backView,(await this.canvasInfo()).canvas,await this.#m());return this.model&&this.addListener(this.model.twistySceneModel.orbitCoordinates,async t=>{let r=await this.camera();ee(r,t,this.options?.backView),this.scheduleRender()}),e})())}addListener(e,t){e.addFreshListener(t),this.#s.push(()=>{e.removeFreshListener(t)})}#s;disconnect(){for(let e of this.#s)e();this.#s=[]}#o;experimentalNextRenderFinishedCallback(e){this.#o=e}async render(){if(!this.scene)throw new Error("Attempted to render without a scene");this.stats?.begin();let[e,t,r]=await Promise.all([this.scene.scene(),this.camera(),this.canvasInfo()]);this.rendererIsShared?z(this.#n,this.#r,r.canvas,e,t):(await this.renderer()).render(e,t),this.stats?.end(),this.#o?.(),this.#o=null}#p;scheduleRender(){this.#p.requestAnimFrame()}};F.define("twisty-3d-vantage",D);export{re as a,p as b,se as c,X as d,B as e,u as f,me as g,J as h,ee as i,_e as j,D as k,$ as l,h as m};
//# sourceMappingURL=chunk-LWA7II2Q.js.map
