import{g as u,h as G}from"./chunk-UW55Z7GB.js";import{c as X,d as Y}from"./chunk-JDD2UWSX.js";import{d as J,e as y}from"./chunk-S4ZNJEAB.js";import{a as E,v as W}from"./chunk-CM3DPZVF.js";import{j as s,p as H,q as p,r as $}from"./chunk-K5RKCHW3.js";import{c as Re}from"./chunk-SYRP7SJ5.js";var gt={};Re(gt,{GanCube:()=>v,GiiKERCube:()=>d,GoCube:()=>b,KeyboardPuzzle:()=>z,connectSmartPuzzle:()=>be,connectSmartRobot:()=>Ae,connectSmartTimer:()=>Te,debugKeyboardConnect:()=>ie,enableDebugLogging:()=>ee});var Z=!1;function ee(i){Z=i}function c(...i){!Z||(console.info?console.info(...i):console.log(...i))}function te(i){switch(Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z))){case i.x:return"x";case-i.x:return"-x";case i.y:return"y";case-i.y:return"-y";case i.z:return"z";case-i.z:return"-z";default:throw new Error("Uh-oh.")}}var w=Math.sqrt(.5),re={"y z":new u(0,0,0,1),"-z y":new u(w,0,0,w),"x z":new u(0,0,-w,w),"-x z":new u(0,0,w,w)},D=class{transformAlgLeaf(o){}transformOrientation(o){let{x:e,y:t,z:r,w:n}=o.quaternion,a=new u(e,t,r,n),l=new G(0,1,0),m=new G(0,0,1),g=te(l.applyQuaternion(a)),Be=te(m.applyQuaternion(a)),j=re[`${g} ${Be}`]||re["y z"];console.log(a),console.log(j);let ze=a.premultiply(j);console.log(ze),o.quaternion=a,console.log(o.quaternion)}};var f=class extends EventTarget{constructor(){super(...arguments);this.transformers=[];this.listeners=[];this.orientationListeners=[]}async getState(){throw new Error("cannot get state")}addAlgLeafListener(e){this.listeners.push(e)}addOrientationListener(e){this.orientationListeners.push(e)}experimentalAddBasicRotationTransformer(){this.transformers.push(new D)}dispatchAlgLeaf(e){for(let t of this.transformers)t.transformAlgLeaf(e);for(let t of this.listeners)t(e)}dispatchOrientation(e){for(let l of this.transformers)l.transformOrientation(e);let{x:t,y:r,z:n,w:a}=e.quaternion;e.quaternion={x:t,y:r,z:n,w:a};for(let l of this.orientationListeners)l(e)}};var z=class extends f{constructor(e){super();this.target=e;this.puzzle=y["3x3x3"].kpuzzle();this.state=(async()=>(await this.puzzle).startState())();this.listener=this.onKeyDown.bind(this),e.addEventListener("keydown",this.listener)}name(){return"Keyboard Input"}disconnect(){this.target.removeEventListener("keydown",this.listener)}async getState(){return this.state}async onKeyDown(e){if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return;let t=$(e);if(t){let r=(await this.state).applyAlg(new p([t]));this.state=Promise.resolve(r),this.dispatchAlgLeaf({latestAlgLeaf:t,timeStamp:e.timeStamp,state:r}),e.preventDefault()}}};async function ie(i=window){return new z(i)}function Ee(i,o=!1){let e=o?{acceptAllDevices:!0,optionalServices:[]}:{filters:[],optionalServices:[]};for(let t of i)o||(e.filters=e.filters.concat(t.filters)),e.optionalServices=e.optionalServices.concat(t.optionalServices);return c({requestOptions:e}),e}var O=0,oe=2;async function S(i,o={}){c("Attempting to pair.");let e;try{let n=o.acceptAllDevices;!n&&O>=oe&&(console.info(`The last ${oe} Bluetooth puzzle connection attempts failed. This time, the Bluetooth prompt will show all possible devices.`),n=!0),e=await navigator.bluetooth.requestDevice(Ee(i,n)),O=0}catch(n){throw O++,new Error(n)}if(c("Device:",e),typeof e.gatt>"u")return Promise.reject("Device did not have a GATT server.");let t=await e.gatt.connect();c("Server:",t);let r=t.device?.name||"";for(let n of i)for(let a of n.prefixes)if(r?.startsWith(a))return n.connect(t,e);throw Error("Unknown Bluetooth devive.")}var De=new Uint8Array(16),Ue=new Uint8Array(new Array(16).fill(16)),k="AES-CBC";async function ne(i){return await crypto.subtle.importKey("raw",i,k,!0,["encrypt","decrypt"])}async function Le(i,o,e){return(await window.crypto.subtle.encrypt({name:k,iv:e},i,o)).slice(0,16)}async function K(i,o){let e=await Le(i,Ue,o),t=new Uint8Array(2*16);return t.set(new Uint8Array(o),0),t.set(new Uint8Array(e),16),(await window.crypto.subtle.decrypt({name:k,iv:De},i,t)).slice(0,16)}var Pe=150,U=6,Me={0:new s("U"),2:new s("U",-1),3:new s("R"),5:new s("R",-1),6:new s("F"),8:new s("F",-1),9:new s("D"),11:new s("D",-1),12:new s("L"),14:new s("L",-1),15:new s("B"),17:new s("B",-1)},I=null;function Ge(i){return i[13]<18&&i[14]<18&&i[15]<18&&i[16]<18&&i[17]<18&&i[18]<18}var Oe=new Uint8Array([198,202,21,223,79,110,19,182,119,13,230,89,58,175,186,162]),ke=new Uint8Array([67,226,91,214,125,220,120,216,7,96,163,218,130,60,1,241]);async function se(i,o){if(o===null)return i;let e=new Uint8Array(i);if(e.set(new Uint8Array(await K(o,e.slice(3))),3),e.set(new Uint8Array(await K(o,e.slice(0,16))),0),Ge(e))return e;throw new Error("Invalid Gan cube state")}var C=class{constructor(o,e){this.dataView=o;this.timeStamp=e;this.arrLen=19;if(this.arr=new Uint8Array(o.buffer),this.arr.length!==this.arrLen)throw new Error("Unexpected array length")}static async read(o,e){let t=await se(new Uint8Array((await o.readValue()).buffer),e),r=Date.now();return new C(new DataView(t.buffer),r)}rotQuat(){let o=this.dataView.getInt16(0,!0)/16384,e=this.dataView.getInt16(2,!0)/16384,t=this.dataView.getInt16(4,!0)/16384;[o,e,t]=[-e,t,-o];let r=1-(o*o+e*e+t*t),n=r>0?Math.sqrt(r):0,a=new u(o,e,t,n);return I||(I=a.clone().invert()),a.clone().multiply(I.clone())}moveCounter(){return this.arr[12]}numMovesSince(o){return this.moveCounter()-o&255}latestMoves(o){if(o<0||o>U)throw new Error(`Must ask for 0 to 6 latest moves. (Asked for ${o})`);return Array.from(this.arr.slice(19-o,19)).map(e=>Me[e])}debugInfo(){return{arr:this.arr}}},h={ganCubeService:"0000fff0-0000-1000-8000-00805f9b34fb",physicalStateCharacteristic:"0000fff5-0000-1000-8000-00805f9b34fb",actualAngleAndBatteryCharacteristic:"0000fff7-0000-1000-8000-00805f9b34fb",faceletStatus1Characteristic:"0000fff2-0000-1000-8000-00805f9b34fb",faceletStatus2Characteristic:"0000fff3-0000-1000-8000-00805f9b34fb",infoService:"0000180a-0000-1000-8000-00805f9b34fb",systemIDCharacteristic:"00002a23-0000-1000-8000-00805f9b34fb",versionCharacteristic:"00002a28-0000-1000-8000-00805f9b34fb"},Ke={reset:new Uint8Array([0,0,36,0,73,146,36,73,109,146,219,182,73,146,182,36,109,219])};function Ie(i){return Array.prototype.map.call(new Uint8Array(i),o=>`00${o.toString(16)}`.slice(-2)).join(" ")}var Fe="UF UR UB UL DF DR DB DL FR FL BR BL".split(" "),Ne="UFR URB UBL ULF DRF DFL DLB DBR".split(" ");function ce(i,o){return i.slice(o)+i.slice(0,o)}var L={};Fe.forEach((i,o)=>{for(let e=0;e<2;e++)L[ce(i,e)]={piece:o,orientation:e}});Ne.forEach((i,o)=>{for(let e=0;e<3;e++)L[ce(i,e)]={piece:o,orientation:e}});var Qe=[[0,21,15],[5,13,47],[7,45,39],[2,37,23],[29,10,16],[31,18,32],[26,34,40],[24,42,8]],Ve=[[1,22],[3,14],[6,46],[4,38],[30,17],[27,9],[25,41],[28,33],[19,12],[20,35],[44,11],[43,36]],ae="URFDLB";async function _e(i){let o=await i.getPrimaryService(h.infoService),e=await o.getCharacteristic(h.versionCharacteristic),t=new Uint8Array((await e.readValue()).buffer),r=((t[0]<<8)+t[1]<<8)+t[2];if(r<65544)return null;let n=r<65792?Oe:ke,a=await o.getCharacteristic(h.systemIDCharacteristic),l=new Uint8Array((await a.readValue()).buffer).reverse(),m=new Uint8Array(n);for(let g=0;g<l.length;g++)m[g]=(m[g]+l[g])%256;return ne(m)}var v=class extends f{constructor(e,t,r,n,a,l){super();this.kpuzzle=e;this.service=t;this.server=r;this.physicalStateCharacteristic=n;this.lastMoveCounter=a;this.aesKey=l;this.INTERVAL_MS=Pe;this.intervalHandle=null;this.state=e.startState(),this.startTrackingMoves()}static async connect(e){let t=await e.getPrimaryService(h.ganCubeService);c("Service:",t);let r=await t.getCharacteristic(h.physicalStateCharacteristic);c("Characteristic:",r);let n=await _e(e),a=(await C.read(r,n)).moveCounter();return c("Initial Move Counter:",a),new v(await y["3x3x3"].kpuzzle(),t,e,r,a,n)}name(){return this.server.device.name}disconnect(){this.server.disconnect()}startTrackingMoves(){this.intervalHandle=window.setInterval(this.intervalHandler.bind(this),this.INTERVAL_MS)}stopTrackingMoves(){if(!this.intervalHandle)throw new Error("Not tracking moves!");clearInterval(this.intervalHandle),this.intervalHandle=null}async intervalHandler(){let e=await C.read(this.physicalStateCharacteristic,this.aesKey),t=e.numMovesSince(this.lastMoveCounter);t>U&&(c(`Too many moves! Dropping ${t-U} moves`),t=U);for(let r of e.latestMoves(t))this.state=this.state.applyMove(r),this.dispatchAlgLeaf({latestAlgLeaf:r,timeStamp:e.timeStamp,debug:e.debugInfo(),state:this.state});this.dispatchOrientation({timeStamp:e.timeStamp,quaternion:e.rotQuat()}),this.lastMoveCounter=e.moveCounter()}async getBattery(){return new Uint8Array(await this.readActualAngleAndBatteryCharacteristic())[7]}async getState(){let e=await se(new Uint8Array(await this.readFaceletStatus1Characteristic()),this.aesKey),t=[];for(let n=0;n<18;n+=3){let a=((e[n^1]<<8)+e[n+1^1]<<8)+e[n+2^1];for(let l=0;l<8;l++)t.push(a&7),a>>=3}let r={CORNERS:{pieces:[],orientation:[]},EDGES:{pieces:[],orientation:[]},CENTERS:{pieces:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}};for(let n of Qe){let a=L[n.map(l=>ae[t[l]]).join("")];r.CORNERS.pieces.push(a.piece),r.CORNERS.orientation.push(a.orientation)}for(let n of Ve){let a=L[n.map(l=>ae[t[l]]).join("")];r.EDGES.pieces.push(a.piece),r.EDGES.orientation.push(a.orientation)}return new E(this.kpuzzle,r)}async faceletStatus1Characteristic(){return this.cachedFaceletStatus1Characteristic=this.cachedFaceletStatus1Characteristic||this.service.getCharacteristic(h.faceletStatus1Characteristic),this.cachedFaceletStatus1Characteristic}async faceletStatus2Characteristic(){return this.cachedFaceletStatus2Characteristic=this.cachedFaceletStatus2Characteristic||this.service.getCharacteristic(h.faceletStatus2Characteristic),this.cachedFaceletStatus2Characteristic}async actualAngleAndBatteryCharacteristic(){return this.cachedActualAngleAndBatteryCharacteristic=this.cachedActualAngleAndBatteryCharacteristic||this.service.getCharacteristic(h.actualAngleAndBatteryCharacteristic),this.cachedActualAngleAndBatteryCharacteristic}async reset(){await(await this.faceletStatus1Characteristic()).writeValue(Ke.reset)}async readFaceletStatus1Characteristic(){return(await(await this.faceletStatus1Characteristic()).readValue()).buffer}async readFaceletStatus2Characteristic(){let e=await this.faceletStatus2Characteristic();return Ie((await e.readValue()).buffer)}async readActualAngleAndBatteryCharacteristic(){return(await(await this.actualAngleAndBatteryCharacteristic()).readValue()).buffer}},le={connect:v.connect.bind(v),prefixes:["GAN"],filters:[{namePrefix:"GAN"}],optionalServices:[h.ganCubeService,h.infoService]};var P=20,F={cubeService:"0000aadb-0000-1000-8000-00805f9b34fb",cubeCharacteristic:"0000aadc-0000-1000-8000-00805f9b34fb"};function qe(i,o){switch(o){case 3:{o=-1;break}case 9:{c("Encountered 9",i,o),o=-2;break}}let e=["?","B","D","L","U","R","F"][i];return new s(e,o)}function je(i){let o="";return o+=i.slice(0,8).join("."),o+=`
`,o+=i.slice(8,16).join("."),o+=`
`,o+=i.slice(16,28).join("."),o+=`
`,o+=i.slice(28,32).join("."),o+=`
`,o+=i.slice(32,40).join("."),o}var He={pieces:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]},$e=[4,8,0,9,5,1,3,7,6,10,2,11],We=[2,5,10,6,0,4,8,7,1,3,9,11],Xe=[1,0,1,0,1,0,1,0,0,0,0,0],Ye=[1,0,1,0,1,0,1,0,0,0,0,0],Je=[4,0,3,5,7,1,2,6],Ze=[1,5,6,2,0,3,7,4],et=[1,2,1,2,2,1,2,1],tt=[2,1,2,1,1,2,1,2],rt=[-1,1,-1,1,1,-1,1,-1];function R(i,o){return o%2===1?i[o/2|0]%16:0|i[o/2|0]/16}function it(i){return i[18]===167}var ue=[176,81,104,224,86,137,237,119,38,26,193,161,210,126,150,81,93,13,236,249,89,235,88,24,113,81,214,131,130,199,2,169,39,165,171,41];function ot(i){let o=R(i,38),e=R(i,39),t=new Uint8Array(P);for(let r=0;r<P;r++)t[r]=i[r]+ue[o+r]+ue[e+r];return t}async function pe(i){return it(i)?ot(i):i}var d=class extends f{constructor(e,t,r){super();this.server=e;this.cubeCharacteristic=t;this.originalValue=r}static async connect(e){let t=await e.getPrimaryService(F.cubeService);c("Service:",t);let r=await t.getCharacteristic(F.cubeCharacteristic);c("Characteristic:",r);let n=await pe(new Uint8Array((await r.readValue()).buffer));c("Original value:",n);let a=new d(e,r,n);return await r.startNotifications(),r.addEventListener("characteristicvaluechanged",a.onCubeCharacteristicChanged.bind(a)),a}name(){return this.server.device.name}disconnect(){this.server.disconnect()}async getState(){return this.toReid333(new Uint8Array((await this.cubeCharacteristic.readValue()).buffer))}getBit(e,t){let r=t/8|0,n=7-t%8;return e[r]>>n&1}toReid333(e){let t={EDGES:{pieces:new Array(12),orientation:new Array(12)},CORNERS:{pieces:new Array(8),orientation:new Array(8)},CENTERS:He};for(let r=0;r<12;r++){let n=We[r];t.EDGES.pieces[r]=$e[R(e,n+16)-1],t.EDGES.orientation[r]=this.getBit(e,n+112)^Xe[t.EDGES.pieces[r]]^Ye[r]}for(let r=0;r<8;r++){let n=Ze[r];t.CORNERS.pieces[r]=Je[R(e,n)-1],t.CORNERS.orientation[r]=(R(e,n+8)*rt[n]+et[t.CORNERS.pieces[r]]+tt[r])%3}return new E(W,t)}async onCubeCharacteristicChanged(e){let t=await pe(new Uint8Array(e.target.value.buffer));if(c(t),c(t),this.isRepeatedInitialValue(t)){c("Skipping repeated initial value.");return}let r=[];for(let a=0;a<P;a++)r.push(Math.floor(t[a]/16)),r.push(t[a]%16);c(r);let n=je(r);c(n),this.dispatchAlgLeaf({latestAlgLeaf:qe(r[32],r[33]),timeStamp:e.timeStamp,debug:{stateStr:n},state:this.toReid333(t)})}isRepeatedInitialValue(e){if(typeof this.originalValue>"u")throw new Error("GiiKERCube has uninitialized original value.");if(this.originalValue===null)return!1;let t=this.originalValue;this.originalValue=null,c("Comparing against original value.");for(let r=0;r<P-2;r++)if(t[r]!==e[r])return c("Different at index ",r),!1;return!0}},me={connect:d.connect.bind(d),prefixes:["Gi",""],filters:[{namePrefix:"Gi"},{services:["0000aadb-0000-1000-8000-00805f9b34fb"]},{services:["0000aaaa-0000-1000-8000-00805f9b34fb"]},{services:["0000fe95-0000-1000-8000-00805f9b34fb"]}],optionalServices:[F.cubeService]};var N={goCubeService:"6e400001-b5a3-f393-e0a9-e50e24dcca9e",goCubeStateCharacteristic:"6e400003-b5a3-f393-e0a9-e50e24dcca9e"};function fe(i){return Array.prototype.map.call(new Uint8Array(i),o=>`00${o.toString(16)}`.slice(-2)).join(" ")}function nt(i){let o=new Uint8Array(i),e="";for(let t of o)e+=String.fromCharCode(t);return e}var he=[new s("B",1),new s("B",-1),new s("F",1),new s("F",-1),new s("U",1),new s("U",-1),new s("D",1),new s("D",-1),new s("R",1),new s("R",-1),new s("L",1),new s("L",-1)],b=class extends f{constructor(e,t){super();this.server=e;this.goCubeStateCharacteristic=t;this.recorded=[];this.homeQuatInverse=null;this.lastRawQuat=new u(0,0,0,1);this.currentQuat=new u(0,0,0,1);this.lastTarget=new u(0,0,0,1);this.alg=new p}static async connect(e){let t=await e.getPrimaryService(N.goCubeService);c({service:t});let r=await t.getCharacteristic(N.goCubeStateCharacteristic);c({goCubeStateCharacteristic:r});let n=new b(e,r);return await r.startNotifications(),r.addEventListener("characteristicvaluechanged",n.onCubeCharacteristicChanged.bind(n)),n}disconnect(){this.server.disconnect()}reset(){this.resetAlg(),this.resetOrientation()}resetAlg(e){this.alg=e||new p}resetOrientation(){this.homeQuatInverse=this.lastRawQuat.clone().invert(),this.currentQuat=new u(0,0,0,1),this.lastTarget=new u(0,0,0,1)}name(){return this.server.device.name}onCubeCharacteristicChanged(e){let t=e.target.value;if(this.recorded.push([e.timeStamp,fe(t.buffer)]),t.byteLength<16)for(let r=3;r<t.byteLength-4;r+=2){let n=he[t.getUint8(r)];this.alg=H(this.alg,n),this.dispatchAlgLeaf({latestAlgLeaf:he[t.getUint8(r)],timeStamp:e.timeStamp,debug:{stateStr:fe(t.buffer)}})}else{let r=nt(t.buffer.slice(3,t.byteLength-3)).split("#").map(l=>parseInt(l,10)/16384),n=new u(r[0],r[1],r[2],r[3]);this.lastRawQuat=n.clone(),this.homeQuatInverse||(this.homeQuatInverse=n.clone().invert());let a=n.clone().multiply(this.homeQuatInverse.clone());a.y=-a.y,this.lastTarget.slerp(a,.5),this.currentQuat.rotateTowards(this.lastTarget,at),this.dispatchOrientation({quaternion:this.currentQuat,timeStamp:e.timeStamp})}}},at=.5,ve={connect:b.connect.bind(b),prefixes:["GoCube","Rubik"],filters:[{namePrefix:"GoCube"},{namePrefix:"Rubik"}],optionalServices:[N.goCubeService]};function A(i,o){let e=0;for(let t=0;t<o;t++){let r=o-1-2*t,n=i&1<<t;e+=r<0?n>>-r:n<<r}return e}var Q={heykubeService:"b46a791a-8273-4fc1-9e67-94d3dc2aac1c",stateCharacteristic:"a2f41a4e-0e31-4bbc-9389-4253475481fb",batteryCharacteristic:"fd51b3ba-99c7-49c6-9f85-5644ff56a378"},x=class extends f{constructor(e,t,r,n,a){super();this.server=n;this.stateCharacteristic=a;r.addEventListener("gattserverdisconnected",this.onDisconnect.bind(this)),this.stateCharacteristic.startNotifications(),this.startTrackingMoves()}static async connect(e,t){let r=await e.getPrimaryService(Q.heykubeService);c("Service:",r);let n=await r.getCharacteristic(Q.stateCharacteristic);return c("Characteristic:",n),new x(await y["3x3x3"].kpuzzle(),r,t,e,n)}name(){return this.server.device.name}disconnect(){this.server.disconnect()}onDisconnect(){this.dispatchEvent(new CustomEvent("disconnect"))}startTrackingMoves(){this.stateCharacteristic.addEventListener("characteristicvaluechanged",e=>this.onStateCharacteristic(e))}onStateCharacteristic(e){let t=this.decodeState(e.target.value);this.dispatchAlgLeaf({latestAlgLeaf:t.latestMove,timeStamp:e.timeStamp,state:t.state})}decodeState(e){let t=[new s("U"),new s("U'"),new s("B"),new s("B'"),new s("F"),new s("F'"),null,null,new s("L"),new s("L'"),new s("D"),new s("D'"),new s("R"),new s("R'")],r=new Uint8Array(e.byteLength);for(let l=0;l<e.byteLength;l++)r[l]=A(e.getUint8(l),8);let n=X(r.slice(0,11)),a={epLex:A(n.epLex,29),eoMask:A(n.eoMask,12),cpLex:A(n.cpLex,16),coMask:A(n.coMask,13),poIdxL:0,poIdxU:7,moSupport:1,moMask:0};return{state:Y(a),latestMove:t[r[20]&15]}}async getState(){let e=await this.stateCharacteristic.readValue();return this.decodeState(e).state}},de={connect:x.connect.bind(x),prefixes:["HEYKUBE"],filters:[{namePrefix:"HEYKUBE"}],optionalServices:[Q.heykubeService]};var st=[le,ve,de,me];async function be(i){return S(st,i)}function ct(i){return Array.prototype.map.call(new Uint8Array(i),o=>`00${o.toString(16)}`.slice(-2)).join(" ")}var V=18*2,lt=150,ut=250,we=new p("F B R2 L2 B' F'"),pt=we.invert(),Se=new p("U D R2 L2 D' U'"),mt=Se.invert(),M={ganRobotService:"0000fff0-0000-1000-8000-00805f9b34fb",statusCharacteristic:"0000fff2-0000-1000-8000-00805f9b34fb",moveCharacteristic:"0000fff3-0000-1000-8000-00805f9b34fb"},ge={R:0,R2:1,"R2'":1,"R'":2,F:3,F2:4,"F2'":4,"F'":5,D:6,D2:7,"D2'":7,"D'":8,L:9,L2:10,"L2'":10,"L'":11,B:12,B2:13,"B2'":13,"B'":14},ye={R:0,R2:1,"R2'":1,"R'":2,U:3,U2:4,"U2'":4,"U'":5,F:6,F2:7,"F2'":7,"F'":8,L:9,L2:10,"L2'":10,"L'":11,D:12,D2:13,"D2'":13,"D'":14};function ft(i){return i%3===1}function ht(i){return ft(i)?ut:lt}function vt(i){throw console.error("invalid move",i,i.toString()),new Error("invalid move!")}function _(i){return new Promise(o=>setTimeout(o,i))}var T=class extends EventTarget{constructor(e,t,r,n,a){super();this.server=t;this.statusCharacteristic=n;this.moveCharacteristic=a;this.experimentalDebugOnSend=null;this.experimentalDebugLog=()=>{};this.experimentalOptions={xAngle:!1,singleMoveFixHack:!1,bufferQueue:0,postSleep:0};this.locked=!1;this.moveQueue=new p;r.addEventListener("gattserverdisconnected",this.onDisconnect.bind(this))}static async connect(e,t){let r=await e.getPrimaryService(M.ganRobotService),n=await r.getCharacteristic(M.statusCharacteristic),a=await r.getCharacteristic(M.moveCharacteristic);return new T(r,e,t,n,a)}name(){return this.server.device.name}disconnect(){this.server.disconnect()}onDisconnect(){this.dispatchEvent(new CustomEvent("disconnect"))}moveToNibble(e){let t=(this.experimentalOptions.xAngle?ye:ge)[e.toString()]??null;return t===null&&vt(e),t}async writeNibbles(e){if(e.length>V)throw new Error(`Can only write ${V} nibbles at a time!`);let t=new Uint8Array(18),r;for(r=0;r<e.length;r++){let a=Math.floor(r/2);t[a]+=e[r],r%2===0&&(t[a]*=16)}e.length%2===1&&(t[Math.ceil(e.length/2)-1]+=15);for(let a=Math.ceil(e.length/2);a<18;a++)t[a]=255;let n=0;for(let a of e)n+=ht(a);for(this.experimentalDebugLog("WRITING:",ct(t)),await this.moveCharacteristic.writeValue(t),await _(n*.75);(await this.getStatus()).movesRemaining>0;);await _(this.experimentalOptions.postSleep)}async getStatus(){let e=new Uint8Array((await this.statusCharacteristic.readValue()).buffer);return this.experimentalDebugLog("moves remaining:",e[0]),{movesRemaining:e[0]}}processQueue(){}async queueMoves(e){if(this.moveQueue=this.moveQueue.concat(e).experimentalSimplify({puzzleSpecificSimplifyOptions:J.puzzleSpecificSimplifyOptions}),!this.locked)try{for(this.locked=!0,this.moveQueue.experimentalNumChildAlgNodes()===1&&await _(this.experimentalOptions.bufferQueue);this.moveQueue.experimentalNumChildAlgNodes()>0;){let t=Array.from(this.moveQueue.childAlgNodes());if(this.experimentalOptions.singleMoveFixHack&&t.length===1){let m=t[0];m.amount===2?t=[m.modified({amount:1}),m.modified({amount:1})]:t=[m.modified({amount:-m.amount}),m.modified({amount:2})]}let r=t.splice(0,V),n=r.map(this.moveToNibble.bind(this)),a=new p(r);this.experimentalDebugLog("SENDING",a.toString()),this.experimentalDebugOnSend&&this.experimentalDebugOnSend(a);let l=this.writeNibbles(n);this.moveQueue=new p(t),await l}}finally{this.locked=!1}}async applyMoves(e){for(let t of e)t.toString()in(this.experimentalOptions.xAngle?ye:ge)?await this.queueMoves(new p([t])):t.family===(this.experimentalOptions.xAngle?"B":"U")&&await Promise.all([this.queueMoves(this.experimentalOptions.xAngle?Se:we),this.queueMoves(new p([t.modified({family:this.experimentalOptions.xAngle?"F":"D"})]).concat(this.experimentalOptions.xAngle?mt:pt))])}},Ce={connect:T.connect.bind(T),prefixes:["GAN"],filters:[{namePrefix:"GAN"}],optionalServices:[M.ganRobotService]};var dt=[Ce];async function Ae(i){return S(dt,i)}var q={ganTimerService:"0000fff0-0000-1000-8000-00805f9b34fb",timeCharacteristic:"0000fff2-0000-1000-8000-00805f9b34fb"},B=class extends EventTarget{constructor(e,t,r,n){super();this.server=t;this.timeCharacteristic=n;this.polling=!1;this.previousDetail=null;this.startPolling(),console.log(t),r.addEventListener("gattserverdisconnected",this.onDisconnect.bind(this))}static async connect(e,t){let r=await e.getPrimaryService(q.ganTimerService);console.log("Service:",r);let n=await r.getCharacteristic(q.timeCharacteristic);return console.log("Characteristic:",n),new B(r,e,t,n)}disconnect(){this.server.disconnect()}async poll(){if(!this.polling)return;let e=await this.getTimeCharacteristic(),t={currentTime:this.decodeTimeMs(e.slice(0,4)),latestTimes:[this.decodeTimeMs(e.slice(4,8)),this.decodeTimeMs(e.slice(8,12)),this.decodeTimeMs(e.slice(12,16))]};t.currentTime===0&&this.previousDetail&&this.previousDetail.currentTime!==0&&this.dispatchEvent(new CustomEvent("reset")),t.currentTime!==0&&this.previousDetail&&(this.previousDetail.currentTime===0&&this.dispatchEvent(new CustomEvent("start")),t.currentTime!==this.previousDetail.currentTime&&(this.dispatchEvent(new CustomEvent("update",{detail:t})),t.currentTime===t.latestTimes[0]&&t.latestTimes[1]===this.previousDetail.latestTimes[0]&&t.latestTimes[2]===this.previousDetail.latestTimes[1]&&this.dispatchEvent(new CustomEvent("stop",{detail:t})))),this.previousDetail=t,this.poll()}onDisconnect(){this.dispatchEvent(new CustomEvent("disconnect"))}async getTimeCharacteristic(){return new Uint8Array((await this.timeCharacteristic.readValue()).buffer)}async getTime(){let e=await this.getTimeCharacteristic();return this.decodeTimeMs(e.slice(0,4))}decodeTimeMs(e){return(e[0]*60+e[1])*1e3+e[2]+e[3]*256}startPolling(){this.polling=!0,this.poll()}stopPolling(){this.polling=!1}},xe={connect:B.connect.bind(B),prefixes:["GAN"],filters:[{namePrefix:"GAN"}],optionalServices:[q.ganTimerService]};var bt=[xe];async function Te(i){return S(bt,i)}export{ee as a,z as b,ie as c,v as d,d as e,b as f,be as g,Ae as h,Te as i,gt as j};
//# sourceMappingURL=chunk-WX2LTJPA.js.map
