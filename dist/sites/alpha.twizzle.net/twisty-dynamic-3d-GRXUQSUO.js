import{a as _,b as q,c as K,d as J,e as ct,f as yt,g as D,h as j,i as G,j as tt,k as g,l as H,m as Q,n as V,o as Mt,p as et,q as xt,r as At}from"./chunk-FLCBQYY2.js";import{i as gt,k as T,t as Dt,w as Ft}from"./chunk-HTCOBPXI.js";import{d as at,n as wt}from"./chunk-D3X4C52T.js";import{j as vt}from"./chunk-ULM6IQGD.js";import"./chunk-OUWZ2PU5.js";function it(n){return n*n*n*(10-n*(15-6*n))}var Et=new xt,Pt=new g({color:4473924,side:K}),Gt=new g({color:13421772,side:q,transparent:!0,opacity:.75}),nt=new g({visible:!1}),Ut=new g({color:4513228}),Ot=new g({color:4513228,side:q,transparent:!0,opacity:.5}),L=class{constructor(e,t,r,i,s,o){this.vector=e;this.fromZ=t;this.color=r;this.dimColor=i;this.hintOpacityScale=s;this.stickerMaterial={regular:new g({color:r,side:_}),dim:new g({color:i,side:_}),oriented:Ut,ignored:Pt,invisible:nt},this.hintStickerMaterial={regular:new g({color:o?.hintColor??r,side:q,transparent:!0,opacity:.5*s}),dim:new g({color:o?.hintDimColor??i,side:q,transparent:!0,opacity:.5*s}),oriented:Ot,ignored:Gt,invisible:nt}}},U=[new L(new D(0,1,0),new G(-T/4,0,0),16777215,14540253,1.25),new L(new D(-1,0,0),new G(0,-T/4,0),16746496,8930304,1,{hintDimColor:10053120}),new L(new D(0,0,1),new G(0,0,0),65280,34816,1,{hintDimColor:39168}),new L(new D(1,0,0),new G(0,T/4,0),16711680,6684672,1,{hintDimColor:10027008}),new L(new D(0,0,-1),new G(0,T/2,0),2254591,1127304,.75,{hintDimColor:6246}),new L(new D(0,-1,0),new G(T/4,0,0),16776960,8947712,1.25,{hintDimColor:12303104})],d={U:0,L:1,F:2,R:3,B:4,D:5},Bt={U:d.U,u:d.U,Uw:d.U,Uv:d.U,y:d.U,L:d.L,l:d.L,Lw:d.L,Lv:d.L,M:d.L,F:d.F,f:d.F,Fw:d.F,Fv:d.F,S:d.F,z:d.F,R:d.R,r:d.R,Rw:d.R,Rv:d.R,x:d.R,B:d.B,b:d.B,Bw:d.B,Bv:d.B,D:d.D,d:d.D,Dw:d.D,Dv:d.D,E:d.D},W={stickerElevation:.503,foundationWidth:1,hintStickerElevation:1.45},It=2;var Ht={showMainStickers:!0,hintFacelets:"floating",showFoundation:!0,experimentalStickeringMask:void 0,foundationSprite:null,hintSprite:null,initialHintFaceletsAnimation:"auto",faceletScale:"auto"},Lt=.85;function lt(n){return typeof n.faceletScale>"u"||n.faceletScale==="auto"?Lt:n.faceletScale}var Nt=new g({color:0,opacity:1,transparent:!0}),jt=new g({color:0,opacity:.3,transparent:!0}),S=class{constructor(e,t,r){this.orbit=e;let i=typeof t=="string"?t.split(""):t;this.stickerFaces=i.map(s=>d[s]),this.matrix=new j,this.matrix.setPosition(st[e]),this.matrix.premultiply(new j().makeRotationFromQuaternion(r))}};function h(n,e){return new yt().setFromAxisAngle(n,T*e/4)}var p={O:new D(0,0,0),U:new D(0,-1,0),L:new D(1,0,0),F:new D(0,0,-1),R:new D(-1,0,0),B:new D(0,0,1),D:new D(0,1,0)},st={EDGES:new D(0,1,1),CORNERS:new D(1,1,1),CENTERS:new D(0,1,0)},Vt={EDGES:[0,1].map(n=>new j().makeRotationAxis(st.EDGES.clone().normalize(),-n*T/2)),CORNERS:[0,1,2].map(n=>new j().makeRotationAxis(st.CORNERS.clone().normalize(),-n*T/3)),CENTERS:[0,1,2,3].map(n=>new j().makeRotationAxis(st.CENTERS.clone().normalize(),-n*T/4))},ut=[d.U,d.F,d.R],X={EDGES:[new S("EDGES","UF",h(p.O,0)),new S("EDGES","UR",h(p.U,3)),new S("EDGES","UB",h(p.U,2)),new S("EDGES","UL",h(p.U,1)),new S("EDGES","DF",h(p.F,2)),new S("EDGES","DR",h(p.F,2).premultiply(h(p.D,1))),new S("EDGES","DB",h(p.F,2).premultiply(h(p.D,2))),new S("EDGES","DL",h(p.F,2).premultiply(h(p.D,3))),new S("EDGES","FR",h(p.U,3).premultiply(h(p.R,3))),new S("EDGES","FL",h(p.U,1).premultiply(h(p.R,3))),new S("EDGES","BR",h(p.U,3).premultiply(h(p.R,1))),new S("EDGES","BL",h(p.U,1).premultiply(h(p.R,1)))],CORNERS:[new S("CORNERS","UFR",h(p.O,0)),new S("CORNERS","URB",h(p.U,3)),new S("CORNERS","UBL",h(p.U,2)),new S("CORNERS","ULF",h(p.U,1)),new S("CORNERS","DRF",h(p.F,2).premultiply(h(p.D,1))),new S("CORNERS","DFL",h(p.F,2).premultiply(h(p.D,0))),new S("CORNERS","DLB",h(p.F,2).premultiply(h(p.D,3))),new S("CORNERS","DBR",h(p.F,2).premultiply(h(p.D,2)))],CENTERS:[new S("CENTERS","U",h(p.O,0)),new S("CENTERS","L",h(p.R,3).premultiply(h(p.U,1))),new S("CENTERS","F",h(p.R,3)),new S("CENTERS","R",h(p.R,3).premultiply(h(p.D,1))),new S("CENTERS","B",h(p.R,3).premultiply(h(p.D,2))),new S("CENTERS","D",h(p.R,2))]},ht=1/3,rt={EDGES:[[[0,4,6],[0,4,5]],[[3,5,7],[0,7,5]],[[2,4,8],[0,10,5]],[[1,3,7],[0,1,5]],[[2,4,2],[2,4,3]],[[3,5,1],[2,7,3]],[[0,4,0],[2,10,3]],[[1,3,1],[2,1,3]],[[3,5,4],[3,6,4]],[[1,3,4],[1,2,4]],[[1,9,4],[1,8,4]],[[3,11,4],[3,0,4]]],CORNERS:[[[0,5,6],[0,5,5],[0,6,5]],[[3,5,8],[0,8,5],[0,9,5]],[[2,3,8],[0,11,5],[0,0,5]],[[1,3,6],[0,2,5],[0,3,5]],[[3,5,2],[2,6,3],[2,5,3]],[[2,3,2],[2,3,3],[2,2,3]],[[1,3,0],[2,0,3],[2,11,3]],[[0,5,0],[2,9,3],[2,8,3]]],CENTERS:[[[0,4,7]],[[0,1,4]],[[0,4,4]],[[0,7,4]],[[0,10,4]],[[0,4,1]]]},zt=null;function Wt(){return zt??(zt=new Mt(W.foundationWidth,W.foundationWidth,W.foundationWidth))}function pt(){let n=new Q,e=.5;return n.setAttribute("position",new H(new Float32Array([e,e,0,-e,e,0,e,-e,0,-e,e,0,-e,-e,0,e,-e,0]),3)),n.setAttribute("uv",new H(new Float32Array([1,1,0,1,1,0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,1,1]),2)),n}var Tt=null;function _t(){return Tt??(Tt=pt())}var Z=class extends tt{constructor(t,r,i={}){super();this.kpuzzle=t;this.scheduleRenderCallback=r;this.pieces={};this.experimentalHintStickerMeshes=[];this.experimentalFoundationMeshes=[];this.sprite=new Promise(t=>{this.setSpriteURL=r=>{Et.load(r,t)}});this.hintSprite=new Promise(t=>{this.setHintSpriteURL=r=>{Et.load(r,t)}});this.#t=null;if(this.options={...Ht},Object.assign(this.options,i),this.kpuzzle.name()!=="3x3x3")throw new Error(`Invalid puzzle for this Cube3D implementation: ${this.kpuzzle.name()}`);i.foundationSprite&&this.setSprite(i.foundationSprite),i.hintSprite&&this.setHintSprite(i.hintSprite),this.kpuzzleFaceletInfo={};for(let s in X){let o=[];this.kpuzzleFaceletInfo[s]=o,this.pieces[s]=X[s].map(this.createCubie.bind(this,s,o))}this.scale.set(ht,ht,ht),this.options.experimentalStickeringMask&&this.setStickeringMask(this.options.experimentalStickeringMask),this.#i(),this.options.faceletScale&&this.experimentalSetFaceletScale(this.options.faceletScale)}setSprite(t){this.sprite=t}setHintSprite(t){this.hintSprite=t}#t;#e(){return this.#t??(this.#t=pt())}#i(){if(this.options.initialHintFaceletsAnimation==="none"||this.options.initialHintFaceletsAnimation!=="always"&&Dt())return;let t=W.hintStickerElevation-W.stickerElevation;this.#e().translate(0,0,-t),setTimeout(()=>{let r=performance.now(),i=0,s=1e3;function o(c){return c*(2-c)}let a=()=>{let c=performance.now()-r,m=o(c/s)*t;this.#e().translate(0,0,m-i),i=m,c<s&&(requestAnimationFrame(a),this.scheduleRenderCallback?.())};a()},500)}experimentalSetStickerSpriteURL(t){this.setSpriteURL(t)}experimentalSetHintStickerSpriteURL(t){this.setHintSpriteURL(t)}setStickeringMask(t){if(t.specialBehaviour==="picture"){for(let r of Object.values(this.kpuzzleFaceletInfo))for(let i of r)for(let s of i){s.facelet.material=nt;let{hintFacelet:o}=s;o&&(o.material=nt)}return}this.options.experimentalStickeringMask=t;for(let[r,i]of Object.entries(t.orbits))for(let s=0;s<i.pieces.length;s++){let o=i.pieces[s];if(o){let a=this.kpuzzleFaceletInfo[r][s];for(let c=0;c<a.length;c++){let m=o.facelets[c];if(m){let f=a[c],b=typeof m=="string"?m:m?.mask;f.facelet.material=U[f.faceIdx].stickerMaterial[b];let y=typeof m=="string"?b:m.hintMask??b;f.hintFacelet&&(f.hintFacelet.material=U[f.faceIdx].hintStickerMaterial[y])}}}}this.scheduleRenderCallback&&this.scheduleRenderCallback()}experimentalUpdateOptions(t){if("showMainStickers"in t)throw new Error("Unimplemented");let r=t.showFoundation;if(typeof r<"u"&&this.options.showFoundation!==r){this.options.showFoundation=r;for(let a of this.experimentalFoundationMeshes)a.visible=r}let i=t.hintFacelets;if(typeof i<"u"&&this.options.hintFacelets!==i&&gt[i]){this.options.hintFacelets=i;for(let a of this.experimentalHintStickerMeshes)a.visible=i==="floating";this.scheduleRenderCallback()}let{experimentalStickeringMask:s}=t;typeof s<"u"&&(this.options.experimentalStickeringMask=s,this.setStickeringMask(s),this.scheduleRenderCallback());let{faceletScale:o}=t;typeof o<"u"&&this.experimentalSetFaceletScale(o)}onPositionChange(t){let r=t.state;for(let i in X){let s=X[i];for(let o=0;o<s.length;o++){let a=r.stateData[i].pieces[o];this.pieces[i][a].matrix.copy(X[i][o].matrix),this.pieces[i][a].matrix.multiply(Vt[i][r.stateData[i].orientation[o]])}for(let o of t.movesInProgress){let a=o.move,c=U[Bt[a.family]].vector,m=new j().makeRotationAxis(c,-this.ease(o.fraction)*o.direction*a.amount*T/4);for(let f=0;f<s.length;f++){let b=this.kpuzzle.moveToTransformation(a.modified({amount:1})),y=b.transformationData[i].permutation[f];if(f!==y||b.transformationData[i].orientation[f]!==0){let v=r.stateData[i].pieces[f];this.pieces[i][v].matrix.premultiply(m)}}}}this.scheduleRenderCallback()}createCubie(t,r,i,s){let o=[];r.push(o);let a=new et;if(this.options.showFoundation){let c=this.createCubieFoundation();a.add(c),this.experimentalFoundationMeshes.push(c)}for(let c=0;c<i.stickerFaces.length;c++){let m=this.createSticker(U[ut[c]],U[i.stickerFaces[c]],!1),f={faceIdx:i.stickerFaces[c],facelet:m};if(a.add(m),this.options.hintFacelets==="floating"){let b=this.createSticker(U[ut[c]],U[i.stickerFaces[c]],!0);a.add(b),f.hintFacelet=b,this.experimentalHintStickerMeshes.push(b)}if(this.options.experimentalStickeringMask?.specialBehaviour==="picture"&&rt[t]&&rt[t][s]&&rt[t][s][c]){let[b,y,v]=rt[t][s][c];(async()=>{let l=async F=>{let P=await(F?this.hintSprite:this.sprite),E=this.createSticker(U[ut[c]],U[i.stickerFaces[c]],F);E.material=new g({map:P,side:F?q:K,transparent:!0});let C=y/12,A=(y+1)/12,B=v/9,R=(v+1)/9,z=new J(C,B),M=new J(C,R),w=new J(A,R),u=new J(A,B);switch(b){case 1:{[z,M,w,u]=[M,w,u,z];break}case 2:{[z,M,w,u]=[w,u,z,M];break}case 3:{[z,M,w,u]=[u,z,M,w];break}}E.geometry.setAttribute("uv",new H(new Float32Array([w.x,w.y,M.x,M.y,u.x,u.y,M.x,M.y,z.x,z.y,u.x,u.y]),2)),a.add(E)};l(!0),l(!1)})()}o.push(f)}return a.matrix.copy(i.matrix),a.matrixAutoUpdate=!1,this.add(a),a}createCubieFoundation(){let t=Wt();return new V(t,this.options.experimentalStickeringMask?.specialBehaviour==="picture"?Nt:jt)}createSticker(t,r,i){let s=this.options.experimentalStickeringMask?.specialBehaviour==="picture"?pt():i?this.#e():_t(),o=new V(s,i?r.hintStickerMaterial.regular:r.stickerMaterial.regular);return o.setRotationFromEuler(t.fromZ),o.position.copy(t.vector),o.position.multiplyScalar(i?this.options.experimentalStickeringMask?.specialBehaviour==="picture"?It:W.hintStickerElevation:W.stickerElevation),o.scale.setScalar(lt(this.options)),o}experimentalSetFoundationOpacity(t){this.experimentalFoundationMeshes[0].material.opacity=t}experimentalSetFaceletScale(t){this.options.faceletScale=t;for(let r of Object.values(this.kpuzzleFaceletInfo))for(let i of r)for(let s of i)s.facelet.scale.setScalar(lt(this.options)),s.hintFacelet?.scale.setScalar(lt(this.options))}ease(t){return it(t)}};var Rt=new g({side:K,color:0}),N=new g({visible:!1}),$=new g({vertexColors:!0});function ft(n,e,t){return Math.hypot(n[3*e]-n[3*t],n[3*e+1]-n[3*t+1],n[3*e+2]-n[3*t+2])}function qt(n,e,t,r){let i=ft(n,e,t),s=ft(n,t,r),o=ft(n,e,r),a=(i+s+o)/2;return Math.sqrt(a*(a-i)*(a-s)*(a-o))}function Kt(n){let e=0;for(let t=2;3*t<n.length;t++)e+=qt(n,0,1,t);return e}function Jt(n){let e=Math.hypot(n[0],n[1],n[2]);return n[0]/=e,n[1]/=e,n[2]/=e,n}function Qt(n,e){let t=new Array(3);return t[0]=n[1]*e[2]-n[2]*e[1],t[1]=n[2]*e[0]-n[0]*e[2],t[2]=n[0]*e[1]-n[1]*e[0],t}function Xt(n){let e=[n[3]-n[0],n[4]-n[1],n[5]-n[2]],t=[n[6]-n[3],n[7]-n[4],n[8]-n[5]],r=Qt(e,t);return Jt(r)}function Zt(n,e){let t=[],r=new Array(3),i=new Array(3);for(let s=1;s<10;s++){for(let a=0;a<n.length;a+=3){let c=(a+n.length-3)%n.length,m=(a+3)%n.length;for(let l=0;l<3;l++)r[l]=n[c+l]-n[a+l],i[l]=n[m+l]-n[a+l];let f=Math.hypot(r[0],r[1],r[2]),b=Math.hypot(i[0],i[1],i[2]);for(let l=0;l<3;l++)r[l]/=f,i[l]/=b;let y=r[0]*i[0]+r[1]*i[1]+r[2]*i[2],v=e/Math.sqrt(1-y*y);for(let l=0;l<3;l++)t[a+l]=n[a+l]+(r[l]+i[l])*v}let o=!0;for(let a=0;o&&a<t.length;a+=3){let c=(a+3)%n.length,m=0;for(let f=0;f<3;f++){let b=n[c+f]-n[a+f],y=t[c+f]-t[a+f];m+=b*y}m<=0&&(o=!1)}if(o)return t;e/=2}return n}var ot=class{constructor(e,t){this.sz=e;this.tm=t;this.vertices=new Float32Array(9*e),this.uvs=void 0,this.colors=new Uint8Array(18*e),this.ind=new Uint8Array(e),this.pos=0,this.ipos=0}add(e,t,r){this.vertices[this.pos]=e[3*t+0],this.vertices[this.pos+1]=e[3*t+1],this.vertices[this.pos+2]=e[3*t+2],this.colors[this.pos]=r>>16,this.colors[this.pos+1]=r>>8&255,this.colors[this.pos+2]=r&255,this.pos+=3}addUncolored(e,t){this.vertices[this.pos]=e[3*t+0],this.vertices[this.pos+1]=e[3*t+1],this.vertices[this.pos+2]=e[3*t+2],this.pos+=3}setind(e){this.ind[this.ipos++]=e}makePoly(e,t,r){let i=e;for(let s=1;3*(s+1)<i.length;s++)this.add(i,0,t),this.add(i,s,t),this.add(i,s+1,t),this.setind(r)}setAttributes(e){e.setAttribute("position",new H(this.vertices,3));let t=this.colors.subarray(0,9*this.sz);e.setAttribute("color",new H(t,3,!0))}makeGroups(e){e.clearGroups();for(let t=0;t<this.ipos;){let r=t++,i=this.ind[r];for(;this.ind[t]===i;)t++;e.addGroup(3*r,3*(t-r),i)}}saveOriginalColors(){this.colors.copyWithin(this.pos,0,this.pos)}},mt=class{constructor(e,t,r,i){this.texturePtr=void 0;this.twistVal=-1;this.isDup=!!t.isDup,this.faceNum=t.face,this.stickerStart=e.ipos;let s=new ct(t.color).getHex();this.origColor=s,this.origColorStickeringMask=s,i?.stickeringMask&&this.setStickeringMask(e,i.stickeringMask),this.faceColor=s;let o=this.stickerCoords(t.coords,r);e.makePoly(o,this.faceColor,this.isDup?4:0),this.stickerEnd=e.ipos}stickerCoords(e,t){return Zt(e.slice(),t)}hintCoords(e,t,r,i){e=this.stickerCoords(e,r),i=i.slice();for(let o=0;o<3;o++)i[o]*=.5*t;let s=new Array(e.length);for(let o=0;3*o<e.length;o++){let a=e.length/3-1-o;s[3*o]=e[3*a]+i[0],s[3*o+1]=e[3*a+1]+i[1],s[3*o+2]=e[3*a+2]+i[2]}return s}foundationCoords(e){let t=e.slice();for(let r=0;r<e.length;r++)t[r]=e[r]*.999;return t}addHint(e,t,r,i,s,o){this.hintStart=e.ipos;let a=this.hintCoords(t.coords,i,s,o);e.makePoly(a,this.faceColor,r&&!this.isDup?2:4),this.hintEnd=e.ipos}addFoundation(e,t,r){this.foundationStart=e.ipos;let i=this.foundationCoords(t.coords);e.makePoly(i,r,this.isDup?4:6),this.foundationEnd=e.ipos}setHintStickers(e,t){let r=this.isDup||!t?4:2;for(let i=this.hintStart;i<this.hintEnd;i++)e.ind[i]=r|e.ind[i]&1}setStickeringMask(e,t){let r=0;switch(t){case"regular":{r=this.origColor;break}case"dim":{this.origColor===16777215?r=14540253:r=new ct(this.origColor).multiplyScalar(.5).getHex();break}case"oriented":{r=16746751;break}case"ignored":{r=4473924;break}case"invisible":r=this.origColor}this.origColorStickeringMask=r;for(let i=9*this.stickerStart;i<9*this.stickerEnd;i+=3)e.colors[e.pos+i]=r>>16,e.colors[e.pos+i+1]=r>>8&255,e.colors[e.pos+i+2]=r&255;for(let i=9*this.hintStart;i<9*this.hintEnd;i+=3)e.colors[e.pos+i]=r>>16,e.colors[e.pos+i+1]=r>>8&255,e.colors[e.pos+i+2]=r&255;this.setHintStickers(e,t!=="invisible"&&!this.isDup)}addUVs(e){let t=e.uvs,r=e.vertices,i=new Array(3);for(let s=3*this.stickerStart;s<3*this.stickerEnd;s++){i[0]=r[3*s],i[1]=r[3*s+1],i[2]=r[3*s+2];let o=e.tm.getuv(this.faceNum,i);t[2*s]=o[0],t[2*s+1]=o[1]}for(let s=3*this.hintStart;s<3*this.hintEnd;s++){i[0]=r[3*s],i[1]=r[3*s+1],i[2]=r[3*s+2];let o=e.tm.getuv(this.faceNum,i);t[2*s]=o[0],t[2*s+1]=o[1]}}setTexture(e,t){if(this.texturePtr===t)return 0;this.texturePtr=t;let r=6*e.sz;return e.uvs.copyWithin(6*this.stickerStart,6*t.stickerStart+r,6*t.stickerEnd+r),e.uvs.copyWithin(6*this.hintStart,6*t.hintStart+r,6*t.hintEnd+r),1}setColor(e,t){let r=t.origColorStickeringMask;if(this.faceColor!==r){this.faceColor=r;let i=e.pos;return e.colors.copyWithin(9*this.stickerStart,9*t.stickerStart+i,9*t.stickerEnd+i),e.colors.copyWithin(9*this.hintStart,9*t.hintStart+i,9*t.hintEnd+i),1}else return 0}},dt=class{constructor(e,t,r){this.cubie=new et;let i=e.coords,s=new ot(i.length/3-2,t);for(let a=1;3*a+3<i.length;a++)s.addUncolored(i,0),s.addUncolored(i,a),s.addUncolored(i,a+1);this.geo=new Q,s.setAttributes(this.geo);let o=new V(this.geo,N);o.userData.quantumMove=r.notationMapper.notationToExternal(new vt(e.name)),this.cubie.scale.setScalar(.99),this.cubie.add(o)}},bt=class{constructor(e){let t=e.coordinates;this.axis=new D(t[0],t[1],t[2]),this.order=e.order}},$t=.71,O=.5,Y=class extends tt{constructor(t,r,i,s=!1,o=!1,a=1,c=1,m={}){super();this.scheduleRenderCallback=t;this.kpuzzle=r;this.stickerDat=i;this.faceletScale=c;this.params=m;this.stickerTargets=[];this.controlTargets=[];this.textured=!1;this.showHintStickers=!1;this.showFoundations=!1;this.#t=!1;if(i.stickers.length===0)throw Error("Reuse of stickerdat from pg; please don't do that.");this.hintMaterial=new g({vertexColors:!0,transparent:!0,opacity:.5}),this.hintMaterialDisposable=!0,this.stickerMaterial=$,this.stickerMaterialDisposable=!1,this.axesInfo={};let f=this.stickerDat.axis;for(let u of f)this.axesInfo[u.quantumMove.family]=new bt(u);let b=this.stickerDat.stickers;this.stickers={},this.materialArray1=new Array(8),this.materialArray2=new Array(8),this.showFoundation(s),s=!0;let y=0,v=3;for(let u of b){let x=u.coords.length/3;y+=v*(x-2)}let l=new ot(y,i.textureMapper),F=0,P=[],E=0;for(let u of i.faces)P.push(Xt(u.coords)),E+=Kt(u.coords);let C=c!=="auto"?c*c:$t,A=0;for(let u of b)u.isDup||A++;let B=Math.sqrt(E/A)*(1-Math.sqrt(C))/2;for(let u of b){let x=u.orbit,k=u.ord,I=u.ori;this.stickers[x]||(this.stickers[x]=[]),this.stickers[x][I]||(this.stickers[x][I]=[]);let St={};m.stickeringMask&&(St.stickeringMask=at(m.stickeringMask,x,k,I,!1));let Ct=new mt(l,u,B,St);this.stickers[x][I][k]=Ct}this.showHintStickers=o,o=!0;for(let u of b){let x=u.orbit,k=u.ord,I=u.ori;this.stickers[x][I][k].addHint(l,u,o,a,B,P[u.face])}this.foundationBound=l.ipos;for(let u of b){let x=u.orbit,k=u.ord,I=u.ori;s&&this.stickers[x][I][k].addFoundation(l,u,F)}let R=new Q;l.setAttributes(R),l.makeGroups(R);let z=new V(R,this.materialArray1);z.scale.set(O,O,O),this.add(z);let M=new V(R,this.materialArray2);M.scale.set(O,O,O),this.add(M);let w=this.stickerDat.faces;this.movingObj=M,this.fixedGeo=R,this.filler=l;for(let u of w){let x=new dt(u,i.textureMapper,this.stickerDat);x.cubie.scale.set(O,O,O),this.add(x.cubie),this.controlTargets.push(x.cubie.children[0])}l.saveOriginalColors(),i.stickers=[],this.updateMaterialArrays()}#t;dispose(){this.fixedGeo&&this.fixedGeo.dispose(),this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterial=$,this.stickerMaterialDisposable=!1),this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterial=$,this.hintMaterialDisposable=!1)}experimentalGetStickerTargets(){return this.stickerTargets}experimentalGetControlTargets(){return this.controlTargets}#e(t){try{return this.kpuzzle.moveToTransformation(t),!0}catch{return!1}}getClosestMoveToAxis(t,r){let i=null,s=0,o=c=>c;switch(r.depth){case"secondSlice":{o=c=>c.modified({innerLayer:2});break}case"rotation":{o=c=>c.modified({family:`${c.family}v`});break}}for(let c of this.stickerDat.axis){let m=t.dot(new D(...c.coordinates));if(m>s){let f=this.stickerDat.notationMapper.notationToExternal(o(c.quantumMove));if(!f)continue;this.#e(f)&&(s=m,i=f)}}if(!i)return null;r.invert&&(i=i.invert());let a=this.kpuzzle.moveToTransformation(i).repetitionOrder();return{move:i,order:a}}setStickeringMask(t){if(this.params.stickeringMask=t,t.specialBehaviour!=="picture")for(let r in this.kpuzzle.definition.orbits){let{numPieces:i,numOrientations:s}=this.kpuzzle.definition.orbits[r];for(let o=0;o<i;o++)for(let a=0;a<s;a++){let c=at(t,r,o,a,!1),m=this.stickers[r][a][o];this.textured&&this.hintMaterialDisposable&&c==="invisible"||m.setStickeringMask(this.filler,c)}}this.#t=!0,this.lastPos&&this.onPositionChange(this.lastPos)}onPositionChange(t){let r=t.state.experimentalToTransformation();if(!r)throw new Error("indistinguishable pieces are not supported by PG3D yet");let i=new G;this.movingObj.rotation.copy(i);let s=0,o=this.filler,a=o.ind;if(!this.lastPos||this.#t||!this.lastPos.state.experimentalToTransformation().isIdentical(r)){for(let m in this.stickers){let f=this.stickers[m],b=r.transformationData[m],y=f.length;if(y===1){let v=f[0];for(let l=0;l<v.length;l++){let F=b.permutation[l];this.textured?s+=v[l].setTexture(o,v[F]):s+=v[l].setColor(o,v[F])}}else for(let v=0;v<y;v++){let l=f[v];for(let F=0;F<l.length;F++){let P=(v+y-b.orientation[F])%y,E=b.permutation[F];this.textured?s+=l[F].setTexture(o,f[P][E]):s+=l[F].setColor(o,f[P][E])}}}this.lastPos=t}let c=0;for(let m of t.movesInProgress){let f=m.move,b=this.stickerDat.unswizzle(f);if(!b)return;let y=f,v;try{v=this.kpuzzle.moveToTransformation(y.modified({amount:1}))}catch(E){let C=this.stickerDat.notationMapper.notationToInternal(y);if(C){let A=this.stickerDat.notationMapper.notationToExternal(C.modified({amount:1}));A&&(v=this.kpuzzle.moveToTransformation(A))}if(!v)throw console.log(E),E}let l=this.axesInfo[b.family],F=l.axis,P=-this.ease(m.fraction)*m.direction*b.amount*T/l.order;if(this.movingObj.rotateOnAxis(F,P),this.lastMoveTransformation!==v){for(let E in this.stickers){let C=this.stickers[E],A=C.length,B=v.transformationData[E];for(let R=0;R<A;R++){let z=C[R];for(let M=0;M<z.length;M++){let w=z[M],u=B.permutation[M],x=0;if((u!==M||B.orientation[M]!==0)&&(x=1),x!==w.twistVal){if(x){for(let k=w.stickerStart;k<w.stickerEnd;k++)a[k]|=1;for(let k=w.hintStart;k<w.hintEnd;k++)a[k]|=1;for(let k=w.foundationStart;k<w.foundationEnd;k++)a[k]|=1}else{for(let k=w.stickerStart;k<w.stickerEnd;k++)a[k]&=-2;for(let k=w.hintStart;k<w.hintEnd;k++)a[k]&=-2;for(let k=w.foundationStart;k<w.foundationEnd;k++)a[k]&=-2}w.twistVal=x,c++}}}}this.lastMoveTransformation=v}}(this.#t||c)&&this.filler.makeGroups(this.fixedGeo),(this.#t||s)&&(this.textured&&(this.fixedGeo.getAttribute("uv").updateRange={offset:0,count:6*this.foundationBound},this.fixedGeo.getAttribute("uv").needsUpdate=!0),(this.#t||!this.textured)&&(this.fixedGeo.getAttribute("color").updateRange={offset:0,count:9*this.foundationBound},this.fixedGeo.getAttribute("color").needsUpdate=!0)),this.scheduleRenderCallback(),this.#t=!1}ease(t){return it(t)}showHintFacelets(t){this.showHintStickers=t}updateMaterialArrays(){for(let t=0;t<8;t++)this.materialArray1[t]=N,this.materialArray2[t]=N;this.materialArray1[0]=this.stickerMaterial,this.materialArray2[1]=this.stickerMaterial,this.showHintStickers?(this.materialArray1[2]=this.hintMaterial,this.materialArray2[3]=this.hintMaterial):(this.materialArray1[2]=N,this.materialArray2[3]=N),this.showFoundations?(this.materialArray1[6]=Rt,this.materialArray2[7]=Rt):(this.materialArray1[6]=N,this.materialArray2[7]=N)}showFoundation(t){this.showFoundations=t}setHintStickerOpacity(t){this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),t===0?this.hintMaterial=N:t===1?this.hintMaterial=this.stickerMaterial:(this.hintMaterial=new g({vertexColors:!0,transparent:!0,opacity:t}),this.hintMaterialDisposable=!0)}experimentalUpdateOptions(t){t.hintFacelets!==void 0&&this.showHintFacelets(t.hintFacelets!=="none"),t.showFoundation!==void 0&&this.showFoundation(t.showFoundation),t.hintStickerOpacity!==void 0&&this.setHintStickerOpacity(t.hintStickerOpacity),this.#t=!0,this.lastPos&&this.onPositionChange(this.lastPos),typeof t.faceletScale<"u"&&t.faceletScale!==this.faceletScale&&console.warn("Dynamic facelet scale is not yet supported for PG3D. For now, re-create the TwistyPlayer to change the facelet scale."),this.updateMaterialArrays(),this.scheduleRenderCallback()}adduvs(){let t=this.filler;if(t.uvs)return;this.filler.uvs=new Float32Array(12*t.sz);for(let i in this.stickers){let s=this.stickers[i],o=s.length;for(let a=0;a<o;a++){let c=s[a];for(let m of c)m.addUVs(this.filler)}}t.uvs.copyWithin(6*t.sz,0,6*t.sz);let r=t.uvs.subarray(0,6*t.sz);this.fixedGeo.setAttribute("uv",new H(r,2,!0))}experimentalUpdateTexture(t,r,i){r||(t=!1),t&&!this.filler.uvs&&this.adduvs(),this.textured=t,this.stickerMaterialDisposable&&(this.stickerMaterial.dispose(),this.stickerMaterialDisposable=!1),t?(this.stickerMaterial=new g({map:r,side:_,transparent:!1}),this.stickerMaterialDisposable=!0):this.stickerMaterial=$,this.hintMaterialDisposable&&(this.hintMaterial.dispose(),this.hintMaterialDisposable=!1),t?(this.hintMaterial=new g({map:i,side:_,transparent:!0}),this.hintMaterialDisposable=!0):this.hintMaterial=$,t&&this.showHintFacelets(i!==null),this.updateMaterialArrays(),this.#t=!0,this.lastPos&&this.onPositionChange(this.lastPos),this.scheduleRenderCallback()}};var kt=class{constructor(){this.renderTargets=new Set;this.twisty3Ds=new Set;this.threeJSScene=(async()=>new(await Ft).Scene)()}addRenderTarget(e){this.renderTargets.add(e)}scheduleRender(){for(let e of this.renderTargets)e.scheduleRender()}async addTwisty3DPuzzle(e){this.twisty3Ds.add(e),(await this.threeJSScene).add(e)}async removeTwisty3DPuzzle(e){this.twisty3Ds.delete(e),(await this.threeJSScene).remove(e)}async clearPuzzles(){for(let e of this.twisty3Ds)(await this.threeJSScene).remove(e);this.twisty3Ds.clear()}};async function De(n,e){return new Z(await wt.kpuzzle(),n,e)}async function Fe(n,e,t,r){return new Y(n,await e.kpuzzle(),(await e.pg()).get3d(),!0,t==="floating",void 0,r)}export{Z as Cube3D,Y as PG3D,At as T3I,kt as Twisty3DScene,De as cube3DShim,Fe as pg3dShim};
//# sourceMappingURL=twisty-dynamic-3d-GRXUQSUO.js.map
