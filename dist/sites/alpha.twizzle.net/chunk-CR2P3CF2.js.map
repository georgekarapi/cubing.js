{
  "version": 3,
  "sources": ["../../../src/cubing/twisty/model/props/puzzle/display/StickeringRequestProp.ts", "../../../src/cubing/twisty/model/helpers.ts", "../../../src/cubing/twisty/controllers/TwistyAnimationController.ts", "../../../src/cubing/twisty/controllers/TwistyPlayerController.ts", "../../../src/cubing/twisty/model/props/viewer/ControlPanelProp.ts", "../../../src/cubing/twisty/views/TwistyViewerWrapper.css.ts", "../../../src/cubing/twisty/views/2D/KPuzzleSVGWrapper.ts", "../../../src/cubing/twisty/views/2D/Twisty2DPuzzle.css.ts", "../../../src/cubing/twisty/views/2D/Twisty2DPuzzle.ts", "../../../src/cubing/twisty/views/2D/Twisty2DPuzzleWrapper.ts", "../../../src/cubing/twisty/views/2D/Twisty2DSceneWrapper.ts", "../../../src/cubing/twisty/views/ClassListManager.ts", "../../../src/cubing/twisty/views/InitialValueTracker.ts", "../../../src/cubing/twisty/views/3D/Twisty3DPuzzleWrapper.ts", "../../../src/cubing/twisty/views/3D/Twisty3DSceneWrapper.ts", "../../../src/cubing/twisty/views/control-panel/TwistyButtons.css.ts", "../../../src/cubing/twisty/views/document.ts", "../../../src/cubing/twisty/views/control-panel/webkit-fullscreen.ts", "../../../src/cubing/twisty/model/props/viewer/ButtonAppearanceProp.ts", "../../../src/cubing/twisty/views/control-panel/TwistyButtons.ts", "../../../src/cubing/twisty/views/control-panel/TwistyScrubber.css.ts", "../../../src/cubing/twisty/views/control-panel/TwistyScrubber.ts", "../../../src/cubing/twisty/views/screenshot.ts", "../../../src/cubing/twisty/views/TwistyPlayer.css.ts", "../../../src/cubing/twisty/model/props/general/ArbitraryStringProp.ts", "../../../src/cubing/twisty/model/props/general/URLProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/AlgProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/AlgTransformationProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/AnchorTransformationProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/CatchUpMoveProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/CurrentLeavesSimplified.ts", "../../../src/cubing/twisty/model/props/puzzle/state/CurrentMoveInfoProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/CurrentStateProp.ts", "../../../src/cubing/twisty/controllers/indexer/AlgDuration.ts", "../../../src/cubing/twisty/controllers/indexer/SimpleAlgIndexer.ts", "../../../src/cubing/twisty/controllers/indexer/simultaneous-moves/simul-moves.ts", "../../../src/cubing/twisty/controllers/indexer/simultaneous-moves/SimultaneousMoveIndexer.ts", "../../../src/cubing/twisty/controllers/indexer/tree/AlgWalker.ts", "../../../src/cubing/twisty/controllers/indexer/tree/chunkAlgs.ts", "../../../src/cubing/twisty/controllers/indexer/tree/TreeAlgIndexer.ts", "../../../src/cubing/twisty/model/props/puzzle/state/IndexerConstructorProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/IndexerConstructorRequestProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/IndexerProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/LegacyPositionProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/NaiveMoveCountProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/PuzzleAlgProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/SetupAnchorProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/SetupTransformationProp.ts", "../../../src/cubing/twisty/model/props/puzzle/structure/KPuzzleProp.ts", "../../../src/cubing/twisty/model/props/puzzle/structure/PuzzleDescriptionProp.ts", "../../../src/cubing/twisty/model/props/puzzle/structure/PuzzleIDProp.ts", "../../../src/cubing/twisty/model/props/puzzle/structure/PuzzleIDRequestProp.ts", "../../../src/cubing/twisty/model/props/puzzle/structure/PuzzleLoaderProp.ts", "../../../src/cubing/twisty/model/props/timeline/CoarseTimelineInfoProp.ts", "../../../src/cubing/twisty/model/props/timeline/DetailedTimelineInfoProp.ts", "../../../src/cubing/twisty/model/props/timeline/PlayingInfoProp.ts", "../../../src/cubing/twisty/model/props/timeline/TempoScaleProp.ts", "../../../src/cubing/twisty/model/props/timeline/TimestampRequestProp.ts", "../../../src/cubing/twisty/model/props/viewer/BackViewProp.ts", "../../../src/cubing/twisty/model/props/viewer/TimeRangeProp.ts", "../../../src/cubing/twisty/model/props/viewer/ViewerLinkProp.ts", "../../../src/cubing/twisty/model/props/viewer/VisualizationProp.ts", "../../../src/cubing/twisty/model/props/viewer/VisualizationStrategyProp.ts", "../../../src/cubing/twisty/model/props/puzzle/display/FaceletScaleProp.ts", "../../../src/cubing/twisty/model/props/puzzle/display/FoundationDisplayProp.ts", "../../../src/cubing/twisty/model/props/puzzle/display/InitialHintFaceletsAnimationProp.ts", "../../../src/cubing/twisty/model/props/puzzle/display/SpriteProp.ts", "../../../src/cubing/twisty/model/props/puzzle/display/StickeringMaskProp.ts", "../../../src/cubing/twisty/model/props/puzzle/display/parseSerializedStickeringMask.ts", "../../../src/cubing/twisty/model/props/puzzle/display/StickeringMaskRequestProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/DragInputProp.ts", "../../../src/cubing/twisty/model/props/puzzle/state/MovePressCancelOptions.ts", "../../../src/cubing/twisty/model/props/puzzle/state/MovePressInputProp.ts", "../../../src/cubing/twisty/model/props/viewer/BackgroundProp.ts", "../../../src/cubing/twisty/model/props/viewer/DarkModeProp.ts", "../../../src/cubing/twisty/model/props/viewer/DarkModeRequestProp.ts", "../../../src/cubing/twisty/model/props/viewer/DOMElementReferenceProp.ts", "../../../src/cubing/twisty/model/props/viewer/LatitudeLimit.ts", "../../../src/cubing/twisty/model/props/viewer/OrbitCoordinatesRequestProp.ts", "../../../src/cubing/twisty/model/props/viewer/OrbitCoordinatesProp.ts", "../../../src/cubing/twisty/model/TwistySceneModel.ts", "../../../src/cubing/twisty/model/UserVisibleErrorTracker.ts", "../../../src/cubing/twisty/model/TwistyPlayerModel.ts", "../../../src/cubing/twisty/views/TwistyPlayerSettable.ts", "../../../src/cubing/twisty/views/TwistyPlayer.ts", "../../../src/cubing/twisty/views/TwistyAlgViewer.css.ts", "../../../src/cubing/twisty/views/TwistyAlgViewer.ts", "../../../src/cubing/twisty/views/TwistyAlgEditor/LeafTokens.ts", "../../../src/cubing/twisty/views/TwistyAlgEditor/model.ts", "../../../src/cubing/twisty/views/TwistyAlgEditor/TwistyAlgEditor.css.ts", "../../../src/cubing/twisty/views/TwistyAlgEditor/TwistyAlgEditor.ts", "../../../src/cubing/twisty/views/twizzle/TwizzleLink.css.ts", "../../../src/cubing/twisty/views/twizzle/TwizzleLink.ts", "../../../src/cubing/twisty/views/twizzle/url-params.ts"],
  "sourcesContent": ["import { experimentalStickerings } from \"../../../../../puzzles/cubing-private\";\nimport { SimpleTwistyPropSource } from \"../../TwistyProp\";\nimport type { PuzzleID } from \"../structure/PuzzleIDRequestProp\";\n\n// TODO: turn these maps into lists?\n// TODO: alg.cubing.net parity\n\nexport type ExperimentalStickering = keyof typeof experimentalStickerings;\n\nexport function getStickeringGroup(\n  stickering: ExperimentalStickering,\n  puzzleID: PuzzleID,\n): string {\n  const groups = experimentalStickerings[stickering]?.groups;\n  if (!groups) {\n    return \"Stickering\";\n  }\n  return groups[puzzleID] ?? \"Stickering\";\n}\n\nexport class StickeringRequestProp extends SimpleTwistyPropSource<ExperimentalStickering | null> {\n  getDefaultValue(): ExperimentalStickering | null {\n    return null;\n  }\n}\n", "export function arrayEquals<T>(a: readonly T[], b: readonly T[]): boolean {\n  if (a === b) {\n    return true;\n  }\n  if (a.length !== b.length) {\n    return false;\n  }\n  for (let i = 0; i < a.length; i++) {\n    if (a[i] !== b[i]) {\n      return false;\n    }\n  }\n  return true;\n}\n\nexport function arrayEqualsCompare<T>(\n  a: readonly T[],\n  b: readonly T[],\n  compare: (a: T, b: T) => boolean,\n): boolean {\n  if (a === b) {\n    return true;\n  }\n  if (a.length !== b.length) {\n    return false;\n  }\n  for (let i = 0; i < a.length; i++) {\n    if (!compare(a[i], b[i])) {\n      return false;\n    }\n  }\n  return true;\n}\n\n// Assumes `offset > 0`. Will produce invalid values if not!\n// We don't check for that, since this can be a hot path.\nexport function mod(v: number, m: number, offset = 0): number {\n  return (((v % m) + m + offset) % m) - offset;\n}\n\nexport function modIntoRange(\n  v: number,\n  rangeMin: number,\n  rangeMax: number,\n): number {\n  return mod(v - rangeMin, rangeMax - rangeMin) + rangeMin;\n}\n", "import {\n  BoundaryType,\n  Direction,\n  directionScalar,\n  MillisecondTimestamp,\n  TimeRange,\n} from \"./AnimationTypes\";\nimport { RenderScheduler } from \"./RenderScheduler\";\nimport type {\n  PlayingInfo,\n  SimpleDirection,\n} from \"../model/props/timeline/PlayingInfoProp\";\nimport type { TwistyPlayerModel } from \"../model/TwistyPlayerModel\";\nimport { StaleDropper } from \"../model/PromiseFreshener\";\nimport type { CurrentMoveInfo } from \"./indexer/AlgIndexer\";\nimport type { TimestampRequest } from \"../model/props/timeline/TimestampRequestProp\";\nimport { modIntoRange } from \"../model/helpers\";\nimport type { CatchUpMove } from \"../model/props/puzzle/state/CatchUpMoveProp\";\n\n// TODO: Figure out a better way for the controller to instruct the player.\nexport interface TwistyAnimationControllerDelegate {\n  flash(): void;\n}\n\n// We use a separate helper to separate the anim frame callbacks (and their cancellations).\n// TODO: fold this into the main controller\nclass CatchUpHelper {\n  catchingUp: boolean = false;\n  pendingFrame = false;\n\n  constructor(private model: TwistyPlayerModel) {}\n\n  private scheduler: RenderScheduler = new RenderScheduler(\n    this.animFrame.bind(this),\n  );\n\n  start(): void {\n    if (!this.catchingUp) {\n      this.lastTimestamp = performance.now();\n    }\n    this.catchingUp = true;\n    this.pendingFrame = true;\n    this.scheduler.requestAnimFrame();\n  }\n\n  stop(): void {\n    this.catchingUp = false;\n    this.scheduler.cancelAnimFrame();\n  }\n\n  catchUpMs = 500;\n  lastTimestamp = 0;\n  animFrame(timestamp: MillisecondTimestamp): void {\n    this.scheduler.requestAnimFrame();\n    const delta = (timestamp - this.lastTimestamp) / this.catchUpMs;\n    this.lastTimestamp = timestamp;\n\n    this.model.catchUpMove.set(\n      (async (): Promise<CatchUpMove> => {\n        const previousCatchUpMove = await this.model.catchUpMove.get();\n        if (previousCatchUpMove.move === null) {\n          return previousCatchUpMove;\n        }\n\n        const amount = previousCatchUpMove.amount + delta; // TODO: use tempo scale?\n        if (amount >= 1) {\n          this.pendingFrame = true;\n          this.stop();\n          this.model.timestampRequest.set(\"end\");\n          return {\n            move: null,\n            amount: 0,\n          };\n        }\n        this.pendingFrame = false;\n        return {\n          move: previousCatchUpMove.move,\n          amount: amount,\n        };\n      })(),\n    );\n  }\n}\n\n// This controls the logic for animation, so that the main controller can focus on the right API abstractions.\nexport class TwistyAnimationController {\n  // TODO: #private?\n  private playing: boolean = false;\n  private direction: Direction = Direction.Forwards;\n\n  private catchUpHelper: CatchUpHelper;\n\n  private model: TwistyPlayerModel;\n\n  private lastDatestamp: MillisecondTimestamp = 0;\n  private lastTimestampPromise: Promise<MillisecondTimestamp>;\n\n  private scheduler: RenderScheduler = new RenderScheduler(\n    this.animFrame.bind(this),\n  );\n\n  constructor(\n    model: TwistyPlayerModel,\n    private delegate: TwistyAnimationControllerDelegate,\n  ) {\n    this.model = model;\n    this.lastTimestampPromise = this.#effectiveTimestampMilliseconds();\n\n    this.model.playingInfo.addFreshListener(this.onPlayingProp.bind(this)); // TODO\n\n    this.catchUpHelper = new CatchUpHelper(this.model);\n    this.model.catchUpMove.addFreshListener(this.onCatchUpMoveProp.bind(this)); // TODO\n  }\n\n  // TODO: Do we need this?\n  async onPlayingProp(playingInfo: PlayingInfo): Promise<void> {\n    if (playingInfo.playing !== this.playing) {\n      playingInfo.playing ? this.play(playingInfo) : this.pause();\n    }\n  }\n\n  // TODO: Do we need this?\n  async onCatchUpMoveProp(catchUpMove: CatchUpMove): Promise<void> {\n    const catchingUp = catchUpMove.move !== null;\n    if (catchingUp !== this.catchUpHelper.catchingUp) {\n      catchingUp ? this.catchUpHelper.start() : this.catchUpHelper.stop();\n    }\n    this.scheduler.requestAnimFrame();\n  }\n\n  async #effectiveTimestampMilliseconds(): Promise<MillisecondTimestamp> {\n    return (await this.model.detailedTimelineInfo.get()).timestamp;\n  }\n\n  // TODO: Return the animation we've switched to.\n  jumpToStart(options?: { flash: boolean }): void {\n    this.model.timestampRequest.set(\"start\");\n    this.pause();\n    if (options?.flash) {\n      this.delegate.flash();\n    }\n  }\n\n  // TODO: Return the animation we've switched to.\n  jumpToEnd(options?: { flash: boolean }): void {\n    this.model.timestampRequest.set(\"end\");\n    this.pause();\n    if (options?.flash) {\n      this.delegate.flash();\n    }\n  }\n\n  // TODO: Return the playing info we've switched to.\n  playPause(): void {\n    if (this.playing) {\n      this.pause();\n    } else {\n      this.play(); // TODO: Resume direction and looping behaviour?\n    }\n  }\n\n  // TODO: bundle playing direction, and boundary into `toggle`.\n  async play(options?: {\n    direction?: SimpleDirection;\n    untilBoundary?: BoundaryType;\n    autoSkipToOtherEndIfStartingAtBoundary?: boolean; // TODO What's a good short name that doesn't imply a more general looping concept?\n    loop?: boolean;\n  }): Promise<void> {\n    // TODO: We might need to cache all playing info?\n    // Or maybe we don't have to worry about short-circuiting, since this is idempotent?\n    // if (this.playing) {\n    //   return;\n    // }\n\n    const direction = options?.direction ?? Direction.Forwards;\n\n    const coarseTimelineInfo = await this.model.coarseTimelineInfo.get(); // TODO: Why do we need to read this if we don't use it?\n    if (options?.autoSkipToOtherEndIfStartingAtBoundary ?? true) {\n      if (direction === Direction.Forwards && coarseTimelineInfo.atEnd) {\n        this.model.timestampRequest.set(\"start\");\n        this.delegate.flash();\n      }\n      if (direction === Direction.Backwards && coarseTimelineInfo.atStart) {\n        this.model.timestampRequest.set(\"end\");\n        this.delegate.flash();\n      }\n    }\n    this.model.playingInfo.set({\n      playing: true,\n      direction,\n      untilBoundary: options?.untilBoundary ?? BoundaryType.EntireTimeline,\n      loop: options?.loop ?? false,\n    });\n\n    this.playing = true;\n    this.lastDatestamp = performance.now(); // TODO: Take from event.\n    this.lastTimestampPromise = this.#effectiveTimestampMilliseconds();\n\n    // TODO: Save timestamp from model?\n    this.scheduler.requestAnimFrame();\n  }\n\n  pause(): void {\n    this.playing = false;\n    this.scheduler.cancelAnimFrame();\n    this.model.playingInfo.set({\n      playing: false,\n      untilBoundary: BoundaryType.EntireTimeline,\n    });\n  }\n\n  #animFrameEffectiveTimestampStaleDropper: StaleDropper<\n    [PlayingInfo, MillisecondTimestamp, TimeRange, number, CurrentMoveInfo]\n  > = new StaleDropper<\n    [PlayingInfo, MillisecondTimestamp, TimeRange, number, CurrentMoveInfo]\n  >();\n\n  async animFrame(frameDatestamp: MillisecondTimestamp): Promise<void> {\n    if (this.playing) {\n      this.scheduler.requestAnimFrame();\n    }\n\n    const lastDatestamp = this.lastDatestamp;\n    const freshenerResult =\n      await this.#animFrameEffectiveTimestampStaleDropper.queue(\n        Promise.all([\n          this.model.playingInfo.get(),\n          this.lastTimestampPromise,\n          this.model.timeRange.get(),\n          this.model.tempoScale.get(),\n          this.model.currentMoveInfo.get(),\n        ]),\n      );\n\n    const [playingInfo, lastTimestamp, timeRange, tempoScale, currentMoveInfo] =\n      freshenerResult;\n\n    // TODO: Get this without wasting time on the others?\n    if (!playingInfo.playing) {\n      this.playing = false;\n      // TODO: Ideally we'd cancel the anim frame from the top of this method.\n      // But `this.scheduler.cancelAnimFrame();` might accidentally cancel a\n      // legit freshly scheduled frame. We should modify `RenderScheduler` to\n      // either have individually cancellable requests, or to have something\n      // like a \"default\" anim frame re-request that can be canceled separately.\n      //\n      // Note that we can't wait until here to call\n      // `this.scheduler.requestAnimFrame();`, because that would slow down the\n      // frame rate.\n      return;\n    }\n\n    let end = currentMoveInfo.earliestEnd; // timeRange.end\n    if (\n      currentMoveInfo.currentMoves.length === 0 ||\n      playingInfo.untilBoundary === BoundaryType.EntireTimeline\n    ) {\n      end = timeRange.end;\n    }\n\n    let start = currentMoveInfo.latestStart; // timeRange.end\n    if (\n      currentMoveInfo.currentMoves.length === 0 ||\n      playingInfo.untilBoundary === BoundaryType.EntireTimeline\n    ) {\n      start = timeRange.start;\n    }\n    // const start = currentMoveInfo.latestStart; // timeRange.start // TODO\n\n    let delta =\n      (frameDatestamp - lastDatestamp) *\n      directionScalar(this.direction) *\n      tempoScale;\n    delta = Math.max(delta, 1); // TODO: This guards against the timestamp going in the wrong direction by accident. Can we avoid it?\n    delta *= playingInfo.direction;\n    let newTimestamp = lastTimestamp + delta; // TODO: Pre-emptively clamp.\n    let newSmartTimestampRequest: Exclude<TimestampRequest, number> | null =\n      null;\n\n    if (newTimestamp >= end) {\n      if (playingInfo.loop) {\n        newTimestamp = modIntoRange(\n          newTimestamp,\n          timeRange.start,\n          timeRange.end,\n        );\n      } else {\n        if (newTimestamp === timeRange.end) {\n          newSmartTimestampRequest = \"end\";\n        } else {\n          newTimestamp = end;\n        }\n        this.playing = false;\n        this.model.playingInfo.set({\n          playing: false,\n        });\n      }\n    } else if (newTimestamp <= start) {\n      if (playingInfo.loop) {\n        newTimestamp = modIntoRange(\n          newTimestamp,\n          timeRange.start,\n          timeRange.end,\n        );\n      } else {\n        if (newTimestamp === timeRange.start) {\n          newSmartTimestampRequest = \"start\";\n        } else {\n          newTimestamp = start;\n        }\n        this.playing = false;\n        this.model.playingInfo.set({\n          playing: false,\n        });\n      }\n    }\n    this.lastDatestamp = frameDatestamp;\n    this.lastTimestampPromise = Promise.resolve(newTimestamp); // TODO: Save this earlier? / Do we need to worry about the effecitve timestamp disagreeing?\n    this.model.timestampRequest.set(newSmartTimestampRequest ?? newTimestamp);\n  }\n}\n", "import type { TwistyPlayerModel } from \"../model/TwistyPlayerModel\";\nimport {\n  TwistyAnimationController,\n  TwistyAnimationControllerDelegate,\n} from \"./TwistyAnimationController\";\n\nexport class TwistyPlayerController {\n  animationController: TwistyAnimationController;\n\n  constructor(\n    private model: TwistyPlayerModel,\n    delegate: TwistyAnimationControllerDelegate,\n  ) {\n    this.animationController = new TwistyAnimationController(model, delegate);\n  }\n\n  jumpToStart(options?: { flash: boolean }): void {\n    this.animationController.jumpToStart(options);\n  }\n\n  jumpToEnd(options?: { flash: boolean }): void {\n    this.animationController.jumpToEnd(options);\n  }\n\n  togglePlay(play?: boolean) {\n    if (typeof play === \"undefined\") {\n      this.animationController.playPause();\n    }\n    play ? this.animationController.play() : this.animationController.pause();\n  }\n\n  public async visitTwizzleLink(): Promise<void> {\n    const a = document.createElement(\"a\");\n    a.href = await this.model.twizzleLink();\n    a.target = \"_blank\";\n    a.click();\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nexport const controlsLocations = {\n  \"bottom-row\": true, // default\n  none: true,\n};\nexport type ControlsLocation = keyof typeof controlsLocations;\nexport type ControlPanelThemeWithAuto = ControlsLocation | \"auto\";\n\nexport class ControlPanelProp extends SimpleTwistyPropSource<ControlPanelThemeWithAuto> {\n  getDefaultValue(): ControlPanelThemeWithAuto {\n    return \"auto\";\n  }\n}\n", "import { CSSSource } from \"./ManagedCustomElement\";\n\nexport const twistyViewerWrapperCSS = new CSSSource(\n  `\n:host {\n  width: 384px;\n  height: 256px;\n  display: grid;\n}\n\n.wrapper {\n  width: 100%;\n  height: 100%;\n  display: grid;\n  overflow: hidden;\n}\n\n.wrapper > * {\n  width: 100%;\n  height: 100%;\n  overflow: hidden;\n}\n\n.wrapper.back-view-side-by-side {\n  grid-template-columns: 1fr 1fr;\n}\n\n.wrapper.back-view-top-right {\n  grid-template-columns: 3fr 1fr;\n  grid-template-rows: 1fr 3fr;\n}\n\n.wrapper.back-view-top-right > :nth-child(1) {\n  grid-row: 1 / 3;\n  grid-column: 1 / 3;\n}\n\n.wrapper.back-view-top-right > :nth-child(2) {\n  grid-row: 1 / 2;\n  grid-column: 2 / 3;\n}\n`,\n);\n", "import type { KPuzzle } from \"../../../kpuzzle\";\nimport type { KState } from \"../../../kpuzzle/KState\";\nimport type {\n  FaceletMeshStickeringMask,\n  StickeringMask,\n} from \"../../../puzzles/stickerings/mask\"; // TODO\n\nconst xmlns = \"http://www.w3.org/2000/svg\";\nconst DATA_COPY_ID_ATTRIBUTE = \"data-copy-id\";\n\n// Unique ID mechanism to keep SVG gradient element IDs unique. TODO: Is there\n// something more performant, and that can't be broken by other elements of the\n// page? (And also doesn't break if this library is run in parallel.)\nlet svgCounter = 0;\nfunction nextSVGID(): string {\n  svgCounter += 1;\n  return `svg${svgCounter.toString()}`;\n}\n\n// TODO: This is hardcoded to 3x3x3 SVGs\nconst colorMaps: Partial<\n  Record<FaceletMeshStickeringMask, string | Record<string, string>>\n> = {\n  dim: {\n    white: \"#dddddd\",\n    orange: \"#884400\",\n    limegreen: \"#008800\",\n    red: \"#660000\",\n    \"rgb(34, 102, 255)\": \"#000088\", // TODO\n    yellow: \"#888800\",\n    \"rgb(102, 0, 153)\": \"rgb(50, 0, 76)\",\n    purple: \"#3f003f\",\n  },\n  oriented: \"#44ddcc\",\n  ignored: \"#555555\",\n  invisible: \"#00000000\",\n};\n\nexport class KPuzzleSVGWrapper {\n  public wrapperElement: HTMLElement;\n  public svgElement: SVGElement;\n  public gradientDefs: SVGDefsElement;\n  private originalColors: { [type: string]: string } = {};\n  private gradients: { [type: string]: SVGGradientElement } = {};\n  private svgID: string;\n  constructor(\n    public kpuzzle: KPuzzle,\n    svgSource: string,\n    experimentalStickeringMask?: StickeringMask,\n  ) {\n    if (!svgSource) {\n      throw new Error(`No SVG definition for puzzle type: ${kpuzzle.name()}`);\n    }\n\n    this.svgID = nextSVGID();\n\n    this.wrapperElement = document.createElement(\"div\");\n    this.wrapperElement.classList.add(\"svg-wrapper\");\n    // TODO: Sanitization.\n    this.wrapperElement.innerHTML = svgSource;\n\n    const svgElem = this.wrapperElement.querySelector(\"svg\");\n    if (!svgElem) {\n      throw new Error(\"Could not get SVG element\");\n    }\n    this.svgElement = svgElem;\n    if (xmlns !== svgElem.namespaceURI) {\n      throw new Error(\"Unexpected XML namespace\");\n    }\n    svgElem.style.maxWidth = \"100%\";\n    svgElem.style.maxHeight = \"100%\";\n    this.gradientDefs = document.createElementNS(xmlns, \"defs\");\n    svgElem.insertBefore(this.gradientDefs, svgElem.firstChild);\n\n    for (const orbitName in kpuzzle.definition.orbits) {\n      const orbitDefinition = kpuzzle.definition.orbits[orbitName];\n\n      for (let idx = 0; idx < orbitDefinition.numPieces; idx++) {\n        for (\n          let orientation = 0;\n          orientation < orbitDefinition.numOrientations;\n          orientation++\n        ) {\n          const id = this.elementID(orbitName, idx, orientation);\n          const elem = this.elementByID(id);\n\n          let originalColor: string = elem.style.fill;\n          /// TODO: Allow setting stickering mask dynamically.\n          if (experimentalStickeringMask) {\n            (() => {\n              // TODO: dedup with Cube3D,,factor out fallback calculations\n              const a = experimentalStickeringMask.orbits;\n              if (!a) {\n                return;\n              }\n              const orbitStickeringMask = a[orbitName];\n              if (!orbitStickeringMask) {\n                return;\n              }\n              const pieceStickeringMask = orbitStickeringMask.pieces[idx];\n              if (!pieceStickeringMask) {\n                return;\n              }\n              const faceletStickeringMasks =\n                pieceStickeringMask.facelets[orientation];\n              if (!faceletStickeringMasks) {\n                return;\n              }\n              const stickeringMask =\n                typeof faceletStickeringMasks === \"string\"\n                  ? faceletStickeringMasks\n                  : faceletStickeringMasks?.mask;\n              const colorMap = colorMaps[stickeringMask];\n              if (typeof colorMap === \"string\") {\n                originalColor = colorMap;\n              } else if (colorMap) {\n                originalColor = colorMap[originalColor];\n              }\n            })();\n          } else {\n            originalColor = elem.style.fill;\n          }\n          this.originalColors[id] = originalColor;\n          this.gradients[id] = this.newGradient(id, originalColor);\n          this.gradientDefs.appendChild(this.gradients[id]);\n          elem.setAttribute(\"style\", `fill: url(#grad-${this.svgID}-${id})`);\n        }\n      }\n    }\n\n    for (const hintElem of Array.from(\n      svgElem.querySelectorAll(`[${DATA_COPY_ID_ATTRIBUTE}]`),\n    )) {\n      const id = hintElem.getAttribute(DATA_COPY_ID_ATTRIBUTE);\n      hintElem.setAttribute(\"style\", `fill: url(#grad-${this.svgID}-${id})`);\n    }\n  }\n\n  public drawState(state: KState, nextState?: KState, fraction?: number): void {\n    this.draw(state, nextState, fraction);\n  }\n\n  // TODO: save definition in the constructor?\n  public draw(state: KState, nextState?: KState, fraction?: number): void {\n    const transformation = state.experimentalToTransformation();\n    const nextTransformation = nextState?.experimentalToTransformation();\n    if (!transformation) {\n      throw new Error(\"Distinguishable pieces are not handled for SVG yet!\");\n    }\n\n    for (const orbitName in transformation.kpuzzle.definition.orbits) {\n      const orbitDefinition =\n        transformation.kpuzzle.definition.orbits[orbitName];\n\n      const curTransformationOrbit =\n        transformation.transformationData[orbitName];\n      const nextTransformationOrbit = nextTransformation\n        ? nextTransformation.transformationData[orbitName]\n        : null;\n      for (let idx = 0; idx < orbitDefinition.numPieces; idx++) {\n        for (\n          let orientation = 0;\n          orientation < orbitDefinition.numOrientations;\n          orientation++\n        ) {\n          const id = this.elementID(orbitName, idx, orientation);\n          const fromCur = this.elementID(\n            orbitName,\n            curTransformationOrbit.permutation[idx],\n            (orbitDefinition.numOrientations -\n              curTransformationOrbit.orientation[idx] +\n              orientation) %\n              orbitDefinition.numOrientations,\n          );\n          let singleColor = false;\n          if (nextTransformationOrbit) {\n            const fromNext = this.elementID(\n              orbitName,\n              nextTransformationOrbit.permutation[idx],\n              (orbitDefinition.numOrientations -\n                nextTransformationOrbit.orientation[idx] +\n                orientation) %\n                orbitDefinition.numOrientations,\n            );\n            if (fromCur === fromNext) {\n              singleColor = true; // TODO: Avoid redundant work during move.\n            }\n            fraction = fraction || 0; // TODO Use the type system to tie this to nextState?\n            const easedBackwardsPercent =\n              100 * (1 - fraction * fraction * (2 - fraction * fraction)); // TODO: Move easing up the stack.\n            this.gradients[id].children[0].setAttribute(\n              \"stop-color\",\n              this.originalColors[fromCur],\n            );\n            this.gradients[id].children[1].setAttribute(\n              \"stop-color\",\n              this.originalColors[fromCur],\n            );\n            this.gradients[id].children[1].setAttribute(\n              \"offset\",\n              `${Math.max(easedBackwardsPercent - 5, 0)}%`,\n            );\n            this.gradients[id].children[2].setAttribute(\n              \"offset\",\n              `${Math.max(easedBackwardsPercent - 5, 0)}%`,\n            );\n            this.gradients[id].children[3].setAttribute(\n              \"offset\",\n              `${easedBackwardsPercent}%`,\n            );\n            this.gradients[id].children[4].setAttribute(\n              \"offset\",\n              `${easedBackwardsPercent}%`,\n            );\n            this.gradients[id].children[4].setAttribute(\n              \"stop-color\",\n              this.originalColors[fromNext],\n            );\n            this.gradients[id].children[5].setAttribute(\n              \"stop-color\",\n              this.originalColors[fromNext],\n            );\n          } else {\n            singleColor = true; // TODO: Avoid redundant work during move.\n          }\n          if (singleColor) {\n            this.gradients[id].children[0].setAttribute(\n              \"stop-color\",\n              this.originalColors[fromCur],\n            );\n            this.gradients[id].children[1].setAttribute(\n              \"stop-color\",\n              this.originalColors[fromCur],\n            );\n            this.gradients[id].children[1].setAttribute(\"offset\", \"100%\");\n            this.gradients[id].children[2].setAttribute(\"offset\", \"100%\");\n            this.gradients[id].children[3].setAttribute(\"offset\", \"100%\");\n            this.gradients[id].children[4].setAttribute(\"offset\", \"100%\");\n          }\n          // this.gradients[id]\n          // this.elementByID(id).style.fill = this.originalColors[from];\n        }\n      }\n    }\n  }\n\n  private newGradient(id: string, originalColor: string): SVGGradientElement {\n    const grad = document.createElementNS(\n      xmlns,\n      \"radialGradient\",\n    ) as SVGGradientElement;\n    grad.setAttribute(\"id\", `grad-${this.svgID}-${id}`);\n    grad.setAttribute(\"r\", \"70.7107%\"); // TODO: Adapt to puzzle.\n    const stopDefs = [\n      { offset: 0, color: originalColor },\n      { offset: 0, color: originalColor },\n      { offset: 0, color: \"black\" },\n      { offset: 0, color: \"black\" },\n      { offset: 0, color: originalColor },\n      { offset: 100, color: originalColor },\n    ];\n    for (const stopDef of stopDefs) {\n      const stop = document.createElementNS(xmlns, \"stop\");\n      stop.setAttribute(\"offset\", `${stopDef.offset}%`);\n      stop.setAttribute(\"stop-color\", stopDef.color);\n      stop.setAttribute(\"stop-opacity\", \"1\");\n      grad.appendChild(stop);\n    }\n    return grad;\n  }\n\n  private elementID(\n    orbitName: string,\n    idx: number,\n    orientation: number,\n  ): string {\n    return `${orbitName}-l${idx}-o${orientation}`;\n  }\n\n  private elementByID(id: string): HTMLElement {\n    // TODO: Use classes and scope selector to SVG element.\n    return this.wrapperElement.querySelector(`#${id}`) as HTMLElement;\n  }\n}\n", "import { CSSSource } from \"../ManagedCustomElement\";\n\n// TODO: Can we do this without so much nesting, and styling all the nested elems?\nexport const twisty2DSVGCSS = new CSSSource(\n  `\n:host {\n  width: 384px;\n  height: 256px;\n  display: grid;\n}\n\n.wrapper {\n  width: 100%;\n  height: 100%;\n  display: grid;\n  overflow: hidden;\n}\n\n.svg-wrapper,\ntwisty-2d-svg,\nsvg {\n  width: 100%;\n  height: 100%;\n  display: grid;\n  min-height: 0;\n}\n\nsvg {\n  animation: fade-in 0.25s ease-in;\n}\n\n@keyframes fade-in {\n  from { opacity: 0; }\n  to { opacity: 1; }\n}\n`,\n);\n", "import type { PuzzleID } from \"../..\";\nimport type { KPuzzle } from \"../../../kpuzzle\";\nimport type { ExperimentalStickeringMask } from \"../../../puzzles/cubing-private\";\nimport type { PuzzleLoader } from \"../../../puzzles/PuzzleLoader\";\nimport type { StickeringMask } from \"../../../puzzles/stickerings/mask\";\nimport {\n  Direction,\n  PositionListener,\n  PuzzlePosition,\n} from \"../../controllers/AnimationTypes\";\nimport { RenderScheduler } from \"../../controllers/RenderScheduler\";\nimport { FreshListenerManager } from \"../../model/props/TwistyProp\";\nimport type { TwistyPlayerModel } from \"../../model/TwistyPlayerModel\";\nimport { ManagedCustomElement } from \"../ManagedCustomElement\";\nimport { customElementsShim } from \"../node-custom-element-shims\";\nimport { KPuzzleSVGWrapper } from \"./KPuzzleSVGWrapper\";\nimport { twisty2DSVGCSS } from \"./Twisty2DPuzzle.css\";\n\nexport interface Twisty2DPuzzleOptions {\n  experimentalStickeringMask?: ExperimentalStickeringMask;\n}\n\n// <twisty-2d-svg>\nexport class Twisty2DPuzzle\n  extends ManagedCustomElement\n  implements PositionListener\n{\n  public svgWrapper: KPuzzleSVGWrapper;\n  private scheduler = new RenderScheduler(this.render.bind(this));\n  #cachedPosition: PuzzlePosition | null = null; // TODO: pull when needed.\n  constructor(\n    private model?: TwistyPlayerModel,\n    private kpuzzle?: KPuzzle,\n    private svgSource?: string,\n    private options?: Twisty2DPuzzleOptions,\n    private puzzleLoader?: PuzzleLoader,\n  ) {\n    super();\n    this.addCSS(twisty2DSVGCSS);\n\n    this.resetSVG(); // TODO: do this in `connectedCallback()`?\n\n    this.#freshListenerManager.addListener(\n      this.model!.puzzleID,\n      (puzzleID: PuzzleID) => {\n        if (puzzleLoader?.id !== puzzleID) {\n          this.disconnect();\n        }\n      },\n    );\n\n    this.#freshListenerManager.addListener(\n      this.model!.legacyPosition,\n      this.onPositionChange.bind(this),\n    );\n\n    if (this.options?.experimentalStickeringMask) {\n      this.experimentalSetStickeringMask(\n        this.options.experimentalStickeringMask,\n      );\n    }\n  }\n\n  #freshListenerManager = new FreshListenerManager();\n  disconnect(): void {\n    this.#freshListenerManager.disconnect();\n  }\n\n  onPositionChange(position: PuzzlePosition): void {\n    try {\n      if (position.movesInProgress.length > 0) {\n        const move = position.movesInProgress[0].move;\n\n        let partialMove = move;\n        if (position.movesInProgress[0].direction === Direction.Backwards) {\n          partialMove = move.invert();\n        }\n        const newState = position.state.applyMove(partialMove);\n        // TODO: move to render()\n        this.svgWrapper.draw(\n          position.state,\n          newState,\n          position.movesInProgress[0].fraction,\n        );\n      } else {\n        this.svgWrapper.draw(position.state);\n        this.#cachedPosition = position;\n      }\n    } catch (e) {\n      console.warn(\n        \"Bad position (this doesn't necessarily mean something is wrong). Pre-emptively disconnecting:\",\n        this.puzzleLoader?.id,\n        e,\n      );\n      this.disconnect();\n    }\n  }\n\n  scheduleRender(): void {\n    this.scheduler.requestAnimFrame();\n  }\n\n  experimentalSetStickeringMask(\n    stickeringMask: ExperimentalStickeringMask,\n  ): void {\n    this.resetSVG(stickeringMask);\n  }\n\n  // TODO: do this without constructing a new SVG.\n  private resetSVG(stickeringMask?: StickeringMask): void {\n    if (this.svgWrapper) {\n      this.removeElement(this.svgWrapper.wrapperElement);\n    }\n    if (!this.kpuzzle) {\n      return; // TODO\n    }\n    this.svgWrapper = new KPuzzleSVGWrapper(\n      this.kpuzzle,\n      this.svgSource!,\n      stickeringMask,\n    ); // TODO\n    this.addElement(this.svgWrapper.wrapperElement);\n    if (this.#cachedPosition) {\n      this.onPositionChange(this.#cachedPosition);\n    }\n  }\n\n  private render(): void {\n    /*...*/\n  }\n}\n\ncustomElementsShim.define(\"twisty-2d-puzzle\", Twisty2DPuzzle);\n", "import type { PuzzleLoader } from \"../../../puzzles\";\nimport type { ExperimentalStickeringMask } from \"../../../puzzles/cubing-private\";\nimport type { Schedulable } from \"../../controllers/RenderScheduler\";\nimport { FreshListenerManager } from \"../../model/props/TwistyProp\";\nimport type { TwistyPlayerModel } from \"../../model/TwistyPlayerModel\";\nimport { Twisty2DPuzzle } from \"./Twisty2DPuzzle\";\n\nexport class Twisty2DPuzzleWrapper implements Schedulable {\n  constructor(\n    private model: TwistyPlayerModel,\n    public schedulable: Schedulable,\n    private puzzleLoader: PuzzleLoader,\n    private effectiveVisualization: \"2D\" | \"experimental-2D-LL\",\n  ) {\n    this.twisty2DPuzzle(); // Start constructing.\n\n    this.#freshListenerManager.addListener(\n      this.model.twistySceneModel.stickeringMask,\n      async (stickeringMask: ExperimentalStickeringMask) => {\n        (await this.twisty2DPuzzle()).experimentalSetStickeringMask(\n          stickeringMask,\n        );\n      },\n    );\n  }\n\n  #freshListenerManager = new FreshListenerManager();\n  disconnect(): void {\n    this.#freshListenerManager.disconnect();\n  }\n\n  // TODO: Hook this up nicely.\n  scheduleRender(): void {\n    // Nothing\n  }\n\n  #cachedTwisty2DPuzzle: Promise<Twisty2DPuzzle> | null = null;\n  // TODO: Stale dropper?\n  async twisty2DPuzzle(): Promise<Twisty2DPuzzle> {\n    return (this.#cachedTwisty2DPuzzle ??= (async () => {\n      const svgPromise =\n        this.effectiveVisualization === \"experimental-2D-LL\"\n          ? this.puzzleLoader.llSVG!()\n          : this.puzzleLoader.svg();\n      return new Twisty2DPuzzle(\n        this.model,\n        await this.puzzleLoader.kpuzzle(),\n        await svgPromise,\n        {},\n        this.puzzleLoader,\n      );\n    })());\n  }\n}\n", "import type { Scene as ThreeScene } from \"three\";\nimport type { PuzzleLoader } from \"../../../puzzles\";\nimport type { Schedulable } from \"../../controllers/RenderScheduler\";\nimport { THREEJS } from \"../../heavy-code-imports/3d\";\nimport { FreshListenerManager } from \"../../model/props/TwistyProp\";\nimport type { TwistySceneModel } from \"../../model/TwistySceneModel\";\nimport { ManagedCustomElement } from \"../ManagedCustomElement\";\nimport { customElementsShim } from \"../node-custom-element-shims\";\nimport { twistyViewerWrapperCSS } from \"../TwistyViewerWrapper.css\";\nimport { Twisty2DPuzzleWrapper } from \"./Twisty2DPuzzleWrapper\";\n\nexport class Twisty2DSceneWrapper\n  extends ManagedCustomElement\n  implements Schedulable\n{\n  #freshListenerManager = new FreshListenerManager();\n  disconnect(): void {\n    this.#freshListenerManager.disconnect();\n  }\n\n  constructor(\n    public model?: TwistySceneModel,\n    private effectiveVisualization?: \"2D\" | \"experimental-2D-LL\",\n  ) {\n    super();\n  }\n\n  async connectedCallback(): Promise<void> {\n    this.addCSS(twistyViewerWrapperCSS);\n    if (this.model) {\n      this.#freshListenerManager.addListener(\n        this.model.twistyPlayerModel.puzzleLoader,\n        this.onPuzzleLoader.bind(this),\n      );\n    }\n  }\n\n  #cachedScene: Promise<ThreeScene> | null;\n  async scene(): Promise<ThreeScene> {\n    return (this.#cachedScene ??= (async () => new (await THREEJS).Scene())());\n  }\n\n  scheduleRender(): void {\n    this.#currentTwisty2DPuzzleWrapper?.scheduleRender();\n  }\n\n  #currentTwisty2DPuzzleWrapper: Twisty2DPuzzleWrapper | null = null;\n  currentTwisty2DPuzzleWrapper(): Twisty2DPuzzleWrapper | null {\n    return this.#currentTwisty2DPuzzleWrapper;\n  }\n\n  // #oldTwisty3DPuzzleWrappers: Twisty3DPuzzleWrapper[] = []; // TODO: Animate these out.\n  async setCurrentTwisty2DPuzzleWrapper(\n    twisty2DPuzzleWrapper: Twisty2DPuzzleWrapper,\n  ): Promise<void> {\n    const old = this.#currentTwisty2DPuzzleWrapper;\n    this.#currentTwisty2DPuzzleWrapper = twisty2DPuzzleWrapper;\n    old?.disconnect(); // TODO: Disconnect properly.\n    const twisty2DPuzzlePromise = twisty2DPuzzleWrapper.twisty2DPuzzle();\n    this.contentWrapper.textContent = \"\"; // Clear existing ones.\n    this.addElement(await twisty2DPuzzlePromise);\n  }\n\n  async onPuzzleLoader(puzzleLoader: PuzzleLoader): Promise<void> {\n    this.#currentTwisty2DPuzzleWrapper?.disconnect();\n    const twisty2DPuzzleWrapper = new Twisty2DPuzzleWrapper(\n      this.model!.twistyPlayerModel,\n      this,\n      puzzleLoader,\n      this.effectiveVisualization!,\n    );\n\n    this.setCurrentTwisty2DPuzzleWrapper(twisty2DPuzzleWrapper);\n  }\n}\n\ncustomElementsShim.define(\"twisty-2d-scene-wrapper\", Twisty2DSceneWrapper);\n", "import type { ManagedCustomElement } from \"./ManagedCustomElement\";\n\nexport class ClassListManager<SuffixType extends string> {\n  #currentClassName: string | null = null;\n  // The prefix should ideally end in a dash.\n  constructor(\n    private elem: ManagedCustomElement,\n    private prefix: string,\n    private validSuffixes: SuffixType[],\n  ) {}\n\n  // Does nothing if there was no value.\n  clearValue(): void {\n    if (this.#currentClassName) {\n      this.elem.contentWrapper.classList.remove(this.#currentClassName);\n    }\n    this.#currentClassName = null; // TODO: add test for this behaviour.\n  }\n\n  // Returns if the value changed\n  setValue(suffix: SuffixType): boolean {\n    if (!this.validSuffixes.includes(suffix)) {\n      throw new Error(`Invalid suffix: ${suffix}`);\n    }\n    const newClassName = `${this.prefix}${suffix}`;\n    const changed = this.#currentClassName !== newClassName;\n    if (changed) {\n      this.clearValue();\n      this.elem.contentWrapper.classList.add(newClassName);\n      this.#currentClassName = newClassName;\n    }\n    return changed;\n  }\n}\n", "export class InitialValueTracker<T> {\n  #resolve: (t: T) => void;\n  reject: (e?: Error) => void; // TODO: AbortController?\n  promise = new Promise<T>((resolve, reject) => {\n    this.#resolve = resolve;\n    this.reject = reject;\n  });\n  handleNewValue(t: T): void {\n    this.#resolve(t);\n  }\n}\n", "import type { Raycaster, Texture as ThreeTexture } from \"three\";\nimport type { PuzzleLoader } from \"../../../puzzles\";\nimport type { ExperimentalStickeringMask } from \"../../../puzzles/cubing-private\";\nimport type { PuzzlePosition } from \"../../controllers/AnimationTypes\";\nimport type { Schedulable } from \"../../controllers/RenderScheduler\";\nimport { proxy3D } from \"../../heavy-code-imports/3d\";\nimport type { FoundationDisplay } from \"../../model/props/puzzle/display/FoundationDisplayProp\";\nimport type { HintFaceletStyleWithAuto } from \"../../model/props/puzzle/display/HintFaceletProp\";\nimport { FreshListenerManager } from \"../../model/props/TwistyProp\";\nimport type { VisualizationStrategy } from \"../../model/props/viewer/VisualizationStrategyProp\";\nimport type { TwistyPlayerModel } from \"../../model/TwistyPlayerModel\";\nimport type { Cube3D } from \"./puzzles/Cube3D\";\nimport type { PG3D } from \"./puzzles/PG3D\";\nimport type { Twisty3DPuzzle } from \"./puzzles/Twisty3DPuzzle\";\n\nexport class Twisty3DPuzzleWrapper extends EventTarget implements Schedulable {\n  constructor(\n    private model: TwistyPlayerModel,\n    public schedulable: Schedulable,\n    private puzzleLoader: PuzzleLoader,\n    private visualizationStrategy: VisualizationStrategy,\n  ) {\n    super();\n    this.twisty3DPuzzle(); // Start constructing.\n\n    // TODO: Hook up listeners before loading the heavy code in the async constructor, so we get any intermediate updates?\n    // Repro: Switch to 40x40x40 a fraction of a second before animation finishes. When it's loaded the itmeline is at the end, but the 40x40x40 is rendered with an earlier position.\n\n    this.#freshListenerManager.addListener(\n      this.model.puzzleLoader,\n      (puzzleLoader: PuzzleLoader) => {\n        if (this.puzzleLoader.id !== puzzleLoader.id) {\n          this.disconnect();\n        }\n      },\n    );\n    this.#freshListenerManager.addListener(\n      this.model.legacyPosition,\n      async (position: PuzzlePosition) => {\n        try {\n          (await this.twisty3DPuzzle()).onPositionChange(position);\n          this.scheduleRender();\n        } catch (e) {\n          // TODO\n          // console.warn(\n          //   \"Bad position (this doesn't necessarily mean something is wrong). Pre-emptively disconnecting:\",\n          //   this.puzzleLoader.id,\n          //   e,\n          // );\n          this.disconnect();\n        }\n      },\n    );\n\n    this.#freshListenerManager.addListener(\n      this.model.twistySceneModel.hintFacelet,\n      async (hintFaceletStyle: HintFaceletStyleWithAuto) => {\n        (\n          (await this.twisty3DPuzzle()) as Cube3D | PG3D\n        ).experimentalUpdateOptions({\n          hintFacelets:\n            hintFaceletStyle === \"auto\" ? \"floating\" : hintFaceletStyle,\n        });\n        this.scheduleRender();\n      },\n    );\n    this.#freshListenerManager.addListener(\n      this.model.twistySceneModel.foundationDisplay,\n      async (foundationDisplay: FoundationDisplay) => {\n        (\n          (await this.twisty3DPuzzle()) as Cube3D | PG3D\n        ).experimentalUpdateOptions({\n          showFoundation: foundationDisplay !== \"none\",\n        });\n        this.scheduleRender();\n      },\n    );\n    this.#freshListenerManager.addListener(\n      this.model.twistySceneModel.stickeringMask,\n      async (stickeringMask: ExperimentalStickeringMask) => {\n        const twisty3D = await this.twisty3DPuzzle();\n        twisty3D.setStickeringMask(stickeringMask);\n        this.scheduleRender();\n      },\n    );\n    this.#freshListenerManager.addListener(\n      this.model.twistySceneModel.faceletScale,\n      async (faceletScale: \"auto\" | number) => {\n        (\n          (await this.twisty3DPuzzle()) as Cube3D | PG3D\n        ).experimentalUpdateOptions({\n          faceletScale,\n        });\n        this.scheduleRender();\n      },\n    );\n\n    this.#freshListenerManager.addMultiListener3(\n      [\n        this.model.twistySceneModel.stickeringMask,\n        this.model.twistySceneModel.foundationStickerSprite,\n        this.model.twistySceneModel.hintStickerSprite,\n      ],\n      async (\n        inputs: [\n          stickeringMask: ExperimentalStickeringMask,\n          foundationSprite: ThreeTexture | null,\n          hintSprite: ThreeTexture | null,\n        ],\n      ) => {\n        if (\"experimentalUpdateTexture\" in (await this.twisty3DPuzzle())) {\n          ((await this.twisty3DPuzzle()) as PG3D).experimentalUpdateTexture(\n            inputs[0].specialBehaviour === \"picture\",\n            inputs[1],\n            inputs[2],\n          );\n          this.scheduleRender();\n        }\n      },\n    );\n  }\n\n  #freshListenerManager = new FreshListenerManager();\n  disconnect(): void {\n    this.#freshListenerManager.disconnect();\n  }\n\n  scheduleRender(): void {\n    this.schedulable.scheduleRender();\n    this.dispatchEvent(new CustomEvent(\"render-scheduled\"));\n  }\n\n  #cachedTwisty3DPuzzle: Promise<Twisty3DPuzzle> | null = null;\n  async twisty3DPuzzle(): Promise<Twisty3DPuzzle> {\n    return (this.#cachedTwisty3DPuzzle ??= (async () => {\n      const proxyPromise = proxy3D();\n      if (\n        this.puzzleLoader.id === \"3x3x3\" &&\n        this.visualizationStrategy === \"Cube3D\"\n      ) {\n        // TODO: synchronize\n        const [\n          foundationSprite,\n          hintSprite,\n          experimentalStickeringMask,\n          initialHintFaceletsAnimation,\n        ] = await Promise.all([\n          this.model.twistySceneModel.foundationStickerSprite.get(),\n          this.model.twistySceneModel.hintStickerSprite.get(),\n          this.model.twistySceneModel.stickeringMask.get(),\n          this.model.twistySceneModel.initialHintFaceletsAnimation.get(),\n        ]);\n        return (await proxyPromise).cube3DShim(\n          () => this.schedulable.scheduleRender(),\n          {\n            foundationSprite,\n            hintSprite,\n            experimentalStickeringMask,\n            initialHintFaceletsAnimation,\n          },\n        );\n      } else {\n        const [hintFacelets, foundationSprite, hintSprite, faceletScale] =\n          await Promise.all([\n            this.model.twistySceneModel.hintFacelet.get(),\n            this.model.twistySceneModel.foundationStickerSprite.get(),\n            this.model.twistySceneModel.hintStickerSprite.get(),\n            this.model.twistySceneModel.faceletScale.get(),\n          ]);\n        const pg3d = (await proxyPromise).pg3dShim(\n          () => this.schedulable.scheduleRender(),\n          this.puzzleLoader,\n          hintFacelets === \"auto\" ? \"floating\" : hintFacelets,\n          faceletScale,\n        );\n        // TODO: Figure out how to do this in one place using the listener.\n        pg3d.then((p) =>\n          p.experimentalUpdateTexture(\n            true,\n            foundationSprite ?? undefined,\n            hintSprite ?? undefined,\n          ),\n        );\n        return pg3d;\n      }\n    })());\n  }\n\n  async raycastMove(\n    raycasterPromise: Promise<Raycaster>,\n    transformations: {\n      invert: boolean;\n      depth?: \"secondSlice\" | \"rotation\" | \"none\";\n    },\n  ): Promise<void> {\n    const puzzle = (await this.twisty3DPuzzle()) as Cube3D | PG3D;\n    // TODO: check this differently.\n    if (!(\"experimentalGetControlTargets\" in puzzle)) {\n      console.info(\"not PG3D! skipping raycast\");\n      return;\n    }\n\n    const targets = puzzle.experimentalGetControlTargets(); // TODO: sticker targets\n    const [raycaster, movePressCancelOptions] = await Promise.all([\n      raycasterPromise,\n      this.model.twistySceneModel.movePressCancelOptions.get(),\n    ]);\n\n    const intersects = raycaster.intersectObjects(targets);\n    if (intersects.length > 0) {\n      const closestMove = puzzle.getClosestMoveToAxis(\n        intersects[0].point,\n        transformations,\n      );\n      if (closestMove) {\n        this.model.experimentalAddMove(closestMove.move, {\n          cancel: movePressCancelOptions,\n        });\n      } else {\n        console.info(\"Skipping move!\");\n      }\n    }\n  }\n}\n", "import type { PerspectiveCamera, Scene as ThreeScene } from \"three\";\nimport type { PuzzleLoader } from \"../../../puzzles\";\nimport type { Schedulable } from \"../../controllers/RenderScheduler\";\nimport { THREEJS } from \"../../heavy-code-imports/3d\";\nimport { StaleDropper } from \"../../model/PromiseFreshener\";\nimport { FreshListenerManager } from \"../../model/props/TwistyProp\";\nimport type {\n  BackViewLayout,\n  BackViewLayoutWithAuto,\n} from \"../../model/props/viewer/BackViewProp\";\nimport type { VisualizationStrategy } from \"../../model/props/viewer/VisualizationStrategyProp\";\nimport type { TwistyPlayerModel } from \"../../model/TwistyPlayerModel\";\nimport { ClassListManager } from \"../ClassListManager\";\nimport { InitialValueTracker } from \"../InitialValueTracker\";\nimport { ManagedCustomElement } from \"../ManagedCustomElement\";\nimport { customElementsShim } from \"../node-custom-element-shims\";\nimport { twistyViewerWrapperCSS } from \"../TwistyViewerWrapper.css\";\nimport type { PressInfo } from \"./DragTracker\";\nimport { Twisty3DPuzzleWrapper } from \"./Twisty3DPuzzleWrapper\";\nimport { Twisty3DVantage } from \"./Twisty3DVantage\";\n\nexport class Twisty3DSceneWrapper\n  extends ManagedCustomElement\n  implements Schedulable\n{\n  #backViewClassListManager: ClassListManager<BackViewLayoutWithAuto> =\n    new ClassListManager(this, \"back-view-\", [\n      \"auto\",\n      \"none\",\n      \"side-by-side\",\n      \"top-right\",\n    ]);\n\n  #freshListenerManager = new FreshListenerManager();\n  disconnect(): void {\n    this.#freshListenerManager.disconnect();\n  }\n\n  constructor(public model?: TwistyPlayerModel) {\n    super();\n  }\n\n  async connectedCallback(): Promise<void> {\n    if(Array.from(this.#vantages.values()).length < 1) {\n      this.addCSS(twistyViewerWrapperCSS);\n      const vantage = new Twisty3DVantage(this.model, this);\n      this.addVantage(vantage);\n      if (this.model) {\n        this.#freshListenerManager.addMultiListener(\n          [this.model.puzzleLoader, this.model.visualizationStrategy],\n          this.onPuzzle.bind(this),\n        );\n        this.#freshListenerManager.addListener(\n          this.model.backView,\n          this.onBackView.bind(this),\n        );\n      }\n      this.scheduleRender();\n    }\n  }\n\n  #backViewVantage: Twisty3DVantage | null = null;\n  setBackView(backView: BackViewLayout): void {\n    const shouldHaveBackView = [\"side-by-side\", \"top-right\"].includes(backView);\n    const hasBackView = this.#backViewVantage !== null;\n\n    this.#backViewClassListManager.setValue(backView);\n    if (shouldHaveBackView) {\n      if (!hasBackView) {\n        this.#backViewVantage = new Twisty3DVantage(this.model, this, {\n          backView: true,\n        });\n        this.addVantage(this.#backViewVantage);\n        this.scheduleRender();\n      }\n    } else {\n      if (this.#backViewVantage) {\n        this.removeVantage(this.#backViewVantage);\n        this.#backViewVantage = null;\n      }\n    }\n  }\n\n  onBackView(backView: BackViewLayout): void {\n    this.setBackView(backView);\n  }\n\n  async onPress(\n    e: CustomEvent<{\n      pressInfo: PressInfo;\n      cameraPromise: Promise<PerspectiveCamera>;\n    }>,\n  ): Promise<void> {\n    const twisty3DPuzzleWrapper = this.#currentTwisty3DPuzzleWrapper;\n    if (!twisty3DPuzzleWrapper) {\n      console.info(\"no wrapper; skipping scene wrapper press!\");\n      return;\n    }\n\n    const raycasterPromise = (async () => {\n      const [camera, three] = await Promise.all([\n        e.detail.cameraPromise,\n        THREEJS,\n      ]);\n\n      const raycaster = new three.Raycaster();\n      const mouse = new (await THREEJS).Vector2(\n        e.detail.pressInfo.normalizedX,\n        e.detail.pressInfo.normalizedY,\n      );\n      raycaster.setFromCamera(mouse, camera);\n      return raycaster;\n    })();\n\n    twisty3DPuzzleWrapper.raycastMove(raycasterPromise, {\n      invert: !e.detail.pressInfo.rightClick,\n      depth: e.detail.pressInfo.keys.ctrlOrMetaKey\n        ? \"rotation\"\n        : e.detail.pressInfo.keys.shiftKey\n        ? \"secondSlice\"\n        : \"none\",\n    });\n  }\n\n  #cachedScene: Promise<ThreeScene> | null;\n  async scene(): Promise<ThreeScene> {\n    return (this.#cachedScene ??= (async () => new (await THREEJS).Scene())());\n  }\n\n  #vantages: Set<Twisty3DVantage> = new Set();\n  addVantage(vantage: Twisty3DVantage) {\n    vantage.addEventListener(\"press\", this.onPress.bind(this));\n    this.#vantages.add(vantage);\n    this.contentWrapper.appendChild(vantage);\n  }\n\n  removeVantage(vantage: Twisty3DVantage) {\n    this.#vantages.delete(vantage);\n    vantage.remove();\n    vantage.disconnect();\n    this.#currentTwisty3DPuzzleWrapper?.disconnect();\n  }\n\n  experimentalVantages(): Iterable<Twisty3DVantage> {\n    return this.#vantages.values();\n  }\n\n  scheduleRender(): void {\n    for (const vantage of this.#vantages) {\n      vantage.scheduleRender();\n    }\n  }\n\n  #currentTwisty3DPuzzleWrapper: Twisty3DPuzzleWrapper | null = null;\n  // #oldTwisty3DPuzzleWrappers: Twisty3DPuzzleWrapper[] = []; // TODO: Animate these out.\n  async setCurrentTwisty3DPuzzleWrapper(\n    scene: ThreeScene,\n    twisty3DPuzzleWrapper: Twisty3DPuzzleWrapper,\n  ): Promise<void> {\n    const old = this.#currentTwisty3DPuzzleWrapper;\n    try {\n      this.#currentTwisty3DPuzzleWrapper = twisty3DPuzzleWrapper;\n      old?.disconnect();\n      scene.add(await twisty3DPuzzleWrapper.twisty3DPuzzle());\n    } finally {\n      if (old) {\n        // We wait for the new puzzle to be in place before removing the old one.\n        scene.remove(await old.twisty3DPuzzle());\n      }\n    }\n    this.#initialWrapperTracker.handleNewValue(twisty3DPuzzleWrapper);\n  }\n\n  #initialWrapperTracker = new InitialValueTracker<Twisty3DPuzzleWrapper>();\n  /** @deprecated */\n  async experimentalTwisty3DPuzzleWrapper(): Promise<Twisty3DPuzzleWrapper> {\n    return (\n      this.#currentTwisty3DPuzzleWrapper || this.#initialWrapperTracker.promise\n    );\n  }\n\n  #twisty3DStaleDropper: StaleDropper<[ThreeScene, Twisty3DPuzzleWrapper]> =\n    new StaleDropper<[ThreeScene, Twisty3DPuzzleWrapper]>();\n\n  async onPuzzle(\n    inputs: [\n      puzzleLoader: PuzzleLoader,\n      visualizationStrategy: VisualizationStrategy,\n    ],\n  ): Promise<void> {\n    if (inputs[1] === \"2D\") {\n      // We are being asked to render with stale info. Ignore.\n      return;\n    }\n    this.#currentTwisty3DPuzzleWrapper?.disconnect();\n    const [scene, twisty3DPuzzleWrapper] =\n      await this.#twisty3DStaleDropper.queue(\n        Promise.all([\n          this.scene(),\n          new Twisty3DPuzzleWrapper(this.model!, this, inputs[0], inputs[1]), // TODO\n        ]),\n      );\n\n    this.setCurrentTwisty3DPuzzleWrapper(scene, twisty3DPuzzleWrapper);\n  }\n}\n\ncustomElementsShim.define(\"twisty-3d-scene-wrapper\", Twisty3DSceneWrapper);\n", "import { CSSSource } from \"../ManagedCustomElement\";\n\nexport const buttonGridCSS = new CSSSource(\n  `\n:host {\n  width: 384px;\n  height: 24px;\n  display: grid;\n}\n\n.wrapper {\n  width: 100%;\n  height: 100%;\n  display: grid;\n  overflow: hidden;\n  backdrop-filter: blur(4px);\n  -webkit-backdrop-filter: blur(4px);\n}\n\n.wrapper {\n  grid-auto-flow: column;\n}\n\n.viewer-link-none .twizzle-link-button {\n  display: none;\n}\n\n.wrapper twisty-button,\n.wrapper twisty-control-button {\n  width: inherit;\n  height: inherit;\n}\n`,\n);\n\nexport const buttonCSS = new CSSSource(\n  `\n:host:not([hidden]) {\n  display: grid;\n}\n\n:host {\n  width: 48px;\n  height: 24px;\n}\n\n.wrapper {\n  width: 100%;\n  height: 100%;\n}\n\nbutton {\n  width: 100%;\n  height: 100%;\n  border: none;\n  \n  background-position: center;\n  background-repeat: no-repeat;\n  background-size: contain;\n\n  background-color: rgba(196, 196, 196, 0.75);\n}\n\nbutton:enabled {\n  background-color: rgba(196, 196, 196, 0.75)\n}\n\n.dark-mode button:enabled {\n  background-color: #88888888;\n}\n\nbutton:disabled {\n  background-color: rgba(0, 0, 0, 0.4);\n  opacity: 0.25;\n  pointer-events: none;\n}\n\n.dark-mode button:disabled {\n  background-color: #ffffff44;\n}\n\nbutton:enabled:hover {\n  background-color: rgba(255, 255, 255, 0.75);\n  box-shadow: 0 0 1em rgba(0, 0, 0, 0.25);\n  cursor: pointer;\n}\n\n/* TODO: fullscreen icons have too much padding?? */\n.svg-skip-to-start button,\nbutton.svg-skip-to-start {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNTg0IiBoZWlnaHQ9IjM1ODQiIHZpZXdCb3g9IjAgMCAzNTg0IDM1ODQiPjxwYXRoIGQ9Ik0yNjQzIDEwMzdxMTktMTkgMzItMTN0MTMgMzJ2MTQ3MnEwIDI2LTEzIDMydC0zMi0xM2wtNzEwLTcxMHEtOS05LTEzLTE5djcxMHEwIDI2LTEzIDMydC0zMi0xM2wtNzEwLTcxMHEtOS05LTEzLTE5djY3OHEwIDI2LTE5IDQ1dC00NSAxOUg5NjBxLTI2IDAtNDUtMTl0LTE5LTQ1VjEwODhxMC0yNiAxOS00NXQ0NS0xOWgxMjhxMjYgMCA0NSAxOXQxOSA0NXY2NzhxNC0xMSAxMy0xOWw3MTAtNzEwcTE5LTE5IDMyLTEzdDEzIDMydjcxMHE0LTExIDEzLTE5eiIvPjwvc3ZnPg==\");\n}\n\n.svg-skip-to-end button,\nbutton.svg-skip-to-end {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNTg0IiBoZWlnaHQ9IjM1ODQiIHZpZXdCb3g9IjAgMCAzNTg0IDM1ODQiPjxwYXRoIGQ9Ik05NDEgMjU0N3EtMTkgMTktMzIgMTN0LTEzLTMyVjEwNTZxMC0yNiAxMy0zMnQzMiAxM2w3MTAgNzEwcTggOCAxMyAxOXYtNzEwcTAtMjYgMTMtMzJ0MzIgMTNsNzEwIDcxMHE4IDggMTMgMTl2LTY3OHEwLTI2IDE5LTQ1dDQ1LTE5aDEyOHEyNiAwIDQ1IDE5dDE5IDQ1djE0MDhxMCAyNi0xOSA0NXQtNDUgMTloLTEyOHEtMjYgMC00NS0xOXQtMTktNDV2LTY3OHEtNSAxMC0xMyAxOWwtNzEwIDcxMHEtMTkgMTktMzIgMTN0LTEzLTMydi03MTBxLTUgMTAtMTMgMTl6Ii8+PC9zdmc+\");\n}\n\n.svg-step-forward button,\nbutton.svg-step-forward {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNTg0IiBoZWlnaHQ9IjM1ODQiIHZpZXdCb3g9IjAgMCAzNTg0IDM1ODQiPjxwYXRoIGQ9Ik0yNjg4IDE1NjhxMCAyNi0xOSA0NWwtNTEyIDUxMnEtMTkgMTktNDUgMTl0LTQ1LTE5cS0xOS0xOS0xOS00NXYtMjU2aC0yMjRxLTk4IDAtMTc1LjUgNnQtMTU0IDIxLjVxLTc2LjUgMTUuNS0xMzMgNDIuNXQtMTA1LjUgNjkuNXEtNDkgNDIuNS04MCAxMDF0LTQ4LjUgMTM4LjVxLTE3LjUgODAtMTcuNSAxODEgMCA1NSA1IDEyMyAwIDYgMi41IDIzLjV0Mi41IDI2LjVxMCAxNS04LjUgMjV0LTIzLjUgMTBxLTE2IDAtMjgtMTctNy05LTEzLTIydC0xMy41LTMwcS03LjUtMTctMTAuNS0yNC0xMjctMjg1LTEyNy00NTEgMC0xOTkgNTMtMzMzIDE2Mi00MDMgODc1LTQwM2gyMjR2LTI1NnEwLTI2IDE5LTQ1dDQ1LTE5cTI2IDAgNDUgMTlsNTEyIDUxMnExOSAxOSAxOSA0NXoiLz48L3N2Zz4=\");\n}\n\n.svg-step-backward button,\nbutton.svg-step-backward {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNTg0IiBoZWlnaHQ9IjM1ODQiIHZpZXdCb3g9IjAgMCAzNTg0IDM1ODQiPjxwYXRoIGQ9Ik0yNjg4IDIwNDhxMCAxNjYtMTI3IDQ1MS0zIDctMTAuNSAyNHQtMTMuNSAzMHEtNiAxMy0xMyAyMi0xMiAxNy0yOCAxNy0xNSAwLTIzLjUtMTB0LTguNS0yNXEwLTkgMi41LTI2LjV0Mi41LTIzLjVxNS02OCA1LTEyMyAwLTEwMS0xNy41LTE4MXQtNDguNS0xMzguNXEtMzEtNTguNS04MC0xMDF0LTEwNS41LTY5LjVxLTU2LjUtMjctMTMzLTQyLjV0LTE1NC0yMS41cS03Ny41LTYtMTc1LjUtNmgtMjI0djI1NnEwIDI2LTE5IDQ1dC00NSAxOXEtMjYgMC00NS0xOWwtNTEyLTUxMnEtMTktMTktMTktNDV0MTktNDVsNTEyLTUxMnExOS0xOSA0NS0xOXQ0NSAxOXExOSAxOSAxOSA0NXYyNTZoMjI0cTcxMyAwIDg3NSA0MDMgNTMgMTM0IDUzIDMzM3oiLz48L3N2Zz4=\");\n}\n\n.svg-pause button,\nbutton.svg-pause {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNTg0IiBoZWlnaHQ9IjM1ODQiIHZpZXdCb3g9IjAgMCAzNTg0IDM1ODQiPjxwYXRoIGQ9Ik0yNTYwIDEwODh2MTQwOHEwIDI2LTE5IDQ1dC00NSAxOWgtNTEycS0yNiAwLTQ1LTE5dC0xOS00NVYxMDg4cTAtMjYgMTktNDV0NDUtMTloNTEycTI2IDAgNDUgMTl0MTkgNDV6bS04OTYgMHYxNDA4cTAgMjYtMTkgNDV0LTQ1IDE5aC01MTJxLTI2IDAtNDUtMTl0LTE5LTQ1VjEwODhxMC0yNiAxOS00NXQ0NS0xOWg1MTJxMjYgMCA0NSAxOXQxOSA0NXoiLz48L3N2Zz4=\");\n}\n\n.svg-play button,\nbutton.svg-play {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNTg0IiBoZWlnaHQ9IjM1ODQiIHZpZXdCb3g9IjAgMCAzNTg0IDM1ODQiPjxwYXRoIGQ9Ik0yNDcyLjUgMTgyM2wtMTMyOCA3MzhxLTIzIDEzLTM5LjUgM3QtMTYuNS0zNlYxMDU2cTAtMjYgMTYuNS0zNnQzOS41IDNsMTMyOCA3MzhxMjMgMTMgMjMgMzF0LTIzIDMxeiIvPjwvc3ZnPg==\");\n}\n\n.svg-enter-fullscreen button,\nbutton.svg-enter-fullscreen {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCAyOCAyOCIgd2lkdGg9IjI4Ij48cGF0aCBkPSJNMiAyaDI0djI0SDJ6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTkgMTZIN3Y1aDV2LTJIOXYtM3ptLTItNGgyVjloM1Y3SDd2NXptMTIgN2gtM3YyaDV2LTVoLTJ2M3pNMTYgN3YyaDN2M2gyVjdoLTV6Ii8+PC9zdmc+\");\n}\n\n.svg-exit-fullscreen button,\nbutton.svg-exit-fullscreen {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCAyOCAyOCIgd2lkdGg9IjI4Ij48cGF0aCBkPSJNMiAyaDI0djI0SDJ6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTcgMThoM3YzaDJ2LTVIN3Yyem0zLThIN3YyaDVWN2gtMnYzem02IDExaDJ2LTNoM3YtMmgtNXY1em0yLTExVjdoLTJ2NWg1di0yaC0zeiIvPjwvc3ZnPg==\");\n}\n\n.svg-twizzle-tw button,\nbutton.svg-twizzle-tw {\n  background-image: url(\"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODY0IiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMzk3LjU4MSAxNTEuMTh2NTcuMDg0aC04OS43MDN2MjQwLjM1MmgtNjYuOTU1VjIwOC4yNjRIMTUxLjIydi01Ny4wODNoMjQ2LjM2MXptNTQuMzEgNzEuNjc3bDcuNTEyIDMzLjY5MmMyLjcxOCAxMi4xNiA1LjU4IDI0LjY4IDguNTg0IDM3LjU1NWEyMTgwLjc3NSAyMTgwLjc3NSAwIDAwOS40NDIgMzguODQzIDEyNjYuMyAxMjY2LjMgMCAwMDEwLjA4NiAzNy41NTVjMy43Mi0xMi41OSA3LjM2OC0yNS40NjYgMTAuOTQ1LTM4LjYyOCAzLjU3Ni0xMy4xNjIgNy4wMS0yNi4xMSAxMC4zLTM4Ljg0M2w1Ljc2OS0yMi40NTZjMS4yNDgtNC44ODcgMi40NzItOS43MDUgMy42NzQtMTQuNDU1IDMuMDA0LTExLjg3NSA1LjY1MS0yMi45NjIgNy45NC0zMy4yNjNoNDYuMzU0bDIuMzg0IDEwLjU2M2EyMDAwLjc3IDIwMDAuNzcgMCAwMDMuOTM1IDE2LjgyOGw2LjcxMSAyNy43MWMxLjIxMyA0Ljk1NiAyLjQ1IDkuOTggMy43MDkgMTUuMDczYTMxMTkuNzc3IDMxMTkuNzc3IDAgMDA5Ljg3MSAzOC44NDMgMTI0OS4yMjcgMTI0OS4yMjcgMCAwMDEwLjczIDM4LjYyOCAxOTA3LjYwNSAxOTA3LjYwNSAwIDAwMTAuMzAxLTM3LjU1NSAxMzk3Ljk0IDEzOTcuOTQgMCAwMDkuNjU3LTM4Ljg0M2w0LjQtMTkuMDQ2Yy43MTUtMy4xMyAxLjQyMS02LjIzNiAyLjExOC05LjMyMWw5LjU3Ny00Mi44OGg2Ni41MjZhMjk4OC43MTggMjk4OC43MTggMCAwMS0xOS41MjkgNjYuMzExbC01LjcyOCAxOC40ODJhMzIzNy40NiAzMjM3LjQ2IDAgMDEtMTQuMDE1IDQzLjc1MmMtNi40MzggMTkuNi0xMi43MzMgMzcuNjk4LTE4Ljg4NSA1NC4yOTRsLTMuMzA2IDguODI1Yy00Ljg4NCAxMi44OTgtOS40MzMgMjQuMjYzLTEzLjY0NyAzNC4wOTVoLTQ5Ljc4N2E4NDE3LjI4OSA4NDE3LjI4OSAwIDAxLTIxLjAzMS02NC44MDkgMTI4OC42ODYgMTI4OC42ODYgMCAwMS0xOC44ODUtNjQuODEgMTk3Mi40NDQgMTk3Mi40NDQgMCAwMS0xOC4yNCA2NC44MSAyNTc5LjQxMiAyNTc5LjQxMiAwIDAxLTIwLjM4OCA2NC44MWgtNDkuNzg3Yy00LjY4Mi0xMC45MjYtOS43Mi0yMy43NDMtMTUuMTEtMzguNDUxbC0xLjYyOS00LjQ3Yy01LjI1OC0xNC41MjEtMTAuNjgtMzAuMTkyLTE2LjI2Ni00Ny4wMTRsLTIuNDA0LTcuMjhjLTYuNDM4LTE5LjYtMTMuMDItNDAuMzQ0LTE5Ljc0My02Mi4yMzRhMjk4OC43MDcgMjk4OC43MDcgMCAwMS0xOS41MjktNjYuMzExaDY3LjM4NXoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjwvc3ZnPg==\");\n}\n`,\n);\n// Sized against full-screen dimensions.\n// button.svg-twizzle-tw {\n//   background-image: url(\"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzc3IiBoZWlnaHQ9IjUxMyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMzU0LjU4MSAxMDcuMTh2NTcuMDg0aC04OS43MDN2MjQwLjM1MmgtNjYuOTU1VjE2NC4yNjRIMTA4LjIydi01Ny4wODNoMjQ2LjM2MXptNTQuMzEgNzEuNjc3bDcuNTEyIDMzLjY5MmMyLjcxOCAxMi4xNiA1LjU4IDI0LjY4IDguNTg0IDM3LjU1NWEyMTgwLjc3NSAyMTgwLjc3NSAwIDAwOS40NDIgMzguODQzIDEyNjYuMyAxMjY2LjMgMCAwMDEwLjA4NiAzNy41NTVjMy43Mi0xMi41OSA3LjM2OC0yNS40NjYgMTAuOTQ1LTM4LjYyOCAzLjU3Ni0xMy4xNjIgNy4wMS0yNi4xMSAxMC4zLTM4Ljg0M2w1Ljc2OS0yMi40NTZjMS4yNDgtNC44ODcgMi40NzItOS43MDUgMy42NzQtMTQuNDU1IDMuMDA0LTExLjg3NSA1LjY1MS0yMi45NjIgNy45NC0zMy4yNjNoNDYuMzU0bDIuMzg0IDEwLjU2M2EyMDAwLjc3IDIwMDAuNzcgMCAwMDMuOTM1IDE2LjgyOGw2LjcxMSAyNy43MWMxLjIxMyA0Ljk1NiAyLjQ1IDkuOTggMy43MDkgMTUuMDczYTMxMTkuNzc3IDMxMTkuNzc3IDAgMDA5Ljg3MSAzOC44NDMgMTI0OS4yMjcgMTI0OS4yMjcgMCAwMDEwLjczIDM4LjYyOCAxOTA3LjYwNSAxOTA3LjYwNSAwIDAwMTAuMzAxLTM3LjU1NSAxMzk3Ljk0IDEzOTcuOTQgMCAwMDkuNjU3LTM4Ljg0M2w0LjQtMTkuMDQ2Yy43MTUtMy4xMyAxLjQyMS02LjIzNiAyLjExOC05LjMyMWw5LjU3Ny00Mi44OGg2Ni41MjZhMjk4OC43MTggMjk4OC43MTggMCAwMS0xOS41MjkgNjYuMzExbC01LjcyOCAxOC40ODJhMzIzNy40NiAzMjM3LjQ2IDAgMDEtMTQuMDE1IDQzLjc1MmMtNi40MzggMTkuNi0xMi43MzMgMzcuNjk4LTE4Ljg4NSA1NC4yOTRsLTMuMzA2IDguODI1Yy00Ljg4NCAxMi44OTgtOS40MzMgMjQuMjYzLTEzLjY0NyAzNC4wOTVoLTQ5Ljc4N2E4NDE3LjI4OSA4NDE3LjI4OSAwIDAxLTIxLjAzMS02NC44MDkgMTI4OC42ODYgMTI4OC42ODYgMCAwMS0xOC44ODUtNjQuODEgMTk3Mi40NDQgMTk3Mi40NDQgMCAwMS0xOC4yNCA2NC44MSAyNTc5LjQxMiAyNTc5LjQxMiAwIDAxLTIwLjM4OCA2NC44MWgtNDkuNzg3Yy00LjY4Mi0xMC45MjYtOS43Mi0yMy43NDMtMTUuMTEtMzguNDUxbC0xLjYyOS00LjQ3Yy01LjI1OC0xNC41MjEtMTAuNjgtMzAuMTkyLTE2LjI2Ni00Ny4wMTRsLTIuNDA0LTcuMjhjLTYuNDM4LTE5LjYtMTMuMDItNDAuMzQ0LTE5Ljc0My02Mi4yMzRhMjk4OC43MDcgMjk4OC43MDcgMCAwMS0xOS41MjktNjYuMzExaDY3LjM4NXoiIGZpbGw9IiM0Mjg1RjQiIGZpbGwtcnVsZT0ibm9uemVybyIvPjwvc3ZnPg==\");\n// }\n", "// Use like this:\n// const enabled = globalSafeDocument?.fullscreenEnabled;\nexport const globalSafeDocument: Document | null =\n  typeof document === \"undefined\" ? null : document;\n", "// Ponyfills for prefixing in Safari.\n\nimport { globalSafeDocument } from \"../document\";\n\ndeclare global {\n  interface Document {\n    webkitFullscreenEnabled?: boolean;\n    webkitExitFullscreen?: () => Promise<void>;\n    webkitFullscreenElement?: Element | null;\n  }\n\n  interface Element {\n    webkitRequestFullscreen: () => Promise<void>;\n  }\n}\n\n// TODO: Can `webkitFullscreenEnabled` change after it's cached at page load?\nexport const fullscreenEnabled: boolean =\n  globalSafeDocument?.fullscreenEnabled ||\n  !!globalSafeDocument?.webkitFullscreenEnabled;\n\nexport function documentExitFullscreen(): Promise<void> {\n  if (document.exitFullscreen) {\n    return document.exitFullscreen();\n  } else {\n    return document.webkitExitFullscreen!(); // YOLO\n  }\n}\n\nexport function documentFullscreenElement(): Element | null {\n  if (document.fullscreenElement) {\n    return document.fullscreenElement;\n  } else {\n    return document.webkitFullscreenElement ?? null;\n  }\n}\n\nexport function requestFullscreen(element: Element): Promise<void> {\n  if (element.requestFullscreen) {\n    return element.requestFullscreen();\n  } else {\n    return element.webkitRequestFullscreen();\n  }\n}\n", "import type { ButtonCommand } from \"../../../views/control-panel/TwistyButtons\";\nimport { fullscreenEnabled } from \"../../../views/control-panel/webkit-fullscreen\";\nimport type { ViewerLinkPageWithAuto } from \"./ViewerLinkProp\";\nimport type { CoarseTimelineInfo as CoarseTimelineInfo } from \"../timeline/CoarseTimelineInfoProp\";\nimport { TwistyPropDerived } from \"../TwistyProp\";\n\nexport const buttonIcons = [\n  \"skip-to-start\",\n  \"skip-to-end\",\n  \"step-forward\",\n  \"step-backward\",\n  \"pause\",\n  \"play\",\n  \"enter-fullscreen\",\n  \"exit-fullscreen\",\n  \"twizzle-tw\",\n];\nexport type ButtonIcon = typeof buttonIcons[number];\n\ninterface ButtonAppearance {\n  enabled: boolean;\n  icon: ButtonIcon;\n  title: string;\n  hidden?: boolean;\n}\nexport type ButtonAppearances = Record<ButtonCommand, ButtonAppearance>;\n\n// TODO: reduce inputs to avoid unnecessary updates.\ninterface ButtonAppearancePropInputs {\n  coarseTimelineInfo: CoarseTimelineInfo;\n  viewerLink: ViewerLinkPageWithAuto;\n}\n\nexport class ButtonAppearanceProp extends TwistyPropDerived<\n  ButtonAppearancePropInputs,\n  ButtonAppearances\n> {\n  // TODO: This still seems to fire twice for play/pause?\n  derive(inputs: ButtonAppearancePropInputs): ButtonAppearances {\n    const buttonAppearances = {\n      fullscreen: {\n        // TODO: Cache?// TODO: Cache?\n        enabled: fullscreenEnabled,\n        icon:\n          // TODO: Check against the expected element?\n          // TODO: This will *not* update when we enter/leave fullscreen. We need to work more closely with the controller.\n          document.fullscreenElement === null\n            ? \"enter-fullscreen\"\n            : \"exit-fullscreen\",\n        title: \"Enter fullscreen\",\n      },\n      \"jump-to-start\": {\n        enabled: !inputs.coarseTimelineInfo.atStart,\n        icon: \"skip-to-start\",\n        title: \"Restart\",\n      },\n      \"play-step-backwards\": {\n        enabled: !inputs.coarseTimelineInfo.atStart,\n        icon: \"step-backward\",\n        title: \"Step backward\",\n      },\n      \"play-pause\": {\n        enabled: !(\n          inputs.coarseTimelineInfo.atStart && inputs.coarseTimelineInfo.atEnd\n        ),\n        icon: inputs.coarseTimelineInfo.playing ? \"pause\" : \"play\",\n        title: inputs.coarseTimelineInfo.playing ? \"Pause\" : \"Play\",\n      },\n      \"play-step\": {\n        enabled: !inputs.coarseTimelineInfo.atEnd,\n        icon: \"step-forward\",\n        title: \"Step forward\",\n      },\n      \"jump-to-end\": {\n        enabled: !inputs.coarseTimelineInfo.atEnd,\n        icon: \"skip-to-end\",\n        title: \"Skip to End\",\n      },\n      \"twizzle-link\": {\n        enabled: true,\n        icon: \"twizzle-tw\",\n        title: \"View at Twizzle\",\n        hidden: inputs.viewerLink === \"none\",\n      },\n    };\n    return buttonAppearances;\n  }\n}\n", "import { BoundaryType, Direction } from \"../../controllers/AnimationTypes\";\nimport { buttonCSS, buttonGridCSS } from \"./TwistyButtons.css\";\nimport { ClassListManager } from \"../ClassListManager\";\nimport { ManagedCustomElement } from \"../ManagedCustomElement\";\nimport { customElementsShim } from \"../node-custom-element-shims\";\nimport {\n  ButtonAppearances,\n  ButtonIcon,\n  buttonIcons,\n} from \"../../model/props/viewer/ButtonAppearanceProp\";\nimport type { TwistyPlayerModel } from \"../../model/TwistyPlayerModel\";\nimport type { TwistyPlayerController } from \"../../controllers/TwistyPlayerController\";\nimport {\n  documentExitFullscreen,\n  documentFullscreenElement,\n  requestFullscreen,\n} from \"./webkit-fullscreen\";\nimport type { DarkModeTheme } from \"../../model/props/viewer/DarkModeRequestProp\";\n\nconst buttonCommands = {\n  fullscreen: true,\n  \"jump-to-start\": true,\n  \"play-step-backwards\": true,\n  \"play-pause\": true,\n  \"play-step\": true,\n  \"jump-to-end\": true,\n  \"twizzle-link\": true,\n};\n\nexport type ButtonCommand = keyof typeof buttonCommands;\n\nexport class TwistyButtons extends ManagedCustomElement {\n  buttons: Record<ButtonCommand, TwistyButton> | null = null;\n\n  // TODO: Privacy\n  constructor(\n    public model?: TwistyPlayerModel,\n    public controller?: TwistyPlayerController,\n    private defaultFullscreenElement?: HTMLElement,\n  ) {\n    super();\n  }\n\n  connectedCallback(): void {\n    this.addCSS(buttonGridCSS);\n    const buttons: Partial<Record<ButtonCommand, TwistyButton>> = {};\n    for (const command in buttonCommands) {\n      const button = new TwistyButton();\n      buttons[command as ButtonCommand] = button;\n      button.htmlButton.addEventListener(\"click\", () =>\n        this.#onCommand(command as ButtonCommand),\n      );\n      this.addElement(button);\n    }\n    this.buttons = buttons as Record<ButtonCommand, TwistyButton>;\n\n    this.model?.buttonAppearance.addFreshListener(this.update.bind(this));\n    this.model?.twistySceneModel.darkMode.addFreshListener(\n      this.updateDarkMode.bind(this),\n    );\n  }\n\n  #onCommand(command: ButtonCommand) {\n    switch (command) {\n      case \"fullscreen\": {\n        this.onFullscreenButton();\n        break;\n      }\n      case \"jump-to-start\": {\n        this.controller?.jumpToStart({ flash: true });\n        break;\n      }\n      case \"play-step-backwards\": {\n        this.controller?.animationController.play({\n          direction: Direction.Backwards,\n          untilBoundary: BoundaryType.Move,\n        });\n        break;\n      }\n      case \"play-pause\": {\n        this.controller?.togglePlay();\n        break;\n      }\n      case \"play-step\": {\n        this.controller?.animationController.play({\n          direction: Direction.Forwards,\n          untilBoundary: BoundaryType.Move,\n        });\n        break;\n      }\n      case \"jump-to-end\": {\n        this.controller?.jumpToEnd({ flash: true });\n        break;\n      }\n      case \"twizzle-link\": {\n        this.controller?.visitTwizzleLink();\n        break;\n      }\n      default:\n        throw new Error(\"Missing command\");\n    }\n  }\n\n  // TODO: Should we have a prop, or a way to query if we're fullscreen?\n  // https://developer.mozilla.org/en-US/docs/Web/API/Element/requestFullScreen\n  async onFullscreenButton(): Promise<void> {\n    if (!this.defaultFullscreenElement) {\n      throw new Error(\"Attempted to go fullscreen without an element.\");\n    }\n\n    if (documentFullscreenElement() === this.defaultFullscreenElement) {\n      documentExitFullscreen();\n    } else {\n      // TODO: Propagate button info to `ButtonAppearanceProp`.\n      this.buttons?.fullscreen.setIcon(\"exit-fullscreen\");\n\n      requestFullscreen(\n        (await this.model?.twistySceneModel.fullscreenElement.get()) ??\n          this.defaultFullscreenElement,\n      );\n\n      const onFullscreen = (): void => {\n        if (documentFullscreenElement() !== this.defaultFullscreenElement) {\n          this.buttons?.fullscreen.setIcon(\"enter-fullscreen\");\n          window.removeEventListener(\"fullscreenchange\", onFullscreen);\n        }\n      };\n      window.addEventListener(\"fullscreenchange\", onFullscreen);\n    }\n  }\n\n  async update(buttonAppearances: ButtonAppearances): Promise<void> {\n    // TODO: Check that we have every command?\n    for (const command in buttonCommands) {\n      // TODO: Why doesn't `command` have the type `ButtonCommand`?\n      const button = this.buttons![command as ButtonCommand];\n      // TODO: track individual changes?\n      const info = buttonAppearances[command as ButtonCommand];\n      button.htmlButton.disabled = !info.enabled;\n      button.htmlButton.title = info.title;\n      button.setIcon(info.icon);\n      button.hidden = !!info.hidden;\n      // button.textContent = info.icon;\n    }\n  }\n\n  updateDarkMode(darkMode: DarkModeTheme): void {\n    for (const button of Object.values(this.buttons ?? {})) {\n      button.updateDarkMode(darkMode);\n    }\n  }\n}\n\ncustomElementsShim.define(\"twisty-buttons\", TwistyButtons);\n\nclass TwistyButton extends ManagedCustomElement {\n  htmlButton: HTMLButtonElement = document.createElement(\"button\"); // TODO: async?\n\n  updateDarkMode(darkMode: DarkModeTheme): void {\n    this.contentWrapper.classList.toggle(\"dark-mode\", darkMode === \"dark\");\n  }\n\n  connectedCallback() {\n    this.addCSS(buttonCSS);\n    this.addElement(this.htmlButton);\n  }\n\n  #iconManager: ClassListManager<ButtonIcon> = new ClassListManager(\n    this,\n    \"svg-\",\n    buttonIcons,\n  );\n\n  setIcon(iconName: ButtonIcon): void {\n    this.#iconManager.setValue(iconName);\n  }\n}\n\ncustomElementsShim.define(\"twisty-button\", TwistyButton);\n", "import { CSSSource } from \"../ManagedCustomElement\";\n\nexport const twistyScrubberCSS = new CSSSource(\n  `\n:host {\n  width: 384px;\n  height: 16px;\n  display: grid;\n}\n\n.wrapper {\n  width: 100%;\n  height: 100%;\n  display: grid;\n  overflow: hidden;\n  backdrop-filter: blur(4px);\n  -webkit-backdrop-filter: blur(4px);\n  background: rgba(196, 196, 196, 0.75);\n}\n\ninput:not(:disabled) {\n  cursor: ew-resize;\n}\n\n.wrapper.dark-mode {\n  background: #666666;\n}\n`,\n);\n", "import { twistyScrubberCSS } from \"./TwistyScrubber.css\";\nimport { ManagedCustomElement } from \"../ManagedCustomElement\";\nimport { customElementsShim } from \"../node-custom-element-shims\";\nimport type { DetailedTimelineInfo } from \"../../model/props/timeline/DetailedTimelineInfoProp\";\nimport type { TwistyPlayerModel } from \"../../model/TwistyPlayerModel\";\nimport { globalSafeDocument } from \"../document\";\nimport type { TwistyPlayerController } from \"../../controllers/TwistyPlayerController\";\nimport { BoundaryType, Direction } from \"../../controllers/AnimationTypes\";\nimport type { DarkModeTheme } from \"../../model/props/viewer/DarkModeRequestProp\";\n\nconst SLOW_DOWN_SCRUBBING = false;\n\nlet isMouseDown = false;\n\nglobalSafeDocument?.addEventListener(\n  \"mousedown\",\n  function (event) {\n    if (event.which) {\n      isMouseDown = true;\n    }\n  },\n  true,\n);\n\nglobalSafeDocument?.addEventListener(\n  \"mouseup\",\n  function (event) {\n    if (event.which) {\n      isMouseDown = false;\n    }\n  },\n  true,\n);\n\n// var x = 0;\nlet y = 0;\nlet clickNum = 0;\n\nglobalSafeDocument?.addEventListener(\n  \"mousedown\",\n  () => {\n    clickNum++;\n  },\n  false,\n);\n\nglobalSafeDocument?.addEventListener(\"mousemove\", onMouseUpdate, false);\nglobalSafeDocument?.addEventListener(\"mouseenter\", onMouseUpdate, false);\n\nfunction onMouseUpdate(e: MouseEvent) {\n  // x = e.pageX;\n  y = e.pageY;\n  // console.log(x, y);\n}\n\nconst lastVal = 0;\nlet lastPreval = 0;\nlet scaling: boolean = false;\nlet currentClickNum = 0;\n\n// Values are integers.\nexport class TwistyScrubber extends ManagedCustomElement {\n  constructor(\n    public model?: TwistyPlayerModel,\n    public controller?: TwistyPlayerController,\n  ) {\n    super();\n  }\n\n  async onDetailedTimelineInfo(\n    detailedTimelineInfo: DetailedTimelineInfo,\n  ): Promise<void> {\n    // TODO: is this efficient enough?\n    const inputElem = await this.inputElem();\n    inputElem.min = detailedTimelineInfo.timeRange.start.toString();\n    inputElem.max = detailedTimelineInfo.timeRange.end.toString();\n    inputElem.disabled = inputElem.min === inputElem.max;\n    inputElem.value = detailedTimelineInfo.timestamp.toString();\n  }\n\n  async connectedCallback(): Promise<void> {\n    this.addCSS(twistyScrubberCSS);\n    this.addElement(await this.inputElem());\n    this.model?.twistySceneModel.darkMode.addFreshListener(\n      this.updateDarkMode.bind(this),\n    );\n  }\n\n  updateDarkMode(darkMode: DarkModeTheme): void {\n    this.contentWrapper.classList.toggle(\"dark-mode\", darkMode === \"dark\");\n  }\n\n  #inputElem: Promise<HTMLInputElement> | null = null;\n  async inputElem(): Promise<HTMLInputElement> {\n    // console.log(\"inputElem\", this.#inputElem);\n    return (this.#inputElem ??= (async () => {\n      const elem = document.createElement(\"input\");\n      elem.type = \"range\";\n      elem.disabled = true;\n\n      // console.log(\"1\");\n      this.model?.detailedTimelineInfo.addFreshListener(\n        this.onDetailedTimelineInfo.bind(this),\n      );\n      // console.log(\"3\");\n      elem.addEventListener(\"input\", this.onInput.bind(this));\n      elem.addEventListener(\"keydown\", this.onKeypress.bind(this));\n\n      return elem;\n    })());\n  }\n\n  async onInput(e: Event): Promise<void> {\n    if (scaling) {\n      return; // TODO\n    }\n    const inputElem = await this.inputElem();\n    await this.slowDown(e, inputElem); // TODO\n\n    const value = parseInt(inputElem.value);\n    // console.log(\"on input\", value);\n    this.model?.playingInfo.set({ playing: false });\n    this.model?.timestampRequest.set(value);\n  }\n\n  onKeypress(e: KeyboardEvent): void {\n    switch (e.key) {\n      case \"ArrowLeft\":\n      // fallthrough\n      case \"ArrowRight\": {\n        this.controller?.animationController.play({\n          direction:\n            e.key === \"ArrowLeft\" ? Direction.Backwards : Direction.Forwards,\n          untilBoundary: BoundaryType.Move,\n        });\n        e.preventDefault();\n        break;\n      }\n      case \" \": {\n        this.controller?.togglePlay();\n        e.preventDefault();\n        break;\n      }\n    }\n  }\n\n  async slowDown(e: Event, inputElem: HTMLInputElement): Promise<void> {\n    if (!SLOW_DOWN_SCRUBBING) {\n      return; // TODO\n    }\n\n    if (isMouseDown) {\n      const rect = inputElem.getBoundingClientRect();\n      const sliderY = rect.top + rect.height / 2;\n      console.log(sliderY, e, y, isMouseDown);\n\n      const yDist = Math.abs(sliderY - y);\n      let scale = 1;\n      if (yDist > 64) {\n        scale = Math.max(Math.pow(2, -(yDist - 64) / 64), 1 / 32);\n      }\n      const preVal = parseInt(inputElem.value);\n      console.log(\"cl\", currentClickNum, clickNum, preVal);\n      if (currentClickNum === clickNum) {\n        const delta = (preVal - lastPreval) * scale;\n        console.log(\"delta\", delta, yDist);\n        scaling = true;\n        let newVal = preVal;\n        newVal =\n          lastVal +\n          delta * scale +\n          (preVal - lastVal) *\n            Math.min(1, Math.pow(1 / 2, (yDist * yDist) / 64));\n        inputElem.value = newVal.toString();\n        console.log(scale);\n        scaling = false;\n        this.contentWrapper.style.opacity = scale.toString();\n      } else {\n        currentClickNum = clickNum;\n      }\n      lastPreval = preVal;\n    }\n  }\n}\n\ncustomElementsShim.define(\"twisty-scrubber\", TwistyScrubber);\n", "import type { PerspectiveCamera } from \"three\";\nimport { THREEJS } from \"../heavy-code-imports/3d\";\nimport type { TwistyPlayerModel } from \"../model/TwistyPlayerModel\";\nimport { rawRenderPooled } from \"./3D/RendererPool\";\nimport { Twisty3DPuzzleWrapper } from \"./3D/Twisty3DPuzzleWrapper\";\nimport { setCameraFromOrbitCoordinates } from \"./3D/Twisty3DVantage\";\n\nexport interface TwistyPlayerScreenshot {\n  dataURL: string;\n  download: (filename?: string) => Promise<void>;\n}\n\n// TODO: cache\nlet cachedCamera: PerspectiveCamera | null = null;\nexport async function screenshot(\n  model: TwistyPlayerModel,\n  options?: { width: number; height: number },\n): Promise<TwistyPlayerScreenshot> {\n  // TODO: improve async caching\n\n  // TODO: Avoid the `_stickering` and `_legacyPosition` calls in favor of proper callbacks.\n  const [\n    { PerspectiveCamera, Scene },\n    puzzleLoader,\n    visualizationStrategy,\n    _stickering, // TODO\n    _stickeringMaskRequest, // TODO\n    _legacyPosition,\n    orbitCoordinates,\n  ] = await Promise.all([\n    THREEJS,\n    await model.puzzleLoader.get(),\n    await model.visualizationStrategy.get(),\n    await model.twistySceneModel.stickeringRequest.get(),\n    await model.twistySceneModel.stickeringMaskRequest.get(),\n    await model.legacyPosition.get(),\n    await model.twistySceneModel.orbitCoordinates.get(),\n  ]);\n\n  const width = options?.width ?? 2048;\n  const height = options?.height ?? 2048;\n  const aspectRatio = width / height;\n  const camera = (cachedCamera ??= await (async () => {\n    return new PerspectiveCamera(20, aspectRatio, 0.1, 20);\n  })());\n\n  const scene = new Scene();\n  const twisty3DWrapper = new Twisty3DPuzzleWrapper(\n    model,\n    { scheduleRender: () => {} },\n    puzzleLoader,\n    visualizationStrategy,\n  );\n  scene.add(await twisty3DWrapper.twisty3DPuzzle());\n  await setCameraFromOrbitCoordinates(camera, orbitCoordinates);\n\n  const rendererCanvas = await rawRenderPooled(width, height, scene, camera);\n  const dataURL = rendererCanvas.toDataURL();\n\n  const defaultFilename = await getDefaultFilename(model);\n\n  return {\n    dataURL,\n    download: async (filename?: string) => {\n      downloadURL(dataURL, filename ?? defaultFilename);\n    },\n  };\n}\n\nexport async function getDefaultFilename(\n  model: TwistyPlayerModel,\n): Promise<string> {\n  const [puzzleID, algWithIssues] = await Promise.all([\n    model.puzzleID.get(),\n    model.alg.get(),\n  ]);\n  return `[${puzzleID}]${\n    algWithIssues.alg.experimentalNumChildAlgNodes() === 0\n      ? \"\"\n      : ` ${algWithIssues.alg.toString()}`\n  }`;\n}\n\nexport function downloadURL(\n  url: string,\n  name: string,\n  extension: string = \"png\",\n): void {\n  const a = document.createElement(\"a\");\n  a.href = url;\n  a.download = `${name}.${extension}`;\n  a.click();\n}\n", "import { CSSSource } from \"./ManagedCustomElement\";\n\n// TODO: figure out why `:host(twisty-player):fullscreen { background-color: white }` doesn't work.\nexport const twistyPlayerCSS = new CSSSource(\n  `\n:host {\n  width: 384px;\n  height: 256px;\n  display: grid;\n\n  -webkit-user-select: none;\n  user-select: none;\n}\n\n.wrapper {\n  display: grid;\n  overflow: hidden;\n  contain: size;\n  grid-template-rows: 7fr minmax(1.5em, 0.5fr) minmax(2em, 1fr);\n}\n\n.wrapper > * {\n  width: inherit;\n  height: inherit;\n  overflow: hidden;\n}\n\n.wrapper.controls-none {\n  grid-template-rows: 7fr;\n}\n\n.wrapper.controls-none twisty-scrubber,\n.wrapper.controls-none twisty-control-button-panel ,\n.wrapper.controls-none twisty-scrubber,\n.wrapper.controls-none twisty-buttons {\n  display: none;\n}\n\ntwisty-scrubber {\n  background: rgba(196, 196, 196, 0.5);\n}\n\n.wrapper.checkered,\n.wrapper.checkered-transparent {\n  background-color: #EAEAEA;\n  background-image: linear-gradient(45deg, #DDD 25%, transparent 25%, transparent 75%, #DDD 75%, #DDD),\n    linear-gradient(45deg, #DDD 25%, transparent 25%, transparent 75%, #DDD 75%, #DDD);\n  background-size: 32px 32px;\n  background-position: 0 0, 16px 16px;\n}\n\n.wrapper.checkered-transparent {\n  background-color: #F4F4F4;\n  background-image: linear-gradient(45deg, #DDDDDD88 25%, transparent 25%, transparent 75%, #DDDDDD88 75%, #DDDDDD88),\n    linear-gradient(45deg, #DDDDDD88 25%, transparent 25%, transparent 75%, #DDDDDD88 75%, #DDDDDD88);\n}\n\n.wrapper.dark-mode {\n  background-color: #444;\n  background-image: linear-gradient(45deg, #DDDDDD0b 25%, transparent 25%, transparent 75%, #DDDDDD0b 75%, #DDDDDD0b),\n    linear-gradient(45deg, #DDDDDD0b 25%, transparent 25%, transparent 75%, #DDDDDD0b 75%, #DDDDDD0b);\n}\n\n.visualization-wrapper > * {\n  width: 100%;\n  height: 100%;\n}\n\n.error-elem {\n  width: 100%;\n  height: 100%;\n  display: none;\n  place-content: center;\n  font-family: sans-serif;\n  box-shadow: inset 0 0 2em rgb(255, 0, 0);\n  color: red;\n  text-shadow: 0 0 0.2em white;\n  background: rgba(255, 255, 255, 0.25);\n}\n\n.wrapper.error .visualization-wrapper {\n  display: none;\n}\n\n.wrapper.error .error-elem {\n  display: grid;\n}\n`,\n);\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nexport class ArbitraryStringProp extends SimpleTwistyPropSource<string | null> {\n  getDefaultValue(): string | null {\n    return null;\n  }\n}\n", "import { TwistyPropSource } from \"../TwistyProp\";\n\nexport class URLProp extends TwistyPropSource<URL | null, URL | string | null> {\n  getDefaultValue(): URL | null {\n    return null;\n  }\n\n  derive(input: URL | string | null): URL | null {\n    if (typeof input === \"string\") {\n      return new URL(input, location.href); // TODO\n    }\n    return input;\n  }\n}\n", "import { Alg } from \"../../../../../alg\";\nimport { arrayEquals } from \"../../../helpers\";\nimport { TwistyPropSource } from \"../../TwistyProp\";\n\nexport class AlgIssues {\n  // TODO: (string | Error)[]\n\n  readonly warnings: readonly string[];\n  readonly errors: readonly string[];\n\n  constructor(issues?: { warnings?: string[]; errors?: string[] }) {\n    // TODO: clone inputs?\n    this.warnings = Object.freeze(issues?.warnings ?? []);\n    this.errors = Object.freeze(issues?.errors ?? []);\n    Object.freeze(this);\n  }\n\n  add(issues?: { warnings?: string[]; errors?: string[] }) {\n    return new AlgIssues({\n      warnings: this.warnings.concat(issues?.warnings ?? []),\n      errors: this.errors.concat(issues?.errors ?? []),\n    });\n  }\n\n  /** @deprecated */\n  log() {\n    if (this.errors.length > 0) {\n      console.error(`\uD83D\uDEA8 ${this.errors[0]}`);\n    } else if (this.warnings.length > 0) {\n      console.warn(`\u26A0\uFE0F ${this.warnings[0]}`);\n    } else {\n      console.info(\"\uD83D\uDE0E No issues!\");\n    }\n  }\n}\n\nexport interface AlgWithIssues {\n  alg: Alg;\n  issues: AlgIssues;\n}\n\nexport function algWithIssuesFromString(s: string): AlgWithIssues {\n  try {\n    const alg = Alg.fromString(s); // TODO: is this safe?\n    const warnings = [];\n    if (alg.toString() !== s) {\n      // TODO: Push this check into the parser and return semantic info (so they can be e.g. highlighted).\n      warnings.push(\"Alg is non-canonical!\");\n    }\n    return {\n      alg,\n      issues: new AlgIssues({ warnings }),\n    };\n  } catch (e) {\n    return {\n      alg: new Alg(),\n      issues: new AlgIssues({\n        errors: [`Malformed alg: ${(e as Error).toString()}`],\n      }),\n    };\n  }\n}\n\nfunction algWithIssuesEquals(a1: AlgWithIssues, a2: AlgWithIssues): boolean {\n  return (\n    a1.alg.isIdentical(a2.alg) &&\n    arrayEquals(a1.issues.warnings, a2.issues.warnings) &&\n    arrayEquals(a1.issues.errors, a2.issues.errors)\n  );\n}\n\nexport class AlgProp extends TwistyPropSource<AlgWithIssues, Alg | string> {\n  override getDefaultValue(): AlgWithIssues {\n    return { alg: new Alg(), issues: new AlgIssues() };\n  }\n\n  protected override canReuseValue(v1: AlgWithIssues, v2: AlgWithIssues) {\n    return algWithIssuesEquals(v1, v2);\n  }\n\n  protected override async derive(\n    newAlg: Alg | string,\n  ): Promise<AlgWithIssues> {\n    if (typeof newAlg === \"string\") {\n      return algWithIssuesFromString(newAlg);\n    } else {\n      return {\n        alg: newAlg,\n        issues: new AlgIssues(),\n      };\n    }\n  }\n}\n", "import type { KPuzzle, KTransformation } from \"../../../../../kpuzzle\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { AlgWithIssues } from \"./AlgProp\";\n\ntype AlgTransformationPropInputs = {\n  setupAlg: AlgWithIssues;\n  kpuzzle: KPuzzle;\n};\n\nexport class AlgTransformationProp extends TwistyPropDerived<\n  AlgTransformationPropInputs,\n  KTransformation\n> {\n  derive(input: AlgTransformationPropInputs): KTransformation {\n    return input.kpuzzle.algToTransformation(input.setupAlg.alg);\n  }\n}\n", "import type { KTransformation } from \"../../../../../kpuzzle\";\nimport type { AlgIndexer } from \"../../../../controllers/indexer/AlgIndexer\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { SetupToLocation } from \"./SetupAnchorProp\";\n\ninterface AnchorTransformationPropInputs {\n  setupTransformation: KTransformation | null;\n  setupAnchor: SetupToLocation;\n  setupAlgTransformation: KTransformation;\n  indexer: AlgIndexer;\n}\n\nexport class AnchorTransformationProp extends TwistyPropDerived<\n  AnchorTransformationPropInputs,\n  KTransformation\n> {\n  derive(inputs: AnchorTransformationPropInputs): KTransformation {\n    if (inputs.setupTransformation) {\n      return inputs.setupTransformation;\n    }\n    switch (inputs.setupAnchor) {\n      case \"start\":\n        return inputs.setupAlgTransformation;\n      case \"end\": {\n        const algTransformation = inputs.indexer.transformationAtIndex(\n          inputs.indexer.numAnimatedLeaves(),\n        );\n        const inverseAlgTransformation = algTransformation.invert();\n        return inputs.setupAlgTransformation.applyTransformation(\n          inverseAlgTransformation,\n        );\n      }\n      default:\n        throw new Error(\"Unimplemented!\");\n    }\n  }\n}\n", "import type { Move } from \"../../../../../alg\";\nimport { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport interface CatchUpMove {\n  move: Move | null;\n  amount: number;\n}\n\nexport class CatchUpMoveProp extends SimpleTwistyPropSource<CatchUpMove> {\n  override getDefaultValue(): CatchUpMove {\n    return { move: null, amount: 0 };\n  }\n\n  protected override canReuseValue(v1: CatchUpMove, v2: CatchUpMove) {\n    return v1.move === v2.move && v1.amount === v2.amount;\n  }\n}\n", "import type { Move } from \"../../../../../alg\";\nimport type { CurrentMoveInfo } from \"../../../../controllers/indexer/AlgIndexer\";\nimport { arrayEqualsCompare } from \"../../../helpers\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\n\ninterface CurrentLeavesSimplifiedPropInputs {\n  currentMoveInfo: CurrentMoveInfo;\n}\n\nexport interface CurrentLeavesSimplified {\n  stateIndex: number;\n  movesFinishing: Move[];\n  movesFinished: Move[];\n}\n\n// This started as a version of `CurrentLeaves` without highly timestamp-sensitive info like fractions, to enable easier caching.\nexport class CurrentLeavesSimplifiedProp extends TwistyPropDerived<\n  CurrentLeavesSimplifiedPropInputs,\n  CurrentLeavesSimplified\n> {\n  protected override derive(\n    inputs: CurrentLeavesSimplifiedPropInputs,\n  ): CurrentLeavesSimplified {\n    return {\n      stateIndex: inputs.currentMoveInfo.stateIndex,\n      movesFinishing: inputs.currentMoveInfo.movesFinishing.map(\n        (currentMoveInfo) => currentMoveInfo.move,\n      ),\n      movesFinished: inputs.currentMoveInfo.movesFinished.map(\n        (currentMoveInfo) => currentMoveInfo.move,\n      ),\n    };\n  }\n\n  protected override canReuseValue(\n    v1: CurrentLeavesSimplified,\n    v2: CurrentLeavesSimplified,\n  ): boolean {\n    return (\n      v1.stateIndex === v2.stateIndex &&\n      arrayEqualsCompare(\n        v1.movesFinishing,\n        v2.movesFinishing,\n        (m1: Move, m2: Move) => m1.isIdentical(m2),\n      ) &&\n      arrayEqualsCompare(\n        v1.movesFinished,\n        v2.movesFinished,\n        (m1: Move, m2: Move) => m1.isIdentical(m2),\n      )\n    );\n  }\n}\n", "import { Move } from \"../../../../../alg\";\nimport { Direction } from \"../../../../controllers/AnimationTypes\";\nimport type {\n  AlgIndexer,\n  CurrentMoveInfo,\n} from \"../../../../controllers/indexer/AlgIndexer\";\nimport type { DetailedTimelineInfo } from \"../../timeline/DetailedTimelineInfoProp\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { CatchUpMove } from \"./CatchUpMoveProp\";\n\ninterface PositionPropInputs {\n  indexer: AlgIndexer;\n  detailedTimelineInfo: DetailedTimelineInfo;\n  catchUpMove: CatchUpMove;\n}\n\n// TODO: Rename \"current\" (implies a single one) to \"active\"?\nexport class CurrentMoveInfoProp extends TwistyPropDerived<\n  PositionPropInputs,\n  CurrentMoveInfo\n> {\n  derive(inputs: PositionPropInputs): CurrentMoveInfo {\n    function addCatchUpMove(currentMoveInfo: CurrentMoveInfo): CurrentMoveInfo {\n      if (\n        inputs.detailedTimelineInfo.atEnd &&\n        inputs.catchUpMove.move !== null\n      ) {\n        currentMoveInfo.currentMoves.push({\n          move: inputs.catchUpMove.move,\n          direction: Direction.Backwards,\n          fraction: 1 - inputs.catchUpMove.amount,\n          startTimestamp: -1, // TODO\n          endTimestamp: -1, // TODO\n        });\n      }\n      return currentMoveInfo;\n    }\n\n    // Copied from AlgCursor\n    if (inputs.indexer.currentMoveInfo) {\n      return addCatchUpMove(\n        inputs.indexer.currentMoveInfo(inputs.detailedTimelineInfo.timestamp),\n      );\n    } else {\n      const idx = inputs.indexer.timestampToIndex(\n        inputs.detailedTimelineInfo.timestamp,\n      );\n      const currentMoveInfo: CurrentMoveInfo = {\n        stateIndex: idx,\n        currentMoves: [],\n        movesFinishing: [],\n        movesFinished: [],\n        movesStarting: [],\n        latestStart: -Infinity,\n        earliestEnd: Infinity,\n      };\n\n      if (inputs.indexer.numAnimatedLeaves() > 0) {\n        const move = inputs.indexer.getAnimLeaf(idx)?.as(Move);\n        if (!move) {\n          return addCatchUpMove(currentMoveInfo);\n        }\n        const start = inputs.indexer.indexToMoveStartTimestamp(idx);\n        const duration = inputs.indexer.moveDuration(idx);\n        const fraction = duration\n          ? (inputs.detailedTimelineInfo.timestamp - start) / duration\n          : 0;\n        const end = start + duration;\n        const currentMove = {\n          move,\n          direction: Direction.Forwards,\n          fraction,\n          startTimestamp: start,\n          endTimestamp: end,\n        };\n        if (fraction === 0) {\n          currentMoveInfo.movesStarting.push(currentMove);\n          // // TODO: push this into the indexer\n          // position.state = combineTransformations(\n          //   inputs.def,\n          //   state,\n          //   transformationForMove(inputs.def, move),\n          // ) as Transformation;\n        } else if (fraction === 1) {\n          currentMoveInfo.movesFinishing.push(currentMove);\n          // // TODO: push this into the indexer\n          // position.state = combineTransformations(\n          //   inputs.def,\n          //   state,\n          //   transformationForMove(inputs.def, move),\n          // ) as Transformation;\n        } else {\n          // TODO\n          currentMoveInfo.currentMoves.push(currentMove);\n          currentMoveInfo.latestStart = Math.max(\n            currentMoveInfo.latestStart,\n            start,\n          );\n          currentMoveInfo.earliestEnd = Math.min(\n            currentMoveInfo.earliestEnd,\n            end,\n          );\n        }\n        // }\n        // }\n      }\n      return addCatchUpMove(currentMoveInfo);\n    }\n  }\n}\n", "import type { KTransformation } from \"../../../../../kpuzzle\";\nimport type { KState } from \"../../../../../kpuzzle/KState\";\nimport type { AlgIndexer } from \"../../../../controllers/indexer/AlgIndexer\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { CurrentLeavesSimplified } from \"./CurrentLeavesSimplified\";\n\ninterface CurrentTransformationPropInputs {\n  anchoredStart: KTransformation; // kpuzzle todo: KState?\n  currentLeavesSimplified: CurrentLeavesSimplified;\n  indexer: AlgIndexer;\n}\n\n// TODO: Make this so we don't have to handle the finishing moves?\nexport class CurrentStateProp extends TwistyPropDerived<\n  CurrentTransformationPropInputs,\n  KState\n> {\n  derive(inputs: CurrentTransformationPropInputs): KState {\n    let transformation: KTransformation = inputs.indexer.transformationAtIndex(\n      inputs.currentLeavesSimplified.stateIndex,\n    );\n    transformation = inputs.anchoredStart.applyTransformation(transformation);\n\n    // TODO: handle non-commutative finished/finishing/current moves.\n    for (const finishingMove of inputs.currentLeavesSimplified.movesFinishing) {\n      transformation = transformation.applyMove(finishingMove);\n    }\n    for (const finishedMove of inputs.currentLeavesSimplified.movesFinished) {\n      transformation = transformation.applyMove(finishedMove);\n    }\n    return transformation.toKState(); // kpuzzle todo\n  }\n}\n", "import {\n  Alg,\n  Grouping,\n  LineComment,\n  Commutator,\n  Conjugate,\n  Move,\n  Newline,\n  Pause,\n  TraversalUp,\n} from \"../../../alg\";\nimport type { Duration } from \"../AnimationTypes\";\n\nexport function constantDurationForAmount(_amount: number): Duration {\n  return 1000;\n}\n\nexport function defaultDurationForAmount(amount: number): Duration {\n  switch (Math.abs(amount)) {\n    case 0:\n      return 0;\n    case 1:\n      return 1000;\n    case 2:\n      return 1500;\n    default:\n      return 2000;\n  }\n}\nexport function ExperimentalScaledDefaultDurationForAmount(\n  scale: number,\n  amount: number,\n): Duration {\n  switch (Math.abs(amount)) {\n    case 0:\n      return 0;\n    case 1:\n      return scale * 1000;\n    case 2:\n      return scale * 1500;\n    default:\n      return scale * 2000;\n  }\n}\n\nexport class AlgDuration extends TraversalUp<Duration> {\n  // TODO: Pass durationForAmount as Down type instead?\n  constructor(\n    public durationForAmount: (\n      amount: number,\n    ) => Duration = defaultDurationForAmount,\n  ) {\n    super();\n  }\n\n  public traverseAlg(alg: Alg): Duration {\n    let total = 0;\n    for (const algNode of alg.childAlgNodes()) {\n      total += this.traverseAlgNode(algNode);\n    }\n    return total;\n  }\n\n  public traverseGrouping(grouping: Grouping): Duration {\n    return grouping.amount * this.traverseAlg(grouping.alg);\n  }\n\n  public traverseMove(move: Move): Duration {\n    return this.durationForAmount(move.amount);\n  }\n\n  public traverseCommutator(commutator: Commutator): Duration {\n    return (\n      2 * (this.traverseAlg(commutator.A) + this.traverseAlg(commutator.B))\n    );\n  }\n\n  public traverseConjugate(conjugate: Conjugate): Duration {\n    return 2 * this.traverseAlg(conjugate.A) + this.traverseAlg(conjugate.B);\n  }\n\n  public traversePause(_pause: Pause): Duration {\n    return this.durationForAmount(1);\n  }\n\n  public traverseNewline(_newline: Newline): Duration {\n    return this.durationForAmount(1);\n  }\n\n  public traverseLineComment(_comment: LineComment): Duration {\n    return this.durationForAmount(0);\n  }\n}\n", "import { Alg, Move, TraversalUp } from \"../../../alg\";\nimport type { KPuzzle, KTransformation } from \"../../../kpuzzle\";\nimport type { KState } from \"../../../kpuzzle/KState\";\nimport { experimentalCountAnimatedLeaves } from \"../../../notation\";\nimport type { Duration, Timestamp } from \"../AnimationTypes\";\nimport { AlgDuration, defaultDurationForAmount } from \"./AlgDuration\";\nimport type { AlgIndexer } from \"./AlgIndexer\";\n\nexport class SimpleAlgIndexer implements AlgIndexer {\n  private moves: Alg;\n  // TODO: Allow custom `durationFn`.\n  private durationFn: TraversalUp<Duration> = new AlgDuration(\n    defaultDurationForAmount,\n  );\n\n  constructor(private kpuzzle: KPuzzle, alg: Alg) {\n    // TODO: Avoid assuming all base moves are block moves.\n    this.moves = new Alg(alg.experimentalExpand());\n  }\n\n  public getAnimLeaf(index: number): Move {\n    return Array.from(this.moves.childAlgNodes())[index] as Move; // TODO: perf\n  }\n\n  public indexToMoveStartTimestamp(index: number): Timestamp {\n    const alg = new Alg(Array.from(this.moves.childAlgNodes()).slice(0, index)); // TODO\n    return this.durationFn.traverseAlg(alg);\n  }\n\n  public timestampToIndex(timestamp: Timestamp): number {\n    let cumulativeTime = 0;\n    let i;\n    for (i = 0; i < this.numAnimatedLeaves(); i++) {\n      cumulativeTime += this.durationFn.traverseMove(this.getAnimLeaf(i));\n      if (cumulativeTime >= timestamp) {\n        return i;\n      }\n    }\n    return i;\n  }\n\n  public stateAtIndex(index: number): KState {\n    return this.kpuzzle\n      .startState()\n      .applyTransformation(this.transformationAtIndex(index));\n  }\n\n  public transformationAtIndex(index: number): KTransformation {\n    let state = this.kpuzzle.identityTransformation();\n    for (const move of Array.from(this.moves.childAlgNodes()).slice(0, index)) {\n      // TODO\n      state = state.applyMove(move as Move);\n    }\n    return state;\n  }\n\n  public algDuration(): Duration {\n    return this.durationFn.traverseAlg(this.moves);\n  }\n\n  public numAnimatedLeaves(): number {\n    // TODO: Cache internally once performance matters.\n    return experimentalCountAnimatedLeaves(this.moves);\n  }\n\n  public moveDuration(index: number): number {\n    return this.durationFn.traverseMove(this.getAnimLeaf(index));\n  }\n}\n", "import {\n  LineComment,\n  Commutator,\n  Conjugate,\n  Pause,\n  TraversalUp,\n  Move,\n  Alg,\n  Grouping,\n  Newline,\n} from \"../../../../alg\";\nimport { functionFromTraversal } from \"../../../../alg\";\nimport type { MillisecondTimestamp } from \"../../AnimationTypes\";\nimport { defaultDurationForAmount } from \"../AlgDuration\";\n\nexport type AnimatedLeafAlgNode = Move | Pause;\nexport interface LocalAnimLeavesWithRange {\n  animLeafAlgNode: AnimatedLeafAlgNode;\n  msUntilNext: MillisecondTimestamp;\n  duration: MillisecondTimestamp;\n}\n\nexport interface AnimLeafWithRange {\n  animLeaf: AnimatedLeafAlgNode;\n  start: MillisecondTimestamp;\n  end: MillisecondTimestamp;\n}\n\nconst axisLookup: Record<string, \"x\" | \"y\" | \"z\"> = {\n  u: \"y\",\n  l: \"x\",\n  f: \"z\",\n  r: \"x\",\n  b: \"z\",\n  d: \"y\",\n  m: \"x\",\n  e: \"y\",\n  s: \"z\",\n  x: \"x\",\n  y: \"y\",\n  z: \"z\",\n};\n\nfunction isSameAxis(move1: Move, move2: Move): boolean {\n  return (\n    axisLookup[move1.family[0].toLowerCase()] ===\n    axisLookup[move2.family[0].toLowerCase()]\n  );\n}\n\n// TODO: Replace this with an optimized implementation.\n// TODO: Consider `(x U)` and `(U x F)` to be simultaneous.\nexport class LocalSimulMoves extends TraversalUp<LocalAnimLeavesWithRange[]> {\n  public traverseAlg(alg: Alg): LocalAnimLeavesWithRange[] {\n    const processed: LocalAnimLeavesWithRange[][] = [];\n    for (const childAlgNode of alg.childAlgNodes()) {\n      processed.push(this.traverseAlgNode(childAlgNode));\n    }\n    return Array.prototype.concat(...processed) as LocalAnimLeavesWithRange[];\n  }\n\n  public traverseGroupingOnce(alg: Alg): LocalAnimLeavesWithRange[] {\n    if (alg.experimentalIsEmpty()) {\n      return [];\n    }\n\n    for (const algNode of alg.childAlgNodes()) {\n      if (!algNode.is(Move)) {\n        // TODO: define the type statically on the class?\n        return this.traverseAlg(alg);\n      }\n    }\n\n    const moves = Array.from(alg.childAlgNodes()) as Move[];\n    let maxSimulDur = defaultDurationForAmount(moves[0].amount);\n    for (let i = 0; i < moves.length - 1; i++) {\n      for (let j = 1; j < moves.length; j++) {\n        if (!isSameAxis(moves[i], moves[j])) {\n          return this.traverseAlg(alg);\n        }\n      }\n      maxSimulDur = Math.max(\n        maxSimulDur,\n        defaultDurationForAmount(moves[i].amount),\n      );\n    }\n\n    const localMovesWithRange: LocalAnimLeavesWithRange[] = moves.map(\n      (blockMove): LocalAnimLeavesWithRange => {\n        return {\n          animLeafAlgNode: blockMove,\n          msUntilNext: 0,\n          duration: maxSimulDur,\n        };\n      },\n    );\n    localMovesWithRange[localMovesWithRange.length - 1].msUntilNext =\n      maxSimulDur;\n    return localMovesWithRange;\n  }\n\n  public traverseGrouping(grouping: Grouping): LocalAnimLeavesWithRange[] {\n    const processed: LocalAnimLeavesWithRange[][] = [];\n\n    const segmentOnce: Alg =\n      grouping.amount > 0 ? grouping.alg : grouping.alg.invert();\n    for (let i = 0; i < Math.abs(grouping.amount); i++) {\n      processed.push(this.traverseGroupingOnce(segmentOnce));\n    }\n    return Array.prototype.concat(...processed) as LocalAnimLeavesWithRange[];\n  }\n\n  public traverseMove(move: Move): LocalAnimLeavesWithRange[] {\n    const duration = defaultDurationForAmount(move.amount);\n    return [\n      {\n        animLeafAlgNode: move,\n        msUntilNext: duration,\n        duration,\n      },\n    ];\n  }\n\n  public traverseCommutator(\n    commutator: Commutator,\n  ): LocalAnimLeavesWithRange[] {\n    const processed: LocalAnimLeavesWithRange[][] = [];\n    const segmentsOnce: Alg[] = [\n      commutator.A,\n      commutator.B,\n      commutator.A.invert(),\n      commutator.B.invert(),\n    ];\n    for (const segment of segmentsOnce) {\n      processed.push(this.traverseGroupingOnce(segment));\n    }\n    return Array.prototype.concat(...processed) as LocalAnimLeavesWithRange[];\n  }\n\n  public traverseConjugate(conjugate: Conjugate): LocalAnimLeavesWithRange[] {\n    const processed: LocalAnimLeavesWithRange[][] = [];\n    const segmentsOnce: Alg[] = [\n      conjugate.A,\n      conjugate.B,\n      conjugate.A.invert(),\n    ];\n    for (const segment of segmentsOnce) {\n      processed.push(this.traverseGroupingOnce(segment));\n    }\n    return Array.prototype.concat(...processed) as LocalAnimLeavesWithRange[];\n  }\n\n  public traversePause(pause: Pause): LocalAnimLeavesWithRange[] {\n    if (pause.experimentalNISSGrouping) {\n      return [];\n    }\n    const duration = defaultDurationForAmount(1);\n    return [\n      {\n        animLeafAlgNode: pause,\n        msUntilNext: duration, // TODO\n        duration,\n      },\n    ];\n  }\n\n  public traverseNewline(_newline: Newline): LocalAnimLeavesWithRange[] {\n    return [];\n  }\n\n  public traverseLineComment(\n    _comment: LineComment,\n  ): LocalAnimLeavesWithRange[] {\n    return [];\n  }\n}\n\nconst localSimulMoves = functionFromTraversal(LocalSimulMoves);\n\nexport function simulMoves(a: Alg): AnimLeafWithRange[] {\n  let timestamp = 0;\n  const l = localSimulMoves(a).map(\n    (localSimulMove: LocalAnimLeavesWithRange): AnimLeafWithRange => {\n      const leafWithRange = {\n        animLeaf: localSimulMove.animLeafAlgNode,\n        start: timestamp,\n        end: timestamp + localSimulMove.duration,\n      };\n      timestamp += localSimulMove.msUntilNext;\n      return leafWithRange;\n    },\n  );\n  return l;\n}\n", "import { Alg, Move } from \"../../../../alg\";\nimport type { KPuzzle, KTransformation } from \"../../../../kpuzzle\";\nimport type { KState } from \"../../../../kpuzzle/KState\";\nimport {\n  Direction,\n  Duration,\n  PuzzlePosition,\n  Timestamp,\n} from \"../../AnimationTypes\";\nimport type { CurrentMove, CurrentMoveInfo } from \"../AlgIndexer\";\nimport {\n  AnimatedLeafAlgNode,\n  AnimLeafWithRange,\n  simulMoves,\n} from \"./simul-moves\";\n\nconst demos: Record<string, AnimLeafWithRange[]> = {\n  \"y' y' U' E D R2 r2 F2 B2 U E D' R2 L2' z2 S2 U U D D S2 F2' B2\": [\n    { animLeaf: new Move(\"y\", -1), start: 0, end: 1000 },\n    { animLeaf: new Move(\"y\", -1), start: 1000, end: 2000 },\n    { animLeaf: new Move(\"U\", -1), start: 1000, end: 1600 },\n    { animLeaf: new Move(\"E\", 1), start: 1200, end: 1800 },\n    { animLeaf: new Move(\"D\"), start: 1400, end: 2000 },\n    { animLeaf: new Move(\"R\", 2), start: 2000, end: 3500 },\n    { animLeaf: new Move(\"r\", 2), start: 2000, end: 3500 },\n    { animLeaf: new Move(\"F\", 2), start: 3500, end: 4200 },\n    { animLeaf: new Move(\"B\", 2), start: 3800, end: 4500 },\n    { animLeaf: new Move(\"U\", 1), start: 4500, end: 5500 },\n    { animLeaf: new Move(\"E\", 1), start: 4500, end: 5500 },\n    { animLeaf: new Move(\"D\", -1), start: 4500, end: 5500 },\n    { animLeaf: new Move(\"R\", 2), start: 5500, end: 6500 },\n    { animLeaf: new Move(\"L\", -2), start: 5500, end: 6500 },\n    { animLeaf: new Move(\"z\", 2), start: 5500, end: 6500 },\n    { animLeaf: new Move(\"S\", 2), start: 6500, end: 7500 },\n    { animLeaf: new Move(\"U\"), start: 7500, end: 8000 },\n    { animLeaf: new Move(\"D\"), start: 7750, end: 8250 },\n    { animLeaf: new Move(\"U\"), start: 8000, end: 8500 },\n    { animLeaf: new Move(\"D\"), start: 8250, end: 8750 },\n    { animLeaf: new Move(\"S\", 2), start: 8750, end: 9250 },\n    { animLeaf: new Move(\"F\", -2), start: 8750, end: 10000 },\n    { animLeaf: new Move(\"B\", 2), start: 8750, end: 10000 },\n  ],\n  \"M' R' U' D' M R\": [\n    { animLeaf: new Move(\"M\", -1), start: 0, end: 1000 },\n    { animLeaf: new Move(\"R\", -1), start: 0, end: 1000 },\n    { animLeaf: new Move(\"U\", -1), start: 1000, end: 2000 },\n    { animLeaf: new Move(\"D\", -1), start: 1000, end: 2000 },\n    { animLeaf: new Move(\"M\"), start: 2000, end: 3000 },\n    { animLeaf: new Move(\"R\"), start: 2000, end: 3000 },\n  ],\n  \"U' E' r E r2' E r U E\": [\n    { animLeaf: new Move(\"U\", -1), start: 0, end: 1000 },\n    { animLeaf: new Move(\"E\", -1), start: 0, end: 1000 },\n    { animLeaf: new Move(\"r\"), start: 1000, end: 2500 },\n    { animLeaf: new Move(\"E\"), start: 2500, end: 3500 },\n    { animLeaf: new Move(\"r\", -2), start: 3500, end: 5000 },\n    { animLeaf: new Move(\"E\"), start: 5000, end: 6000 },\n    { animLeaf: new Move(\"r\"), start: 6000, end: 7000 },\n    { animLeaf: new Move(\"U\"), start: 7000, end: 8000 },\n    { animLeaf: new Move(\"E\"), start: 7000, end: 8000 },\n  ],\n};\n\nexport class SimultaneousMoveIndexer {\n  private animLeaves: AnimLeafWithRange[];\n  // TODO: Allow custom `durationFn`.\n\n  constructor(private kpuzzle: KPuzzle, alg: Alg) {\n    this.animLeaves = demos[alg.toString()] ?? simulMoves(alg);\n    // TODO: Avoid assuming all base moves are block moves.\n  }\n\n  public getAnimLeaf(index: number): AnimatedLeafAlgNode | null {\n    return (\n      this.animLeaves[Math.min(index, this.animLeaves.length - 1)]?.animLeaf ??\n      null\n    );\n  }\n\n  private getAnimLeafWithRange(index: number): AnimLeafWithRange {\n    return this.animLeaves[Math.min(index, this.animLeaves.length - 1)];\n  }\n\n  public indexToMoveStartTimestamp(index: number): Timestamp {\n    let start = 0;\n    if (this.animLeaves.length > 0) {\n      start =\n        this.animLeaves[Math.min(index, this.animLeaves.length - 1)].start;\n    }\n    return start;\n  }\n\n  public timestampToIndex(timestamp: Timestamp): number {\n    let i = 0;\n    for (i = 0; i < this.animLeaves.length; i++) {\n      if (this.animLeaves[i].start >= timestamp) {\n        return Math.max(0, i - 1);\n      }\n    }\n    return Math.max(0, i - 1);\n  }\n\n  public timestampToPosition(\n    timestamp: Timestamp,\n    startState?: KState,\n  ): PuzzlePosition {\n    const currentMoveInfo = this.currentMoveInfo(timestamp);\n\n    let state = startState ?? this.kpuzzle.identityTransformation().toKState();\n    for (const leafWithRange of this.animLeaves.slice(\n      0,\n      currentMoveInfo.stateIndex,\n    )) {\n      const move = leafWithRange.animLeaf.as(Move);\n      if (move !== null) {\n        state = state.applyMove(move);\n      }\n    }\n\n    return {\n      state,\n      movesInProgress: currentMoveInfo.currentMoves,\n    };\n  }\n\n  // TODO: Caching\n  public currentMoveInfo(timestamp: Timestamp): CurrentMoveInfo {\n    // The starting timestamp of the earliest active move.\n    let windowEarliestTimestamp = Infinity;\n    for (const leafWithRange of this.animLeaves) {\n      if (leafWithRange.start <= timestamp && leafWithRange.end >= timestamp) {\n        windowEarliestTimestamp = Math.min(\n          windowEarliestTimestamp,\n          leafWithRange.start,\n        );\n      } else if (leafWithRange.start > timestamp) {\n        break;\n      }\n    }\n\n    const currentMoves: CurrentMove[] = [];\n    const movesStarting: CurrentMove[] = [];\n    const movesFinishing: CurrentMove[] = [];\n    const movesFinished: CurrentMove[] = [];\n    let latestStart: number = -Infinity; // TODO: is there a better way to accumulate this?\n    let earliestEnd: number = Infinity; // TODO: is there a better way to accumulate this?\n\n    let stateIndex: number = 0;\n    for (const leafWithRange of this.animLeaves) {\n      if (leafWithRange.end <= windowEarliestTimestamp) {\n        stateIndex++;\n      } else if (leafWithRange.start > timestamp) {\n        break;\n      } else {\n        const move = leafWithRange.animLeaf.as(Move);\n        if (move !== null) {\n          let fraction =\n            (timestamp - leafWithRange.start) /\n            (leafWithRange.end - leafWithRange.start);\n          let moveFinished = false;\n          if (fraction > 1) {\n            fraction = 1;\n            moveFinished = true;\n          }\n          const currentMove = {\n            move: move,\n            direction: Direction.Forwards,\n            fraction: fraction,\n            startTimestamp: leafWithRange.start,\n            endTimestamp: leafWithRange.end,\n          };\n          switch (fraction) {\n            case 0: {\n              movesStarting.push(currentMove);\n              break;\n            }\n            case 1: {\n              // Generalize this to avoid reordering commuting moves.\n              if (moveFinished) {\n                movesFinished.push(currentMove);\n              } else {\n                movesFinishing.push(currentMove);\n              }\n              break;\n            }\n            default:\n              currentMoves.push(currentMove);\n              latestStart = Math.max(latestStart, leafWithRange.start);\n              earliestEnd = Math.min(earliestEnd, leafWithRange.end);\n          }\n        }\n      }\n    }\n    return {\n      stateIndex,\n      currentMoves,\n      latestStart,\n      earliestEnd,\n      movesStarting,\n      movesFinishing,\n      movesFinished,\n    };\n  }\n\n  public stateAtIndex(index: number, startState?: KState): KState {\n    let state = startState ?? this.kpuzzle.startState();\n    for (let i = 0; i < this.animLeaves.length && i < index; i++) {\n      const leafWithRange = this.animLeaves[i];\n      const move = leafWithRange.animLeaf.as(Move);\n      if (move !== null) {\n        state = state.applyMove(move);\n      }\n    }\n    return state;\n  }\n\n  public transformationAtIndex(index: number): KTransformation {\n    let transformation = this.kpuzzle.identityTransformation();\n    for (const leafWithRange of this.animLeaves.slice(0, index)) {\n      const move = leafWithRange.animLeaf.as(Move);\n      if (move !== null) {\n        transformation = transformation.applyMove(move);\n      }\n    }\n    return transformation;\n  }\n\n  public algDuration(): Duration {\n    let max = 0;\n    for (const leafWithRange of this.animLeaves) {\n      max = Math.max(max, leafWithRange.end);\n    }\n    return max;\n  }\n\n  public numAnimatedLeaves(): number {\n    // TODO: Cache internally once performance matters.\n    return this.animLeaves.length;\n  }\n\n  public moveDuration(index: number): number {\n    const move = this.getAnimLeafWithRange(index);\n    return move.end - move.start;\n  }\n}\n", "import {\n  Alg,\n  Commutator,\n  Conjugate,\n  Grouping,\n  LineComment,\n  Move,\n  Newline,\n  Pause,\n  TraversalDownUp,\n  TraversalUp,\n  AlgNode,\n} from \"../../../../alg\";\nimport {\n  experimentalDirectedGenerator,\n  ExperimentalIterationDirection,\n} from \"../../../../alg/cubing-private\";\nimport type { KPuzzle, KTransformation } from \"../../../../kpuzzle\";\nimport type { Duration } from \"../../AnimationTypes\";\nimport { AlgDuration, defaultDurationForAmount } from \"../AlgDuration\";\n\nexport class AlgWalkerDecoration {\n  constructor(\n    public moveCount: number,\n    public duration: number,\n    public forward: KTransformation,\n    public backward: KTransformation,\n    public children: AlgWalkerDecoration[] = [],\n  ) {}\n}\nexport class DecoratorConstructor extends TraversalUp<AlgWalkerDecoration> {\n  private identity: KTransformation;\n  private dummyLeaf: AlgWalkerDecoration;\n  private durationFn: TraversalUp<Duration> = new AlgDuration(\n    defaultDurationForAmount,\n  );\n\n  private cache: { [key: string]: AlgWalkerDecoration } = {};\n\n  constructor(private kpuzzle: KPuzzle) {\n    super();\n    this.identity = kpuzzle.identityTransformation();\n    this.dummyLeaf = new AlgWalkerDecoration(\n      0,\n      0,\n      this.identity,\n      this.identity,\n      [],\n    );\n  }\n\n  public traverseAlg(alg: Alg): AlgWalkerDecoration {\n    let moveCount = 0;\n    let duration = 0;\n    let transformation = this.identity;\n    const child: AlgWalkerDecoration[] = [];\n    for (const algNode of alg.childAlgNodes()) {\n      const apd = this.traverseAlgNode(algNode);\n      moveCount += apd.moveCount;\n      duration += apd.duration;\n      if (transformation === this.identity) {\n        transformation = apd.forward;\n      } else {\n        transformation = transformation.applyTransformation(apd.forward);\n      }\n      child.push(apd);\n    }\n    return new AlgWalkerDecoration(\n      moveCount,\n      duration,\n      transformation,\n      transformation.invert(),\n      child,\n    );\n  }\n\n  public traverseGrouping(grouping: Grouping): AlgWalkerDecoration {\n    const dec = this.traverseAlg(grouping.alg);\n    return this.mult(dec, grouping.amount, [dec]);\n  }\n\n  public traverseMove(move: Move): AlgWalkerDecoration {\n    const key = move.toString();\n    let r: AlgWalkerDecoration | undefined = this.cache[key];\n    if (r) {\n      return r;\n    }\n    const transformation = this.kpuzzle.moveToTransformation(move);\n    r = new AlgWalkerDecoration(\n      1,\n      this.durationFn.traverseAlgNode(move),\n      transformation,\n      transformation.invert(),\n    );\n    this.cache[key] = r;\n    return r;\n  }\n\n  public traverseCommutator(commutator: Commutator): AlgWalkerDecoration {\n    const decA = this.traverseAlg(commutator.A);\n    const decB = this.traverseAlg(commutator.B);\n    const AB = decA.forward.applyTransformation(decB.forward);\n    const ApBp = decA.backward.applyTransformation(decB.backward);\n    const ABApBp = AB.applyTransformation(ApBp);\n    const dec = new AlgWalkerDecoration(\n      2 * (decA.moveCount + decB.moveCount),\n      2 * (decA.duration + decB.duration),\n      ABApBp,\n      ABApBp.invert(),\n      [decA, decB],\n    );\n    return this.mult(dec, 1, [dec, decA, decB]);\n  }\n\n  public traverseConjugate(conjugate: Conjugate): AlgWalkerDecoration {\n    const decA = this.traverseAlg(conjugate.A);\n    const decB = this.traverseAlg(conjugate.B);\n    const AB = decA.forward.applyTransformation(decB.forward);\n    const ABAp = AB.applyTransformation(decA.backward);\n    const dec = new AlgWalkerDecoration(\n      2 * decA.moveCount + decB.moveCount,\n      2 * decA.duration + decB.duration,\n      ABAp,\n      ABAp.invert(),\n      [decA, decB],\n    );\n    return this.mult(dec, 1, [dec, decA, decB]);\n  }\n\n  public traversePause(pause: Pause): AlgWalkerDecoration {\n    if (pause.experimentalNISSGrouping) {\n      return this.dummyLeaf;\n    }\n    return new AlgWalkerDecoration(\n      1,\n      this.durationFn.traverseAlgNode(pause),\n      this.identity,\n      this.identity,\n    );\n  }\n\n  public traverseNewline(_newline: Newline): AlgWalkerDecoration {\n    return this.dummyLeaf;\n  }\n\n  public traverseLineComment(_comment: LineComment): AlgWalkerDecoration {\n    return this.dummyLeaf;\n  }\n\n  private mult(\n    apd: AlgWalkerDecoration,\n    n: number,\n    child: AlgWalkerDecoration[],\n  ): AlgWalkerDecoration {\n    const absn = Math.abs(n);\n    const st = apd.forward.selfMultiply(n);\n    return new AlgWalkerDecoration(\n      apd.moveCount * absn,\n      apd.duration * absn,\n      st,\n      st.invert(),\n      child,\n    );\n  }\n}\nclass WalkerDown {\n  constructor(public apd: AlgWalkerDecoration, public back: boolean) {\n    /**/\n  }\n}\nexport class AlgWalker extends TraversalDownUp<WalkerDown, boolean> {\n  public move?: AlgNode;\n  public moveDuration: number;\n  public back: boolean;\n  public st: KTransformation;\n  public root: WalkerDown;\n  public i: number;\n  public dur: number;\n  private goali: number;\n  private goaldur: number;\n  constructor(\n    public kpuzzle: KPuzzle,\n    public algOrAlgNode: Alg | AlgNode, // TODO: can we keep these separate?\n    public apd: AlgWalkerDecoration,\n  ) {\n    super();\n    this.i = -1;\n    this.dur = -1;\n    this.goali = -1;\n    this.goaldur = -1;\n    this.move = undefined;\n    this.back = false;\n    this.moveDuration = 0;\n    this.st = this.kpuzzle.identityTransformation();\n    this.root = new WalkerDown(this.apd, false);\n  }\n\n  public moveByIndex(loc: number): boolean {\n    if (this.i >= 0 && this.i === loc) {\n      return this.move !== undefined;\n    }\n    return this.dosearch(loc, Infinity);\n  }\n\n  public moveByDuration(dur: number): boolean {\n    if (\n      this.dur >= 0 &&\n      this.dur < dur &&\n      this.dur + this.moveDuration >= dur\n    ) {\n      return this.move !== undefined;\n    }\n    return this.dosearch(Infinity, dur);\n  }\n\n  public dosearch(loc: number, dur: number): boolean {\n    this.goali = loc;\n    this.goaldur = dur;\n    this.i = 0;\n    this.dur = 0;\n    this.move = undefined;\n    this.moveDuration = 0;\n    this.back = false;\n    this.st = this.kpuzzle.identityTransformation();\n    const r = this.algOrAlgNode.is(Alg)\n      ? this.traverseAlg(this.algOrAlgNode as Alg, this.root)\n      : this.traverseAlgNode(this.algOrAlgNode as AlgNode, this.root); // TODO\n    return r;\n  }\n\n  public traverseAlg(alg: Alg, wd: WalkerDown): boolean {\n    if (!this.firstcheck(wd)) {\n      return false;\n    }\n    let i = wd.back ? alg.experimentalNumChildAlgNodes() - 1 : 0;\n    for (const algNode of experimentalDirectedGenerator(\n      alg.childAlgNodes(),\n      wd.back\n        ? ExperimentalIterationDirection.Backwards\n        : ExperimentalIterationDirection.Forwards,\n    )) {\n      if (\n        this.traverseAlgNode(\n          algNode,\n          new WalkerDown(wd.apd.children[i], wd.back),\n        )\n      ) {\n        return true;\n      }\n      i += wd.back ? -1 : 1;\n    }\n    return false;\n  }\n\n  public traverseGrouping(grouping: Grouping, wd: WalkerDown): boolean {\n    if (!this.firstcheck(wd)) {\n      return false;\n    }\n    const back = this.domult(wd, grouping.amount);\n    return this.traverseAlg(\n      grouping.alg,\n      new WalkerDown(wd.apd.children[0], back),\n    );\n  }\n\n  public traverseMove(move: Move, wd: WalkerDown): boolean {\n    if (!this.firstcheck(wd)) {\n      return false;\n    }\n    this.move = move;\n    this.moveDuration = wd.apd.duration;\n    this.back = wd.back;\n    return true;\n  }\n\n  public traverseCommutator(commutator: Commutator, wd: WalkerDown): boolean {\n    if (!this.firstcheck(wd)) {\n      return false;\n    }\n    const back = this.domult(wd, 1);\n    if (back) {\n      return (\n        this.traverseAlg(\n          commutator.B,\n          new WalkerDown(wd.apd.children[2], !back),\n        ) ||\n        this.traverseAlg(\n          commutator.A,\n          new WalkerDown(wd.apd.children[1], !back),\n        ) ||\n        this.traverseAlg(\n          commutator.B,\n          new WalkerDown(wd.apd.children[2], back),\n        ) ||\n        this.traverseAlg(commutator.A, new WalkerDown(wd.apd.children[1], back))\n      );\n    } else {\n      return (\n        this.traverseAlg(\n          commutator.A,\n          new WalkerDown(wd.apd.children[1], back),\n        ) ||\n        this.traverseAlg(\n          commutator.B,\n          new WalkerDown(wd.apd.children[2], back),\n        ) ||\n        this.traverseAlg(\n          commutator.A,\n          new WalkerDown(wd.apd.children[1], !back),\n        ) ||\n        this.traverseAlg(\n          commutator.B,\n          new WalkerDown(wd.apd.children[2], !back),\n        )\n      );\n    }\n  }\n\n  public traverseConjugate(conjugate: Conjugate, wd: WalkerDown): boolean {\n    if (!this.firstcheck(wd)) {\n      return false;\n    }\n    const back = this.domult(wd, 1);\n    if (back) {\n      return (\n        this.traverseAlg(\n          conjugate.A,\n          new WalkerDown(wd.apd.children[1], !back),\n        ) ||\n        this.traverseAlg(\n          conjugate.B,\n          new WalkerDown(wd.apd.children[2], back),\n        ) ||\n        this.traverseAlg(conjugate.A, new WalkerDown(wd.apd.children[1], back))\n      );\n    } else {\n      return (\n        this.traverseAlg(\n          conjugate.A,\n          new WalkerDown(wd.apd.children[1], back),\n        ) ||\n        this.traverseAlg(\n          conjugate.B,\n          new WalkerDown(wd.apd.children[2], back),\n        ) ||\n        this.traverseAlg(conjugate.A, new WalkerDown(wd.apd.children[1], !back))\n      );\n    }\n  }\n\n  public traversePause(pause: Pause, wd: WalkerDown): boolean {\n    if (!this.firstcheck(wd)) {\n      return false;\n    }\n    this.move = pause;\n    this.moveDuration = wd.apd.duration;\n    this.back = wd.back;\n    return true;\n  }\n\n  public traverseNewline(_newline: Newline, _wd: WalkerDown): boolean {\n    return false;\n  }\n\n  public traverseLineComment(\n    _lineComment: LineComment,\n    _wd: WalkerDown,\n  ): boolean {\n    return false;\n  }\n\n  private firstcheck(wd: WalkerDown): boolean {\n    if (\n      wd.apd.moveCount + this.i <= this.goali &&\n      wd.apd.duration + this.dur < this.goaldur\n    ) {\n      return this.keepgoing(wd);\n    }\n    return true;\n  }\n\n  private domult(wd: WalkerDown, amount: number): boolean {\n    let back = wd.back;\n    if (amount === 0) {\n      // I don't believe this will ever happen\n      return back;\n    }\n    if (amount < 0) {\n      back = !back;\n      amount = -amount;\n    }\n    const base = wd.apd.children[0];\n    const full = Math.min(\n      Math.floor((this.goali - this.i) / base.moveCount),\n      Math.ceil((this.goaldur - this.dur) / base.duration - 1),\n    );\n    if (full > 0) {\n      this.keepgoing(new WalkerDown(base, back), full);\n    }\n    return back;\n  }\n\n  private keepgoing(wd: WalkerDown, mul: number = 1): boolean {\n    this.i += mul * wd.apd.moveCount;\n    this.dur += mul * wd.apd.duration;\n    if (mul !== 1) {\n      if (wd.back) {\n        this.st = this.st.applyTransformation(\n          wd.apd.backward.selfMultiply(mul),\n        );\n      } else {\n        this.st = this.st.applyTransformation(wd.apd.forward.selfMultiply(mul));\n      }\n    } else {\n      if (wd.back) {\n        this.st = this.st.applyTransformation(wd.apd.backward);\n      } else {\n        this.st = this.st.applyTransformation(wd.apd.forward);\n      }\n    }\n    return false;\n  }\n}\n", "import {\n  Alg,\n  AlgBuilder,\n  AlgNode,\n  Commutator,\n  Conjugate,\n  Grouping,\n  LineComment,\n  Move,\n  Newline,\n  Pause,\n  TraversalUp,\n} from \"../../../../alg\";\nimport { functionFromTraversal } from \"../../../../alg\";\n\nconst MIN_CHUNKING_THRESHOLD = 16;\n\nfunction chunkifyAlg(alg: Alg, chunkMaxLength: number): Alg {\n  const mainAlgBuilder = new AlgBuilder();\n  const chunkAlgBuilder = new AlgBuilder();\n  for (const algNode of alg.childAlgNodes()) {\n    chunkAlgBuilder.push(algNode);\n    if (chunkAlgBuilder.experimentalNumAlgNodes() >= chunkMaxLength) {\n      mainAlgBuilder.push(new Grouping(chunkAlgBuilder.toAlg()));\n      chunkAlgBuilder.reset();\n    }\n  }\n  mainAlgBuilder.push(new Grouping(chunkAlgBuilder.toAlg()));\n  return mainAlgBuilder.toAlg();\n}\n\nclass ChunkAlgs extends TraversalUp<Alg, AlgNode> {\n  traverseAlg(alg: Alg): Alg {\n    const algLength = alg.experimentalNumChildAlgNodes();\n    if (algLength < MIN_CHUNKING_THRESHOLD) {\n      return alg;\n    }\n    return chunkifyAlg(alg, Math.ceil(Math.sqrt(algLength)));\n  }\n\n  traverseGrouping(grouping: Grouping): AlgNode {\n    return new Grouping(\n      this.traverseAlg(grouping.alg),\n      grouping.amount, // TODO\n    );\n  }\n\n  traverseMove(move: Move): AlgNode {\n    return move;\n  }\n\n  traverseCommutator(commutator: Commutator): AlgNode {\n    return new Conjugate(\n      this.traverseAlg(commutator.A),\n      this.traverseAlg(commutator.B),\n    );\n  }\n\n  traverseConjugate(conjugate: Conjugate): AlgNode {\n    return new Conjugate(\n      this.traverseAlg(conjugate.A),\n      this.traverseAlg(conjugate.B),\n    );\n  }\n\n  traversePause(pause: Pause): AlgNode {\n    return pause;\n  }\n\n  traverseNewline(newline: Newline): AlgNode {\n    return newline;\n  }\n\n  traverseLineComment(comment: LineComment): AlgNode {\n    return comment;\n  }\n}\n\nexport const chunkAlgs = functionFromTraversal(ChunkAlgs);\n", "import type { Alg, Move } from \"../../../../alg\";\nimport type { KPuzzle, KTransformation } from \"../../../../kpuzzle\";\nimport type { KState } from \"../../../../kpuzzle/KState\";\nimport type { Duration, Timestamp } from \"../../AnimationTypes\";\nimport type { AlgIndexer } from \"../AlgIndexer\";\nimport {\n  AlgWalkerDecoration,\n  AlgWalker,\n  DecoratorConstructor,\n} from \"./AlgWalker\";\nimport { chunkAlgs } from \"./chunkAlgs\";\n\nexport class TreeAlgIndexer implements AlgIndexer {\n  private decoration: AlgWalkerDecoration;\n  private walker: AlgWalker;\n  constructor(private kpuzzle: KPuzzle, alg: Alg) {\n    const deccon = new DecoratorConstructor(this.kpuzzle);\n\n    const chunkedAlg = chunkAlgs(alg);\n\n    this.decoration = deccon.traverseAlg(chunkedAlg);\n    this.walker = new AlgWalker(this.kpuzzle, chunkedAlg, this.decoration);\n  }\n\n  public getAnimLeaf(index: number): Move | null {\n    // FIXME need to support Pause\n    if (this.walker.moveByIndex(index)) {\n      if (!this.walker.move) {\n        throw new Error(\"`this.walker.mv` missing\");\n      }\n      const move = this.walker.move as Move;\n      // TODO: this type of negation needs to be in alg\n      if (this.walker.back) {\n        return move.invert();\n      }\n      return move;\n    }\n    return null;\n  }\n\n  public indexToMoveStartTimestamp(index: number): Timestamp {\n    if (this.walker.moveByIndex(index) || this.walker.i === index) {\n      return this.walker.dur;\n    }\n    throw new Error(`Out of algorithm: index ${index}`);\n  }\n\n  public indexToMovesInProgress(index: number): Timestamp {\n    if (this.walker.moveByIndex(index) || this.walker.i === index) {\n      return this.walker.dur;\n    }\n    throw new Error(`Out of algorithm: index ${index}`);\n  }\n\n  public stateAtIndex(index: number, startState?: KState): KState {\n    this.walker.moveByIndex(index);\n    return (startState ?? this.kpuzzle.startState()).applyTransformation(\n      this.walker.st,\n    );\n  }\n\n  // TransformAtIndex does not reflect the start state; it only reflects\n  // the change from the start state to the current move index.  If you\n  // want the actual state, use stateAtIndex.\n  public transformationAtIndex(index: number): KTransformation {\n    this.walker.moveByIndex(index);\n    return this.walker.st;\n  }\n\n  public numAnimatedLeaves(): number {\n    return this.decoration.moveCount;\n  }\n\n  public timestampToIndex(timestamp: Timestamp): number {\n    this.walker.moveByDuration(timestamp);\n    return this.walker.i;\n  }\n\n  public algDuration(): Duration {\n    return this.decoration.duration;\n  }\n\n  public moveDuration(index: number): number {\n    this.walker.moveByIndex(index);\n    return this.walker.moveDuration;\n  }\n}\n", "import type { AlgIndexer } from \"../../../..\";\nimport type { Alg } from \"../../../../../alg\";\nimport type { KPuzzle } from \"../../../../../kpuzzle\";\nimport { experimentalCountMoves } from \"../../../../../notation\";\nimport { SimpleAlgIndexer } from \"../../../../controllers/indexer/SimpleAlgIndexer\";\nimport { SimultaneousMoveIndexer } from \"../../../../controllers/indexer/simultaneous-moves/SimultaneousMoveIndexer\";\nimport { TreeAlgIndexer } from \"../../../../controllers/indexer/tree/TreeAlgIndexer\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { VisualizationStrategy } from \"../../viewer/VisualizationStrategyProp\";\nimport type { PuzzleID } from \"../structure/PuzzleIDRequestProp\";\nimport type { AlgWithIssues } from \"./AlgProp\";\nimport type { IndexerStrategyName } from \"./IndexerConstructorRequestProp\";\n\nexport type IndexerConstructor = new (kpuzzle: KPuzzle, alg: Alg) => AlgIndexer;\n\ninterface IndexerConstructorPropInputs {\n  puzzle: PuzzleID;\n  alg: AlgWithIssues;\n  visualizationStrategy: VisualizationStrategy;\n  indexerConstructorRequest: IndexerStrategyName;\n}\n\n// TODO: Also handle PG3D vs. 3D\nexport class IndexerConstructorProp extends TwistyPropDerived<\n  IndexerConstructorPropInputs,\n  IndexerConstructor\n> {\n  derive(inputs: IndexerConstructorPropInputs): IndexerConstructor {\n    switch (inputs.indexerConstructorRequest) {\n      case \"auto\":\n        if (\n          experimentalCountMoves(inputs.alg.alg) < 100 &&\n          inputs.puzzle === \"3x3x3\" &&\n          inputs.visualizationStrategy === \"Cube3D\"\n        ) {\n          return SimultaneousMoveIndexer;\n        } else {\n          return TreeAlgIndexer;\n        }\n      case \"tree\":\n        return TreeAlgIndexer;\n      case \"simple\":\n        return SimpleAlgIndexer;\n      case \"simultaneous\":\n        return SimultaneousMoveIndexer;\n      default:\n        throw new Error(\"Invalid indexer request!\");\n    }\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport const indexerStrategyNames = {\n  auto: true,\n  simple: true,\n  tree: true,\n  simultaneous: true,\n};\nexport type IndexerStrategyName = keyof typeof indexerStrategyNames;\n\nexport class IndexerConstructorRequestProp extends SimpleTwistyPropSource<IndexerStrategyName> {\n  getDefaultValue(): IndexerStrategyName {\n    return \"auto\";\n  }\n}\n", "import type { KPuzzle } from \"../../../../../kpuzzle\";\nimport type { AlgIndexer } from \"../../../../controllers/indexer/AlgIndexer\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { AlgWithIssues } from \"./AlgProp\";\nimport type { IndexerConstructor } from \"./IndexerConstructorProp\";\n\ntype IndexerPropInputs = {\n  indexerConstructor: IndexerConstructor;\n  algWithIssues: AlgWithIssues;\n  kpuzzle: KPuzzle;\n};\nexport class IndexerProp extends TwistyPropDerived<\n  IndexerPropInputs,\n  AlgIndexer\n> {\n  derive(input: IndexerPropInputs): AlgIndexer {\n    return new input.indexerConstructor(input.kpuzzle, input.algWithIssues.alg);\n  }\n}\n", "import type { KState } from \"../../../../../kpuzzle/KState\";\nimport type { PuzzlePosition } from \"../../../../controllers/AnimationTypes\";\nimport type { CurrentMoveInfo } from \"../../../../controllers/indexer/AlgIndexer\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\n\nexport interface LegacyPositionPropInputs {\n  currentMoveInfo: CurrentMoveInfo;\n  state: KState;\n}\n\n// TODO: This exist as a convenience for old `Twisty3D` implementations. Get rid of this.\nexport class LegacyPositionProp extends TwistyPropDerived<\n  LegacyPositionPropInputs,\n  PuzzlePosition\n> {\n  derive(inputs: LegacyPositionPropInputs): PuzzlePosition {\n    return {\n      state: inputs.state,\n      movesInProgress: inputs.currentMoveInfo.currentMoves,\n    };\n  }\n}\n", "import { experimentalCountMoves } from \"../../../../../notation\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { AlgWithIssues } from \"./AlgProp\";\n\ninterface NaiveMoveCountPropInputs {\n  alg: AlgWithIssues;\n}\n\n// TODO: handle metrics\nexport class NaiveMoveCountProp extends TwistyPropDerived<\n  NaiveMoveCountPropInputs,\n  number | null\n> {\n  derive(inputs: NaiveMoveCountPropInputs): number | null {\n    if (inputs.alg.issues.errors.length > 0) {\n      return null;\n    }\n    return experimentalCountMoves(inputs.alg.alg);\n  }\n}\n", "import { Alg } from \"../../../../../alg\";\nimport type { KPuzzle } from \"../../../../../kpuzzle\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport { AlgIssues, AlgWithIssues } from \"./AlgProp\";\n\nlet validate: boolean = true;\nexport function experimentalSetPuzzleAlgValidation(newValidate: boolean): void {\n  validate = newValidate;\n}\n\nexport class PuzzleAlgProp extends TwistyPropDerived<\n  { algWithIssues: AlgWithIssues; kpuzzle: KPuzzle },\n  AlgWithIssues\n> {\n  async derive(inputs: {\n    algWithIssues: AlgWithIssues;\n    kpuzzle: KPuzzle;\n  }): Promise<AlgWithIssues> {\n    try {\n      if (validate) {\n        inputs.kpuzzle.algToTransformation(inputs.algWithIssues.alg);\n      }\n\n      // Looks like we could apply the alg!\n      return inputs.algWithIssues;\n    } catch (e) {\n      return {\n        alg: new Alg(),\n        issues: new AlgIssues({\n          errors: [`Invalid alg for puzzle: ${(e as Error).toString()}`],\n        }),\n      };\n    }\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\n// TODO: turn these maps into lists?\nexport const setupToLocations = {\n  start: true, // default // TODO: \"beginning\"\n  end: true,\n};\nexport type SetupToLocation = keyof typeof setupToLocations;\n\nexport class SetupAnchorProp extends SimpleTwistyPropSource<SetupToLocation> {\n  getDefaultValue(): SetupToLocation {\n    return \"start\";\n  }\n}\n", "import type { KTransformation } from \"../../../../../kpuzzle\";\nimport { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport class SetupTransformationProp extends SimpleTwistyPropSource<KTransformation | null> {\n  getDefaultValue(): KTransformation | null {\n    return null;\n  }\n}\n", "import type { KPuzzle } from \"../../../../../kpuzzle\";\nimport type { PuzzleLoader } from \"../../../../../puzzles\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\n\nexport class KPuzzleProp extends TwistyPropDerived<\n  { puzzleLoader: PuzzleLoader },\n  KPuzzle\n> {\n  async derive(inputs: { puzzleLoader: PuzzleLoader }): Promise<KPuzzle> {\n    return inputs.puzzleLoader.kpuzzle();\n  }\n}\n", "import type { PuzzleDescriptionString } from \"../../../../../puzzle-geometry/PGPuzzles\";\nimport {\n  NoValueType,\n  NO_VALUE,\n  SimpleTwistyPropSource,\n} from \"../../TwistyProp\";\n\nexport class PGPuzzleDescriptionStringProp extends SimpleTwistyPropSource<\n  PuzzleDescriptionString | NoValueType\n> {\n  getDefaultValue(): PuzzleDescriptionString | NoValueType {\n    return NO_VALUE;\n  }\n}\n", "import type { PuzzleLoader } from \"../../../../../puzzles\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { PuzzleID } from \"./PuzzleIDRequestProp\";\n\nexport class PuzzleIDProp extends TwistyPropDerived<\n  { puzzleLoader: PuzzleLoader },\n  PuzzleID\n> {\n  async derive(inputs: { puzzleLoader: PuzzleLoader }): Promise<PuzzleID> {\n    return inputs.puzzleLoader.id as PuzzleID;\n  }\n}\n", "import {\n  NoValueType,\n  NO_VALUE,\n  SimpleTwistyPropSource,\n} from \"../../TwistyProp\";\n\nexport const puzzleIDs = {\n  \"3x3x3\": true, // default\n  custom: true,\n  \"2x2x2\": true,\n  \"4x4x4\": true,\n  \"5x5x5\": true,\n  \"6x6x6\": true,\n  \"7x7x7\": true,\n  \"40x40x40\": true,\n  megaminx: true,\n  pyraminx: true,\n  square1: true,\n  clock: true,\n  skewb: true,\n  fto: true,\n  gigaminx: true,\n  master_tetraminx: true,\n  kilominx: true,\n  redi_cube: true,\n  melindas2x2x2x2: true,\n};\nexport type PuzzleID = keyof typeof puzzleIDs;\n\n// TODO: Ideally we'd use `null` to mean \"no value\", but `null` has a special meaning\n// for `TwistyProp` and might mess with caching.\n// https://github.com/cubing/cubing.js/blob/63b0a55b83963f68410bb117a2e481052a07e086/src/cubing/twisty/model/TwistyProp.ts#L189-L189\nexport class PuzzleIDRequestProp extends SimpleTwistyPropSource<\n  PuzzleID | NoValueType\n> {\n  getDefaultValue(): PuzzleID | NoValueType {\n    return NO_VALUE;\n  }\n}\n", "import type { PuzzleDescriptionString } from \"../../../../../puzzle-geometry/PGPuzzles\";\nimport { cube3x3x3, PuzzleLoader, puzzles } from \"../../../../../puzzles\";\nimport { experimentalCustomPGPuzzleLoader } from \"../../../../../puzzles/cubing-private\";\nimport { NoValueType, NO_VALUE, TwistyPropDerived } from \"../../TwistyProp\";\nimport type { PuzzleID } from \"./PuzzleIDRequestProp\";\n8;\ninterface PuzzleLoaderPropInputs {\n  puzzleIDRequest: PuzzleID | NoValueType;\n  puzzleDescriptionRequest: PuzzleDescriptionString | NoValueType;\n}\n\nexport class PuzzleLoaderProp extends TwistyPropDerived<\n  PuzzleLoaderPropInputs,\n  PuzzleLoader\n> {\n  derive(inputs: PuzzleLoaderPropInputs): PuzzleLoader {\n    if (inputs.puzzleIDRequest && inputs.puzzleIDRequest !== NO_VALUE) {\n      const puzzleLoader = puzzles[inputs.puzzleIDRequest];\n      if (!puzzleLoader) {\n        this.userVisibleErrorTracker!.set({\n          errors: [`Invalid puzzle ID: ${inputs.puzzleIDRequest}`],\n        });\n      }\n      return puzzleLoader;\n    }\n    if (\n      inputs.puzzleDescriptionRequest &&\n      inputs.puzzleDescriptionRequest !== NO_VALUE\n    ) {\n      return experimentalCustomPGPuzzleLoader(inputs.puzzleDescriptionRequest);\n    }\n    return cube3x3x3;\n  }\n}\n", "import type { ButtonCommand } from \"../../../views/control-panel/TwistyButtons\";\nimport type { PlayingInfo } from \"./PlayingInfoProp\";\nimport type { DetailedTimelineInfo } from \"./DetailedTimelineInfoProp\";\nimport { TwistyPropDerived } from \"../TwistyProp\";\n\ninterface ButtonAppearance {\n  enabled: boolean;\n  icon: string;\n  title: string;\n}\nexport type ButtonAppearances = Record<ButtonCommand, ButtonAppearance>;\n\ninterface CoarseTimelineInfoInputs {\n  playingInfo: PlayingInfo;\n  detailedTimelineInfo: DetailedTimelineInfo;\n}\n\nexport interface CoarseTimelineInfo {\n  playing: boolean;\n  atStart: boolean;\n  atEnd: boolean;\n}\n\n// This started as a version of `EffectiveTimestamp` without the actual\n// timestamp, to enable easier caching.\nexport class CoarseTimelineInfoProp extends TwistyPropDerived<\n  CoarseTimelineInfoInputs,\n  CoarseTimelineInfo\n> {\n  protected override derive(\n    inputs: CoarseTimelineInfoInputs,\n  ): CoarseTimelineInfo {\n    return {\n      playing: inputs.playingInfo.playing,\n      atStart: inputs.detailedTimelineInfo.atStart,\n      atEnd: inputs.detailedTimelineInfo.atEnd,\n    };\n  }\n\n  protected override canReuseValue(\n    v1: CoarseTimelineInfo,\n    v2: CoarseTimelineInfo,\n  ): boolean {\n    return (\n      v1.playing === v2.playing &&\n      v1.atStart === v2.atStart &&\n      v1.atEnd === v2.atEnd\n    );\n  }\n}\n", "import type {\n  MillisecondTimestamp,\n  TimeRange,\n} from \"../../../controllers/AnimationTypes\";\nimport type { TimestampRequest } from \"./TimestampRequestProp\";\nimport { TwistyPropDerived } from \"../TwistyProp\";\nimport type { SetupToLocation } from \"../puzzle/state/SetupAnchorProp\";\nimport type { AlgWithIssues } from \"../puzzle/state/AlgProp\";\n\ninterface DetailedTimelineInfoInputs {\n  timestampRequest: TimestampRequest;\n  timeRange: TimeRange;\n  setupAnchor: SetupToLocation;\n  setupAlg: AlgWithIssues;\n}\n\nexport interface DetailedTimelineInfo {\n  timestamp: MillisecondTimestamp;\n  timeRange: TimeRange; // TODO: Don't incluede this, and let fresh listeners listen to multiple inputs?\n  // Note: `atStart` and `atEnd` can both be true. This is the case with the\n  // default (empty) alg, which has a duration of 0 ms.\n  atStart: boolean;\n  atEnd: boolean;\n}\n\nexport class DetailedTimelineInfoProp extends TwistyPropDerived<\n  DetailedTimelineInfoInputs,\n  DetailedTimelineInfo\n> {\n  protected override derive(\n    inputs: DetailedTimelineInfoInputs,\n  ): DetailedTimelineInfo {\n    let timestamp = this.#requestedTimestampToMilliseconds(inputs);\n    let atStart: boolean = false;\n    let atEnd: boolean = false;\n    if (timestamp >= inputs.timeRange.end) {\n      atEnd = true;\n      timestamp = Math.min(inputs.timeRange.end, timestamp);\n    }\n    if (timestamp <= inputs.timeRange.start) {\n      atStart = true;\n      timestamp = Math.max(inputs.timeRange.start, timestamp);\n    }\n    return {\n      timestamp,\n      timeRange: inputs.timeRange,\n      atStart,\n      atEnd,\n    };\n  }\n\n  #requestedTimestampToMilliseconds(\n    inputs: DetailedTimelineInfoInputs,\n  ): MillisecondTimestamp {\n    switch (inputs.timestampRequest) {\n      case \"auto\":\n        return inputs.setupAnchor === \"start\" &&\n          inputs.setupAlg.alg.experimentalIsEmpty()\n          ? inputs.timeRange.end\n          : inputs.timeRange.start;\n      case \"start\":\n        return inputs.timeRange.start;\n      case \"end\":\n        return inputs.timeRange.end;\n      case \"anchor\":\n        return inputs.setupAnchor === \"start\"\n          ? inputs.timeRange.start\n          : inputs.timeRange.end;\n      case \"opposite-anchor\":\n        return inputs.setupAnchor === \"start\"\n          ? inputs.timeRange.end\n          : inputs.timeRange.start;\n      default:\n        return inputs.timestampRequest;\n    }\n  }\n\n  protected override canReuseValue(\n    v1: DetailedTimelineInfo,\n    v2: DetailedTimelineInfo,\n  ) {\n    return (\n      v1.timestamp === v2.timestamp &&\n      v1.timeRange.start === v2.timeRange.start &&\n      v1.timeRange.end === v2.timeRange.end &&\n      v1.atStart === v2.atStart &&\n      v1.atEnd === v2.atEnd\n    );\n  }\n}\n", "import { BoundaryType, Direction } from \"../../../controllers/AnimationTypes\";\nimport { TwistyPropSource } from \"../TwistyProp\";\n\nexport type SimpleDirection = Direction.Forwards | Direction.Backwards;\n\nexport interface PlayingInfo {\n  playing: boolean;\n  direction: SimpleDirection;\n  untilBoundary: BoundaryType; // TODO: allows this to be optional in the setter?\n  // TODO: Is `loop` responsible to add at this point? Maybe we should wait until we've figured out autoplay?\n  // TODO: Combine `loop` into something with BoundaryType?\n  loop: boolean;\n}\n\n// TODO: direction,\nexport class PlayingInfoProp extends TwistyPropSource<\n  PlayingInfo,\n  Partial<PlayingInfo>\n> {\n  public override async getDefaultValue(): Promise<PlayingInfo> {\n    return {\n      direction: Direction.Forwards,\n      playing: false,\n      untilBoundary: BoundaryType.EntireTimeline,\n      loop: false,\n    };\n  }\n\n  protected override async derive(\n    newInfo: Partial<PlayingInfo>,\n    oldValuePromise: Promise<PlayingInfo>,\n  ): Promise<PlayingInfo> {\n    const oldValue = await oldValuePromise;\n\n    const newValue: PlayingInfo = Object.assign({}, oldValue);\n    Object.assign(newValue, newInfo);\n    return newValue;\n  }\n\n  protected override canReuseValue(v1: PlayingInfo, v2: PlayingInfo) {\n    return (\n      v1.direction === v2.direction &&\n      v1.playing === v2.playing &&\n      v1.untilBoundary === v2.untilBoundary &&\n      v1.loop === v2.loop\n    );\n  }\n}\n", "import { TwistyPropSource } from \"../TwistyProp\";\n\n// TODO: Pick a better name. `speed` is probably good, although that could mean\n// something else (e.g. shorter, faster moves but still with the same spacing).\nexport class TempoScaleProp extends TwistyPropSource<number, number> {\n  getDefaultValue(): number {\n    return 1;\n  }\n\n  derive(v: number): number {\n    return v < 0 ? 1 : v;\n  }\n}\n", "import type { MillisecondTimestamp } from \"../../../controllers/AnimationTypes\";\nimport { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nconst smartTimestamps = {\n  auto: true,\n  start: true,\n  end: true,\n  anchor: true,\n  \"opposite-anchor\": true,\n};\n\nexport type TimestampRequest =\n  | MillisecondTimestamp\n  | keyof typeof smartTimestamps;\n\nexport class TimestampRequestProp extends SimpleTwistyPropSource<TimestampRequest> {\n  override getDefaultValue(): TimestampRequest {\n    return \"auto\";\n  }\n\n  // TODO: Support `Promise`\n  public override set(v: TimestampRequest) {\n    if (!this.validInput(v)) {\n      // TODO: Generalize this to more props. How do we surface this? Throw an error and catch it from sync setters that call into this?\n      return;\n    }\n    super.set(v);\n  }\n\n  protected validInput(v: TimestampRequest): boolean {\n    if (typeof v === \"number\") {\n      return true;\n    }\n    if (smartTimestamps[v]) {\n      return true;\n    }\n    return false;\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nexport const backViewLayouts = {\n  none: true, // default\n  \"side-by-side\": true,\n  \"top-right\": true,\n};\nexport type BackViewLayout = keyof typeof backViewLayouts;\n\nexport type BackViewLayoutWithAuto = BackViewLayout | \"auto\";\n\nexport class BackViewProp extends SimpleTwistyPropSource<BackViewLayoutWithAuto> {\n  getDefaultValue(): BackViewLayoutWithAuto {\n    return \"auto\";\n  }\n}\n", "import type { TimeRange } from \"../../../controllers/AnimationTypes\";\nimport type { AlgIndexer } from \"../../../controllers/indexer/AlgIndexer\";\nimport { TwistyPropDerived } from \"../TwistyProp\";\n\nexport class TimeRangeProp extends TwistyPropDerived<\n  { indexer: AlgIndexer },\n  TimeRange\n> {\n  derive(inputs: { indexer: AlgIndexer }): TimeRange {\n    return {\n      start: 0,\n      end: inputs.indexer.algDuration(),\n    };\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nexport const viewerLinkPages = {\n  twizzle: true, // default\n  \"experimental-twizzle-explorer\": true,\n  none: true,\n};\nexport type ViewerLinkPage = keyof typeof viewerLinkPages;\nexport type ViewerLinkPageWithAuto = ViewerLinkPage | \"auto\";\n\nexport class ViewerLinkProp extends SimpleTwistyPropSource<ViewerLinkPageWithAuto> {\n  getDefaultValue(): ViewerLinkPageWithAuto {\n    return \"auto\";\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\n// TODO: turn these maps into lists?\nexport const visualizationFormats = {\n  \"3D\": true, // default\n  \"2D\": true,\n  \"experimental-2D-LL\": true, // TODO\n  PG3D: true,\n};\nexport type VisualizationFormat = keyof typeof visualizationFormats;\nexport type VisualizationFormatWithAuto = VisualizationFormat | \"auto\";\n\nexport class VisualizationFormatProp extends SimpleTwistyPropSource<VisualizationFormatWithAuto> {\n  getDefaultValue(): VisualizationFormatWithAuto {\n    return \"auto\";\n  }\n}\n", "import type { VisualizationFormatWithAuto } from \"./VisualizationProp\";\nimport { TwistyPropDerived } from \"../TwistyProp\";\nimport type { PuzzleID } from \"../../..\";\n\ntype VisualizationStrategyPropInputs = {\n  visualizationRequest: VisualizationFormatWithAuto;\n  puzzleID: PuzzleID;\n};\n\nexport type VisualizationStrategy =\n  | \"Cube3D\"\n  | \"2D\"\n  | \"experimental-2D-LL\"\n  | \"PG3D\";\n\nexport class VisualizationStrategyProp extends TwistyPropDerived<\n  VisualizationStrategyPropInputs,\n  VisualizationStrategy\n> {\n  derive(inputs: VisualizationStrategyPropInputs): VisualizationStrategy {\n    // TODO: let the puzzle loader tell us.\n    switch (inputs.puzzleID) {\n      case \"clock\":\n      case \"square1\":\n      case \"kilominx\":\n      case \"redi_cube\":\n      case \"melindas2x2x2x2\":\n        return \"2D\";\n      case \"3x3x3\":\n        switch (inputs.visualizationRequest) {\n          case \"auto\":\n          case \"3D\":\n            return \"Cube3D\";\n          default:\n            return inputs.visualizationRequest;\n        }\n      default:\n        switch (inputs.visualizationRequest) {\n          case \"auto\":\n          case \"3D\":\n            return \"PG3D\";\n          case \"experimental-2D-LL\":\n            if ([\"2x2x2\", \"4x4x4\", \"megaminx\"].includes(inputs.puzzleID)) {\n              // TODO: calculate this based on the `PuzzleLoader`.\n              return \"experimental-2D-LL\";\n            } else {\n              return \"2D\";\n            }\n          default:\n            return inputs.visualizationRequest;\n        }\n    }\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport type FaceletScale = \"auto\" | number;\nexport class FaceletScaleProp extends SimpleTwistyPropSource<FaceletScale> {\n  getDefaultValue(): FaceletScale {\n    return \"auto\";\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport type FoundationDisplay = \"auto\" | \"opaque\" | \"none\";\n\nexport class FoundationDisplayProp extends SimpleTwistyPropSource<FoundationDisplay> {\n  getDefaultValue(): FoundationDisplay {\n    return \"auto\";\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport type InitialHintFaceletsAnimation = \"auto\" | \"always\" | \"none\";\n\nexport class InitialHintFaceletsAnimationProp extends SimpleTwistyPropSource<InitialHintFaceletsAnimation> {\n  getDefaultValue(): InitialHintFaceletsAnimation {\n    return \"auto\";\n  }\n}\n", "import type { Texture, TextureLoader } from \"three\";\nimport { THREEJS } from \"../../../../heavy-code-imports/3d\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\n\nlet cachedLoader: TextureLoader | null = null;\nasync function loader(): Promise<TextureLoader> {\n  return (cachedLoader ??= new (await THREEJS).TextureLoader());\n}\n\ntype SpritePropInputs = {\n  spriteURL: URL | null;\n};\n\n// TODO: Find a way to make the 3D elements own this, instead of the main `TwistyPlayerModel`.\nexport class SpriteProp extends TwistyPropDerived<\n  SpritePropInputs,\n  Texture | null\n> {\n  async derive(inputs: SpritePropInputs): Promise<Texture | null> {\n    const { spriteURL: textureURL } = inputs;\n    if (textureURL === null) {\n      return null;\n    }\n    // rome-ignore lint/suspicious/noAsyncPromiseExecutor: TODO: Find a different way to handle `onLoadingError`?\n    return new Promise(async (resolve, _reject) => {\n      const onLoadingError = (): void => {\n        console.warn(\"Could not load sprite:\", textureURL.toString());\n        resolve(null);\n      };\n      // TODO: provide a way to listen for errors?\n      try {\n        (await loader()).load(\n          textureURL.toString(),\n          resolve,\n          onLoadingError,\n          onLoadingError,\n        );\n      } catch (e) {\n        onLoadingError();\n      }\n    });\n  }\n}\n", "import type { PuzzleLoader } from \"../../../../../puzzles\";\nimport type {\n  ExperimentalStickeringMask,\n  ExperimentalPieceStickeringMask,\n} from \"../../../../../puzzles/cubing-private\";\nimport { TwistyPropDerived } from \"../../TwistyProp\";\nimport type { ExperimentalStickering } from \"./StickeringRequestProp\";\n\ninterface StickeringMaskPropInputs {\n  stickeringMaskRequest: ExperimentalStickeringMask | null;\n  stickeringRequest: ExperimentalStickering | null;\n  puzzleLoader: PuzzleLoader;\n}\n\nconst r: ExperimentalPieceStickeringMask = {\n  facelets: [\"regular\", \"regular\", \"regular\", \"regular\", \"regular\"],\n};\n\nasync function fullStickeringMask(\n  puzzleLoader: PuzzleLoader,\n): Promise<ExperimentalStickeringMask> {\n  const { definition } = await puzzleLoader.kpuzzle();\n  const fullStickeringMask: ExperimentalStickeringMask = { orbits: {} };\n  for (const [orbitName, orbitDef] of Object.entries(definition.orbits)) {\n    fullStickeringMask.orbits[orbitName] = {\n      pieces: new Array(orbitDef.numPieces).fill(r),\n    };\n  }\n  return fullStickeringMask;\n}\n\nexport class StickeringMaskProp extends TwistyPropDerived<\n  StickeringMaskPropInputs,\n  ExperimentalStickeringMask\n> {\n  getDefaultValue(): ExperimentalStickeringMask {\n    return { orbits: {} }; // TODO: auto\n  }\n\n  async derive(\n    inputs: StickeringMaskPropInputs,\n  ): Promise<ExperimentalStickeringMask> {\n    if (inputs.stickeringMaskRequest) {\n      return inputs.stickeringMaskRequest;\n    }\n    if (inputs.stickeringRequest === \"picture\") {\n      return {\n        specialBehaviour: \"picture\",\n        orbits: {},\n      };\n    }\n    return (\n      inputs.puzzleLoader.stickeringMask?.(\n        inputs.stickeringRequest ?? \"full\",\n      ) ?? fullStickeringMask(inputs.puzzleLoader)\n    );\n  }\n  // TODO: Implement canReuseValue?\n}\n", "// import type {\n//   FaceletMeshStickeringMask,\n//   PieceStickeringMask,\n//   StickeringMask,\n// } from \"./mask\";\n\nimport {\n  experimentalGetPieceStickeringMask,\n  ExperimentalPieceStickering,\n  ExperimentalPieceStickeringMask,\n  ExperimentalStickeringMask,\n} from \"../../../../../puzzles/cubing-private\";\n\nconst charMap: Record<string, ExperimentalPieceStickering> = {\n  \"-\": ExperimentalPieceStickering.Regular,\n  D: ExperimentalPieceStickering.Dim,\n  I: ExperimentalPieceStickering.Ignored,\n  // o: ExperimentalPieceStickering.OrientationStickers, // TODO: hack for centers\n  X: ExperimentalPieceStickering.Invisible,\n  O: ExperimentalPieceStickering.IgnoreNonPrimary, // orient color known\n  P: ExperimentalPieceStickering.PermuteNonPrimary, // Example: PLL\n  o: ExperimentalPieceStickering.Ignoriented, // Example: LL edges during CLS\n  \"?\": ExperimentalPieceStickering.OrientationWithoutPermutation, // ACube: ignore position\n  \"@\": ExperimentalPieceStickering.Regular, // ACube: ignore orientation // TODO: distinguish from \"regular\"\n};\n\nexport function parseSerializedStickeringMask(\n  serializedStickeringMask: string,\n): ExperimentalStickeringMask {\n  const stickeringMask: ExperimentalStickeringMask = {\n    orbits: {},\n  };\n  const serializedOrbits = serializedStickeringMask.split(\",\");\n  for (const serializedOrbit of serializedOrbits) {\n    const [orbitName, serializedOrbitPieces, ...rest] =\n      serializedOrbit.split(\":\");\n    if (rest.length > 0) {\n      throw new Error(\n        `Invalid serialized orbit stickering mask (too many colons): \\`${serializedOrbit}\\``,\n      );\n    }\n    const pieces: ExperimentalPieceStickeringMask[] = [];\n    stickeringMask.orbits[orbitName] = { pieces };\n    for (const char of serializedOrbitPieces) {\n      const pieceStickering = charMap[char];\n      pieces.push(experimentalGetPieceStickeringMask(pieceStickering));\n    }\n  }\n  return stickeringMask;\n}\n", "import type { ExperimentalStickeringMask } from \"../../../../../puzzles/cubing-private\";\nimport { TwistyPropSource } from \"../../TwistyProp\";\nimport { parseSerializedStickeringMask } from \"./parseSerializedStickeringMask\";\n\nexport class StickeringMaskRequestProp extends TwistyPropSource<\n  ExperimentalStickeringMask | null,\n  string | ExperimentalStickeringMask | null\n> {\n  getDefaultValue(): ExperimentalStickeringMask | null {\n    return null; // TODO: auto\n  }\n\n  derive(\n    input: string | ExperimentalStickeringMask | null,\n  ): ExperimentalStickeringMask | null {\n    if (input === null) {\n      return null;\n    } else if (typeof input === \"string\") {\n      return parseSerializedStickeringMask(input);\n    } else {\n      return input;\n    }\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport const dragInputModes = {\n  auto: true,\n  none: true,\n};\nexport type DragInputMode = keyof typeof dragInputModes;\n\nexport class DragInputProp extends SimpleTwistyPropSource<DragInputMode> {\n  getDefaultValue(): DragInputMode {\n    return \"auto\";\n  }\n}\n", "import type { AppendCancelOptions } from \"../../../../../alg\";\nimport { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\n// TODO: this should probably be dynamic based on the input, e.g. possibly even controlled using a modifier key.\nexport class MovePressCancelOptions extends SimpleTwistyPropSource<AppendCancelOptions> {\n  getDefaultValue(): AppendCancelOptions {\n    return {};\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../../TwistyProp\";\n\nexport const movePressInputNames = {\n  auto: true,\n  none: true,\n  basic: true,\n};\nexport type MovePressInput = keyof typeof movePressInputNames;\n\nexport class MovePressInputProp extends SimpleTwistyPropSource<MovePressInput> {\n  getDefaultValue(): MovePressInput {\n    return \"auto\";\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nexport const backgroundThemes = {\n  checkered: true, // default\n  \"checkered-transparent\": true, // default\n  none: true,\n};\nexport type BackgroundTheme = keyof typeof backgroundThemes;\n\nexport type BackgroundThemeWithAuto = BackgroundTheme | \"auto\";\n\nexport class BackgroundProp extends SimpleTwistyPropSource<BackgroundThemeWithAuto> {\n  getDefaultValue(): BackgroundThemeWithAuto {\n    return \"auto\";\n  }\n}\n", "import { TwistyPropDerived } from \"../TwistyProp\";\nimport type {\n  DarkModeTheme,\n  DarkModeThemeWithAuto,\n} from \"./DarkModeRequestProp\";\n\ninterface DarkModePropInputs {\n  darkModeRequest: DarkModeThemeWithAuto;\n}\n\nexport class DarkModeProp extends TwistyPropDerived<\n  DarkModePropInputs,\n  DarkModeTheme\n> {\n  protected derive(inputs: DarkModePropInputs): DarkModeTheme {\n    // TODO: Once the theme is ready, use `prefers-color-scheme` for automatic dark mode by default.\n    return inputs.darkModeRequest === \"dark\" ? \"dark\" : \"light\";\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nexport const darkModeThemes = {\n  light: true,\n  dark: true,\n};\nexport type DarkModeTheme = keyof typeof darkModeThemes;\nexport type DarkModeThemeWithAuto = DarkModeTheme | \"auto\";\n\nexport class DarkModeRequstProp extends SimpleTwistyPropSource<DarkModeThemeWithAuto> {\n  getDefaultValue(): DarkModeThemeWithAuto {\n    return \"auto\";\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\n\nexport class DOMElementReferenceProp extends SimpleTwistyPropSource<Element | null> {\n  getDefaultValue(): Element | null {\n    return null;\n  }\n}\n", "import { SimpleTwistyPropSource } from \"../TwistyProp\";\nimport type { CoordinateDegrees } from \"./OrbitCoordinatesRequestProp\";\n\n// Similar to https://alg.cubing.net/\nconst DEFAULT_LATITUDE_LIMIT = 35;\n\nexport class LatitudeLimitProp extends SimpleTwistyPropSource<CoordinateDegrees> {\n  getDefaultValue(): CoordinateDegrees {\n    return DEFAULT_LATITUDE_LIMIT;\n  }\n}\n", "import { mod } from \"../../helpers\";\nimport { TwistyPropSource } from \"../TwistyProp\";\n\nexport type CoordinateDegrees = number;\n\nexport interface OrbitCoordinates {\n  latitude: CoordinateDegrees;\n  longitude: CoordinateDegrees;\n  distance: number;\n}\n\nexport function orbitCoordinatesEqual(\n  c1: OrbitCoordinates,\n  c2: OrbitCoordinates,\n): boolean {\n  return (\n    c1.latitude === c2.latitude &&\n    c1.longitude === c2.longitude &&\n    c1.distance === c2.distance\n  );\n}\n\n// TOOD: Check if freezing affects perf.\n// const DEFAULT_COORDINATES = Object.freeze({\n//   latitude: 35,\n//   longitude: 30,\n//   distance: 6,\n// });\n\nexport type OrbitCoordinatesRequest = Partial<OrbitCoordinates> | \"auto\";\n\n// TODO: Put the \"auto\" calculations in a separate place.\nexport class OrbitCoordinatesRequestProp extends TwistyPropSource<\n  OrbitCoordinatesRequest,\n  Partial<OrbitCoordinates> | \"auto\"\n> {\n  override getDefaultValue(): OrbitCoordinatesRequest {\n    return \"auto\";\n  }\n\n  protected override canReuseValue(v1: OrbitCoordinates, v2: OrbitCoordinates) {\n    return v1 === v2 || orbitCoordinatesEqual(v1, v2);\n  }\n\n  protected override async derive(\n    newCoordinates: Partial<OrbitCoordinates> | \"auto\",\n    oldValuePromise: Promise<OrbitCoordinatesRequest>,\n  ): Promise<OrbitCoordinatesRequest> {\n    if (newCoordinates === \"auto\") {\n      return \"auto\";\n    }\n\n    let oldValue = await oldValuePromise;\n    if (oldValue === \"auto\") {\n      oldValue = {};\n    }\n\n    const newValue: Partial<OrbitCoordinates> = Object.assign({}, oldValue);\n    Object.assign(newValue, newCoordinates);\n\n    if (typeof newValue.latitude !== \"undefined\") {\n      newValue.latitude = Math.min(Math.max(newValue.latitude, -90), 90);\n    }\n    if (typeof newValue.longitude !== \"undefined\") {\n      newValue.longitude = mod(newValue.longitude, 360, 180);\n    }\n    return newValue;\n  }\n}\n", "import { DEGREES_PER_RADIAN } from \"../../../views/3D/TAU\";\nimport type { PuzzleID } from \"../puzzle/structure/PuzzleIDRequestProp\";\nimport { TwistyPropDerived } from \"../TwistyProp\";\nimport {\n  CoordinateDegrees,\n  OrbitCoordinates,\n  orbitCoordinatesEqual,\n  OrbitCoordinatesRequest,\n} from \"./OrbitCoordinatesRequestProp\";\nimport type { VisualizationStrategy } from \"./VisualizationStrategyProp\";\n\ninterface OrbitCoordinatesPropInputs {\n  orbitCoordinatesRequest: OrbitCoordinatesRequest;\n  latitudeLimit: CoordinateDegrees;\n  puzzleID: PuzzleID;\n  strategy: VisualizationStrategy;\n}\n\nexport class OrbitCoordinatesProp extends TwistyPropDerived<\n  OrbitCoordinatesPropInputs,\n  OrbitCoordinates\n> {\n  override canReuseValue(v1: OrbitCoordinates, v2: OrbitCoordinates) {\n    return orbitCoordinatesEqual(v1, v2);\n  }\n\n  async derive(inputs: OrbitCoordinatesPropInputs): Promise<OrbitCoordinates> {\n    if (inputs.orbitCoordinatesRequest === \"auto\") {\n      return defaultCameraOrbitCoordinates(inputs.puzzleID, inputs.strategy);\n    }\n\n    const req: OrbitCoordinates = Object.assign(\n      Object.assign(\n        {},\n        defaultCameraOrbitCoordinates(inputs.puzzleID, inputs.strategy),\n        inputs.orbitCoordinatesRequest,\n      ),\n    );\n\n    if (Math.abs(req.latitude) <= inputs.latitudeLimit) {\n      return req;\n    } else {\n      const { latitude, longitude, distance } = req;\n      // TODO: Should we re-normalize the request, so we don't depend on normalization in the input?\n      return {\n        latitude: inputs.latitudeLimit * Math.sign(latitude),\n        longitude,\n        distance,\n      };\n    }\n  }\n}\n\n// const DEFAULT_CAMERA_Z = 5;\n// // Golden ratio is perfect for FTO and Megaminx.\n// const DEFAULT_CAMERA_Y = DEFAULT_CAMERA_Z * (2 / (1 + Math.sqrt(5)));\nexport const centeredCameraOrbitCoordinates: OrbitCoordinates = {\n  latitude: 31.717474411461005,\n  longitude: 0,\n  distance: 5.877852522924731,\n};\n\n// This is tuned so that the hint facelets for 3x3x3 always fit in the canvas.\nexport const cubeCube3DCameraOrbitCoordinates: OrbitCoordinates = {\n  latitude: 35,\n  longitude: 30,\n  distance: 6,\n};\n\n// This is tuned so that the hint facelets always fit in the canvas.\nexport const cubePG3DCameraOrbitCoordinates: OrbitCoordinates = {\n  latitude: 35,\n  longitude: 30,\n  distance: 6.25,\n};\n\nexport const megaminxCameraOrbitCoordinates: OrbitCoordinates = {\n  latitude: Math.atan(1 / 2) * DEGREES_PER_RADIAN,\n  longitude: 0,\n  distance: 6.7,\n};\n\nexport const pyraminxCameraOrbitCoordinates: OrbitCoordinates = {\n  latitude: 26.56505117707799,\n  longitude: 0,\n  distance: 6,\n};\n\nexport const cornerCameraOrbitCoordinates: OrbitCoordinates = {\n  latitude: 35.264389682754654,\n  longitude: 45,\n  distance: 6.928203230275509,\n};\n\n// TODO\nexport function defaultCameraOrbitCoordinates(\n  puzzleID: PuzzleID,\n  strategy: VisualizationStrategy,\n): OrbitCoordinates {\n  if (puzzleID[1] === \"x\") {\n    if (strategy === \"Cube3D\") {\n      return cubeCube3DCameraOrbitCoordinates;\n    } else {\n      return cubePG3DCameraOrbitCoordinates;\n    }\n  } else {\n    switch (puzzleID) {\n      case \"megaminx\":\n      case \"gigaminx\":\n        return megaminxCameraOrbitCoordinates;\n      case \"pyraminx\":\n      case \"master_tetraminx\":\n        return pyraminxCameraOrbitCoordinates;\n      case \"skewb\":\n        return cubePG3DCameraOrbitCoordinates;\n      default:\n        return centeredCameraOrbitCoordinates;\n    }\n  }\n}\n// TODO: templatize\nexport interface ManagedAttribute<K> {\n  string: string;\n  value: K;\n  setString(s: string): boolean;\n  setValue(v: K): boolean;\n}\n", "import { URLProp } from \"./props/general/URLProp\";\nimport { FaceletScaleProp } from \"./props/puzzle/display/FaceletScaleProp\";\nimport { FoundationDisplayProp } from \"./props/puzzle/display/FoundationDisplayProp\";\nimport { HintFaceletProp } from \"./props/puzzle/display/HintFaceletProp\";\nimport { InitialHintFaceletsAnimationProp } from \"./props/puzzle/display/InitialHintFaceletsAnimationProp\";\nimport { SpriteProp } from \"./props/puzzle/display/SpriteProp\";\nimport { StickeringMaskProp } from \"./props/puzzle/display/StickeringMaskProp\";\nimport { StickeringMaskRequestProp } from \"./props/puzzle/display/StickeringMaskRequestProp\";\nimport { StickeringRequestProp } from \"./props/puzzle/display/StickeringRequestProp\";\nimport { DragInputProp } from \"./props/puzzle/state/DragInputProp\";\nimport { MovePressCancelOptions } from \"./props/puzzle/state/MovePressCancelOptions\";\nimport { MovePressInputProp } from \"./props/puzzle/state/MovePressInputProp\";\nimport { BackgroundProp } from \"./props/viewer/BackgroundProp\";\nimport { DarkModeProp } from \"./props/viewer/DarkModeProp\";\nimport { DarkModeRequstProp } from \"./props/viewer/DarkModeRequestProp\";\nimport { DOMElementReferenceProp } from \"./props/viewer/DOMElementReferenceProp\";\nimport { LatitudeLimitProp } from \"./props/viewer/LatitudeLimit\";\nimport { OrbitCoordinatesProp } from \"./props/viewer/OrbitCoordinatesProp\";\nimport { OrbitCoordinatesRequestProp } from \"./props/viewer/OrbitCoordinatesRequestProp\";\nimport type { TwistyPlayerModel } from \"./TwistyPlayerModel\";\n\nexport class TwistySceneModel {\n  // Depth 0\n  background = new BackgroundProp();\n  darkModeRequest = new DarkModeRequstProp();\n  dragInput = new DragInputProp();\n  foundationDisplay = new FoundationDisplayProp();\n  foundationStickerSpriteURL = new URLProp();\n  fullscreenElement = new DOMElementReferenceProp();\n  hintFacelet = new HintFaceletProp();\n  hintStickerSpriteURL = new URLProp();\n  initialHintFaceletsAnimation = new InitialHintFaceletsAnimationProp();\n  latitudeLimit = new LatitudeLimitProp();\n  movePressInput = new MovePressInputProp();\n  movePressCancelOptions = new MovePressCancelOptions();\n  orbitCoordinatesRequest: OrbitCoordinatesRequestProp =\n    new OrbitCoordinatesRequestProp();\n  // `stickeringMaskRequest` takes priority over `stickeringRequest`\n  stickeringMaskRequest = new StickeringMaskRequestProp();\n  stickeringRequest = new StickeringRequestProp();\n  faceletScale = new FaceletScaleProp();\n\n  // Depth 1\n  darkMode = new DarkModeProp({ darkModeRequest: this.darkModeRequest });\n  foundationStickerSprite = new SpriteProp({\n    spriteURL: this.foundationStickerSpriteURL,\n  });\n  hintStickerSprite = new SpriteProp({\n    spriteURL: this.hintStickerSpriteURL,\n  });\n\n  // Dependence on TwistyPlayerModel\n  orbitCoordinates: OrbitCoordinatesProp;\n  stickeringMask: StickeringMaskProp;\n\n  constructor(public twistyPlayerModel: TwistyPlayerModel) {\n    this.orbitCoordinates = new OrbitCoordinatesProp({\n      orbitCoordinatesRequest: this.orbitCoordinatesRequest,\n      latitudeLimit: this.latitudeLimit,\n      puzzleID: twistyPlayerModel.puzzleID,\n      strategy: twistyPlayerModel.visualizationStrategy,\n    });\n    this.stickeringMask = new StickeringMaskProp({\n      stickeringMaskRequest: this.stickeringMaskRequest,\n      stickeringRequest: this.stickeringRequest,\n      puzzleLoader: twistyPlayerModel.puzzleLoader,\n    });\n  }\n}\n", "import { arrayEquals } from \"./helpers\";\nimport { SimpleTwistyPropSource } from \"./props/TwistyProp\";\n\ninterface UserVisibleError {\n  errors: string[];\n}\n\nconst EMPTY_ERRORS = { errors: [] };\n\nexport class UserVisibleErrorTracker extends SimpleTwistyPropSource<UserVisibleError> {\n  override getDefaultValue(): UserVisibleError {\n    return EMPTY_ERRORS;\n  }\n\n  public reset() {\n    this.set(this.getDefaultValue());\n  }\n\n  protected override canReuseValue(\n    _v1: UserVisibleError,\n    _v2: UserVisibleError,\n  ): boolean {\n    return arrayEquals(_v1.errors, _v2.errors);\n  }\n}\n", "import { Alg, experimentalAppendMove, Move } from \"../../alg\";\nimport type { AlgLeaf } from \"../../alg/alg-nodes/AlgNode\";\nimport type { AppendOptions } from \"../../alg/simplify\";\nimport { getPartialAppendOptionsForPuzzleSpecificSimplifyOptions } from \"../../puzzles/cubing-private\";\nimport { ArbitraryStringProp } from \"./props/general/ArbitraryStringProp\";\nimport { URLProp } from \"./props/general/URLProp\";\nimport { AlgProp } from \"./props/puzzle/state/AlgProp\";\nimport { AlgTransformationProp } from \"./props/puzzle/state/AlgTransformationProp\";\nimport { AnchorTransformationProp } from \"./props/puzzle/state/AnchorTransformationProp\";\nimport { CatchUpMoveProp } from \"./props/puzzle/state/CatchUpMoveProp\";\nimport { CurrentLeavesSimplifiedProp } from \"./props/puzzle/state/CurrentLeavesSimplified\";\nimport { CurrentMoveInfoProp } from \"./props/puzzle/state/CurrentMoveInfoProp\";\nimport { CurrentStateProp } from \"./props/puzzle/state/CurrentStateProp\";\nimport { IndexerConstructorProp } from \"./props/puzzle/state/IndexerConstructorProp\";\nimport { IndexerConstructorRequestProp } from \"./props/puzzle/state/IndexerConstructorRequestProp\";\nimport { IndexerProp } from \"./props/puzzle/state/IndexerProp\";\nimport { LegacyPositionProp } from \"./props/puzzle/state/LegacyPositionProp\";\nimport { NaiveMoveCountProp } from \"./props/puzzle/state/NaiveMoveCountProp\";\nimport { PuzzleAlgProp } from \"./props/puzzle/state/PuzzleAlgProp\";\nimport { SetupAnchorProp } from \"./props/puzzle/state/SetupAnchorProp\";\nimport { SetupTransformationProp } from \"./props/puzzle/state/SetupTransformationProp\";\nimport { KPuzzleProp } from \"./props/puzzle/structure/KPuzzleProp\";\nimport { PGPuzzleDescriptionStringProp } from \"./props/puzzle/structure/PuzzleDescriptionProp\";\nimport { PuzzleIDProp } from \"./props/puzzle/structure/PuzzleIDProp\";\nimport { PuzzleIDRequestProp } from \"./props/puzzle/structure/PuzzleIDRequestProp\";\nimport { PuzzleLoaderProp } from \"./props/puzzle/structure/PuzzleLoaderProp\";\nimport { CoarseTimelineInfoProp } from \"./props/timeline/CoarseTimelineInfoProp\";\nimport { DetailedTimelineInfoProp } from \"./props/timeline/DetailedTimelineInfoProp\";\nimport { PlayingInfoProp } from \"./props/timeline/PlayingInfoProp\";\nimport { TempoScaleProp } from \"./props/timeline/TempoScaleProp\";\nimport { TimestampRequestProp } from \"./props/timeline/TimestampRequestProp\";\nimport { NO_VALUE } from \"./props/TwistyProp\";\nimport { BackViewProp } from \"./props/viewer/BackViewProp\";\nimport { ButtonAppearanceProp } from \"./props/viewer/ButtonAppearanceProp\";\nimport { ControlPanelProp } from \"./props/viewer/ControlPanelProp\";\nimport { TimeRangeProp } from \"./props/viewer/TimeRangeProp\";\nimport { ViewerLinkProp } from \"./props/viewer/ViewerLinkProp\";\nimport { VisualizationFormatProp } from \"./props/viewer/VisualizationProp\";\nimport { VisualizationStrategyProp } from \"./props/viewer/VisualizationStrategyProp\";\nimport { TwistySceneModel } from \"./TwistySceneModel\";\nimport { UserVisibleErrorTracker } from \"./UserVisibleErrorTracker\";\n\n// From https://stackoverflow.com/a/50918777\ntype Without<T, K extends string[]> = Pick<T, Exclude<keyof T, K[number]>>;\n\nexport class TwistyPlayerModel {\n  // TODO: incorporate error handling into the entire prop graph.\n  // TODO: Make this something that can't get confused with normal props?\n  userVisibleErrorTracker = new UserVisibleErrorTracker();\n\n  // TODO: Redistribute and group props with controllers.\n\n  // Depth 0\n  alg = new AlgProp();\n  backView = new BackViewProp();\n  controlPanel = new ControlPanelProp();\n  catchUpMove = new CatchUpMoveProp();\n  indexerConstructorRequest = new IndexerConstructorRequestProp();\n  playingInfo = new PlayingInfoProp();\n  puzzleDescriptionRequest = new PGPuzzleDescriptionStringProp();\n  puzzleIDRequest = new PuzzleIDRequestProp();\n  setupAnchor = new SetupAnchorProp();\n  setupAlg = new AlgProp();\n  setupTransformation = new SetupTransformationProp();\n  tempoScale = new TempoScaleProp();\n  timestampRequest = new TimestampRequestProp();\n  viewerLink = new ViewerLinkProp();\n  visualizationFormat = new VisualizationFormatProp();\n  // Metadata\n  title = new ArbitraryStringProp();\n  videoURL = new URLProp();\n  competitionID = new ArbitraryStringProp();\n\n  // Depth 1\n  puzzleLoader = new PuzzleLoaderProp(\n    {\n      puzzleIDRequest: this.puzzleIDRequest,\n      puzzleDescriptionRequest: this.puzzleDescriptionRequest,\n    },\n    this.userVisibleErrorTracker,\n  );\n\n  // Depth 2\n  kpuzzle = new KPuzzleProp({ puzzleLoader: this.puzzleLoader });\n\n  puzzleID = new PuzzleIDProp({ puzzleLoader: this.puzzleLoader });\n\n  // Depth 3\n\n  puzzleAlg = new PuzzleAlgProp({\n    algWithIssues: this.alg,\n    kpuzzle: this.kpuzzle,\n  });\n\n  puzzleSetupAlg = new PuzzleAlgProp({\n    algWithIssues: this.setupAlg,\n    kpuzzle: this.kpuzzle,\n  });\n\n  visualizationStrategy = new VisualizationStrategyProp({\n    visualizationRequest: this.visualizationFormat,\n    puzzleID: this.puzzleID,\n  });\n\n  // Depth 4\n  indexerConstructor = new IndexerConstructorProp({\n    alg: this.alg,\n    puzzle: this.puzzleID,\n    visualizationStrategy: this.visualizationStrategy,\n    indexerConstructorRequest: this.indexerConstructorRequest,\n  });\n\n  moveCount = new NaiveMoveCountProp({ alg: this.puzzleAlg });\n\n  setupAlgTransformation = new AlgTransformationProp({\n    setupAlg: this.puzzleSetupAlg,\n    kpuzzle: this.kpuzzle,\n  });\n\n  // Depth 5\n  indexer = new IndexerProp({\n    indexerConstructor: this.indexerConstructor,\n    algWithIssues: this.puzzleAlg,\n    kpuzzle: this.kpuzzle,\n  });\n\n  // Depth 6\n  anchorTransformation = new AnchorTransformationProp({\n    setupTransformation: this.setupTransformation,\n    setupAnchor: this.setupAnchor,\n    setupAlgTransformation: this.setupAlgTransformation,\n    indexer: this.indexer,\n  });\n\n  timeRange = new TimeRangeProp({\n    indexer: this.indexer,\n  });\n\n  // Depth 7\n  detailedTimelineInfo: DetailedTimelineInfoProp = new DetailedTimelineInfoProp(\n    {\n      timestampRequest: this.timestampRequest,\n      timeRange: this.timeRange,\n      setupAnchor: this.setupAnchor,\n      setupAlg: this.setupAlg,\n    },\n  );\n\n  // Depth 8\n  coarseTimelineInfo = new CoarseTimelineInfoProp({\n    detailedTimelineInfo: this.detailedTimelineInfo,\n    playingInfo: this.playingInfo,\n  });\n\n  currentMoveInfo = new CurrentMoveInfoProp({\n    indexer: this.indexer,\n    detailedTimelineInfo: this.detailedTimelineInfo,\n    catchUpMove: this.catchUpMove,\n  });\n\n  // Depth 9\n  // TODO: Inline Twisty3D management.\n  buttonAppearance = new ButtonAppearanceProp({\n    coarseTimelineInfo: this.coarseTimelineInfo,\n    viewerLink: this.viewerLink,\n  });\n\n  currentLeavesSimplified = new CurrentLeavesSimplifiedProp({\n    currentMoveInfo: this.currentMoveInfo,\n  });\n\n  // Depth 10\n  currentState = new CurrentStateProp({\n    anchoredStart: this.anchorTransformation,\n    currentLeavesSimplified: this.currentLeavesSimplified,\n    indexer: this.indexer,\n  });\n\n  // Depth 11\n  legacyPosition = new LegacyPositionProp({\n    currentMoveInfo: this.currentMoveInfo,\n    state: this.currentState,\n  });\n\n  twistySceneModel = new TwistySceneModel(this);\n\n  public async twizzleLink(): Promise<string> {\n    const [\n      viewerLink,\n      puzzleID,\n      puzzleDescription,\n      alg,\n      setup,\n      anchor,\n      experimentalStickeringRequest,\n      experimentalTitle,\n    ] = await Promise.all([\n      this.viewerLink.get(),\n      this.puzzleID.get(),\n      this.puzzleDescriptionRequest.get(),\n      this.alg.get(),\n      this.setupAlg.get(),\n      this.setupAnchor.get(),\n      this.twistySceneModel.stickeringRequest.get(),\n      this.twistySceneModel.twistyPlayerModel.title.get(),\n    ]);\n\n    const isExplorer = viewerLink === \"experimental-twizzle-explorer\";\n\n    const url = new URL(\n      `https://alpha.twizzle.net/${isExplorer ? \"explore\" : \"edit\"}/`,\n    );\n\n    if (!alg.alg.experimentalIsEmpty()) {\n      url.searchParams.set(\"alg\", alg.alg.toString());\n    }\n    if (!setup.alg.experimentalIsEmpty()) {\n      url.searchParams.set(\"setup-alg\", setup.alg.toString());\n    }\n    if (anchor !== \"start\") {\n      url.searchParams.set(\"setup-anchor\", anchor);\n    }\n    if (\n      experimentalStickeringRequest !== \"full\" &&\n      experimentalStickeringRequest !== null\n    ) {\n      url.searchParams.set(\n        \"experimental-stickering\",\n        experimentalStickeringRequest,\n      );\n    }\n    if (isExplorer && puzzleDescription !== NO_VALUE) {\n      url.searchParams.set(\"puzzle-description\", puzzleDescription);\n    } else if (puzzleID !== \"3x3x3\") {\n      url.searchParams.set(\"puzzle\", puzzleID);\n    }\n    if (experimentalTitle) {\n      url.searchParams.set(\"title\", experimentalTitle);\n    }\n    return url.toString();\n  }\n\n  experimentalAddAlgLeaf(algLeaf: AlgLeaf, options?: AppendOptions): void {\n    const maybeMove = algLeaf.as(Move);\n    if (maybeMove) {\n      this.experimentalAddMove(maybeMove, options);\n    } else {\n      this.alg.set(\n        (async () => {\n          const alg = (await this.alg.get()).alg;\n          const newAlg = alg.concat(new Alg([algLeaf]));\n          this.timestampRequest.set(\"end\");\n          return newAlg;\n        })(),\n      );\n    }\n  }\n\n  // TODO: Animate the new move.\n  experimentalAddMove(\n    flexibleMove: Move | string,\n    options?: Without<\n      AppendOptions,\n      [\"puzzleLoader\", \"puzzleSpecificSimplifyOptions\"] // TODO: figure out how to modify `AppendOptions` to accommodate this (or just accept cancel options for now?)\n    >,\n  ): void {\n    const move =\n      typeof flexibleMove === \"string\" ? new Move(flexibleMove) : flexibleMove;\n    this.alg.set(\n      (async () => {\n        const [{ alg }, puzzleLoader] = await Promise.all([\n          this.alg.get(),\n          this.puzzleLoader.get(),\n        ]);\n        const newAlg = experimentalAppendMove(alg, move, {\n          ...options,\n          ...(await getPartialAppendOptionsForPuzzleSpecificSimplifyOptions(\n            puzzleLoader,\n          )),\n        });\n        this.timestampRequest.set(\"end\");\n        this.catchUpMove.set({\n          move: move,\n          amount: 0,\n        });\n        return newAlg;\n      })(),\n    );\n  }\n\n  // TODO: allow more than 1?\n  experimentalRemoveFinalChild(): void {\n    this.alg.set(\n      (async () => {\n        const alg = (await this.alg.get()).alg;\n        const children = Array.from(alg.childAlgNodes());\n        const [finalChild] = children.splice(-1);\n        if (!finalChild) {\n          return alg;\n        }\n        this.timestampRequest.set(\"end\");\n        const finalChildMove = finalChild.as(Move);\n        if (finalChildMove) {\n          this.catchUpMove.set({\n            move: finalChildMove.invert(),\n            amount: 0,\n          });\n        }\n        return new Alg(children);\n      })(),\n    );\n  }\n}\n", "import type { Alg, AppendCancelOptions } from \"../../alg\";\nimport type { PuzzleDescriptionString } from \"../../puzzle-geometry/PGPuzzles\";\nimport type { StickeringMask } from \"../../puzzles/stickerings/mask\";\nimport type { ExperimentalStickering, PuzzleID } from \"../../twisty\";\nimport type { MillisecondTimestamp } from \"../controllers/AnimationTypes\";\nimport type { FaceletScale } from \"../model/props/puzzle/display/FaceletScaleProp\";\nimport type { HintFaceletStyleWithAuto } from \"../model/props/puzzle/display/HintFaceletProp\";\nimport type { InitialHintFaceletsAnimation } from \"../model/props/puzzle/display/InitialHintFaceletsAnimationProp\";\nimport type { DragInputMode } from \"../model/props/puzzle/state/DragInputProp\";\nimport type { IndexerStrategyName } from \"../model/props/puzzle/state/IndexerConstructorRequestProp\";\nimport type { MovePressInput } from \"../model/props/puzzle/state/MovePressInputProp\";\nimport type { SetupToLocation } from \"../model/props/puzzle/state/SetupAnchorProp\";\nimport type { TimestampRequest } from \"../model/props/timeline/TimestampRequestProp\";\nimport type { BackgroundThemeWithAuto } from \"../model/props/viewer/BackgroundProp\";\nimport type { BackViewLayoutWithAuto } from \"../model/props/viewer/BackViewProp\";\nimport type { ControlPanelThemeWithAuto } from \"../model/props/viewer/ControlPanelProp\";\nimport type { DarkModeThemeWithAuto } from \"../model/props/viewer/DarkModeRequestProp\";\nimport type { ViewerLinkPageWithAuto } from \"../model/props/viewer/ViewerLinkProp\";\nimport type { VisualizationFormatWithAuto } from \"../model/props/viewer/VisualizationProp\";\nimport { TwistyPlayerModel } from \"../model/TwistyPlayerModel\";\nimport { ManagedCustomElement } from \"./ManagedCustomElement\";\n\nfunction err(propName: string): Error {\n  return new Error(\n    `Cannot get \\`.${propName}\\` directly from a \\`TwistyPlayer\\`.`,\n  );\n}\n\nexport abstract class TwistyPlayerSettable extends ManagedCustomElement {\n  experimentalModel: TwistyPlayerModel = new TwistyPlayerModel();\n\n  set alg(newAlg: Alg | string) {\n    this.experimentalModel.alg.set(newAlg);\n  }\n  get alg(): never {\n    throw err(\"alg\");\n  }\n\n  set experimentalSetupAlg(newSetup: Alg | string) {\n    this.experimentalModel.setupAlg.set(newSetup);\n  }\n  get experimentalSetupAlg(): never {\n    throw err(\"setup\");\n  }\n\n  set experimentalSetupAnchor(anchor: SetupToLocation) {\n    this.experimentalModel.setupAnchor.set(anchor);\n  }\n  get experimentalSetupAnchor(): never {\n    throw err(\"anchor\");\n  }\n\n  set puzzle(puzzleID: PuzzleID) {\n    this.experimentalModel.puzzleIDRequest.set(puzzleID);\n  }\n  get puzzle(): never {\n    throw err(\"puzzle\");\n  }\n\n  set experimentalPuzzleDescription(puzzleDescription: PuzzleDescriptionString) {\n    this.experimentalModel.puzzleDescriptionRequest.set(puzzleDescription);\n  }\n  get experimentalPuzzleDescription(): never {\n    throw err(\"experimentalPuzzleDescription\");\n  }\n\n  set timestamp(timestamp: TimestampRequest) {\n    this.experimentalModel.timestampRequest.set(timestamp);\n  }\n  get timestamp(): never {\n    throw err(\"timestamp\");\n  }\n\n  set hintFacelets(hintFaceletStyle: HintFaceletStyleWithAuto) {\n    this.experimentalModel.twistySceneModel.hintFacelet.set(hintFaceletStyle);\n  }\n  get hintFacelets(): never {\n    throw err(\"hintFacelets\");\n  }\n\n  set experimentalStickering(stickering: ExperimentalStickering) {\n    this.experimentalModel.twistySceneModel.stickeringRequest.set(stickering);\n  }\n  get experimentalStickering(): never {\n    throw err(\"experimentalStickering\");\n  }\n\n  set experimentalStickeringMaskOrbits(stickeringMask:\n    | string\n    | StickeringMask) {\n    this.experimentalModel.twistySceneModel.stickeringMaskRequest.set(\n      stickeringMask,\n    );\n  }\n  get experimentalStickeringMaskOrbits(): never {\n    throw err(\"experimentalStickeringMaskOrbits\");\n  }\n\n  set experimentalFaceletScale(faceletScale: FaceletScale) {\n    this.experimentalModel.twistySceneModel.faceletScale.set(faceletScale);\n  }\n\n  get experimentalFaceletScale(): never {\n    throw err(\"experimentalFaceletScale\");\n  }\n\n  set backView(backView: BackViewLayoutWithAuto) {\n    this.experimentalModel.backView.set(backView);\n  }\n  get backView(): never {\n    throw err(\"backView\");\n  }\n\n  set background(backgroundTheme: BackgroundThemeWithAuto) {\n    this.experimentalModel.twistySceneModel.background.set(backgroundTheme);\n  }\n  get background(): never {\n    throw err(\"background\");\n  }\n\n  set darkMode(darkMode: DarkModeThemeWithAuto) {\n    this.experimentalModel.twistySceneModel.darkModeRequest.set(darkMode);\n  }\n  get darkMode(): never {\n    throw err(\"darkMode\");\n  }\n\n  set controlPanel(newControlPanel: ControlPanelThemeWithAuto) {\n    this.experimentalModel.controlPanel.set(newControlPanel);\n  }\n  get controlPanel(): never {\n    throw err(\"controlPanel\");\n  }\n\n  set visualization(visualizationFormat: VisualizationFormatWithAuto) {\n    this.experimentalModel.visualizationFormat.set(visualizationFormat);\n  }\n  get visualization(): never {\n    throw err(\"visualization\");\n  }\n\n  set experimentalTitle(title: string | null) {\n    this.experimentalModel.title.set(title);\n  }\n  get experimentalTitle(): never {\n    throw err(\"experimentalTitle\");\n  }\n\n  set experimentalVideoURL(videoURL: string | null) {\n    this.experimentalModel.videoURL.set(videoURL);\n  }\n  get experimentalVideoURL(): never {\n    throw err(\"experimentalVideoURL\");\n  }\n\n  set experimentalCompetitionID(competitionID: string | null) {\n    this.experimentalModel.competitionID.set(competitionID);\n  }\n  get experimentalCompetitionID(): never {\n    throw err(\"experimentalCompetitionID\");\n  }\n\n  set viewerLink(viewerLinkPage: ViewerLinkPageWithAuto) {\n    this.experimentalModel.viewerLink.set(viewerLinkPage);\n  }\n  get viewerLink(): never {\n    throw err(\"viewerLink\");\n  }\n\n  set experimentalMovePressInput(movePressInput: MovePressInput) {\n    this.experimentalModel.twistySceneModel.movePressInput.set(movePressInput);\n  }\n  get experimentalMovePressInput(): never {\n    throw err(\"experimentalMovePressInput\");\n  }\n\n  set experimentalMovePressCancelOptions(movePressCancelOptions: AppendCancelOptions) {\n    this.experimentalModel.twistySceneModel.movePressCancelOptions.set(\n      movePressCancelOptions,\n    );\n  }\n  get experimentalMovePressCancelOptions(): never {\n    throw err(\"experimentalMovePressCancelOptions\");\n  }\n\n  set cameraLatitude(latitude: number) {\n    this.experimentalModel.twistySceneModel.orbitCoordinatesRequest.set({\n      latitude,\n    });\n  }\n  get cameraLatitude(): never {\n    throw err(\"cameraLatitude\");\n  }\n\n  set cameraLongitude(longitude: number) {\n    this.experimentalModel.twistySceneModel.orbitCoordinatesRequest.set({\n      longitude,\n    });\n  }\n  get cameraLongitude(): never {\n    throw err(\"cameraLongitude\");\n  }\n\n  set cameraDistance(distance: number) {\n    this.experimentalModel.twistySceneModel.orbitCoordinatesRequest.set({\n      distance,\n    });\n  }\n  get cameraDistance(): never {\n    throw err(\"cameraDistance\");\n  }\n\n  set cameraLatitudeLimit(latitudeLimit: number) {\n    this.experimentalModel.twistySceneModel.latitudeLimit.set(latitudeLimit);\n  }\n  get cameraLatitudeLimit(): never {\n    throw err(\"cameraLatitudeLimit\");\n  }\n\n  set indexer(indexer: IndexerStrategyName) {\n    this.experimentalModel.indexerConstructorRequest.set(indexer);\n  }\n  get indexer(): never {\n    throw err(\"indexer\");\n  }\n\n  set tempoScale(newTempoScale: number) {\n    this.experimentalModel.tempoScale.set(newTempoScale);\n  }\n  get tempoScale(): never {\n    throw err(\"tempoScale\");\n  }\n\n  set experimentalSprite(url: string | URL) {\n    this.experimentalModel.twistySceneModel.foundationStickerSpriteURL.set(url);\n  }\n  get experimentalSprite(): never {\n    throw err(\"experimentalSprite\");\n  }\n\n  set experimentalHintSprite(url: string | URL) {\n    this.experimentalModel.twistySceneModel.hintStickerSpriteURL.set(url);\n  }\n  get experimentalHintSprite(): never {\n    throw err(\"experimentalHintSprite\");\n  }\n\n  set fullscreenElement(element: Element | null) {\n    this.experimentalModel.twistySceneModel.fullscreenElement.set(element);\n  }\n  get fullscreenElement(): never {\n    throw err(\"fullscreenElement\");\n  }\n\n  set experimentalInitialHintFaceletsAnimation(anim: InitialHintFaceletsAnimation) {\n    this.experimentalModel.twistySceneModel.initialHintFaceletsAnimation.set(\n      anim,\n    );\n  }\n  get experimentalInitialHintFaceletsAnimation(): never {\n    throw err(\"experimentalInitialHintFaceletsAnimation\");\n  }\n\n  set experimentalDragInput(dragInputMode: DragInputMode) {\n    this.experimentalModel.twistySceneModel.dragInput.set(dragInputMode);\n  }\n  get experimentalDragInput(): never {\n    throw err(\"experimentalDragInput\");\n  }\n\n  experimentalGet = new ExperimentalGetters(this.experimentalModel);\n}\n\nclass ExperimentalGetters {\n  constructor(private model: TwistyPlayerModel) {}\n\n  async alg(): Promise<Alg> {\n    return (await this.model.alg.get()).alg;\n  }\n\n  async setupAlg(): Promise<Alg> {\n    return (await this.model.setupAlg.get()).alg;\n  }\n\n  puzzleID(): Promise<PuzzleID> {\n    return this.model.puzzleID.get();\n  }\n\n  async timestamp(): Promise<MillisecondTimestamp> {\n    return (await this.model.detailedTimelineInfo.get()).timestamp;\n  }\n}\n", "import type { Object3D } from \"three\";\nimport type { ExperimentalStickering } from \"..\";\nimport type { Alg, Move } from \"../../alg\";\nimport type { AlgLeaf } from \"../../alg/alg-nodes/AlgNode\";\nimport type { AppendCancelOptions, AppendOptions } from \"../../alg/simplify\";\nimport type { PuzzleDescriptionString } from \"../../puzzle-geometry/PGPuzzles\";\nimport type { ExperimentalStickeringMask } from \"../../puzzles/cubing-private\";\nimport { RenderScheduler } from \"../controllers/RenderScheduler\";\nimport type { TwistyAnimationControllerDelegate } from \"../controllers/TwistyAnimationController\";\nimport { TwistyPlayerController } from \"../controllers/TwistyPlayerController\";\nimport type { HintFaceletStyleWithAuto } from \"../model/props/puzzle/display/HintFaceletProp\";\nimport type { InitialHintFaceletsAnimation } from \"../model/props/puzzle/display/InitialHintFaceletsAnimationProp\";\nimport type { DragInputMode } from \"../model/props/puzzle/state/DragInputProp\";\nimport type { MovePressInput } from \"../model/props/puzzle/state/MovePressInputProp\";\nimport type { SetupToLocation } from \"../model/props/puzzle/state/SetupAnchorProp\";\nimport type { PuzzleID } from \"../model/props/puzzle/structure/PuzzleIDRequestProp\";\nimport type { BackgroundThemeWithAuto } from \"../model/props/viewer/BackgroundProp\";\nimport type { BackViewLayoutWithAuto } from \"../model/props/viewer/BackViewProp\";\nimport {\n  ControlPanelThemeWithAuto,\n  controlsLocations,\n} from \"../model/props/viewer/ControlPanelProp\";\nimport type {\n  DarkModeTheme,\n  DarkModeThemeWithAuto,\n} from \"../model/props/viewer/DarkModeRequestProp\";\nimport type { ViewerLinkPageWithAuto } from \"../model/props/viewer/ViewerLinkProp\";\nimport type { VisualizationFormatWithAuto } from \"../model/props/viewer/VisualizationProp\";\nimport type { VisualizationStrategy } from \"../model/props/viewer/VisualizationStrategyProp\";\nimport { Twisty2DSceneWrapper } from \"./2D/Twisty2DSceneWrapper\";\nimport type { Twisty3DPuzzle } from \"./3D/puzzles/Twisty3DPuzzle\";\nimport { Twisty3DSceneWrapper } from \"./3D/Twisty3DSceneWrapper\";\nimport type { Twisty3DVantage } from \"./3D/Twisty3DVantage\";\nimport { ClassListManager } from \"./ClassListManager\";\nimport { TwistyButtons } from \"./control-panel/TwistyButtons\";\nimport { TwistyScrubber } from \"./control-panel/TwistyScrubber\";\nimport { InitialValueTracker } from \"./InitialValueTracker\";\nimport { customElementsShim } from \"./node-custom-element-shims\";\nimport { downloadURL, getDefaultFilename, screenshot } from \"./screenshot\";\nimport { twistyPlayerCSS } from \"./TwistyPlayer.css\";\nimport { TwistyPlayerSettable } from \"./TwistyPlayerSettable\";\n\nconst DATA_ATTRIBUTE_PREFIX = \"data-\";\n\n// TODO: I couldn't figure out how to use use more specific types. Ideally, we'd\n// enforce consistency with the model.\nexport const twistyPlayerAttributeMap = {\n  // TODO: We assume each of these can be set using a string or will be automatically converted by JS (e.g. numbers). Can we enforce\n  // that with types? Do we need to add a translation mechanism for things we\n  // don't want to leave settable as strings?\n  // TODO: Enum validation.\n\n  // Alg\n  alg: \"alg\",\n  \"experimental-setup-alg\": \"experimentalSetupAlg\",\n\n  // String-based\n  \"experimental-setup-anchor\": \"experimentalSetupAnchor\",\n  puzzle: \"puzzle\",\n  \"experimental-puzzle-description\": \"experimentalPuzzleDescription\",\n  visualization: \"visualization\",\n  \"hint-facelets\": \"hintFacelets\",\n  \"experimental-stickering\": \"experimentalStickering\",\n  \"experimental-stickering-mask-orbits\": \"experimentalStickeringMaskOrbits\",\n  background: \"background\",\n  \"dark-mode\": \"darkMode\",\n  \"control-panel\": \"controlPanel\",\n  \"back-view\": \"backView\",\n  \"experimental-initial-hint-facelets-animation\":\n    \"experimentalInitialHintFaceletsAnimation\",\n  // \"indexer\": \"indexer\",\n  \"viewer-link\": \"viewerLink\",\n  \"experimental-move-press-input\": \"experimentalMovePressInput\",\n  \"experimental-drag-input\": \"experimentalDragInput\",\n\n  // Metadata\n  \"experimental-title\": \"experimentalTitle\",\n  \"experimental-video-url\": \"experimentalVideoURL\",\n  \"experimental-competition-id\": \"experimentalCompetitionID\",\n\n  // Number-based\n  \"camera-latitude\": \"cameraLatitude\",\n  \"camera-longitude\": \"cameraLongitude\",\n  \"camera-distance\": \"cameraDistance\",\n  \"camera-latitude-limit\": \"cameraLatitudeLimit\",\n  \"tempo-scale\": \"tempoScale\",\n\n  // URL-based\n  \"experimental-sprite\": \"experimentalSprite\",\n  \"experimental-hint-sprite\": \"experimentalHintSprite\",\n};\n\nexport type TwistyPlayerAttribute = keyof typeof twistyPlayerAttributeMap;\n\nconst configKeys: Record<TwistyPlayerAttribute, true> = Object.fromEntries(\n  Object.values(twistyPlayerAttributeMap).map((s) => [s, true]),\n) as any;\n\n// TODO: Find a way to share this def with `attributeMap`.\n/**\n * The config argument passed to {@link TwistyPlayer} when calling the\n * constructor. This interface type be useful for avoiding bugs when you would\n * like to create a {@link TwistyPlayer} using a dynamic config, or by combining\n * configs.\n *\n * ```js\n * import { TwistyPlayer, type TwistyPlayerConfig } from \"cubing/twisty\";\n *\n * const MY_DEFAULT_CONFIG: TwistyPlayerConfig = {\n *   puzzle: \"megaminx\",\n *   alg: \"R U R'\"\n * };\n * export function createTwistyPlayer(overrideConfig: TwistyPlayerConfig) {\n *   const options = { ...MY_DEFAULT_CONFIG, ...overrideConfig };\n *   return new TwistyPlayer(options);\n * }\n *\n * // Example: if the current page is https://alpha.twizzle.net/edit/?alg=M2+E2+S2\n * // then this gives us the \"alg\" param value \"M2 E2 S2\".\n * const myOverrideConfig: TwistyPlayerConfig = {};\n * const algParam = new URL(location.href).searchParams.get(\"alg\");\n * if (algParam) {\n *   myOverrideConfig.alg = algParam;\n * }\n * createTwistyPlayer(myOverrideConfig);\n * ```\n *\n * @category TwistyPlayer\n */\nexport interface TwistyPlayerConfig {\n  // Alg\n  alg?: Alg | string;\n  experimentalSetupAlg?: Alg | string;\n  // String-based\n  experimentalSetupAnchor?: SetupToLocation; // TODO: \"auto\"\n  puzzle?: PuzzleID;\n  experimentalPuzzleDescription?: PuzzleDescriptionString;\n  visualization?: VisualizationFormatWithAuto;\n  hintFacelets?: HintFaceletStyleWithAuto;\n  experimentalStickering?: ExperimentalStickering;\n  experimentalStickeringMaskOrbits?: ExperimentalStickeringMask | string;\n  background?: BackgroundThemeWithAuto;\n  darkMode?: DarkModeThemeWithAuto;\n  controlPanel?: ControlPanelThemeWithAuto;\n  backView?: BackViewLayoutWithAuto;\n  experimentalInitialHintFaceletsAnimation?: InitialHintFaceletsAnimation;\n  // \"indexer\"?: \"indexer\";\n  viewerLink?: ViewerLinkPageWithAuto;\n  experimentalMovePressInput?: MovePressInput;\n  experimentalDragInput?: DragInputMode;\n  // Metadata\n  experimentalTitle?: string | null;\n  experimentalVideoURL?: string;\n  experimentalCompetitionID?: string;\n  // Number-based\n  cameraLatitude?: number;\n  cameraLongitude?: number;\n  cameraDistance?: number;\n  cameraLatitudeLimit?: number;\n  tempoScale?: number;\n  // URL-based\n  experimentalSprite?: string | null;\n  experimentalHintSprite?: string | null;\n  // TODO: Not supported as attributes\n  experimentalMovePressCancelOptions?: AppendCancelOptions; // TODO: Support setting via a simplified attribute enum?\n}\n\nconst propOnly: Record<string, boolean> = {\n  experimentalMovePressCancelOptions: true,\n};\n\n/**\n * TwistyPlayer is the heart of `cubing.js`. It can be used to display a puzzle on a web page like this:\n *\n *     <script src=\"path/to/cubing/twisty\" type=\"module\"></script>\n *     <twisty-player alg=\"R U R'\"></twisty-player>\n *\n * You can also construct it directly in JavaScript:\n *\n * ```js\n * import { TwistyPlayer } from \"cubing/twisty\";\n * const twistyPlayer = new TwistyPlayer({alg: \"R U R'\"});\n * // Once the page has loaded, you can do this:\n * document.body.appendChild(twistyPlayer);\n * ```\n *\n * See {@link https://js.cubing.net/cubing/} for more examples.\n *\n * @category TwistyPlayer\n */\nexport class TwistyPlayer\n  extends TwistyPlayerSettable\n  implements TwistyAnimationControllerDelegate\n{\n  controller: TwistyPlayerController = new TwistyPlayerController(\n    this.experimentalModel,\n    this,\n  );\n\n  buttons: TwistyButtons;\n\n  experimentalCanvasClickCallback: (...args: any) => void = () => {};\n  // #onCanvasClick() {\n\n  // }\n\n  constructor(config: TwistyPlayerConfig = {}) {\n    super();\n\n    // TODO: double-check that these are all getting set sync without causing extra work.\n    for (const [propName, value] of Object.entries(config)) {\n      if (\n        !(configKeys[propName as TwistyPlayerAttribute] || propOnly[propName])\n      ) {\n        console.warn(`Invalid config passed to TwistyPlayer: ${propName}`);\n        break;\n      }\n      (this as any)[propName] = value;\n    }\n  }\n\n  #controlsManager: ClassListManager<ControlPanelThemeWithAuto> =\n    new ClassListManager<ControlPanelThemeWithAuto>(\n      this,\n      \"controls-\",\n      ([\"auto\"] as ControlPanelThemeWithAuto[]).concat(\n        Object.keys(controlsLocations) as ControlPanelThemeWithAuto[],\n      ),\n    );\n\n  #visualizationWrapperElem = document.createElement(\"div\"); // TODO: Better pattern.\n  #errorElem = document.createElement(\"div\"); // TODO: Better pattern.\n  #alreadyConnected = false; // TODO: support resetting\n  async connectedCallback(): Promise<void> {\n    if (this.#alreadyConnected) {\n      return;\n    }\n    this.#alreadyConnected = true;\n    this.addCSS(twistyPlayerCSS);\n\n    this.addElement(this.#visualizationWrapperElem).classList.add(\n      \"visualization-wrapper\",\n    );\n    this.addElement(this.#errorElem).classList.add(\"error-elem\");\n    this.#errorElem.textContent = \"Error\";\n    this.experimentalModel.userVisibleErrorTracker.addFreshListener(\n      (userVisibleError) => {\n        const errorString: string | null = userVisibleError.errors[0] ?? null;\n        this.contentWrapper.classList.toggle(\"error\", !!errorString);\n        if (errorString) {\n          this.#errorElem.textContent = errorString;\n        }\n      },\n    );\n\n    const scrubber = new TwistyScrubber(\n      this.experimentalModel,\n      this.controller,\n    );\n    this.contentWrapper.appendChild(scrubber);\n\n    this.buttons = new TwistyButtons(\n      this.experimentalModel,\n      this.controller,\n      this,\n    );\n    this.contentWrapper.appendChild(this.buttons);\n\n    this.experimentalModel.twistySceneModel.background.addFreshListener(\n      (backgroundTheme: BackgroundThemeWithAuto) => {\n        this.contentWrapper.classList.toggle(\n          \"checkered\",\n          [\"auto\", \"checkered\"].includes(backgroundTheme),\n        );\n        this.contentWrapper.classList.toggle(\n          \"checkered-transparent\",\n          backgroundTheme === \"checkered-transparent\",\n        );\n      },\n    );\n\n    this.experimentalModel.twistySceneModel.darkMode.addFreshListener(\n      (darkModeTheme: DarkModeTheme) => {\n        this.contentWrapper.classList.toggle(\n          \"dark-mode\",\n          [\"dark\"].includes(darkModeTheme),\n        );\n      },\n    );\n\n    this.experimentalModel.controlPanel.addFreshListener(\n      (controlPanel: ControlPanelThemeWithAuto) => {\n        this.#controlsManager.setValue(controlPanel);\n      },\n    );\n\n    this.experimentalModel.visualizationStrategy.addFreshListener(\n      this.#setVisualizationWrapper.bind(this),\n    );\n\n    this.experimentalModel.puzzleID.addFreshListener(this.flash.bind(this));\n  }\n\n  #flashLevel: \"auto\" | \"none\" = \"auto\";\n  /** @deprecated */\n  experimentalSetFlashLevel(newLevel: \"auto\" | \"none\"): void {\n    this.#flashLevel = newLevel;\n  }\n\n  flash() {\n    if (this.#flashLevel === \"auto\") {\n      this.#visualizationWrapper?.animate([{ opacity: 0.25 }, { opacity: 1 }], {\n        duration: 250,\n        easing: \"ease-out\",\n      });\n    }\n  }\n\n  #visualizationWrapper: Twisty2DSceneWrapper | Twisty3DSceneWrapper | null =\n    null;\n  #initial3DVisualizationWrapper =\n    new InitialValueTracker<Twisty3DSceneWrapper>();\n\n  #visualizationStrategy: VisualizationStrategy | null = null;\n  #setVisualizationWrapper(strategy: VisualizationStrategy): void {\n    if (strategy !== this.#visualizationStrategy) {\n      this.#visualizationWrapper?.remove();\n      this.#visualizationWrapper?.disconnect();\n      let newWrapper: Twisty2DSceneWrapper | Twisty3DSceneWrapper;\n      switch (strategy) {\n        case \"2D\":\n        case \"experimental-2D-LL\": {\n          newWrapper = new Twisty2DSceneWrapper(\n            this.experimentalModel.twistySceneModel,\n            strategy,\n          );\n          break;\n        }\n        case \"Cube3D\":\n        case \"PG3D\": {\n          // TODO: Properly wire this up so we can set PG3D for the cube.\n          newWrapper = new Twisty3DSceneWrapper(this.experimentalModel);\n          this.#initial3DVisualizationWrapper.handleNewValue(newWrapper);\n          break;\n        }\n        default:\n          throw new Error(\"Invalid visualization\");\n      }\n      this.#visualizationWrapperElem.appendChild(newWrapper);\n      this.#visualizationWrapper = newWrapper;\n      this.#visualizationStrategy = strategy;\n    }\n  }\n\n  async experimentalCurrentVantages(): Promise<Iterable<Twisty3DVantage>> {\n    this.connectedCallback();\n    const wrapper = this.#visualizationWrapper;\n    if (wrapper instanceof Twisty3DSceneWrapper) {\n      return wrapper.experimentalVantages();\n    }\n    return [];\n  }\n\n  async experimentalCurrentCanvases(): Promise<HTMLCanvasElement[]> {\n    const vantages = await this.experimentalCurrentVantages();\n    const canvases: HTMLCanvasElement[] = [];\n    for (const vantage of vantages) {\n      canvases.push((await vantage.canvasInfo()).canvas);\n    }\n    return canvases;\n  }\n\n  /**\n   * Get the first available puzzle `Object3D`. This can be inserted into\n   * another `three.js` scene, essentially \"adopting\" it from the\n   * `TwistyPlayer`'s scenes while still allowing the `TwistyPlayer` to animate\n   * it. The function returns a `Promise` that returns if and when the\n   * `Object3D` is available, and accepts a callback that is called whenever a\n   * render is scheduled for the puzzle (essentially, if something about the\n   * puzzle has changed, like its appearance or current animated state).\n   *\n   * Note:\n   * - This may never resolve if the player never creates the relevant 3D object\n   *   under the hood (e.g. if the config is set to 2D, or is not valid for\n   *   rendering a puzzle)\n   * - The architecture of `cubing.js` may change significantly, so it is not\n   *   guaranteed that a `three.js` `Object3D` will be available from the main\n   *   thread in the future.\n   * - This function only returns the current `three.js` puzzle object (once one\n   *   exists). If you change e.g. the `puzzle` config for the player, then the\n   *   object will currently become stale. This may be replaced with more\n   *   convenient behaviour in the future.\n   *\n   * @deprecated */\n  async experimentalCurrentThreeJSPuzzleObject(\n    puzzleRenderScheduledCallback?: () => void,\n  ): Promise<Object3D> {\n    this.connectedCallback();\n    const sceneWrapper = await this.#initial3DVisualizationWrapper.promise;\n    const puzzleWrapper =\n      await sceneWrapper.experimentalTwisty3DPuzzleWrapper();\n    const twisty3DPuzzlePromise: Promise<Twisty3DPuzzle> =\n      puzzleWrapper.twisty3DPuzzle();\n    const safeToCallback = (async () => {\n      await twisty3DPuzzlePromise;\n      await new Promise((resolve) => setTimeout(resolve, 0));\n    })();\n    if (puzzleRenderScheduledCallback) {\n      // We want to notify the callback when the render is *scheduled* (once per\n      // render), not when it is run. So we have a stub callback for the\n      // scheduler itself, and rely on `scheduler.requestIsPending()` to dedup\n      // requests below.\n      const scheduler = new RenderScheduler(async () => {});\n      puzzleWrapper.addEventListener(\"render-scheduled\", async () => {\n        if (!scheduler.requestIsPending()) {\n          scheduler.requestAnimFrame();\n          await safeToCallback;\n          puzzleRenderScheduledCallback();\n        }\n      });\n    }\n    return twisty3DPuzzlePromise;\n  }\n\n  jumpToStart(options?: { flash: boolean }): void {\n    this.controller.jumpToStart(options);\n  }\n\n  jumpToEnd(options?: { flash: boolean }): void {\n    this.controller.jumpToEnd(options);\n  }\n\n  play(): void {\n    this.controller.togglePlay(true);\n  }\n\n  pause(): void {\n    this.controller.togglePlay(false);\n  }\n\n  // Inspiration:\n  // - https://developer.mozilla.org/en-US/docs/Web/API/Element/toggleAttribute (`force` argument)\n  // - https://developer.mozilla.org/en-US/docs/Web/API/DOMTokenList/toggle (`force` argument)\n  // We still provide `play()` and `pause()` individually for convenience, though.\n  togglePlay(play?: boolean): void {\n    this.controller.togglePlay(play);\n  }\n\n  // TODO: Animate the new move.\n  // TODO: Automatically handle puzzle.\n  experimentalAddMove(\n    flexibleMove: Move | string,\n    options?: AppendOptions,\n  ): void {\n    this.experimentalModel.experimentalAddMove(flexibleMove, options);\n  }\n\n  // TODO: Animate the new move.\n  // TODO: Automatically handle puzzle.\n  experimentalAddAlgLeaf(algLeaf: AlgLeaf, options?: AppendOptions): void {\n    this.experimentalModel.experimentalAddAlgLeaf(algLeaf, options);\n  }\n\n  static get observedAttributes(): string[] {\n    const observed: string[] = [];\n    for (const key of Object.keys(twistyPlayerAttributeMap)) {\n      observed.push(key, DATA_ATTRIBUTE_PREFIX + key);\n    }\n    return observed;\n  }\n\n  experimentalRemoveFinalChild(): void {\n    this.experimentalModel.experimentalRemoveFinalChild();\n  }\n\n  attributeChangedCallback(\n    attributeName: string,\n    _oldValue: string,\n    newValue: string,\n  ): void {\n    if (attributeName.startsWith(DATA_ATTRIBUTE_PREFIX)) {\n      attributeName = attributeName.slice(DATA_ATTRIBUTE_PREFIX.length);\n    }\n    const setterName =\n      twistyPlayerAttributeMap[attributeName as TwistyPlayerAttribute];\n    if (!setterName) {\n      return;\n    }\n\n    (this as any)[setterName] = newValue;\n  }\n\n  // TODO: Make this more ergonomic and flexible.\n  // TODO: dimensions.\n  async experimentalScreenshot(options?: {\n    width: number;\n    height: number;\n  }): Promise<string> {\n    return (await screenshot(this.experimentalModel, options)).dataURL;\n  }\n\n  // TODO: Make this more ergonomic and flexible.\n  // TODO: dimensions.\n  async experimentalDownloadScreenshot(filename?: string): Promise<void> {\n    if (\n      [\"2D\", \"experimental-2D-LL\"].includes(\n        await this.experimentalModel.visualizationStrategy.get(),\n      )\n    ) {\n      // TODO: This has lots of async issues. It should also go into the screenshot impl file.\n      const wrapper2D = this.#visualizationWrapper as Twisty2DSceneWrapper;\n      const twisty2DPuzzle = await wrapper2D\n        .currentTwisty2DPuzzleWrapper()!\n        .twisty2DPuzzle();\n      const str = new XMLSerializer().serializeToString(\n        twisty2DPuzzle.svgWrapper.svgElement,\n      );\n      const url = URL.createObjectURL(new Blob([str]));\n      downloadURL(\n        url,\n        filename ?? (await getDefaultFilename(this.experimentalModel)),\n        \"svg\",\n      );\n    } else {\n      await (await screenshot(this.experimentalModel)).download(filename);\n    }\n  }\n}\n\ncustomElementsShim.define(\"twisty-player\", TwistyPlayer);\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"twisty-player\": TwistyPlayer;\n  }\n}\n", "import { CSSSource } from \"./ManagedCustomElement\";\n\nexport const twistyAlgViewerCSS = new CSSSource(\n  `\n:host {\n  display: inline;\n}\n\n.wrapper {\n  display: inline;\n}\n\na:not(:hover) {\n  color: inherit;\n  text-decoration: none;\n}\n\ntwisty-alg-leaf-elem.twisty-alg-comment {\n  color: rgba(0, 0, 0, 0.4);\n}\n\n.wrapper.current-move {\n  background: rgba(66, 133, 244, 0.3);\n  margin-left: -0.1em;\n  margin-right: -0.1em;\n  padding-left: 0.1em;\n  padding-right: 0.1em;\n  border-radius: 0.1em;\n}\n`,\n);\n", "import {\n  Alg,\n  Commutator,\n  Conjugate,\n  Grouping,\n  LineComment,\n  Move,\n  Newline,\n  Pause,\n  TraversalDownUp,\n  AlgNode,\n} from \"../../alg\";\nimport type { Parsed } from \"../../alg/parseAlg\";\nimport type { AlgWithIssues } from \"../model/props/puzzle/state/AlgProp\";\nimport type { DetailedTimelineInfo } from \"../model/props/timeline/DetailedTimelineInfoProp\";\nimport type { MillisecondTimestamp } from \"../controllers/AnimationTypes\";\nimport type { CurrentMoveInfo } from \"../controllers/indexer/AlgIndexer\";\nimport { ManagedCustomElement } from \"./ManagedCustomElement\";\nimport {\n  customElementsShim,\n  HTMLElementShim,\n} from \"./node-custom-element-shims\";\nimport { twistyAlgViewerCSS } from \"./TwistyAlgViewer.css\";\nimport { TwistyPlayer } from \"./TwistyPlayer\";\nimport {\n  experimentalDirect,\n  ExperimentalIterationDirection,\n} from \"../../alg/cubing-private\";\nimport { functionFromTraversal } from \"../../alg\";\n\nconst DEFAULT_OFFSET_MS = 250; // TODO: make this a fraction?\n\nclass DataDown {\n  earliestMoveIndex: number;\n  twistyAlgViewer: TwistyAlgViewer;\n  direction: ExperimentalIterationDirection;\n}\n\nclass DataUp {\n  moveCount: number;\n  element: TwistyAlgWrapperElem | TwistyAlgLeafElem;\n}\n\nclass TwistyAlgLeafElem extends ManagedCustomElement {\n  constructor(\n    className: string,\n    text: string,\n    dataDown: DataDown,\n    public algOrAlgNode: Alg | AlgNode,\n    offsetIntoMove: boolean,\n    clickable: boolean,\n  ) {\n    super({ mode: \"open\" });\n    this.classList.add(className);\n\n    this.addCSS(twistyAlgViewerCSS);\n    if (clickable) {\n      const anchor = this.contentWrapper.appendChild(\n        document.createElement(\"a\"),\n      );\n      anchor.href = \"#\";\n      anchor.textContent = text;\n\n      anchor.addEventListener(\"click\", (e) => {\n        e.preventDefault();\n        dataDown.twistyAlgViewer.jumpToIndex(\n          dataDown.earliestMoveIndex,\n          offsetIntoMove,\n        );\n      });\n    } else {\n      this.contentWrapper.appendChild(\n        document.createElement(\"span\"),\n      ).textContent = text;\n    }\n  }\n\n  pathToIndex(_index: number): (TwistyAlgWrapperElem | TwistyAlgLeafElem)[] {\n    return [];\n  }\n\n  setCurrentMove(current: boolean) {\n    this.contentWrapper.classList.toggle(\"current-move\", current);\n  }\n}\n\ncustomElementsShim.define(\"twisty-alg-leaf-elem\", TwistyAlgLeafElem);\n\nclass TwistyAlgWrapperElem extends HTMLElementShim {\n  private queue: (Element | Text)[] = [];\n\n  constructor(className: string, public algOrAlgNode: Alg | AlgNode) {\n    super();\n    this.classList.add(className);\n  }\n\n  addString(str: string) {\n    this.queue.push(document.createTextNode(str));\n  }\n\n  addElem(dataUp: DataUp): number {\n    this.queue.push(dataUp.element);\n    return dataUp.moveCount;\n  }\n\n  flushQueue(\n    direction: ExperimentalIterationDirection = ExperimentalIterationDirection.Forwards,\n  ): void {\n    for (const node of maybeReverseList(this.queue, direction)) {\n      this.append(node);\n    }\n    this.queue = [];\n  }\n\n  pathToIndex(_index: number): (TwistyAlgWrapperElem | TwistyAlgLeafElem)[] {\n    return [];\n  }\n}\n\ncustomElementsShim.define(\"twisty-alg-wrapper-elem\", TwistyAlgWrapperElem);\n\nfunction oppositeDirection(\n  direction: ExperimentalIterationDirection,\n): ExperimentalIterationDirection {\n  return direction === ExperimentalIterationDirection.Forwards\n    ? ExperimentalIterationDirection.Backwards\n    : ExperimentalIterationDirection.Forwards;\n}\n\nfunction updateDirectionByAmount(\n  currentDirection: ExperimentalIterationDirection,\n  amount: number,\n): ExperimentalIterationDirection {\n  return amount < 0 ? oppositeDirection(currentDirection) : currentDirection;\n}\n\nfunction maybeReverseList<T>(\n  l: T[],\n  direction: ExperimentalIterationDirection,\n): T[] {\n  if (direction === ExperimentalIterationDirection.Forwards) {\n    return l;\n  }\n  // console.log(\"rev\", Array.from(l).reverse());\n  // return Array.from(l).reverse();\n  const copy = Array.from(l);\n  copy.reverse();\n  return copy;\n}\n\nclass AlgToDOMTree extends TraversalDownUp<DataDown, DataUp, DataUp> {\n  public traverseAlg(alg: Alg, dataDown: DataDown): DataUp {\n    let moveCount = 0;\n    const element = new TwistyAlgWrapperElem(\"twisty-alg-alg\", alg); // TODO: pick a better class name.\n    let first = true;\n    for (const algNode of experimentalDirect(\n      alg.childAlgNodes(),\n      dataDown.direction,\n    )) {\n      if (!first) {\n        element.addString(\" \");\n      }\n      first = false;\n      if (algNode.as(Pause)?.experimentalNISSGrouping) {\n        element.addString(\"^(\"); // TODO: Handle this lower down.\n      }\n      // TODO: Handle this check lower down.\n      if (!algNode.as(Grouping)?.experimentalNISSPlaceholder) {\n        moveCount += element.addElem(\n          this.traverseAlgNode(algNode, {\n            earliestMoveIndex: dataDown.earliestMoveIndex + moveCount,\n            twistyAlgViewer: dataDown.twistyAlgViewer,\n            direction: dataDown.direction,\n          }),\n        );\n      }\n      if (algNode.as(Pause)?.experimentalNISSGrouping) {\n        element.addString(\")\"); // TODO: Handle this lower down.\n      }\n    }\n    element.flushQueue(dataDown.direction);\n    return {\n      moveCount: moveCount,\n      element,\n    };\n  }\n\n  public traverseGrouping(grouping: Grouping, dataDown: DataDown): DataUp {\n    const square1Tuple = grouping.experimentalAsSquare1Tuple();\n    // if (square1Tuplle) {\n\n    // }\n\n    const direction = updateDirectionByAmount(\n      dataDown.direction,\n      grouping.amount,\n    );\n    let moveCount = 0;\n    const element = new TwistyAlgWrapperElem(\"twisty-alg-grouping\", grouping);\n    element.addString(\"(\");\n\n    if (square1Tuple) {\n      moveCount += element.addElem({\n        moveCount: 1,\n        element: new TwistyAlgLeafElem(\n          \"twisty-alg-move\", // TODO: Mark the tuple with a special class?\n          square1Tuple[0].amount.toString(),\n          dataDown,\n          square1Tuple[0],\n          true,\n          true,\n        ),\n      });\n      element.addString(\", \");\n      moveCount += element.addElem({\n        moveCount: 1,\n        element: new TwistyAlgLeafElem(\n          \"twisty-alg-move\", // TODO: Mark the tuple with a special class?\n          square1Tuple[1].amount.toString(),\n          dataDown,\n          square1Tuple[1],\n          true,\n          true,\n        ),\n      });\n    } else {\n      moveCount += element.addElem(\n        this.traverseAlg(grouping.alg, {\n          earliestMoveIndex: dataDown.earliestMoveIndex + moveCount,\n          twistyAlgViewer: dataDown.twistyAlgViewer,\n          direction,\n        }),\n      );\n    }\n\n    element.addString(`)${grouping.experimentalRepetitionSuffix}`);\n    element.flushQueue();\n    return {\n      moveCount: moveCount * Math.abs(grouping.amount),\n      element,\n    };\n  }\n\n  public traverseMove(move: Move, dataDown: DataDown): DataUp {\n    const element = new TwistyAlgLeafElem(\n      \"twisty-alg-move\",\n      move.toString(),\n      dataDown,\n      move,\n      true,\n      true,\n    );\n    dataDown.twistyAlgViewer.highlighter.addMove(\n      (move as Parsed<Move>).startCharIndex,\n      element,\n    );\n    return {\n      moveCount: 1,\n      element,\n    };\n  }\n\n  public traverseCommutator(\n    commutator: Commutator,\n    dataDown: DataDown,\n  ): DataUp {\n    let moveCount = 0;\n    const element = new TwistyAlgWrapperElem(\n      \"twisty-alg-commutator\",\n      commutator,\n    );\n    element.addString(\"[\");\n    element.flushQueue();\n    const [first, second]: Alg[] = maybeReverseList(\n      [commutator.A, commutator.B],\n      dataDown.direction,\n    );\n    moveCount += element.addElem(\n      this.traverseAlg(first, {\n        earliestMoveIndex: dataDown.earliestMoveIndex + moveCount,\n        twistyAlgViewer: dataDown.twistyAlgViewer,\n        direction: dataDown.direction,\n      }),\n    );\n    element.addString(\", \");\n    moveCount += element.addElem(\n      this.traverseAlg(second, {\n        earliestMoveIndex: dataDown.earliestMoveIndex + moveCount,\n        twistyAlgViewer: dataDown.twistyAlgViewer,\n        direction: dataDown.direction,\n      }),\n    );\n    element.flushQueue(dataDown.direction);\n    element.addString(\"]\");\n    element.flushQueue();\n    return {\n      moveCount: moveCount * 2,\n      element,\n    };\n  }\n\n  public traverseConjugate(conjugate: Conjugate, dataDown: DataDown): DataUp {\n    let moveCount = 0;\n    const element = new TwistyAlgWrapperElem(\"twisty-alg-conjugate\", conjugate);\n    element.addString(\"[\");\n    const aLen = element.addElem(\n      this.traverseAlg(conjugate.A, {\n        earliestMoveIndex: dataDown.earliestMoveIndex + moveCount,\n        twistyAlgViewer: dataDown.twistyAlgViewer,\n        direction: dataDown.direction,\n      }),\n    );\n    moveCount += aLen;\n    element.addString(\": \");\n    moveCount += element.addElem(\n      this.traverseAlg(conjugate.B, {\n        earliestMoveIndex: dataDown.earliestMoveIndex + moveCount,\n        twistyAlgViewer: dataDown.twistyAlgViewer,\n        direction: dataDown.direction,\n      }),\n    );\n    element.addString(\"]\");\n    element.flushQueue();\n    return {\n      moveCount: moveCount + aLen,\n      element,\n    };\n  }\n\n  public traversePause(pause: Pause, dataDown: DataDown): DataUp {\n    if (pause.experimentalNISSGrouping) {\n      return this.traverseAlg(pause.experimentalNISSGrouping.alg, dataDown);\n    }\n    return {\n      moveCount: 1,\n      element: new TwistyAlgLeafElem(\n        \"twisty-alg-pause\",\n        \".\",\n        dataDown,\n        pause,\n        true,\n        true,\n      ),\n    };\n  }\n\n  public traverseNewline(newline: Newline, _dataDown: DataDown): DataUp {\n    const element = new TwistyAlgWrapperElem(\"twisty-alg-newline\", newline);\n    element.append(document.createElement(\"br\"));\n    return {\n      moveCount: 0,\n      element,\n    };\n  }\n\n  public traverseLineComment(\n    lineComment: LineComment,\n    dataDown: DataDown,\n  ): DataUp {\n    return {\n      moveCount: 0,\n      element: new TwistyAlgLeafElem(\n        \"twisty-alg-line-comment\",\n        `//${lineComment.text}`,\n        dataDown,\n        lineComment,\n        false,\n        false,\n      ),\n    };\n  }\n}\n\nconst algToDOMTree = functionFromTraversal(AlgToDOMTree);\n\nclass MoveHighlighter {\n  moveCharIndexMap: Map<number, TwistyAlgLeafElem> = new Map();\n  currentElem: TwistyAlgLeafElem | null = null;\n\n  addMove(charIndex: number, elem: TwistyAlgLeafElem): void {\n    this.moveCharIndexMap.set(charIndex, elem);\n  }\n\n  set(move: Parsed<Move> | null): void {\n    const newElem = move\n      ? this.moveCharIndexMap.get(move.startCharIndex) ?? null\n      : null;\n    if (this.currentElem === newElem) {\n      return;\n    }\n    this.currentElem?.classList.remove(\"twisty-alg-current-move\");\n    this.currentElem?.setCurrentMove(false);\n    newElem?.classList.add(\"twisty-alg-current-move\");\n    newElem?.setCurrentMove(true);\n    this.currentElem = newElem;\n  }\n}\n\n/** @category Other Custom Elements */\nexport class TwistyAlgViewer extends HTMLElementShim {\n  highlighter: MoveHighlighter = new MoveHighlighter();\n  #domTree: TwistyAlgWrapperElem | TwistyAlgLeafElem;\n  #twistyPlayer: TwistyPlayer | null = null;\n  lastClickTimestamp: number | null = null;\n  constructor(options?: { twistyPlayer?: TwistyPlayer }) {\n    super();\n    if (options?.twistyPlayer) {\n      this.twistyPlayer = options?.twistyPlayer;\n    }\n  }\n\n  protected connectedCallback(): void {\n    // nothing to do?\n  }\n\n  private setAlg(alg: Alg): void {\n    this.#domTree = algToDOMTree(alg, {\n      earliestMoveIndex: 0,\n      twistyAlgViewer: this,\n      direction: ExperimentalIterationDirection.Forwards,\n    }).element;\n    this.textContent = \"\";\n    this.appendChild(this.#domTree);\n  }\n\n  get twistyPlayer(): TwistyPlayer | null {\n    return this.#twistyPlayer;\n  }\n\n  set twistyPlayer(twistyPlayer: TwistyPlayer | null) {\n    this.#setTwistyPlayer(twistyPlayer);\n  }\n\n  async #setTwistyPlayer(twistyPlayer: TwistyPlayer | null) {\n    if (this.#twistyPlayer) {\n      console.warn(\"twisty-player reassignment is not supported\");\n      return;\n    }\n    if (twistyPlayer === null) {\n      throw new Error(\"clearing twistyPlayer is not supported\");\n    }\n    this.#twistyPlayer = twistyPlayer;\n\n    this.#twistyPlayer.experimentalModel.alg.addFreshListener(\n      (algWithIssues: AlgWithIssues) => {\n        this.setAlg(algWithIssues.alg);\n      },\n    );\n\n    const sourceAlg = (await this.#twistyPlayer.experimentalModel.alg.get())\n      .alg;\n    // TODO: Use proper architecture instead of a heuristic to ensure we have a parsed alg annotated with char indices.\n    const parsedAlg =\n      \"startCharIndex\" in (sourceAlg as Partial<Parsed<Alg>>)\n        ? sourceAlg\n        : Alg.fromString(sourceAlg.toString());\n    this.setAlg(parsedAlg);\n\n    twistyPlayer.experimentalModel.currentMoveInfo.addFreshListener(\n      (currentMoveInfo: CurrentMoveInfo) => {\n        let moveInfo = currentMoveInfo.currentMoves[0];\n        moveInfo ??= currentMoveInfo.movesStarting[0];\n        moveInfo ??= currentMoveInfo.movesFinishing[0];\n        if (!moveInfo) {\n          this.highlighter.set(null);\n        } else {\n          const mainCurrentMove = moveInfo.move; // TODO\n          this.highlighter.set(mainCurrentMove as Parsed<Move>);\n        }\n      },\n    );\n\n    twistyPlayer.experimentalModel.detailedTimelineInfo.addFreshListener(\n      (detailedTimelineInfo: DetailedTimelineInfo) => {\n        if (detailedTimelineInfo.timestamp !== this.lastClickTimestamp) {\n          this.lastClickTimestamp = null;\n        }\n      },\n    );\n  }\n\n  async jumpToIndex(index: number, offsetIntoMove: boolean): Promise<void> {\n    // TODO: Fix async issues.\n    const twistyPlayer = this.#twistyPlayer;\n    if (twistyPlayer) {\n      twistyPlayer.pause();\n      const timestampPromise = (async (): Promise<MillisecondTimestamp> => {\n        const indexer = await twistyPlayer.experimentalModel.indexer.get();\n        const offset = offsetIntoMove ? DEFAULT_OFFSET_MS : 0;\n        return (\n          indexer.indexToMoveStartTimestamp(index) +\n          indexer.moveDuration(index) -\n          offset\n        );\n      })();\n      twistyPlayer.experimentalModel.timestampRequest.set(\n        await timestampPromise, // TODO\n      );\n      if (this.lastClickTimestamp === (await timestampPromise)) {\n        twistyPlayer.play();\n        this.lastClickTimestamp = null;\n      } else {\n        this.lastClickTimestamp = await timestampPromise;\n      }\n    }\n  }\n\n  protected async attributeChangedCallback(\n    attributeName: string,\n    _oldValue: string,\n    newValue: string,\n  ): Promise<void> {\n    if (attributeName === \"for\") {\n      const elem = document.getElementById(newValue);\n      if (!elem) {\n        console.warn(\"for= elem does not exist\");\n        return;\n      }\n      await customElements.whenDefined(\"twisty-player\");\n      if (!(elem instanceof TwistyPlayer)) {\n        console.warn(\"for= elem is not a twisty-player\");\n        return;\n      }\n      this.twistyPlayer = elem;\n    }\n  }\n\n  static get observedAttributes(): string[] {\n    return [\"for\"];\n  }\n}\n\ncustomElementsShim.define(\"twisty-alg-viewer\", TwistyAlgViewer);\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"twisty-alg-viewer\": TwistyAlgViewer;\n  }\n}\n", "import {\n  Alg,\n  Commutator,\n  Conjugate,\n  Grouping,\n  LineComment,\n  Move,\n  Newline,\n  Pause,\n  TraversalDownUp,\n} from \"../../../alg\";\nimport type { Parsed } from \"../../../alg/parseAlg\";\nimport { functionFromTraversal } from \"../../../alg\";\nimport type { AnimatedLeafAlgNode } from \"../../controllers/indexer/simultaneous-moves/simul-moves\";\n\nexport type AnimatedLeafAlgNodeInfo = {\n  leaf: Parsed<AnimatedLeafAlgNode>;\n  idx: number;\n};\nexport type OrderedLeafTokens = AnimatedLeafAlgNodeInfo[];\n\ninterface DataUp {\n  tokens: OrderedLeafTokens;\n  numLeavesInside: number;\n}\n\ninterface DataDown {\n  numMovesSofar: number;\n}\n\nclass LeafTokens extends TraversalDownUp<DataDown, DataUp> {\n  public traverseAlg(alg: Alg, dataDown: DataDown): DataUp {\n    const algNodeArrays: OrderedLeafTokens[] = [];\n    let numMovesInside = 0;\n    for (const algNode of alg.childAlgNodes()) {\n      const dataUp = this.traverseAlgNode(algNode, {\n        numMovesSofar: dataDown.numMovesSofar + numMovesInside,\n      });\n      algNodeArrays.push(dataUp.tokens);\n      numMovesInside += dataUp.numLeavesInside;\n    }\n    return {\n      tokens: Array.prototype.concat(...algNodeArrays),\n      numLeavesInside: numMovesInside,\n    };\n  }\n\n  public traverseGrouping(grouping: Grouping, dataDown: DataDown): DataUp {\n    const dataUp = this.traverseAlg(grouping.alg, dataDown);\n    return {\n      tokens: dataUp.tokens,\n      numLeavesInside: dataUp.numLeavesInside * grouping.amount,\n    };\n  }\n\n  public traverseMove(move: Move, dataDown: DataDown): DataUp {\n    return {\n      tokens: [{ leaf: move as Parsed<Move>, idx: dataDown.numMovesSofar }],\n      numLeavesInside: 1,\n    }; // TODO: What if not parsed?\n  }\n\n  public traverseCommutator(\n    commutator: Commutator,\n    dataDown: DataDown,\n  ): DataUp {\n    const dataUpA = this.traverseAlg(commutator.A, dataDown);\n    const dataUpB = this.traverseAlg(commutator.B, {\n      numMovesSofar: dataDown.numMovesSofar + dataUpA.numLeavesInside,\n    });\n    return {\n      tokens: dataUpA.tokens.concat(dataUpB.tokens),\n      numLeavesInside: dataUpA.numLeavesInside * 2 + dataUpB.numLeavesInside,\n    };\n  }\n\n  public traverseConjugate(conjugate: Conjugate, dataDown: DataDown): DataUp {\n    const dataUpA = this.traverseAlg(conjugate.A, dataDown);\n    const dataUpB = this.traverseAlg(conjugate.B, {\n      numMovesSofar: dataDown.numMovesSofar + dataUpA.numLeavesInside,\n    });\n    return {\n      tokens: dataUpA.tokens.concat(dataUpB.tokens),\n      numLeavesInside:\n        dataUpA.numLeavesInside * 2 + dataUpB.numLeavesInside * 2,\n    };\n  }\n\n  public traversePause(pause: Pause, dataDown: DataDown): DataUp {\n    return {\n      tokens: [{ leaf: pause as Parsed<Pause>, idx: dataDown.numMovesSofar }],\n      numLeavesInside: 1,\n    }; // TODO: What if not parsed?\n  }\n\n  public traverseNewline(_newline: Newline, _dataDown: DataDown): DataUp {\n    return {\n      tokens: [],\n      numLeavesInside: 0,\n    };\n  }\n\n  public traverseLineComment(\n    _comment: LineComment,\n    _dataDown: DataDown,\n  ): DataUp {\n    return {\n      tokens: [],\n      numLeavesInside: 0,\n    };\n  }\n}\n\nexport const leafTokens = functionFromTraversal(LeafTokens);\n", "// TODO: Move this?\n\nimport type { Alg } from \"../../../alg\";\nimport type { Parsed } from \"../../../alg/parseAlg\";\nimport {\n  AlgWithIssues,\n  algWithIssuesFromString,\n} from \"../../model/props/puzzle/state/AlgProp\";\nimport {\n  SimpleTwistyPropSource,\n  TwistyPropDerived,\n  TwistyPropSource,\n} from \"../../model/props/TwistyProp\";\nimport {\n  AnimatedLeafAlgNodeInfo,\n  leafTokens,\n  OrderedLeafTokens,\n} from \"./LeafTokens\";\n\nexport class TwistyAlgEditorValueProp extends SimpleTwistyPropSource<string> {\n  getDefaultValue(): string {\n    return \"\";\n  }\n}\n\ninterface AlgEditorAlgWithIssuesPropInput {\n  value: string;\n}\nclass AlgEditorAlgWithIssuesProp extends TwistyPropDerived<\n  AlgEditorAlgWithIssuesPropInput,\n  AlgWithIssues\n> {\n  derive(input: AlgEditorAlgWithIssuesPropInput): AlgWithIssues {\n    return algWithIssuesFromString(input.value);\n  }\n  // TODO: canReuse needs to take the source string into account.\n}\n\ninterface SelectionInfoPropInput {\n  selectionStart: number;\n  selectionEnd: number;\n}\ninterface SelectionInfo extends SelectionInfoPropInput {\n  endChangedMostRecently: boolean;\n}\nexport class TwistyAlgEditorSelectionProp extends TwistyPropSource<\n  SelectionInfo,\n  SelectionInfoPropInput\n> {\n  getDefaultValue() {\n    return {\n      selectionStart: 0,\n      selectionEnd: 0,\n      endChangedMostRecently: false,\n    };\n  }\n\n  async derive(\n    input: SelectionInfoPropInput,\n    oldValue: Promise<SelectionInfo>,\n  ): Promise<SelectionInfo> {\n    const { selectionStart, selectionEnd } = input;\n    const lastResult = await oldValue;\n    const endChangedMostRecently =\n      input.selectionStart === lastResult.selectionStart &&\n      input.selectionEnd !== (await oldValue).selectionEnd;\n    return {\n      selectionStart,\n      selectionEnd,\n      endChangedMostRecently,\n    };\n  }\n}\n\ninterface TargetCharPropInputs {\n  selectionInfo: SelectionInfo;\n}\n\nexport class TargetCharProp extends TwistyPropDerived<\n  TargetCharPropInputs,\n  number\n> {\n  derive(inputs: TargetCharPropInputs) {\n    return inputs.selectionInfo.endChangedMostRecently\n      ? inputs.selectionInfo.selectionEnd\n      : inputs.selectionInfo.selectionStart;\n  }\n}\n\ninterface LeafTokensPropInputs {\n  algWithIssues: AlgWithIssues;\n}\nclass LeafTokensProp extends TwistyPropDerived<\n  LeafTokensPropInputs,\n  OrderedLeafTokens\n> {\n  derive(inputs: LeafTokensPropInputs): OrderedLeafTokens {\n    return leafTokens(inputs.algWithIssues.alg as Parsed<Alg>, {\n      numMovesSofar: 0,\n    }).tokens;\n  }\n}\n\ninterface LeafToHighlightPropInputs {\n  targetChar: number;\n  leafTokens: OrderedLeafTokens;\n}\ntype HighlightWhere = \"before\" | \"start\" | \"inside\" | \"end\" | \"after\";\nexport interface HighlightInfo {\n  leafInfo: AnimatedLeafAlgNodeInfo;\n  where: HighlightWhere;\n}\nclass LeafToHighlightProp extends TwistyPropDerived<\n  LeafToHighlightPropInputs,\n  HighlightInfo | null\n> {\n  derive(inputs: LeafToHighlightPropInputs): HighlightInfo | null {\n    function withWhere(\n      leafInfo: AnimatedLeafAlgNodeInfo | null,\n    ): HighlightInfo | null {\n      if (leafInfo === null) {\n        return null;\n      }\n      let where: HighlightWhere;\n      if (inputs.targetChar < leafInfo.leaf.startCharIndex) {\n        where = \"before\";\n      } else if (inputs.targetChar === leafInfo.leaf.startCharIndex) {\n        where = \"start\";\n      } else if (inputs.targetChar < leafInfo.leaf.endCharIndex) {\n        where = \"inside\";\n      } else if (inputs.targetChar === leafInfo.leaf.endCharIndex) {\n        where = \"end\";\n      } else {\n        where = \"after\";\n      }\n      return {\n        leafInfo,\n        where,\n      };\n    }\n\n    let lastLeafInfo: AnimatedLeafAlgNodeInfo | null = null;\n    // TODO: binary search\n    for (const leafInfo of inputs.leafTokens) {\n      if (\n        inputs.targetChar < leafInfo.leaf.startCharIndex &&\n        lastLeafInfo !== null\n      ) {\n        return withWhere(lastLeafInfo);\n      }\n      if (inputs.targetChar <= leafInfo.leaf.endCharIndex) {\n        return withWhere(leafInfo);\n      }\n      lastLeafInfo = leafInfo;\n    }\n\n    return withWhere(lastLeafInfo);\n  }\n}\n\nexport class TwistyAlgEditorModel {\n  valueProp = new TwistyAlgEditorValueProp();\n  selectionProp = new TwistyAlgEditorSelectionProp();\n  targetCharProp = new TargetCharProp({ selectionInfo: this.selectionProp });\n\n  algEditorAlgWithIssues = new AlgEditorAlgWithIssuesProp({\n    value: this.valueProp,\n  });\n\n  leafTokensProp = new LeafTokensProp({\n    algWithIssues: this.algEditorAlgWithIssues,\n  });\n\n  leafToHighlight = new LeafToHighlightProp({\n    leafTokens: this.leafTokensProp,\n    targetChar: this.targetCharProp,\n  });\n}\n", "import { CSSSource } from \"../ManagedCustomElement\";\n\nexport const twistyAlgEditorCSS = new CSSSource(\n  `\n:host {\n  width: 384px;\n  display: grid;\n}\n\n.wrapper {\n  /*overflow: hidden;\n  resize: horizontal;*/\n\n  background: var(--background, none);\n  display: grid;\n}\n\ntextarea, .carbon-copy {\n  grid-area: 1 / 1 / 2 / 2;\n\n  width: 100%;\n  font-family: sans-serif;\n  line-height: 1.2em;\n\n  font-size: var(--font-size, inherit);\n  font-family: var(--font-family, sans-serif);\n\n  box-sizing: border-box;\n\n  padding: var(--padding, 0.5em);\n  /* Prevent horizontal growth. */\n  overflow-x: hidden;\n}\n\ntextarea {\n  resize: none;\n  background: none;\n  z-index: 2;\n  overflow: hidden;\n  border: 1px solid var(--border-color, rgba(0, 0, 0, 0.25));\n}\n\n.carbon-copy {\n  white-space: pre-wrap;\n  word-wrap: break-word;\n  color: transparent;\n  user-select: none;\n  pointer-events: none;\n\n  z-index: 1;\n}\n\n.carbon-copy .highlight {\n  background: var(--highlight-color, rgba(255, 128, 0, 0.5));\n  padding: 0.1em 0.2em;\n  margin: -0.1em -0.2em;\n  border-radius: 0.2em;\n}\n\n.wrapper.issue-warning textarea,\n.wrapper.valid-for-puzzle-warning textarea {\n  outline: none;\n  border: 1px solid rgba(200, 200, 0, 0.5);\n  background: rgba(255, 255, 0, 0.1);\n}\n\n.wrapper.issue-error textarea,\n.wrapper.valid-for-puzzle-error textarea {\n  outline: none;\n  border: 1px solid red;\n  background: rgba(255, 0, 0, 0.1);\n}\n`,\n);\n", "/**\n * Warning: the current implementation of <twisty-alg-editor> is *not good*,\n * but it is *good enough*. The important parts is that:\n *\n * - The editor can be used in apps without much effort.\n * - The editor handles alg validation and move highlighting *okay* when not\n *   connected to a `<twisty-player>`.\n * - The editor stays in sync if it's connected to a `<twisty-player>`.\n *\n * The current implementation still has some race conditions and edge cases. A\n * proper rewrite with a better model would be very welcome.\n */\n\nimport type { ExperimentalParsed } from \"../../../alg\";\nimport { Alg, Move, Pause } from \"../../../alg\";\nimport type { Parsed } from \"../../../alg/parseAlg\";\nimport type {\n  AlgProp,\n  AlgWithIssues,\n} from \"../../model/props/puzzle/state/AlgProp\";\nimport type { CurrentLeavesSimplified } from \"../../model/props/puzzle/state/CurrentLeavesSimplified\";\nimport { ClassListManager } from \"../ClassListManager\";\nimport { ManagedCustomElement } from \"../ManagedCustomElement\";\nimport { customElementsShim } from \"../node-custom-element-shims\";\nimport { TwistyPlayer } from \"../TwistyPlayer\";\nimport { HighlightInfo, TwistyAlgEditorModel } from \"./model\";\nimport { twistyAlgEditorCSS } from \"./TwistyAlgEditor.css\";\n\nconst ATTRIBUTE_FOR_TWISTY_PLAYER = \"for-twisty-player\";\nconst ATTRIBUTE_PLACEHOLDER = \"placeholder\";\nconst ATTRIBUTE_TWISTY_PLAYER_PROP = \"twisty-player-prop\";\n\ntype TwistyPlayerAlgProp = \"alg\" | \"setupAlg\";\n\n/** @category Other Custom Elements */\nexport class TwistyAlgEditor extends ManagedCustomElement {\n  model = new TwistyAlgEditorModel();\n\n  // #alg: Alg = new Alg();\n  #textarea: HTMLTextAreaElement = document.createElement(\"textarea\");\n  #carbonCopy: HTMLDivElement = document.createElement(\"div\");\n  #carbonCopyPrefix: HTMLSpanElement = document.createElement(\"span\");\n  #carbonCopyHighlight: HTMLSpanElement = document.createElement(\"span\");\n  #carbonCopySuffix: HTMLSpanElement = document.createElement(\"span\");\n\n  // #textareaClassListManager: ClassListManager<\"none\" | \"warning\" | \"error\"> =\n  //   new ClassListManager(this, \"issue-\", [\"none\", \"warning\", \"error\"]);\n\n  #textareaClassListValidForPuzzleManager: ClassListManager<\n    \"none\" | \"warning\" | \"error\"\n  > = new ClassListManager(this, \"valid-for-puzzle-\", [\n    \"none\",\n    \"warning\",\n    \"error\",\n  ]);\n\n  #twistyPlayer: TwistyPlayer | null = null;\n  #twistyPlayerProp: TwistyPlayerAlgProp;\n  get #algProp(): AlgProp | null {\n    if (this.#twistyPlayer === null) {\n      return null;\n    } else {\n      return this.#twistyPlayer.experimentalModel[this.#twistyPlayerProp];\n    }\n  }\n\n  // Temporary Workaround for Twizzle Explorer\n  debugNeverRequestTimestamp: boolean = false;\n\n  constructor(options?: {\n    twistyPlayer?: TwistyPlayer;\n    twistyPlayerProp?: TwistyPlayerAlgProp;\n  }) {\n    super();\n    this.#carbonCopy.classList.add(\"carbon-copy\");\n    this.addElement(this.#carbonCopy);\n    this.#textarea.rows = 1;\n    this.addElement(this.#textarea);\n    this.#carbonCopyPrefix.classList.add(\"prefix\");\n    this.#carbonCopy.appendChild(this.#carbonCopyPrefix);\n    this.#carbonCopyHighlight.classList.add(\"highlight\");\n    this.#carbonCopy.appendChild(this.#carbonCopyHighlight);\n    this.#carbonCopySuffix.classList.add(\"suffix\");\n    this.#carbonCopy.appendChild(this.#carbonCopySuffix);\n\n    this.#textarea.placeholder = \"Alg\";\n    // Prevent iOS from defaulting to smart quotes.\n    this.#textarea.setAttribute(\"spellcheck\", \"false\");\n\n    this.addCSS(twistyAlgEditorCSS);\n\n    // TODO: What set of events should we register? `change`? `keydown`?\n    this.#textarea.addEventListener(\"input\", () => {\n      this.#onInputHasFired = true;\n      this.onInput();\n    });\n    this.#textarea.addEventListener(\"blur\", () => this.onBlur());\n    document.addEventListener(\"selectionchange\", () =>\n      this.onSelectionChange(),\n    );\n\n    if (options?.twistyPlayer) {\n      this.twistyPlayer = options.twistyPlayer;\n    }\n    this.#twistyPlayerProp = options?.twistyPlayerProp ?? \"alg\";\n\n    if (options?.twistyPlayerProp === \"alg\") {\n      this.model.leafToHighlight.addFreshListener(\n        (highlightInfo: HighlightInfo | null) => {\n          if (highlightInfo) {\n            this.highlightLeaf(highlightInfo.leafInfo.leaf);\n          }\n        },\n      );\n    }\n  }\n\n  // TODO\n  set algString(s: string) {\n    this.#textarea.value = s;\n    this.onInput();\n  }\n\n  // TODO: remove?\n  get algString(): string {\n    return this.#textarea.value;\n  }\n\n  // To we need a getter?\n  set placeholder(placeholderText: string) {\n    this.#textarea.placeholder = placeholderText;\n  }\n\n  #onInputHasFired = false;\n  onInput(): void {\n    this.#carbonCopyHighlight.hidden = true;\n    this.highlightLeaf(null);\n\n    // TODO: This is a hack so that the you don't get a warning when the cursor\n    // is after the space while typing `R U`. It would be nice to have something\n    // cursor-aware that can also ignore whitespace warnings (or other syntax\n    // errors due to normal input) adjacent to the cursor when it's in the\n    // middle, but this is suffuciently useful for now.\n    const endTrimmed = this.#textarea.value.trimEnd();\n    this.model.valueProp.set(endTrimmed);\n    this.#algProp?.set(endTrimmed);\n  }\n\n  async onSelectionChange(): Promise<void> {\n    if (\n      document.activeElement !== this ||\n      this.shadow.activeElement !== this.#textarea\n    ) {\n      return;\n    }\n    if (this.#twistyPlayerProp !== \"alg\") {\n      return;\n    }\n\n    const { selectionStart, selectionEnd } = this.#textarea;\n    this.model.selectionProp.set({\n      selectionStart,\n      selectionEnd,\n    });\n  }\n\n  async onBlur(): Promise<void> {\n    // TODO: Figure out how not to make the cursor jump.\n    // const parsed = Alg.fromString(this.algString);\n    // this.algString = parsed.toString();\n    // const [currentLeavesSimplified, indexer] = await Promise.all([\n    //   this.#twistyPlayer!.model.currentLeavesSimplifiedProp.get(),\n    //   this.#twistyPlayer!.model.indexerProp.get(),\n    // ]);\n    // const leaf = indexer.getAnimLeaf(currentLeavesSimplified.stateIndex);\n    // this.highlightLeaf(leaf as Parsed<Move | Pause> | null);\n  }\n\n  setAlgIssueClassForPuzzle(issues: \"none\" | \"warning\" | \"error\") {\n    this.#textareaClassListValidForPuzzleManager.setValue(issues);\n  }\n\n  // `white-space: pre;` mostly matches the formatting of the `<textarea>`, *except* when we end with a newline.\n  // So we add an space to ensure that there is a character on the final line (that is very unlikely to trigger extra line wrapping).\n  #padSuffix(s: string): string {\n    return s.endsWith(\"\\n\") ? `${s} ` : s;\n  }\n\n  #highlightedLeaf: ExperimentalParsed<Move | Pause> | null = null;\n  // TODO: support a primary highlighted move and secondary ones.\n  highlightLeaf(leaf: ExperimentalParsed<Move | Pause> | null): void {\n    if (this.#twistyPlayerProp !== \"alg\") {\n      return;\n    }\n    if (leaf === null) {\n      this.#carbonCopyPrefix.textContent = \"\";\n      this.#carbonCopyHighlight.textContent = \"\";\n      this.#carbonCopySuffix.textContent = this.#padSuffix(\n        this.#textarea.value,\n      );\n      return;\n    }\n    if (leaf === this.#highlightedLeaf) {\n      return;\n    }\n    this.#highlightedLeaf = leaf;\n    this.#carbonCopyPrefix.textContent = this.#textarea.value.slice(\n      0,\n      leaf.startCharIndex,\n    );\n    this.#carbonCopyHighlight.textContent = this.#textarea.value.slice(\n      leaf.startCharIndex,\n      leaf.endCharIndex,\n    );\n    this.#carbonCopySuffix.textContent = this.#padSuffix(\n      this.#textarea.value.slice(leaf.endCharIndex),\n    );\n    this.#carbonCopyHighlight.hidden = false;\n  }\n\n  get twistyPlayer(): TwistyPlayer | null {\n    return this.#twistyPlayer;\n  }\n\n  // TODO: spread out this impl over private methods instead of self-listeners.\n  set twistyPlayer(twistyPlayer: TwistyPlayer | null) {\n    if (this.#twistyPlayer) {\n      // TODO: support reassigment/clearing\n      console.warn(\"twisty-player reassignment/clearing is not supported\");\n      return;\n    }\n    this.#twistyPlayer = twistyPlayer;\n    if (!twistyPlayer) {\n      return;\n    }\n    (async () => {\n      this.algString = this.#algProp\n        ? (await this.#algProp.get()).alg.toString()\n        : \"\";\n    })();\n\n    if (this.#twistyPlayerProp === \"alg\") {\n      // this.model.leafToHighlight.addFreshListener(\n      //   this.highlightLeaf.bind(this),\n      // );\n\n      // TODO: listen to puzzle prop?\n      this.#twistyPlayer?.experimentalModel.puzzleAlg.addFreshListener(\n        (algWithIssues: AlgWithIssues) => {\n          // console.log(JSON.stringify(algWithIssues));\n          if (algWithIssues.issues.errors.length === 0) {\n            this.setAlgIssueClassForPuzzle(\n              // TODO: Allow trailing spaces.\n              algWithIssues.issues.warnings.length === 0 ? \"none\" : \"warning\",\n            );\n            const newAlg = algWithIssues.alg;\n            const oldAlg = Alg.fromString(this.algString);\n            if (!newAlg.isIdentical(oldAlg)) {\n              this.algString = newAlg.toString();\n              this.onInput();\n            } else {\n              // this.model.algInputProp.set(oldAlg);\n            }\n          } else {\n            this.setAlgIssueClassForPuzzle(\"error\");\n          }\n        },\n      );\n\n      this.model.leafToHighlight.addFreshListener(\n        async (highlightInfo: HighlightInfo | null) => {\n          if (highlightInfo === null) {\n            return;\n          }\n          // TODO: This indexer can be out of date!\n          const [indexer, timestampRequest] = await Promise.all([\n            await twistyPlayer.experimentalModel.indexer.get(),\n            await twistyPlayer.experimentalModel.timestampRequest.get(),\n          ]);\n          if (timestampRequest === \"auto\" && !this.#onInputHasFired) {\n            return;\n          }\n          const moveStartTimestamp = indexer.indexToMoveStartTimestamp(\n            highlightInfo.leafInfo.idx,\n          );\n          const duration = indexer.moveDuration(highlightInfo.leafInfo.idx);\n\n          let newTimestamp: number;\n          switch (highlightInfo.where) {\n            case \"before\": {\n              newTimestamp = moveStartTimestamp;\n              break;\n            }\n            case \"start\":\n            case \"inside\": {\n              newTimestamp = moveStartTimestamp + duration / 4;\n              break;\n            }\n            case \"end\":\n            case \"after\": {\n              newTimestamp = moveStartTimestamp + duration;\n              break;\n            }\n            default:\n              console.log(\"invalid where\");\n              throw new Error(\"Invalid where!\");\n          }\n          if (!this.debugNeverRequestTimestamp) {\n            twistyPlayer.experimentalModel.timestampRequest.set(newTimestamp);\n          }\n        },\n      );\n\n      twistyPlayer.experimentalModel.currentLeavesSimplified.addFreshListener(\n        async (currentLeavesSimplified: CurrentLeavesSimplified) => {\n          const indexer = await twistyPlayer.experimentalModel.indexer.get();\n          const leaf = indexer.getAnimLeaf(currentLeavesSimplified.stateIndex);\n          this.highlightLeaf(leaf as Parsed<Move | Pause> | null);\n        },\n      );\n    }\n  }\n\n  protected attributeChangedCallback(\n    attributeName: string,\n    _oldValue: string,\n    newValue: string,\n  ): void {\n    switch (attributeName) {\n      case ATTRIBUTE_FOR_TWISTY_PLAYER: {\n        const elem = document.getElementById(newValue);\n        if (!elem) {\n          console.warn(`${ATTRIBUTE_FOR_TWISTY_PLAYER}= elem does not exist`);\n          return;\n        }\n        if (!(elem instanceof TwistyPlayer)) {\n          // TODO: avoid assuming single instance of lib?\n          console.warn(`${ATTRIBUTE_FOR_TWISTY_PLAYER}=is not a twisty-player`);\n          return;\n        }\n        this.twistyPlayer = elem;\n        return;\n      }\n      case ATTRIBUTE_PLACEHOLDER: {\n        this.placeholder = newValue;\n        return;\n      }\n      case ATTRIBUTE_TWISTY_PLAYER_PROP: {\n        if (this.#twistyPlayer) {\n          console.log(\"cannot set prop\");\n          throw new Error(\"cannot set prop after twisty player\");\n        }\n        this.#twistyPlayerProp = newValue as TwistyPlayerAlgProp;\n        return;\n      }\n    }\n  }\n\n  static get observedAttributes(): string[] {\n    return [\n      ATTRIBUTE_FOR_TWISTY_PLAYER,\n      ATTRIBUTE_PLACEHOLDER,\n      ATTRIBUTE_TWISTY_PLAYER_PROP,\n    ];\n  }\n}\n\ncustomElementsShim.define(\"twisty-alg-editor\", TwistyAlgEditor);\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"twisty-alg-editor\": TwistyAlgEditor;\n  }\n}\n", "import { CSSSource } from \"../ManagedCustomElement\";\n\nexport const twizzleLinkCSS = new CSSSource(\n  `\n.wrapper {\n  background: rgb(255, 245, 235);\n  border: 1px solid rgba(0, 0, 0, 0.25);\n}\n\n.setup-alg, twisty-alg-viewer {\n  padding: 0.5em 1em;\n}\n\n.heading {\n  background: rgba(255, 230, 210, 1);\n  font-weight: bold;\n  padding: 0.25em 0.5em;\n}\n\n.heading.title {\n  background: rgb(255, 245, 235);\n  font-size: 150%;\n  white-space: pre;\n}\n\n.heading a {\n  text-decoration: none;\n  color: inherit;\n}\n\ntwisty-player {\n  width: 100%;\n  min-height: 128px;\n  height: 288px;\n  resize: vertical;\n  overflow-y: hidden;\n}\n\ntwisty-player + .heading {\n  padding-top: 0.5em;\n}\n\ntwisty-alg-viewer {\n  display: inline-block;\n}\n\n.wrapper {\n  container-type: inline-size;\n}\n\n.scrollable-region {\n  border-top: 1px solid rgba(0, 0, 0, 0.25);\n}\n\n.scrollable-region {\n  max-height: 18em;\n  overflow-y: auto;\n}\n\n@container (min-width: 512px) {\n  .responsive-wrapper {\n    display: grid;\n    grid-template-columns: 1fr 1fr;\n  }\n  twisty-player {\n    height: 320px\n  }\n  .scrollable-region {\n    border-top: none;\n    border-left: 1px solid rgba(0, 0, 0, 0.25);\n    contain: strict;\n    max-height: 100cqh;\n  }\n}\n\n.wrapper:fullscreen,\n.wrapper:fullscreen .responsive-wrapper {\n  width: 100%;\n  height: 100%;\n}\n\n.wrapper:fullscreen twisty-player,\n.wrapper:fullscreen .scrollable-region {\n  height: 50%;\n}\n\n@container (min-width: 512px) {\n  .wrapper:fullscreen twisty-player,\n  .wrapper:fullscreen .scrollable-region {\n    height: 100%;\n  }\n}\n`,\n);\n\nexport const twizzleLinkForumTweaksCSS = new CSSSource(`\n.wrapper {\n  background: white;\n}\n\n.heading {\n  background: #4285f422;\n}\n\n.scrollable-region {\n  overflow-y: auto;\n}\n\n.wrapper.dark-mode {\n  background: #262626;\n  color: #929292;\n  border-color: #FFFFFF44;\n  color-scheme: dark;\n}\n\n.wrapper.dark-mode .heading:not(.title) {\n  background: #1d1d1d;\n  color: #ececec;\n}\n\n.heading.title {\n  background: none;\n}\n`);\n", "import { TwistyPlayer } from \"../..\";\nimport { Alg } from \"../../../alg\";\nimport { puzzles } from \"../../../puzzles\";\nimport { ManagedCustomElement } from \"../ManagedCustomElement\";\nimport { customElementsShim } from \"../node-custom-element-shims\";\nimport { TwistyAlgViewer } from \"../TwistyAlgViewer\";\nimport { twizzleLinkCSS, twizzleLinkForumTweaksCSS } from \"./TwizzleLink.css\";\nimport { getConfigFromURL } from \"./url-params\";\n\n/** @category Other Custom Elements */\nexport class TwizzleLink extends ManagedCustomElement {\n  twistyPlayer: TwistyPlayer | null = null;\n  a: HTMLAnchorElement | null = null;\n  constructor(\n    private options?: { cdnForumTweaks?: boolean; darkMode: boolean },\n  ) {\n    super({ mode: \"open\" });\n  }\n\n  fallback() {\n    this.contentWrapper.textContent = \"\";\n    if (this.a) {\n      const span = this.contentWrapper.appendChild(\n        document.createElement(\"span\"),\n      );\n      span.textContent = \"\u2757\uFE0F\";\n      span.title = \"Could not show a player for link\";\n      this.addElement(this.a);\n    }\n    this.#cssElem?.remove();\n    this.#cssCDNForumTweaksElem?.remove();\n  }\n\n  #cssElem: HTMLStyleElement | undefined;\n  #cssCDNForumTweaksElem: HTMLStyleElement | undefined;\n  #scrollableRegion: HTMLDivElement;\n  #responsiveWrapper: HTMLDivElement;\n  async connectedCallback() {\n    this.#responsiveWrapper = this.addElement(document.createElement(\"div\"));\n    this.#responsiveWrapper.classList.add(\"responsive-wrapper\");\n    if (this.options?.darkMode) {\n      this.contentWrapper.classList.add(\"dark-mode\");\n    }\n    this.#cssElem = this.addCSS(twizzleLinkCSS);\n    if (this.options?.cdnForumTweaks) {\n      this.addCSS(twizzleLinkForumTweaksCSS);\n    }\n    this.a = this.querySelector(\"a\");\n    if (!this.a) {\n      return;\n    }\n\n    const config = getConfigFromURL(\"\", this.a.href);\n\n    const href = this.a?.href;\n    const { hostname, pathname } = new URL(href);\n\n    if (hostname !== \"alpha.twizzle.net\") {\n      this.fallback();\n      return;\n    }\n    if ([\"/edit/\", \"/explore/\"].includes(pathname)) {\n      const isExplorer = pathname === \"/explore/\";\n\n      if (config.puzzle && !(config.puzzle in puzzles)) {\n        const puzzleDescription = (\n          await import(\"../../../puzzle-geometry\")\n        ).getPuzzleDescriptionString(config.puzzle);\n        delete config.puzzle;\n        config.experimentalPuzzleDescription = puzzleDescription;\n      }\n\n      this.twistyPlayer = this.#responsiveWrapper.appendChild(\n        new TwistyPlayer({\n          background: this.options?.cdnForumTweaks\n            ? \"checkered-transparent\"\n            : \"checkered\",\n          darkMode: this.options?.darkMode ? \"dark\" : \"light\",\n          ...config,\n          viewerLink: isExplorer ? \"experimental-twizzle-explorer\" : \"auto\",\n        }),\n      );\n      this.twistyPlayer.fullscreenElement = this.contentWrapper;\n      if (config.experimentalTitle) {\n        this.twistyPlayer.experimentalTitle = config.experimentalTitle;\n      }\n\n      this.#scrollableRegion = this.#responsiveWrapper.appendChild(\n        document.createElement(\"div\"),\n      );\n      this.#scrollableRegion.classList.add(\"scrollable-region\");\n\n      if (config.experimentalTitle) {\n        this.addHeading(config.experimentalTitle).classList.add(\"title\");\n        // const setupAlgDiv = this.addElement(document.createElement(\"div\"));\n        // setupAlgDiv.classList.add(\"setup-alg\");\n        // setupAlgDiv.textContent = puzzles[config.puzzle ?? \"3x3x3\"].fullName;\n      }\n\n      if (config.experimentalSetupAlg) {\n        this.addHeading(\n          \"Setup\",\n          async () =>\n            (\n              await this.twistyPlayer?.experimentalModel.setupAlg.get()\n            )?.alg.toString() ?? null,\n        );\n\n        const setupAlgDiv = this.#scrollableRegion.appendChild(\n          document.createElement(\"div\"),\n        );\n        setupAlgDiv.classList.add(\"setup-alg\");\n        setupAlgDiv.textContent = new Alg(\n          config.experimentalSetupAlg,\n        ).toString();\n      }\n      this.addHeading(\n        \"Moves\",\n        async () =>\n          (\n            await this.twistyPlayer?.experimentalModel.alg.get()\n          )?.alg.toString() ?? null,\n      );\n      const twistyAlgViewer = this.#scrollableRegion.appendChild(\n        new TwistyAlgViewer({ twistyPlayer: this.twistyPlayer }),\n      );\n      twistyAlgViewer.part.add(\"twisty-alg-viewer\");\n    } else {\n      this.fallback();\n    }\n  }\n\n  addHeading(\n    text: string,\n    getTextToCopy?: () => Promise<string | null>,\n  ): HTMLElement {\n    const headingDiv = this.#scrollableRegion!.appendChild(\n      document.createElement(\"div\"),\n    );\n    headingDiv.classList.add(\"heading\");\n    headingDiv.textContent = text;\n    if (getTextToCopy) {\n      headingDiv.textContent += \" \";\n      const a = headingDiv.appendChild(document.createElement(\"a\"));\n      a.textContent = \"\uD83D\uDCCB\";\n      a.href = \"#\";\n      a.title = \"Copy to clipboard\";\n      async function setAndClear(text: string) {\n        a.textContent = text;\n        await new Promise((resolve) => setTimeout(resolve, 2000));\n        if (a.textContent === text) {\n          a.textContent = \"\uD83D\uDCCB\";\n        }\n      }\n      a.addEventListener(\"click\", async (e) => {\n        e.preventDefault();\n        a.textContent = \"\u2026\uD83D\uDCCB\";\n        const textToCopy = await getTextToCopy();\n        if (textToCopy) {\n          try {\n            await navigator.clipboard.writeText(textToCopy);\n            setAndClear(\"\u2705\uD83D\uDCCB\");\n          } catch (e) {\n            setAndClear(\"\u274C\uD83D\uDCCB\");\n            throw e;\n          }\n        } else {\n          setAndClear(\"\u274C\uD83D\uDCCB\");\n        }\n      });\n    }\n    return headingDiv;\n  }\n}\n\ncustomElementsShim.define(\"twizzle-link\", TwizzleLink);\ndeclare global {\n  interface HTMLElementTagNameMap {\n    \"twizzle-link\": TwizzleLink;\n  }\n}\n", "import { EXPERIMENTAL_PROP_NO_VALUE } from \"../../../../cubing/twisty\";\nimport type {\n  AlgProp,\n  AlgWithIssues,\n} from \"../../../../cubing/twisty/model/props/puzzle/state/AlgProp\";\nimport type { TwistyPlayerModel } from \"../../../../cubing/twisty/model/TwistyPlayerModel\";\nimport type { TwistyPropSource } from \"../../../../cubing/twisty/model/props/TwistyProp\";\nimport {\n  TwistyPlayerAttribute,\n  twistyPlayerAttributeMap,\n  TwistyPlayerConfig,\n} from \"../../../../cubing/twisty/views/TwistyPlayer\";\n\nfunction updateURL(url: URL): void {\n  window.history.replaceState(\"\", \"\", url.toString());\n}\n\n// TODO: Find a way to connect this to the `TwistyPlayer` constructor?\n\nexport type URLParamUpdaterOptions = {\n  prefix?: string;\n};\n\nexport class URLParamUpdater {\n  #prefix: string;\n  constructor(model: TwistyPlayerModel, options?: URLParamUpdaterOptions) {\n    this.#prefix = options?.prefix ?? \"\";\n\n    this.listenToAlgProp(model.alg, \"alg\");\n    this.listenToAlgProp(model.setupAlg, \"setup-alg\");\n    this.listenToStringOrNullProp(\n      model.twistySceneModel.stickeringRequest,\n      \"stickering\",\n      \"full\",\n    );\n    this.listenToStringSourceProp(model.setupAnchor, \"setup-anchor\");\n    this.listenToStringOrNullProp(model.title, \"title\");\n    this.listenToStringOrNoValueProp(\n      model.puzzleIDRequest,\n      \"puzzle\",\n      EXPERIMENTAL_PROP_NO_VALUE,\n    );\n    this.listenToStringOrNoValueProp(\n      model.puzzleDescriptionRequest,\n      \"puzzle-description\",\n      EXPERIMENTAL_PROP_NO_VALUE,\n    );\n  }\n\n  // TODO: Cache parsed URL?\n  setURLParam(\n    unprefixedKey: string,\n    value: string,\n    defaultString: string,\n  ): void {\n    const prefixedKey = this.#prefix + unprefixedKey;\n    const url = new URL(location.href);\n    if (value === defaultString) {\n      url.searchParams.delete(prefixedKey);\n    } else {\n      url.searchParams.set(prefixedKey, value);\n    }\n    updateURL(url);\n  }\n\n  async listenToStringSourceProp(\n    prop: TwistyPropSource<string | null>,\n    key: string,\n    defaultString?: string,\n  ): Promise<void> {\n    const actualDefaultString =\n      defaultString ?? (await prop.getDefaultValue()) ?? \"\"; // TODO\n    prop.addFreshListener((s: string) => {\n      this.setURLParam(key, s, actualDefaultString);\n    });\n  }\n\n  async listenToStringOrNullProp(\n    prop: TwistyPropSource<string | null>,\n    key: string,\n    defaultString: string = \"\",\n  ): Promise<void> {\n    prop.addFreshListener((s: string | null) => {\n      this.setURLParam(key, s ?? defaultString, defaultString);\n    });\n  }\n\n  async listenToStringOrNoValueProp(\n    prop: TwistyPropSource<string | typeof EXPERIMENTAL_PROP_NO_VALUE>,\n    key: string,\n    defaultString: string | typeof EXPERIMENTAL_PROP_NO_VALUE,\n  ): Promise<void> {\n    prop.addFreshListener((s: string | typeof EXPERIMENTAL_PROP_NO_VALUE) => {\n      if (s === EXPERIMENTAL_PROP_NO_VALUE) {\n        s = defaultString;\n      }\n      if (s === EXPERIMENTAL_PROP_NO_VALUE) {\n        this.setURLParam(key, \"\", \"\");\n      } else {\n        this.setURLParam(key, s, \"\"); // TODO\n      }\n    });\n  }\n\n  listenToAlgProp(prop: AlgProp, key: string): void {\n    prop.addFreshListener((algWithIssues: AlgWithIssues) => {\n      this.setURLParam(key, algWithIssues.alg.toString(), \"\");\n    });\n  }\n}\n\nexport function getConfigFromURL(\n  prefix = \"\",\n  url: string = location.href,\n): TwistyPlayerConfig {\n  // TODO: Why does `Object.entries(paramMapping)` crash if this is defined elswhere?\n  const paramMapping: Record<string, TwistyPlayerAttribute> = {\n    alg: \"alg\",\n    \"setup-alg\": \"experimental-setup-alg\",\n    \"setup-anchor\": \"experimental-setup-anchor\",\n    puzzle: \"puzzle\",\n    stickering: \"experimental-stickering\",\n    \"puzzle-description\": \"experimental-puzzle-description\",\n    title: \"experimental-title\",\n    \"video-url\": \"experimental-video-url\",\n    competition: \"experimental-competition-id\",\n  };\n\n  const params = new URL(url).searchParams;\n  const config: TwistyPlayerConfig = {};\n  for (const [ourParam, twistyPlayerParam] of Object.entries(paramMapping)) {\n    const paramValue = params.get(prefix + ourParam);\n    if (paramValue !== null) {\n      // TODO: type\n      const configKey = twistyPlayerAttributeMap[twistyPlayerParam];\n      (config as any)[configKey] = paramValue;\n    }\n  }\n  return config;\n}\n\nexport function remapLegacyURLParams(\n  mapping: Record<string, string | null>,\n): void {\n  const url = new URL(location.href);\n  for (const [oldKey, newKey] of Object.entries(mapping)) {\n    // `null` indicates there is no new key, i.e. just drop the old key\n    if (newKey !== null) {\n      // The new key takes precedents, so we only remap the old key if the new key\n      // is not already set.\n      if (!url.searchParams.has(newKey)) {\n        const value = url.searchParams.get(oldKey);\n        if (value !== null) {\n          url.searchParams.set(newKey, value);\n        }\n      }\n    }\n    url.searchParams.delete(oldKey);\n  }\n  updateURL(url);\n}\n"],
  "mappings": "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",
  "names": ["getStickeringGroup", "stickering", "puzzleID", "groups", "experimentalStickerings", "StickeringRequestProp", "SimpleTwistyPropSource", "arrayEquals", "a", "b", "i", "arrayEqualsCompare", "compare", "mod", "v", "m", "offset", "modIntoRange", "rangeMin", "rangeMax", "CatchUpHelper", "model", "RenderScheduler", "timestamp", "delta", "previousCatchUpMove", "amount", "TwistyAnimationController", "delegate", "#animFrameEffectiveTimestampStaleDropper", "StaleDropper", "#effectiveTimestampMilliseconds", "playingInfo", "catchUpMove", "catchingUp", "options", "direction", "coarseTimelineInfo", "frameDatestamp", "lastDatestamp", "freshenerResult", "lastTimestamp", "timeRange", "tempoScale", "currentMoveInfo", "end", "start", "newTimestamp", "newSmartTimestampRequest", "modIntoRange", "TwistyPlayerController", "model", "delegate", "TwistyAnimationController", "options", "play", "a", "controlsLocations", "ControlPanelProp", "SimpleTwistyPropSource", "twistyViewerWrapperCSS", "CSSSource", "xmlns", "DATA_COPY_ID_ATTRIBUTE", "svgCounter", "nextSVGID", "colorMaps", "KPuzzleSVGWrapper", "kpuzzle", "svgSource", "experimentalStickeringMask", "svgElem", "orbitName", "orbitDefinition", "idx", "orientation", "id", "elem", "originalColor", "a", "orbitStickeringMask", "pieceStickeringMask", "faceletStickeringMasks", "stickeringMask", "colorMap", "hintElem", "state", "nextState", "fraction", "transformation", "nextTransformation", "curTransformationOrbit", "nextTransformationOrbit", "fromCur", "singleColor", "fromNext", "easedBackwardsPercent", "grad", "stopDefs", "stopDef", "stop", "twisty2DSVGCSS", "CSSSource", "Twisty2DPuzzle", "ManagedCustomElement", "model", "kpuzzle", "svgSource", "options", "puzzleLoader", "RenderScheduler", "#cachedPosition", "#freshListenerManager", "FreshListenerManager", "twisty2DSVGCSS", "puzzleID", "position", "move", "partialMove", "newState", "e", "stickeringMask", "KPuzzleSVGWrapper", "customElementsShim", "Twisty2DPuzzleWrapper", "model", "schedulable", "puzzleLoader", "effectiveVisualization", "#freshListenerManager", "stickeringMask", "FreshListenerManager", "#cachedTwisty2DPuzzle", "svgPromise", "Twisty2DPuzzle", "Twisty2DSceneWrapper", "ManagedCustomElement", "model", "effectiveVisualization", "#freshListenerManager", "FreshListenerManager", "twistyViewerWrapperCSS", "#cachedScene", "THREEJS", "#currentTwisty2DPuzzleWrapper", "twisty2DPuzzleWrapper", "old", "twisty2DPuzzlePromise", "puzzleLoader", "Twisty2DPuzzleWrapper", "customElementsShim", "ClassListManager", "elem", "prefix", "validSuffixes", "#currentClassName", "suffix", "newClassName", "changed", "InitialValueTracker", "resolve", "reject", "#resolve", "Twisty3DPuzzleWrapper", "model", "schedulable", "puzzleLoader", "visualizationStrategy", "#freshListenerManager", "position", "hintFaceletStyle", "foundationDisplay", "stickeringMask", "faceletScale", "inputs", "FreshListenerManager", "#cachedTwisty3DPuzzle", "proxyPromise", "proxy3D", "foundationSprite", "hintSprite", "experimentalStickeringMask", "initialHintFaceletsAnimation", "hintFacelets", "pg3d", "p", "raycasterPromise", "transformations", "puzzle", "targets", "raycaster", "movePressCancelOptions", "intersects", "closestMove", "Twisty3DSceneWrapper", "ManagedCustomElement", "model", "#backViewClassListManager", "ClassListManager", "#freshListenerManager", "FreshListenerManager", "#vantages", "twistyViewerWrapperCSS", "vantage", "Twisty3DVantage", "#backViewVantage", "backView", "shouldHaveBackView", "hasBackView", "twisty3DPuzzleWrapper", "#currentTwisty3DPuzzleWrapper", "raycasterPromise", "camera", "three", "THREEJS", "raycaster", "mouse", "#cachedScene", "scene", "old", "#initialWrapperTracker", "InitialValueTracker", "#twisty3DStaleDropper", "StaleDropper", "inputs", "Twisty3DPuzzleWrapper", "customElementsShim", "buttonGridCSS", "CSSSource", "buttonCSS", "globalSafeDocument", "fullscreenEnabled", "globalSafeDocument", "documentExitFullscreen", "documentFullscreenElement", "requestFullscreen", "element", "buttonIcons", "ButtonAppearanceProp", "TwistyPropDerived", "inputs", "fullscreenEnabled", "buttonCommands", "TwistyButtons", "ManagedCustomElement", "model", "controller", "defaultFullscreenElement", "buttonGridCSS", "buttons", "command", "button", "TwistyButton", "#onCommand", "documentFullscreenElement", "documentExitFullscreen", "requestFullscreen", "onFullscreen", "buttonAppearances", "info", "darkMode", "customElementsShim", "#iconManager", "ClassListManager", "buttonIcons", "buttonCSS", "iconName", "twistyScrubberCSS", "CSSSource", "SLOW_DOWN_SCRUBBING", "isMouseDown", "globalSafeDocument", "event", "y", "clickNum", "onMouseUpdate", "e", "lastVal", "lastPreval", "scaling", "currentClickNum", "TwistyScrubber", "ManagedCustomElement", "model", "controller", "detailedTimelineInfo", "inputElem", "twistyScrubberCSS", "darkMode", "#inputElem", "elem", "value", "rect", "sliderY", "yDist", "scale", "preVal", "delta", "newVal", "customElementsShim", "cachedCamera", "screenshot", "model", "options", "PerspectiveCamera", "Scene", "puzzleLoader", "visualizationStrategy", "_stickering", "_stickeringMaskRequest", "_legacyPosition", "orbitCoordinates", "THREEJS", "width", "height", "aspectRatio", "camera", "scene", "twisty3DWrapper", "Twisty3DPuzzleWrapper", "setCameraFromOrbitCoordinates", "dataURL", "rawRenderPooled", "defaultFilename", "getDefaultFilename", "filename", "downloadURL", "puzzleID", "algWithIssues", "url", "name", "extension", "a", "twistyPlayerCSS", "CSSSource", "ArbitraryStringProp", "SimpleTwistyPropSource", "URLProp", "TwistyPropSource", "input", "AlgIssues", "issues", "algWithIssuesFromString", "s", "alg", "Alg", "warnings", "e", "algWithIssuesEquals", "a1", "a2", "arrayEquals", "AlgProp", "TwistyPropSource", "v1", "v2", "newAlg", "AlgTransformationProp", "TwistyPropDerived", "input", "AnchorTransformationProp", "TwistyPropDerived", "inputs", "inverseAlgTransformation", "CatchUpMoveProp", "SimpleTwistyPropSource", "v1", "v2", "CurrentLeavesSimplifiedProp", "TwistyPropDerived", "inputs", "currentMoveInfo", "v1", "v2", "arrayEqualsCompare", "m1", "m2", "CurrentMoveInfoProp", "TwistyPropDerived", "inputs", "addCatchUpMove", "currentMoveInfo", "idx", "move", "Move", "start", "duration", "fraction", "end", "currentMove", "CurrentStateProp", "TwistyPropDerived", "inputs", "transformation", "finishingMove", "finishedMove", "defaultDurationForAmount", "amount", "AlgDuration", "TraversalUp", "durationForAmount", "defaultDurationForAmount", "alg", "total", "algNode", "grouping", "move", "commutator", "conjugate", "_pause", "_newline", "_comment", "SimpleAlgIndexer", "kpuzzle", "alg", "AlgDuration", "defaultDurationForAmount", "Alg", "index", "timestamp", "cumulativeTime", "i", "state", "move", "countAnimatedLeaves", "axisLookup", "isSameAxis", "move1", "move2", "LocalSimulMoves", "TraversalUp", "alg", "processed", "childAlgNode", "algNode", "Move", "moves", "maxSimulDur", "defaultDurationForAmount", "i", "j", "localMovesWithRange", "blockMove", "grouping", "segmentOnce", "move", "duration", "commutator", "segmentsOnce", "segment", "conjugate", "pause", "_newline", "_comment", "localSimulMoves", "functionFromTraversal", "simulMoves", "a", "timestamp", "localSimulMove", "leafWithRange", "demos", "Move", "SimultaneousMoveIndexer", "kpuzzle", "alg", "simulMoves", "index", "start", "timestamp", "i", "startState", "currentMoveInfo", "state", "leafWithRange", "move", "windowEarliestTimestamp", "currentMoves", "movesStarting", "movesFinishing", "movesFinished", "latestStart", "earliestEnd", "stateIndex", "fraction", "moveFinished", "currentMove", "transformation", "max", "AlgWalkerDecoration", "moveCount", "duration", "forward", "backward", "children", "DecoratorConstructor", "TraversalUp", "kpuzzle", "AlgDuration", "defaultDurationForAmount", "alg", "transformation", "child", "algNode", "apd", "grouping", "dec", "move", "key", "r", "commutator", "decA", "decB", "AB", "ApBp", "ABApBp", "conjugate", "ABAp", "pause", "_newline", "_comment", "n", "absn", "st", "WalkerDown", "back", "AlgWalker", "TraversalDownUp", "algOrAlgNode", "loc", "dur", "Alg", "wd", "directedGenerator", "_wd", "_lineComment", "amount", "base", "full", "mul", "MIN_CHUNKING_THRESHOLD", "chunkifyAlg", "alg", "chunkMaxLength", "mainAlgBuilder", "AlgBuilder", "chunkAlgBuilder", "algNode", "Grouping", "ChunkAlgs", "TraversalUp", "algLength", "grouping", "move", "commutator", "Conjugate", "conjugate", "pause", "newline", "comment", "chunkAlgs", "functionFromTraversal", "TreeAlgIndexer", "kpuzzle", "alg", "deccon", "DecoratorConstructor", "chunkedAlg", "chunkAlgs", "AlgWalker", "index", "move", "startState", "timestamp", "IndexerConstructorProp", "TwistyPropDerived", "inputs", "countMoves", "SimultaneousMoveIndexer", "TreeAlgIndexer", "SimpleAlgIndexer", "IndexerConstructorRequestProp", "SimpleTwistyPropSource", "IndexerProp", "TwistyPropDerived", "input", "LegacyPositionProp", "TwistyPropDerived", "inputs", "NaiveMoveCountProp", "TwistyPropDerived", "inputs", "countMoves", "validate", "PuzzleAlgProp", "TwistyPropDerived", "inputs", "validate", "Alg", "AlgIssues", "SetupAnchorProp", "SimpleTwistyPropSource", "SetupTransformationProp", "SimpleTwistyPropSource", "KPuzzleProp", "TwistyPropDerived", "inputs", "PGPuzzleDescriptionStringProp", "SimpleTwistyPropSource", "NO_VALUE", "PuzzleIDProp", "TwistyPropDerived", "inputs", "PuzzleIDRequestProp", "SimpleTwistyPropSource", "NO_VALUE", "PuzzleLoaderProp", "TwistyPropDerived", "inputs", "NO_VALUE", "puzzleLoader", "puzzles", "customPGPuzzleLoader", "cube3x3x3", "CoarseTimelineInfoProp", "TwistyPropDerived", "inputs", "v1", "v2", "DetailedTimelineInfoProp", "TwistyPropDerived", "inputs", "timestamp", "#requestedTimestampToMilliseconds", "atStart", "atEnd", "v1", "v2", "PlayingInfoProp", "TwistyPropSource", "newInfo", "oldValuePromise", "oldValue", "newValue", "v1", "v2", "TempoScaleProp", "TwistyPropSource", "v", "smartTimestamps", "TimestampRequestProp", "SimpleTwistyPropSource", "v", "BackViewProp", "SimpleTwistyPropSource", "TimeRangeProp", "TwistyPropDerived", "inputs", "ViewerLinkProp", "SimpleTwistyPropSource", "VisualizationFormatProp", "SimpleTwistyPropSource", "VisualizationStrategyProp", "TwistyPropDerived", "inputs", "FaceletScaleProp", "SimpleTwistyPropSource", "FoundationDisplayProp", "SimpleTwistyPropSource", "InitialHintFaceletsAnimationProp", "SimpleTwistyPropSource", "cachedLoader", "loader", "THREEJS", "SpriteProp", "TwistyPropDerived", "inputs", "textureURL", "resolve", "_reject", "onLoadingError", "r", "fullStickeringMask", "puzzleLoader", "definition", "orbitName", "orbitDef", "StickeringMaskProp", "TwistyPropDerived", "inputs", "charMap", "parseSerializedStickeringMask", "serializedStickeringMask", "stickeringMask", "serializedOrbits", "serializedOrbit", "orbitName", "serializedOrbitPieces", "rest", "pieces", "char", "pieceStickering", "getPieceStickeringMask", "StickeringMaskRequestProp", "TwistyPropSource", "input", "parseSerializedStickeringMask", "DragInputProp", "SimpleTwistyPropSource", "MovePressCancelOptions", "SimpleTwistyPropSource", "MovePressInputProp", "SimpleTwistyPropSource", "BackgroundProp", "SimpleTwistyPropSource", "DarkModeProp", "TwistyPropDerived", "inputs", "DarkModeRequstProp", "SimpleTwistyPropSource", "DOMElementReferenceProp", "SimpleTwistyPropSource", "DEFAULT_LATITUDE_LIMIT", "LatitudeLimitProp", "SimpleTwistyPropSource", "orbitCoordinatesEqual", "c1", "c2", "OrbitCoordinatesRequestProp", "TwistyPropSource", "v1", "v2", "newCoordinates", "oldValuePromise", "oldValue", "newValue", "mod", "OrbitCoordinatesProp", "TwistyPropDerived", "v1", "v2", "orbitCoordinatesEqual", "inputs", "defaultCameraOrbitCoordinates", "req", "latitude", "longitude", "distance", "centeredCameraOrbitCoordinates", "cubeCube3DCameraOrbitCoordinates", "cubePG3DCameraOrbitCoordinates", "megaminxCameraOrbitCoordinates", "DEGREES_PER_RADIAN", "pyraminxCameraOrbitCoordinates", "defaultCameraOrbitCoordinates", "puzzleID", "strategy", "cubeCube3DCameraOrbitCoordinates", "cubePG3DCameraOrbitCoordinates", "megaminxCameraOrbitCoordinates", "pyraminxCameraOrbitCoordinates", "centeredCameraOrbitCoordinates", "TwistySceneModel", "twistyPlayerModel", "BackgroundProp", "DarkModeRequstProp", "DragInputProp", "FoundationDisplayProp", "URLProp", "DOMElementReferenceProp", "HintFaceletProp", "InitialHintFaceletsAnimationProp", "LatitudeLimitProp", "MovePressInputProp", "MovePressCancelOptions", "OrbitCoordinatesRequestProp", "StickeringMaskRequestProp", "StickeringRequestProp", "FaceletScaleProp", "DarkModeProp", "SpriteProp", "OrbitCoordinatesProp", "StickeringMaskProp", "EMPTY_ERRORS", "UserVisibleErrorTracker", "SimpleTwistyPropSource", "_v1", "_v2", "arrayEquals", "TwistyPlayerModel", "UserVisibleErrorTracker", "AlgProp", "BackViewProp", "ControlPanelProp", "CatchUpMoveProp", "IndexerConstructorRequestProp", "PlayingInfoProp", "PGPuzzleDescriptionStringProp", "PuzzleIDRequestProp", "SetupAnchorProp", "SetupTransformationProp", "TempoScaleProp", "TimestampRequestProp", "ViewerLinkProp", "VisualizationFormatProp", "ArbitraryStringProp", "URLProp", "PuzzleLoaderProp", "KPuzzleProp", "PuzzleIDProp", "PuzzleAlgProp", "VisualizationStrategyProp", "IndexerConstructorProp", "NaiveMoveCountProp", "AlgTransformationProp", "IndexerProp", "AnchorTransformationProp", "TimeRangeProp", "DetailedTimelineInfoProp", "CoarseTimelineInfoProp", "CurrentMoveInfoProp", "ButtonAppearanceProp", "CurrentLeavesSimplifiedProp", "CurrentStateProp", "LegacyPositionProp", "TwistySceneModel", "viewerLink", "puzzleID", "puzzleDescription", "alg", "setup", "anchor", "experimentalStickeringRequest", "experimentalTitle", "isExplorer", "url", "NO_VALUE", "algLeaf", "options", "maybeMove", "Move", "newAlg", "Alg", "flexibleMove", "move", "puzzleLoader", "experimentalAppendMove", "getPartialAppendOptionsForPuzzleSpecificSimplifyOptions", "children", "finalChild", "finalChildMove", "err", "propName", "TwistyPlayerSettable", "ManagedCustomElement", "TwistyPlayerModel", "ExperimentalGetters", "newAlg", "newSetup", "anchor", "puzzleID", "puzzleDescription", "timestamp", "hintFaceletStyle", "stickering", "stickeringMask", "faceletScale", "backView", "backgroundTheme", "darkMode", "newControlPanel", "visualizationFormat", "title", "videoURL", "competitionID", "viewerLinkPage", "movePressInput", "movePressCancelOptions", "latitude", "longitude", "distance", "latitudeLimit", "indexer", "newTempoScale", "url", "element", "anim", "dragInputMode", "model", "DATA_ATTRIBUTE_PREFIX", "twistyPlayerAttributeMap", "configKeys", "s", "propOnly", "TwistyPlayer", "TwistyPlayerSettable", "config", "TwistyPlayerController", "#controlsManager", "ClassListManager", "controlsLocations", "#visualizationWrapperElem", "#errorElem", "#alreadyConnected", "#flashLevel", "#visualizationWrapper", "#initial3DVisualizationWrapper", "InitialValueTracker", "#visualizationStrategy", "propName", "value", "twistyPlayerCSS", "userVisibleError", "errorString", "scrubber", "TwistyScrubber", "TwistyButtons", "backgroundTheme", "darkModeTheme", "controlPanel", "#setVisualizationWrapper", "newLevel", "strategy", "newWrapper", "Twisty2DSceneWrapper", "Twisty3DSceneWrapper", "wrapper", "vantages", "canvases", "vantage", "puzzleRenderScheduledCallback", "puzzleWrapper", "twisty3DPuzzlePromise", "safeToCallback", "resolve", "scheduler", "RenderScheduler", "options", "play", "flexibleMove", "algLeaf", "observed", "key", "attributeName", "_oldValue", "newValue", "setterName", "screenshot", "filename", "twisty2DPuzzle", "str", "url", "downloadURL", "getDefaultFilename", "customElementsShim", "twistyAlgViewerCSS", "CSSSource", "DEFAULT_OFFSET_MS", "TwistyAlgLeafElem", "ManagedCustomElement", "className", "text", "dataDown", "algOrAlgNode", "offsetIntoMove", "clickable", "twistyAlgViewerCSS", "anchor", "e", "_index", "current", "customElementsShim", "TwistyAlgWrapperElem", "HTMLElementShim", "str", "dataUp", "direction", "node", "maybeReverseList", "oppositeDirection", "updateDirectionByAmount", "currentDirection", "amount", "l", "copy", "AlgToDOMTree", "TraversalDownUp", "alg", "moveCount", "element", "first", "algNode", "direct", "Pause", "Grouping", "grouping", "square1Tuple", "move", "commutator", "second", "conjugate", "aLen", "pause", "newline", "_dataDown", "lineComment", "algToDOMTree", "functionFromTraversal", "MoveHighlighter", "charIndex", "elem", "newElem", "TwistyAlgViewer", "options", "#twistyPlayer", "#domTree", "twistyPlayer", "#setTwistyPlayer", "algWithIssues", "sourceAlg", "parsedAlg", "Alg", "currentMoveInfo", "moveInfo", "mainCurrentMove", "detailedTimelineInfo", "index", "timestampPromise", "indexer", "offset", "DEFAULT_OFFSET_MS", "attributeName", "_oldValue", "newValue", "TwistyPlayer", "LeafTokens", "TraversalDownUp", "alg", "dataDown", "algNodeArrays", "numMovesInside", "algNode", "dataUp", "grouping", "move", "commutator", "dataUpA", "dataUpB", "conjugate", "pause", "_newline", "_dataDown", "_comment", "leafTokens", "functionFromTraversal", "TwistyAlgEditorValueProp", "SimpleTwistyPropSource", "AlgEditorAlgWithIssuesProp", "TwistyPropDerived", "input", "algWithIssuesFromString", "TwistyAlgEditorSelectionProp", "TwistyPropSource", "oldValue", "selectionStart", "selectionEnd", "lastResult", "endChangedMostRecently", "TargetCharProp", "inputs", "LeafTokensProp", "leafTokens", "LeafToHighlightProp", "withWhere", "leafInfo", "where", "lastLeafInfo", "TwistyAlgEditorModel", "twistyAlgEditorCSS", "CSSSource", "ATTRIBUTE_FOR_TWISTY_PLAYER", "ATTRIBUTE_PLACEHOLDER", "ATTRIBUTE_TWISTY_PLAYER_PROP", "TwistyAlgEditor", "ManagedCustomElement", "options", "TwistyAlgEditorModel", "#textarea", "#carbonCopy", "#carbonCopyPrefix", "#carbonCopyHighlight", "#carbonCopySuffix", "#textareaClassListValidForPuzzleManager", "ClassListManager", "#twistyPlayer", "#onInputHasFired", "#highlightedLeaf", "twistyAlgEditorCSS", "#twistyPlayerProp", "highlightInfo", "#algProp", "s", "placeholderText", "endTrimmed", "selectionStart", "selectionEnd", "issues", "#padSuffix", "leaf", "twistyPlayer", "algWithIssues", "newAlg", "oldAlg", "Alg", "indexer", "timestampRequest", "moveStartTimestamp", "duration", "newTimestamp", "currentLeavesSimplified", "attributeName", "_oldValue", "newValue", "elem", "TwistyPlayer", "customElementsShim", "twizzleLinkCSS", "CSSSource", "twizzleLinkForumTweaksCSS", "TwizzleLink", "ManagedCustomElement", "options", "span", "#cssElem", "#cssCDNForumTweaksElem", "#scrollableRegion", "#responsiveWrapper", "twizzleLinkCSS", "twizzleLinkForumTweaksCSS", "config", "getConfigFromURL", "href", "hostname", "pathname", "isExplorer", "puzzles", "puzzleDescription", "TwistyPlayer", "setupAlgDiv", "Alg", "TwistyAlgViewer", "text", "getTextToCopy", "headingDiv", "a", "setAndClear", "resolve", "e", "textToCopy", "customElementsShim", "updateURL", "url", "URLParamUpdater", "#prefix", "model", "options", "NO_VALUE", "unprefixedKey", "value", "defaultString", "prefixedKey", "prop", "key", "actualDefaultString", "s", "algWithIssues", "getConfigFromURL", "prefix", "paramMapping", "params", "config", "ourParam", "twistyPlayerParam", "paramValue", "configKey", "twistyPlayerAttributeMap", "remapLegacyURLParams", "mapping", "oldKey", "newKey"]
}
